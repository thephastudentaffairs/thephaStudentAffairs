<!DOCTYPE html>
<html lang="th">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>จัดการข้อมูลนักเรียน</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link
    href="https://fonts.googleapis.com/css2?family=Prompt:wght@400;600;700&family=Sarabun:wght@400;600;700&display=swap"
    rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.1/jspdf.plugin.autotable.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
  <script src="https://unpkg.com/jsqr@1.4.0/dist/jsQR.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
  <script>
    // Authentication check - redirect to login if not authenticated as admin
    (function () {
      const currentUser = sessionStorage.getItem('currentUser');
      if (!currentUser) {
        window.location.href = 'index.html';
        return;
      }

      try {
        const user = JSON.parse(currentUser);
        if (user.role !== 'admin') {
          window.location.href = 'index.html';
          return;
        }
      } catch (e) {
        window.location.href = 'index.html';
        return;
      }
    })();
  </script>
  <link rel="stylesheet" href="teacher-dashboard.css">
  <link rel="stylesheet" href="teacher-dashboard-p2.css">
  <link rel="stylesheet" href="teacher-dashboard-p3.css">
  <style>
    /* Minimal inline overrides - kept for compatibility */
  </style>
</head>

<body>
  <div class="container">
    <!-- Header -->
    <div class="header">
      <h1><i class="fas fa-edit"></i> จัดการและแก้ไขคะแนนนักเรียน</h1>
      <p>แก้ไขคะแนนได้โดยตรง พร้อมบันทึกอัตโนมัติ</p>
    </div>

    <!-- Actions Bar -->
    <div class="card" style="margin-bottom: 20px;">
      <div class="action-buttons" style="display: flex; gap: 15px; flex-wrap: wrap; justify-content: center;">
        <button class="action-btn btn-enter-id" onclick="openManualInput()">
          <div class="btn-icon"><i class="fas fa-keyboard"></i></div>
          กรอกรหัส
        </button>
        <button class="action-btn btn-camera" onclick="document.getElementById('qrInputFile').click()">
          <div class="btn-icon"><i class="fas fa-camera"></i></div>
          ถ่ายรูป QR
        </button>
        <input type="file" id="qrInputFile" accept="image/*" style="display: none;" onchange="processQRImage(this)">

        <button class="action-btn btn-scan-qr" onclick="openQRScanner()">
          <div class="btn-icon"><i class="fas fa-qrcode"></i></div>
          สแกน QR
        </button>

        <button class="action-btn btn-search-all" onclick="openStudentSearchModal()">
          <div class="btn-icon"><i class="fas fa-search"></i></div>
          ค้นหา นร.
        </button>

        <button class="action-btn" onclick="openReportModal()"
          style="background: linear-gradient(135deg, #3b82f6, #2563eb); box-shadow: 0 4px 15px rgba(59, 130, 246, 0.4);">
          <div class="btn-icon"><i class="fas fa-file-alt"></i></div>
          รายงานสรุป
        </button>
      </div>
    </div>

    <!-- การแจ้งเตือน -->
    <div class="notification-card" id="notificationCard" style="display: none;">
      <div class="notification-header">
        <h3>
          <i class="fas fa-bell"></i>
          การแจ้งเตือนจากครู
        </h3>
        <span class="notification-badge" id="notificationCount">0</span>
      </div>
      <div class="notification-list" id="notificationList">
        <!-- Notifications will be rendered here -->
      </div>
    </div>

    <!-- สถิติ -->
    <div class="card">
      <h2><i class="fas fa-chart-bar"></i> สถิติคะแนน</h2>
      <div class="stats-grid" id="statsGrid">
        <div class="stat-card">
          <div class="label">นักเรียนทั้งหมด</div>
          <div class="value" id="statTotal">0</div>
        </div>
        <div class="stat-card">
          <div class="label">คะแนนเฉลี่ย</div>
          <div class="value" id="statAvg">0</div>
        </div>
        <div class="stat-card">
          <div class="label">คะแนนสูง (≥80)</div>
          <div class="value" id="statHigh">0</div>
        </div>
        <div class="stat-card">
          <div class="label">คะแนนต่ำ (<60)< /div>
              <div class="value" id="statLow">0</div>
          </div>
        </div>
      </div>

      <!-- View All History Button -->
      <div style="margin-top: 20px; text-align: center;">
        <button class="btn-view-all-history" onclick="openAllHistoryModal()">
          <i class="fas fa-history"></i> ดูประวัติทั้งหมด
        </button>
      </div>
    </div>



    <!-- ตารางแก้ไขคะแนน -->
    <div class="card">
      <h2><i class="fas fa-table"></i> แก้ไขคะแนนนักเรียน</h2>

      <div id="statusMessage" class="status-box"></div>

      <div class="search-box">
        <div class="search-input-container">
          <input type="text" id="searchInput" placeholder="ค้นหาชื่อหรือรหัสนักเรียน...">
          <div id="searchDropdown" class="search-dropdown"></div>
        </div>

        <!-- NEW: Quick Action Buttons Area -->
        <div class="qr-action-buttons">
          <!-- Manual ID Input -->
          <button class="qr-action-btn btn-qr-manual" onclick="openManualInput()">
            <div class="btn-icon">
              <i class="fas fa-keyboard"></i>
            </div>
            <span>กรอกรหัส</span>
          </button>

          <!-- Camera Capture -->
          <label class="qr-action-btn btn-qr-photo">
            <div class="btn-icon">
              <i class="fas fa-camera"></i>
            </div>
            <span>ถ่ายรูป QR</span>
            <input type="file" id="qrCameraInput" accept="image/*" class="hidden-input" onchange="processQRImage(this)">
          </label>

          <!-- Live QR Scanner -->
          <button class="qr-action-btn btn-qr-live" onclick="openQRScanner()">
            <div class="btn-icon">
              <i class="fas fa-qrcode"></i>
            </div>
            <span>สแกน QR</span>
          </button>
        </div>
        <select id="classFilter" class="class-filter" onchange="filterByClass()">
          <option value="">ทุกห้อง</option>
        </select>
        <select id="reportMonth" class="class-filter">
          <option value="1">มกราคม</option>
          <option value="2">กุมภาพันธ์</option>
          <option value="3">มีนาคม</option>
          <option value="4">เมษายน</option>
          <option value="5">พฤษภาคม</option>
          <option value="6">มิถุนายน</option>
          <option value="7">กรกฎาคม</option>
          <option value="8">สิงหาคม</option>
          <option value="9">กันยายน</option>
          <option value="10">ตุลาคม</option>
          <option value="11">พฤศจิกายน</option>
          <option value="12">ธันวาคม</option>
        </select>
        <select id="academicYear" class="class-filter">
          <option value="2567">2567</option>
          <option value="2568">2568</option>
          <option value="2569">2569</option>
          <option value="2570">2570</option>
        </select>
        <button class="btn btn-success" onclick="exportToExcel()">
          <i class="fas fa-file-excel"></i> ส่งออก Excel
        </button>
        <button class="btn btn-primary" onclick="loadData()">
          <i class="fas fa-sync"></i> โหลดข้อมูล
        </button>
        <button class="btn btn-success" onclick="saveAll()">
          <i class="fas fa-save"></i> บันทึกทั้งหมด
        </button>
        <button class="btn btn-danger" onclick="exportLowScorePDF()">
          <i class="fas fa-file-pdf"></i> PDF (คะแนน<100) </button>
            <button class="btn btn-primary" onclick="exportAllStudentsPDF()"
              style="background: linear-gradient(135deg, #9f7aea, #805ad5);">
              <i class="fas fa-file-pdf"></i> PDF ทั้งหมด
            </button>
            <button class="btn btn-info" onclick="openPhotosManager()"
              style="background: linear-gradient(135deg, #38b2ac, #319795);">
              <i class="fas fa-images"></i> จัดการรูปนักเรียน
            </button>
            <button class="btn btn-warning" onclick="openLateReportModal()"
              style="background: linear-gradient(135deg, #f59e0b, #d97706);">
              <i class="fas fa-clock"></i> สรุปรายงานมาสาย
            </button>
      </div>

      <div class="btn-group">
        <button class="btn btn-info btn-sm" onclick="setAllScores(100)">
          <i class="fas fa-star"></i> ตั้งเป็น 100 ทุกคน
        </button>
        <button class="btn btn-warning btn-sm" onclick="addToAll(5)">
          <i class="fas fa-plus"></i> +5 ทุกคน
        </button>
        <button class="btn btn-warning btn-sm" onclick="addToAll(-5)">
          <i class="fas fa-minus"></i> -5 ทุกคน
        </button>
        <button class="btn btn-danger btn-sm" onclick="resetChanges()">
          <i class="fas fa-undo"></i> ยกเลิกการเปลี่ยนแปลง
        </button>
      </div>

      <div class="table-container">
        <table>
          <thead>
            <tr>
              <th>ลำดับ</th>
              <th>รหัส</th>
              <th>ชื่อ-นามสกุล</th>
              <th>ห้องเรียน</th>
              <th>สถานะ</th>
              <th>คะแนนเดิม</th>
              <th>ปรับ (+/-)</th>
              <th>คะแนนใหม่</th>
              <th>เครื่องมือ</th>
            </tr>
          </thead>
          <tbody id="studentTable">
            <tr>
              <td colspan="9" style="text-align: center; padding: 40px;">
                <i class="fas fa-spinner fa-spin" style="font-size: 2em; color: #cbd5e0;"></i>
                <p style="margin-top: 10px; color: #a0aec0;">กำลังโหลดข้อมูล...</p>
              </td>
            </tr>
          </tbody>
        </table>
      </div>

      <!-- Pagination -->
      <div class="pagination-container" id="paginationContainer">
        <div class="pagination-info">
          แสดง <span id="showingFrom">0</span> - <span id="showingTo">0</span> จาก <span id="showingTotal">0</span>
          รายการ
        </div>
        <div class="pagination-controls">
          <button class="btn btn-sm" onclick="goToPage(1)" id="btnFirst"><i
              class="fas fa-angle-double-left"></i></button>
          <button class="btn btn-sm" onclick="goToPage(currentPage - 1)" id="btnPrev"><i
              class="fas fa-angle-left"></i></button>
          <div class="page-numbers" id="pageNumbers"></div>
          <button class="btn btn-sm" onclick="goToPage(currentPage + 1)" id="btnNext"><i
              class="fas fa-angle-right"></i></button>
          <button class="btn btn-sm" onclick="goToPage(totalPages)" id="btnLast"><i
              class="fas fa-angle-double-right"></i></button>
        </div>
        <div class="items-per-page">
          <label>แสดง:</label>
          <select id="itemsPerPage" onchange="changeItemsPerPage()">
            <option value="10">10</option>
            <option value="20" selected>20</option>
            <option value="50">50</option>
            <option value="100">100</option>
          </select>
          <label>รายการ</label>
        </div>
      </div>
    </div>

    <!-- จัดการไฟล์ -->
    <div class="card">
      <h2><i class="fas fa-file-export"></i> จัดการไฟล์</h2>
      <div class="btn-group">
        <button class="btn btn-success" onclick="downloadJSON()">
          <i class="fas fa-download"></i> ดาวน์โหลด JSON
        </button>
        <button class="btn btn-warning" onclick="downloadBackup()">
          <i class="fas fa-history"></i> ดาวน์โหลดไฟล์สำรอง (คะแนน 100)
        </button>
      </div>
    </div>

    <!-- อัปโหลด Excel -->
    <div class="card">
      <h2><i class="fas fa-file-excel"></i> อัปโหลดไฟล์ Excel และแปลงเป็น JSON</h2>
      <p style="color: #718096; margin-bottom: 15px;">เลือกไฟล์ Excel (.xlsx) ที่มีคอลัมน์: id, name, password,
        status, score, class (ห้องเรียน)</p>

      <div class="upload-area" id="uploadArea">
        <input type="file" id="excelFile" accept=".xlsx,.xls" style="display: none;"
          onchange="handleExcelUpload(event)">
        <div class="upload-content" onclick="document.getElementById('excelFile').click()">
          <i class="fas fa-cloud-upload-alt" style="font-size: 3em; color: #667eea; margin-bottom: 15px;"></i>
          <p style="font-size: 1.1em; font-weight: 600; color: #333;">คลิกเพื่อเลือกไฟล์ Excel</p>
          <p style="color: #718096;">หรือลากไฟล์มาที่นี่</p>
        </div>
      </div>

      <div id="excelStatus" class="status-box" style="margin-top: 15px;"></div>

      <div id="excelPreview" style="display: none; margin-top: 20px;">
        <h3 style="margin-bottom: 15px;"><i class="fas fa-eye"></i> ตัวอย่างข้อมูล (<span id="previewCount">0</span>
          รายการ)</h3>
        <div class="table-container" style="max-height: 300px;">
          <table>
            <thead>
              <tr>
                <th>ลำดับ</th>
                <th>รหัส (id)</th>
                <th>ชื่อ (name)</th>
                <th>ห้องเรียน (class)</th>
                <th>รหัสผ่าน (password)</th>
                <th>สถานะ (status)</th>
                <th>คะแนน (score)</th>
              </tr>
            </thead>
            <tbody id="excelPreviewTable"></tbody>
          </table>
        </div>

        <div class="form-group" style="margin-top: 20px;">
          <label for="jsonFileName">ชื่อไฟล์ JSON ที่ต้องการบันทึก:</label>
          <input type="text" id="jsonFileName" placeholder="เช่น students.json" style="margin-top: 8px;">
        </div>

        <div class="btn-group" style="margin-top: 15px;">
          <button class="btn btn-success" onclick="downloadExcelAsJSON()">
            <i class="fas fa-download"></i> ดาวน์โหลดเป็น JSON
          </button>
          <button class="btn btn-primary" onclick="useExcelData()">
            <i class="fas fa-check"></i> ใช้ข้อมูลนี้ในตาราง
          </button>
          <button class="btn btn-danger" onclick="clearExcelData()">
            <i class="fas fa-times"></i> ยกเลิก
          </button>
        </div>
      </div>
    </div>

    <!-- ดาวน์โหลดข้อมูล JSON -->
    <div class="card">
      <h2><i class="fas fa-download"></i> ดาวน์โหลดข้อมูล JSON</h2>
      <p style="color: #718096; margin-bottom: 20px;">ดาวน์โหลดไฟล์ข้อมูลทั้งหมดในระบบ</p>

      <div class="btn-group" style="flex-wrap: wrap;">
        <button class="btn btn-primary" onclick="downloadJSON('user2.1.json')">
          <i class="fas fa-users"></i> user2.1.json (นักเรียน)
        </button>
        <button class="btn btn-success" onclick="downloadJSON('th.json')">
          <i class="fas fa-chalkboard-teacher"></i> th.json (ครูที่ปรึกษา)
        </button>
        <button class="btn btn-warning" onclick="downloadJSON('log.json')">
          <i class="fas fa-history"></i> log.json (ประวัติคะแนน)
        </button>
        <button class="btn btn-info" onclick="downloadJSON('toadmin.json')">
          <i class="fas fa-bell"></i> toadmin.json (แจ้งเตือน)
        </button>
        <button class="btn btn-danger" onclick="downloadJSON('TPAC.json')">
          <i class="fas fa-user-shield"></i> TPAC.json (แอดมิน)
        </button>
      </div>

      <div style="margin-top: 15px; padding-top: 15px; border-top: 2px solid #f0f0f0;">
        <button class="btn btn-primary" onclick="downloadAllJSON()"
          style="background: linear-gradient(135deg, #1a202c, #2d3748);">
          <i class="fas fa-file-archive"></i> ดาวน์โหลดทั้งหมด (ZIP)
        </button>
      </div>
    </div>
  </div>

  <!-- Modal แก้ไขนักเรียน -->
  <div id="editModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3><i class="fas fa-user-edit"></i> แก้ไขข้อมูลนักเรียน</h3>
        <button class="close-btn" onclick="closeEditModal()">
          <i class="fas fa-times"></i>
        </button>
      </div>

      <div class="form-group">
        <label>รหัสนักเรียน</label>
        <div class="info-display" id="modalId">-</div>
      </div>

      <div class="form-group">
        <label>ชื่อ-นามสกุล</label>
        <div class="info-display" id="modalName">-</div>
      </div>

      <div class="form-group">
        <label>คะแนนเดิม</label>
        <div class="info-display" id="modalOldScore">-</div>
      </div>

      <div class="form-group">
        <label>คะแนนใหม่ (0-100)</label>
        <input type="number" id="modalScore" min="0" max="100" placeholder="กรอกคะแนนใหม่">
      </div>

      <div class="form-group">
        <label>เหตุผล</label>
        <textarea id="modalReason" rows="3" placeholder="ระบุเหตุผล (ถ้ามี)"></textarea>
      </div>

      <div class="btn-group">
        <button class="btn btn-success" onclick="saveEdit()">
          <i class="fas fa-save"></i> บันทึก
        </button>
        <button class="btn btn-danger" onclick="closeEditModal()">
          <i class="fas fa-times"></i> ยกเลิก
        </button>
      </div>
    </div>
  </div>

  <!-- Reason Modal -->
  <div class="reason-modal-overlay" id="reasonModal">
    <div class="reason-modal">
      <div class="reason-modal-header">
        <div class="reason-modal-icon" id="reasonIcon">
          <i class="fas fa-edit"></i>
        </div>
        <div class="reason-modal-title-group">
          <h3 id="reasonTitle">ระบุเหตุผล</h3>
          <p class="reason-modal-subtitle" id="reasonSubtitle">กรุณาระบุเหตุผลในการปรับคะแนน</p>
        </div>
      </div>

      <!-- Checkbox group for deduction reasons -->
      <div class="deduction-reasons-container" id="deductionReasonsContainer">
        <label class="deduction-reasons-label">เลือกสาเหตุการหักคะแนน <span style="color: #ef4444;">*</span></label>
        <div class="deduction-reasons-grid">
          <div class="deduction-checkbox-item" onclick="toggleDeductionCheckbox(this)">
            <input type="checkbox" id="reason1" value="มาสาย">
            <label for="reason1">1. มาสาย</label>
          </div>
          <div class="deduction-checkbox-item" onclick="toggleDeductionCheckbox(this)">
            <input type="checkbox" id="reason2" value="ไม่สวมหมวกกันน็อค">
            <label for="reason2">2. ไม่สวมหมวกกันน็อค</label>
          </div>
          <div class="deduction-checkbox-item" onclick="toggleDeductionCheckbox(this)">
            <input type="checkbox" id="reason3" value="หนีเรียน">
            <label for="reason3">3. หนีเรียน</label>
          </div>
          <div class="deduction-checkbox-item" onclick="toggleDeductionCheckbox(this)">
            <input type="checkbox" id="reason4" value="สูบบุหรี่">
            <label for="reason4">4. สูบบุหรี่</label>
          </div>
          <div class="deduction-checkbox-item" onclick="toggleDeductionCheckbox(this)">
            <input type="checkbox" id="reason5" value="บุหรี่ไฟฟ้า">
            <label for="reason5">5. บุหรี่ไฟฟ้า</label>
          </div>
          <div class="deduction-checkbox-item" onclick="toggleDeductionCheckbox(this)">
            <input type="checkbox" id="reason6" value="การแต่งกายผิดระเบียบ">
            <label for="reason6">6. การแต่งกายผิดระเบียบ</label>
          </div>
          <div class="deduction-checkbox-item" onclick="toggleDeductionCheckbox(this)">
            <input type="checkbox" id="reason7" value="ทะเลาะวิวาท">
            <label for="reason7">7. ทะเลาะวิวาท</label>
          </div>
          <div class="deduction-checkbox-item" onclick="toggleDeductionCheckbox(this)">
            <input type="checkbox" id="reason8" value="ใช้สื่อโซเชียลไม่เหมาะสม">
            <label for="reason8">8. ใช้สื่อโซเชียลไม่เหมาะสม</label>
          </div>
          <div class="deduction-checkbox-item" onclick="toggleDeductionCheckbox(this)">
            <input type="checkbox" id="reason9" value="เล่นการพนัน">
            <label for="reason9">9. เล่นการพนัน</label>
          </div>
          <div class="deduction-checkbox-item" onclick="toggleDeductionCheckbox(this)">
            <input type="checkbox" id="reason10" value="สิงห้องน้ำ">
            <label for="reason10">10. สิงห้องน้ำ</label>
          </div>
          <div class="deduction-checkbox-item" onclick="toggleDeductionCheckbox(this)">
            <input type="checkbox" id="reason11" value="บูลลี่">
            <label for="reason11">11. บูลลี่</label>
          </div>
          <div class="deduction-checkbox-item" onclick="toggleDeductionCheckbox(this)">
            <input type="checkbox" id="reason12" value="ทำลายทรัพย์สินโรงเรียน">
            <label for="reason12">12. ทำลายทรัพย์สินโรงเรียน</label>
          </div>
          <div class="deduction-checkbox-item" onclick="toggleDeductionCheckbox(this)">
            <input type="checkbox" id="reason13" value="แอบถ่ายรูป">
            <label for="reason13">13. แอบถ่ายรูป</label>
          </div>
          <div class="deduction-checkbox-item" onclick="toggleDeductionCheckbox(this)">
            <input type="checkbox" id="reasonOther" value="อื่นๆ" onchange="toggleOtherReasonInput()">
            <label for="reasonOther">อื่นๆ (ระบุ)</label>
          </div>
        </div>
        <div class="other-reason-input" id="otherReasonInput">
          <input type="text" id="otherReasonText" placeholder="ระบุสาเหตุอื่นๆ...">
        </div>
      </div>

      <div class="reason-form-group">
        <label for="reasonInput">เหตุผล <span style="color: #ef4444;">*</span></label>
        <textarea id="reasonInput" placeholder="เช่น มาสาย, ไม่ส่งการบ้าน, ช่วยเหลือเพื่อน, เป็นตัวอย่างที่ดี..."
          required></textarea>
      </div>

      <div class="reason-modal-buttons">
        <button class="reason-btn reason-btn-cancel" onclick="cancelReason()">
          <i class="fas fa-times"></i> ยกเลิก
        </button>
        <button class="reason-btn reason-btn-confirm" onclick="confirmReason()">
          <i class="fas fa-check"></i> ยืนยัน
        </button>
      </div>
    </div>
  </div>

  <script>
    let studentsData = [];
    let teachersData = [];
    let originalData = [];
    let filteredData = [];
    let currentEditIndex = -1;

    // Reason modal variables
    let reasonCallback = null;
    let reasonCancelCallback = null;
    let pendingAdjustment = null;

    // Pagination variables
    let currentPage = 1;
    let itemsPerPage = 20;
    let totalPages = 1;
    let selectedClass = '';

    // Notification variables
    let notificationsData = [];
    let notificationRefreshInterval = null;

    // โหลดการแจ้งเตือน
    async function loadNotifications() {
      try {
        const response = await fetch('/toadmin.json');
        const rawData = await response.json();

        // Add original index to track correct position in JSON file
        const data = rawData.map((item, index) => ({ ...item, originalIndex: index }));

        // กรองเฉพาะที่ยังไม่ได้ดำเนินการ และไม่เอาอันที่ปรับคะแนนโดยครู (Admin Adjust)
        notificationsData = data.filter(item =>
          item.status !== 'completed' &&
          item.status !== 'rejected' &&
          !(item.detail || '').includes('ปรับคะแนนโดยครู') &&
          !(item.detail || '').includes('Admin Adjust')
        );

        // Sorting: Pending first, then by timestamp descending
        notificationsData.sort((a, b) => {
          if (a.status !== 'completed' && a.status !== 'rejected' && (b.status === 'completed' || b.status === 'rejected')) return -1;
          if ((a.status === 'completed' || a.status === 'rejected') && b.status !== 'completed' && b.status !== 'rejected') return 1;
          return new Date(b.timestamp) - new Date(a.timestamp);
        });

        renderNotifications();
      } catch (error) {
        console.error('Error loading notifications:', error);
        notificationsData = [];
        renderNotifications();
      }
    }

    // แสดงการแจ้งเตือน
    function renderNotifications() {
      const card = document.getElementById('notificationCard');
      const list = document.getElementById('notificationList');
      const count = document.getElementById('notificationCount');

      if (notificationsData.length === 0) {
        card.style.display = 'none';
        return;
      }

      card.style.display = 'block';

      // Count only pending items for the badge
      const pendingCount = notificationsData.filter(i => i.status !== 'completed' && i.status !== 'rejected').length;
      count.textContent = pendingCount;
      if (pendingCount === 0) count.style.display = 'none';
      else count.style.display = 'inline-flex';

      list.innerHTML = notificationsData.map((item, index) => {
        const timestamp = formatDateTime(item.timestamp);
        const reason = item.reason || item.detail || 'ไม่ระบุรายละเอียด';
        const isCompleted = item.status === 'completed' || item.status === 'rejected';

        let imagesHtml = '';
        if (item.image_before || item.image_after) {
          imagesHtml = '<div class="notification-images">';
          if (item.image_before) {
            imagesHtml += `
              <div class="notification-img-wrapper">
                <span class="img-label">Before</span>
                <img src="${item.image_before}" onclick="viewImage('${item.image_before}')">
              </div>`;
          }
          if (item.image_after) {
            imagesHtml += `
              <div class="notification-img-wrapper">
                <span class="img-label">After</span>
                <img src="${item.image_after}" onclick="viewImage('${item.image_after}')">
              </div>`;
          }
          imagesHtml += '</div>';
        }

        // Logic for styling based on status
        if (isCompleted) {
          // Notification Style (Read-only)
          return `
            <div class="notification-item" style="border-left: 5px solid #10b981; background: #f0fdf4;">
              <div class="notification-info">
                <div class="notification-student">
                  ${item.student_id} - ${item.student_name}
                </div>
                <div class="notification-reason" style="color: #047857;">
                  <i class="fas fa-bell"></i> ${reason}
                </div>
                ${imagesHtml}
                <div class="notification-meta">
                  <span><i class="fas fa-user-shield"></i> ${item.admin_name || item.teacher || 'Admin'}</span>
                  <span><i class="fas fa-clock"></i> ${timestamp}</span>
                </div>
              </div>
            </div>
            `;
        } else {
          // Action Card Style (Existing) + Reject Button
          return `
            <div class="notification-item">
              <div class="notification-info">
                <div class="notification-student">
                  ${item.student_id} - ${item.student_name}
                </div>
                <div class="notification-reason">
                  <i class="fas fa-comment-dots"></i> ${reason}
                </div>
                ${imagesHtml}
                <div class="notification-meta">
                  <span><i class="fas fa-user"></i> ${item.teacher}</span>
                  <span><i class="fas fa-clock"></i> ${timestamp}</span>
                </div>
              </div>
              <div class="notification-actions">
                <div style="display: flex; flex-direction: column; gap: 8px; width: 140px;">
                  <button class="btn-complete" onclick="markAsCompleted(${index})" style="width: 100%; justify-content: center;">
                    <i class="fas fa-check"></i> อนุมัติ
                  </button>
                  <button class="btn-complete" onclick="rejectNotification(${index})" style="width: 100%; background: linear-gradient(135deg, #ef4444, #dc2626); justify-content: center;">
                    <i class="fas fa-times"></i> ปฏิเสธ
                  </button>
                </div>
              </div>
            </div>
          `;
        }
      }).join('');
    }

    async function rejectNotification(index) {
      const notification = notificationsData[index];
      if (!notification) return;

      const { value: reason } = await Swal.fire({
        title: 'ระบุเหตุผลที่ปฏิเสธ',
        input: 'text',
        inputLabel: 'เหตุผล',
        inputPlaceholder: 'เช่น ข้อมูลไม่ถูกต้อง, รูปภาพไม่ชัดเจน',
        showCancelButton: true,
        confirmButtonColor: '#ef4444',
        cancelButtonColor: '#64748b',
        confirmButtonText: 'ยืนยันการปฏิเสธ',
        cancelButtonText: 'ยกเลิก',
        inputValidator: (value) => {
          if (!value) return 'กรุณาระบุเหตุผล';
        }
      });

      if (reason) {
        try {
          if (typeof showLoading === 'function') showLoading(true); // Optional if helper exists

          // Use originalIndex if available, otherwise fall back to search
          let serverIndex = notification.originalIndex;

          if (serverIndex === undefined) {
            const response = await fetch('/toadmin.json');
            const allData = await response.json();
            serverIndex = allData.findIndex(item =>
              item.student_id === notification.student_id &&
              item.timestamp === notification.timestamp
            );
          }

          if (serverIndex === undefined || serverIndex === -1) {
            if (typeof showLoading === 'function') showLoading(false);
            showStatus('error', 'ไม่พบข้อมูลในระบบ');
            return;
          }

          const currentUser = JSON.parse(sessionStorage.getItem('currentUser') || '{}');
          const adminName = currentUser.name || 'Admin';

          const response = await fetch('/api/update-toadmin-status', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              index: serverIndex,
              admin_name: adminName,
              status: 'rejected',
              reason: reason
            })
          });

          const result = await response.json();

          if (typeof showLoading === 'function') showLoading(false);

          if (result.status === 'success') {
            showStatus('success', 'ปฏิเสธรายการเรียบร้อยแล้ว');
            // Remove from list
            notificationsData.splice(index, 1);
            renderNotifications();
          } else {
            showStatus('error', 'เกิดข้อผิดพลาด: ' + result.message);
          }

        } catch (error) {
          console.error(error);
          if (typeof showLoading === 'function') showLoading(false);
          showStatus('error', 'เกิดข้อผิดพลาดในการเชื่อมต่อ');
        }
      }
    }

    // ทำเครื่องหมายว่าดำเนินการแล้ว
    async function markAsCompleted(index) {
      try {
        const notification = notificationsData[index];
        if (!notification) {
          showStatus('error', 'ไม่พบข้อมูลการแจ้งเตือน');
          return;
        }

        // Open the manual adjustment modal directly
        openAdjustScoreModal(index); // This needs to be checked if it supports originalIndex usage internally or if we pass it

      } catch (error) {
        console.error('Error marking as completed:', error);
        showStatus('error', 'เกิดข้อผิดพลาดในการดำเนินการ');
      }
    }

    // ฟังก์ชันจบงาน (Mark as Done)
    async function finalizeCompletion(index, actualIndex, adminName) {
      // ลบออกจาก array ทันทีและ re-render
      if (index < notificationsData.length) {
        notificationsData.splice(index, 1);
        renderNotifications();
      }

      try {
        // Send update to server
        const updateResponse = await fetch('/api/update-toadmin-status', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            index: actualIndex,
            admin_name: adminName
          })
        });

        const result = await updateResponse.json();

        if (result.status === 'success') {
          showStatus('success', 'ดำเนินการเรียบร้อยแล้ว');

          // Refresh table
          if (typeof filterData === 'function') filterData();
          else if (typeof displayTable === 'function') displayTable();

        } else {
          showStatus('error', 'เกิดข้อผิดพลาด: ' + (result.message || 'Unknown error'));
          loadNotifications();
        }
      } catch (e) {
        console.error(e);
        loadNotifications();
      }
    }

    // แปลงวันที่และเวลา
    function formatDateTime(isoString) {
      if (!isoString) return '-';
      const date = new Date(isoString);
      const now = new Date();
      const diffMs = now - date;
      const diffMins = Math.floor(diffMs / 60000);
      const diffHours = Math.floor(diffMs / 3600000);
      const diffDays = Math.floor(diffMs / 86400000);

      if (diffMins < 1) return 'เมื่อสักครู่';
      if (diffMins < 60) return `${diffMins} นาทีที่แล้ว`;
      if (diffHours < 24) return `${diffHours} ชั่วโมงที่แล้ว`;
      if (diffDays < 7) return `${diffDays} วันที่แล้ว`;

      const day = date.getDate().toString().padStart(2, '0');
      const month = (date.getMonth() + 1).toString().padStart(2, '0');
      const year = date.getFullYear() + 543; // พ.ศ.
      const hours = date.getHours().toString().padStart(2, '0');
      const minutes = date.getMinutes().toString().padStart(2, '0');

      return `${day}/${month}/${year} ${hours}:${minutes}`;
    }

    // แปลง class code เป็นชื่อห้องเรียน (201 -> ม.2/1)
    function formatClassName(classCode) {
      if (!classCode) return '-';
      const codeStr = String(classCode);
      if (codeStr.length >= 2) {
        const grade = codeStr.charAt(0); // ชั้น
        const room = codeStr.substring(1); // ห้อง
        return `ม.${grade}/${parseInt(room)}`;
      }
      return codeStr;
    }

    // ดึงรายการห้องเรียนทั้งหมด
    function getUniqueClasses() {
      const classes = new Set();
      studentsData.forEach(s => {
        if (s.class) classes.add(s.class);
      });
      return Array.from(classes).sort((a, b) => a - b);
    }

    // อัปเดต dropdown ห้องเรียน
    function updateClassFilter() {
      const select = document.getElementById('classFilter');
      const classes = getUniqueClasses();

      select.innerHTML = '<option value="">ทุกห้อง</option>';
      classes.forEach(classCode => {
        const option = document.createElement('option');
        option.value = classCode;
        option.textContent = formatClassName(classCode);
        select.appendChild(option);
      });
    }

    // กรองตามห้องเรียน
    function filterByClass() {
      selectedClass = document.getElementById('classFilter').value;
      currentPage = 1;
      applyFilters();
    }

    // Apply all filters (search + class)
    function applyFilters() {
      const query = document.getElementById('searchInput').value.toLowerCase().trim();

      filteredData = studentsData.filter(s => {
        // Ensure name exists and is a string
        const studentName = (s.name || '').toString().toLowerCase();
        const studentId = (s.id || '').toString();

        const matchSearch = !query || studentName.includes(query) || studentId.includes(query);
        const matchClass = !selectedClass || String(s.class) === selectedClass;
        return matchSearch && matchClass;
      });

      updatePagination();
      displayTable();
    }

    // Update pagination
    function updatePagination() {
      totalPages = Math.ceil(filteredData.length / itemsPerPage);
      if (totalPages < 1) totalPages = 1;
      if (currentPage > totalPages) currentPage = totalPages;

      renderPagination();
    }

    // Render pagination controls
    function renderPagination() {
      const from = filteredData.length > 0 ? (currentPage - 1) * itemsPerPage + 1 : 0;
      const to = Math.min(currentPage * itemsPerPage, filteredData.length);

      document.getElementById('showingFrom').textContent = from;
      document.getElementById('showingTo').textContent = to;
      document.getElementById('showingTotal').textContent = filteredData.length;

      // Page numbers
      const pageNumbersDiv = document.getElementById('pageNumbers');
      pageNumbersDiv.innerHTML = '';

      let startPage = Math.max(1, currentPage - 2);
      let endPage = Math.min(totalPages, currentPage + 2);

      if (currentPage <= 3) {
        endPage = Math.min(5, totalPages);
      }
      if (currentPage >= totalPages - 2) {
        startPage = Math.max(1, totalPages - 4);
      }

      for (let i = startPage; i <= endPage; i++) {
        const pageSpan = document.createElement('span');
        pageSpan.className = 'page-number' + (i === currentPage ? ' active' : '');
        pageSpan.textContent = i;
        pageSpan.onclick = () => goToPage(i);
        pageNumbersDiv.appendChild(pageSpan);
      }

      // Update button states
      document.getElementById('btnFirst').disabled = currentPage === 1;
      document.getElementById('btnPrev').disabled = currentPage === 1;
      document.getElementById('btnNext').disabled = currentPage === totalPages;
      document.getElementById('btnLast').disabled = currentPage === totalPages;
    }

    // Go to specific page
    function goToPage(page) {
      if (page < 1 || page > totalPages) return;
      currentPage = page;
      displayTable();
      renderPagination();
    }

    // Change items per page
    function changeItemsPerPage() {
      itemsPerPage = parseInt(document.getElementById('itemsPerPage').value);
      currentPage = 1;
      updatePagination();
      displayTable();
    }

    // Search dropdown
    function showSearchDropdown(results) {
      const dropdown = document.getElementById('searchDropdown');

      // Filter results by selected class if a class is selected
      let filteredResults = results;
      if (selectedClass) {
        filteredResults = results.filter(student => String(student.class) === selectedClass);
      }

      if (filteredResults.length === 0) {
        dropdown.classList.remove('show');
        return;
      }

      dropdown.innerHTML = filteredResults.slice(0, 8).map(student => {
        const studentName = student.name || 'ไม่ระบุชื่อ';
        return `
          <div class="dropdown-item" onclick="selectStudent('${student.id}')">
            <div class="student-info">
              <span class="student-name">${studentName}</span>
              <span class="student-id">รหัส: ${student.id}</span>
            </div>
            <span class="student-class">${formatClassName(student.class)}</span>
          </div>
        `;
      }).join('');

      dropdown.classList.add('show');
    }

    function selectStudent(studentId) {
      document.getElementById('searchInput').value = studentId;
      document.getElementById('searchDropdown').classList.remove('show');
      applyFilters();
    }

    // Hide dropdown when clicking outside
    document.addEventListener('click', (e) => {
      if (!e.target.closest('.search-input-container')) {
        document.getElementById('searchDropdown')?.classList.remove('show');
      }
    });

    // โหลดข้อมูล
    async function loadData() {
      const statusMsg = document.getElementById('statusMessage');
      statusMsg.className = 'status-box show status-info';
      statusMsg.innerHTML = '<i class="fas fa-spinner fa-spin"></i> กำลังโหลดข้อมูล...';

      try {
        const res = await fetch('th.json');
        if (res.ok) {
          teachersData = await res.json();
          console.log('Loaded teachers:', teachersData.length);
        }
      } catch (e) {
        console.error('Error loading teachers:', e);
      }

      const files = ['user2.1.json', 'user2_1.json'];
      let foundFile = null;

      for (let file of files) {
        try {
          const response = await fetch(file);
          if (response.ok) {
            foundFile = file;
            const data = await response.json();

            // Verify data is array
            if (!Array.isArray(data)) {
              console.error('Data is not an array:', data);
              continue;
            }

            // Ensure all records have name field and required properties
            studentsData = data.map(student => ({
              id: student.id || '',
              name: student.name || student.studentName || 'ไม่ระบุชื่อ',
              password: student.password || '',
              status: student.status || 'normal',
              score: student.score || 0,
              class: student.class || 0
            }));

            console.log('Loaded data sample:', studentsData.slice(0, 3));

            originalData = JSON.parse(JSON.stringify(studentsData)); // Backup
            filteredData = [...studentsData];

            // Fix for QR Scanner: Assign to global window.allStudents
            window.allStudents = studentsData;
            console.log('Global students data set:', window.allStudents.length);

            break;
          } else {
            console.log(`File ${file} not found (HTTP ${response.status})`);
          }
        } catch (e) {
          console.log(`Error loading ${file}:`, e.message);
        }
      }

      if (foundFile && studentsData.length > 0) {
        statusMsg.className = 'status-box show status-success';
        statusMsg.innerHTML = `<i class="fas fa-check-circle"></i> โหลดข้อมูลสำเร็จจากไฟล์: <strong>${foundFile}</strong> (${studentsData.length} คน)`;
        updateClassFilter();
        updateStats();
        currentPage = 1;
        updatePagination();
        displayTable();
      } else {
        statusMsg.className = 'status-box show status-error';
        const helpText = `
          <strong>ไม่พบไฟล์ข้อมูล!</strong><br>
          วิธีแก้:<br>
          1. โปรดตรวจสอบว่ามีไฟล์ <strong>user2.1.json</strong> หรือ <strong>user2_1.json</strong> ในโฟลเดอร์เดียวกัน<br>
          2. หากเปิดไฟล์ HTML โดยตรง ให้เปิดผ่านเซิร์ฟเวอร์แทน:<br>
          &nbsp;&nbsp;&nbsp;- เปิด Command Prompt/Terminal ไปที่โฟลเดอร์นี้<br>
          &nbsp;&nbsp;&nbsp;- พิมพ์: <code>node server.js</code><br>
          &nbsp;&nbsp;&nbsp;- เข้าไปที่: <strong>http://localhost:8000</strong><br>
          3. ถ้าไม่มี server.js ให้ใช้เซิร์ฟเวอร์อื่น เช่น:<br>
          &nbsp;&nbsp;&nbsp;- <code>python -m http.server 8000</code> (Python)<br>
          &nbsp;&nbsp;&nbsp;- <code>php -S localhost:8000</code> (PHP)<br>
          &nbsp;&nbsp;&nbsp;- <code>npx http-server</code> (Node.js)
        `;
        statusMsg.innerHTML = helpText;
        statusMsg.style.textAlign = 'left';
        statusMsg.style.lineHeight = '1.6';
        // Show empty table instead of stuck loading state
        displayTable();
      }
    }

    // ==================== REAL-TIME UPDATE LOGIC ====================
    let isUserInteracting = false;

    // Monitor user interaction
    document.addEventListener('focus', (e) => {
      if (['INPUT', 'TEXTAREA', 'SELECT'].includes(e.target.tagName)) {
        isUserInteracting = true;
      }
    }, true);

    document.addEventListener('blur', (e) => {
      if (['INPUT', 'TEXTAREA', 'SELECT'].includes(e.target.tagName)) {
        setTimeout(() => isUserInteracting = false, 500);
      }
    }, true);

    async function refreshStudentData() {
      // Safeguard: User interaction or Modal active
      const isModalOpen = document.querySelector('.modal.show') ||
        document.querySelector('.reason-modal-overlay.show') ||
        document.querySelector('.manual-input-modal.show') ||
        document.querySelector('.qr-scanner-overlay.show') ||
        document.querySelector('.student-search-overlay.show') ||
        document.querySelector('.history-modal-overlay.show') ||
        document.querySelector('.all-history-modal-overlay.show') ||
        document.querySelector('#editModal.show');

      if (isUserInteracting || isModalOpen) return;

      try {
        const timestamp = new Date().getTime();
        const response = await fetch(`user2.1.json?v=${timestamp}`);
        if (!response.ok) return;

        const newData = await response.json();
        if (!Array.isArray(newData)) return;

        // Detect changes (compare essential fields)
        const currentSnapshot = JSON.stringify(studentsData.map(s => ({ i: s.id, s: s.score, st: s.status, c: s.class })));
        const newSnapshot = JSON.stringify(newData.map(s => ({
          i: s.id || '',
          s: s.score || 0,
          st: s.status || 'normal',
          c: s.class || 0
        })));

        if (currentSnapshot !== newSnapshot) {
          // console.log('Real-time update: Syncing data...');

          // Update Data
          studentsData = newData.map(student => ({
            id: student.id || '',
            name: student.name || student.studentName || 'ไม่ระบุชื่อ',
            password: student.password || '',
            status: student.status || 'normal',
            score: student.score || 0,
            class: student.class || 0,
            history: student.history
          }));

          // Sync dependencies
          window.allStudents = studentsData;
          originalData = JSON.parse(JSON.stringify(studentsData)); // Sync baseline

          // Refresh UI
          applyFilters();
          updateStats();
        }
      } catch (e) {
        console.warn('Silent refresh failed:', e);
      }
    }

    // Start Polling (every 3 seconds)
    setInterval(refreshStudentData, 3000);

    // Helper function to show status messages
    function showStatus(type, message) {
      const statusMsg = document.getElementById('statusMessage');
      if (!statusMsg) {
        console.log(`[${type}] ${message}`);
        return;
      }

      const icons = {
        'info': 'fa-spinner fa-spin',
        'success': 'fa-check-circle',
        'error': 'fa-exclamation-triangle',
        'warning': 'fa-exclamation-circle'
      };

      const statusClasses = {
        'info': 'status-info',
        'success': 'status-success',
        'error': 'status-error',
        'warning': 'status-warning'
      };

      statusMsg.className = `status-box show ${statusClasses[type] || 'status-info'}`;
      statusMsg.innerHTML = `<i class="fas ${icons[type] || 'fa-info-circle'}"></i> ${message}`;

      // Auto-hide after 5 seconds for success/info
      if (type === 'success' || type === 'info') {
        setTimeout(() => {
          statusMsg.classList.remove('show');
        }, 5000);
      }
    }

    // อัปเดตสถิติ
    function updateStats() {
      const total = studentsData.length;
      const avg = total > 0 ? studentsData.reduce((sum, s) => sum + s.score, 0) / total : 0;
      const high = studentsData.filter(s => s.score >= 80).length;
      const low = studentsData.filter(s => s.score < 60).length;

      document.getElementById('statTotal').textContent = total;
      document.getElementById('statAvg').textContent = avg.toFixed(1);
      document.getElementById('statHigh').textContent = high;
      document.getElementById('statLow').textContent = low;
    }

    // อัปเดตสถานะนักเรียน
    async function updateStatus(studentId, newStatus) {
      try {
        const response = await fetch('/api/save-status', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ id: studentId, status: newStatus })
        });

        const result = await response.json();

        if (result.status === 'success') {
          // Update local data
          const student = studentsData.find(s => s.id === studentId);
          if (student) student.status = newStatus;

          showStatus('success', `อัปเดตสถานะ ${studentId} เรียบร้อย`);
        } else {
          showStatus('error', 'อัปเดตไม่สำเร็จ: ' + result.message);
          displayTable(); // Revert
        }
      } catch (e) {
        console.error(e);
        showStatus('error', 'เกิดข้อผิดพลาดในการเชื่อมต่อ');
        displayTable(); // Revert
      }
    }

    // แสดงตาราง
    function displayTable() {
      const tbody = document.getElementById('studentTable');

      if (filteredData.length === 0) {
        tbody.innerHTML = `
          <tr>
            <td colspan="9" style="text-align: center; padding: 40px; color: #a0aec0;">
              <i class="fas fa-inbox" style="font-size: 3em; margin-bottom: 10px; display: block;"></i>
              ไม่พบข้อมูล
            </td>
          </tr>
        `;
        return;
      }

      // Pagination slice
      const startIndex = (currentPage - 1) * itemsPerPage;
      const endIndex = startIndex + itemsPerPage;
      const pageData = filteredData.slice(startIndex, endIndex);

      tbody.innerHTML = pageData.map((student, index) => {
        const actualIndex = studentsData.findIndex(s => s.id === student.id);
        const originalScore = originalData.find(s => s.id === student.id)?.score || student.score;
        const isChanged = student.score !== originalScore;
        const scoreClass = student.score >= 80 ? 'score-high' : student.score < 60 ? 'score-low' : 'score-medium';
        const diff = student.score - originalScore;
        const displayIndex = startIndex + index + 1;
        const studentName = student.name || 'ไม่ระบุชื่อ';
        const studentStatus = student.status || 'normal';

        return `
          <tr>
            <td>${displayIndex}</td>
            <td>${student.id}</td>
            <td>${studentName}</td>
            <td><span class="class-badge">${formatClassName(student.class)}</span></td>
            <td>
              <select onchange="updateStatus('${student.id}', this.value)" style="padding: 6px; border-radius: 6px; border: 1px solid #cbd5e0; background: white; font-family: inherit; font-size: 0.9em; cursor: pointer;">
                <option value="normal" ${studentStatus === 'normal' ? 'selected' : ''}>กำลังศึกษาอยู่</option>
                <option value="Absent" ${studentStatus === 'Absent' ? 'selected' : ''}>ขาดเรียนนาน</option>
                <option value="moved" ${studentStatus === 'moved' ? 'selected' : ''}>ย้ายแล้ว</option>
                <option value="notnormal" ${student.status === 'notnormal' ? 'selected' : ''}>พักการเรียน</option>
              </select>
            </td>
            <td><span class="score-badge ${scoreClass}">${originalScore}</span></td>
            <td>
              <input 
                type="text" 
                class="adjust-input" 
                id="adjust-${actualIndex}"
                placeholder="+10 / -5"
                onchange="adjustScore(${actualIndex}, this.value)"
                onkeypress="if(event.key==='Enter') this.blur()"
              >
            </td>
            <td>
              <span class="score-result ${isChanged ? 'changed' : ''}">${student.score}</span>
            </td>
            <td>
              <div class="action-buttons">
                <button class="btn btn-success btn-sm" onclick="quickSave(${actualIndex})" title="บันทึกเดี่ยว">
                  <i class="fas fa-check"></i>
                </button>
                <button class="btn-history" onclick="viewStudentHistory('${student.id}', '${student.name.replace(/'/g, "\\\\'")}')" title="ดูประวัติ">
                  <i class="fas fa-history"></i>
                </button>
                <button class="btn-manage" onclick="openManageStudentModal('${student.id}', '${student.name.replace(/'/g, "\\\\'")}')" title="จัดการ">
                  <i class="fas fa-user-cog"></i>
                </button>
              </div>
            </td>
          </tr>
        `;
      }).join('');
    }

    // ปรับคะแนนด้วย +/-
    function adjustScore(index, value) {
      const input = document.getElementById(`adjust-${index}`);
      const trimmed = value.trim();

      if (!trimmed) {
        input.className = 'adjust-input';
        return;
      }

      let adjustment = 0;

      // รองรับรูปแบบ +10, -5, 10 (บวกโดยปริยาย)
      if (trimmed.startsWith('+')) {
        adjustment = parseInt(trimmed.substring(1));
        input.className = 'adjust-input positive';
      } else if (trimmed.startsWith('-')) {
        adjustment = -parseInt(trimmed.substring(1));
        input.className = 'adjust-input negative';
      } else {
        adjustment = parseInt(trimmed);
        input.className = adjustment >= 0 ? 'adjust-input positive' : 'adjust-input negative';
      }

      if (isNaN(adjustment)) {
        showStatus('error', 'กรุณากรอกตัวเลข เช่น +10 หรือ -5');
        input.value = '';
        input.className = 'adjust-input';
        return;
      }

      // เก็บข้อมูลไว้ใช้ใน modal
      pendingAdjustment = {
        index: index,
        adjustment: adjustment,
        input: input
      };

      // แสดง modal ให้กรอกเหตุผล
      showReasonModal(
        adjustment < 0 ? 'decrease' : 'increase',
        adjustment,
        studentsData[index].name,
        (reason) => {
          // เมื่อยืนยัน
          studentsData[index].logReason = reason;

          const originalScore = originalData.find(s => s.id === studentsData[index].id)?.score || studentsData[index].score;
          const newScore = originalScore + pendingAdjustment.adjustment;
          studentsData[pendingAdjustment.index].score = newScore;

          updateStats();
          displayTable();

          // บันทึกลง server และ log.json ทันที
          quickSave(pendingAdjustment.index).then(() => {
            showStatus('success', `ปรับคะแนน ${pendingAdjustment.adjustment > 0 ? '+' : ''}${pendingAdjustment.adjustment} และบันทึกสำเร็จ!`);
          });

          pendingAdjustment.input.value = '';
          pendingAdjustment.input.className = 'adjust-input';
          pendingAdjustment = null;
        },
        () => {
          // เมื่อยกเลิก
          pendingAdjustment.input.value = '';
          pendingAdjustment.input.className = 'adjust-input';
          pendingAdjustment = null;
        }
      );
    }

    // แสดง Reason Modal
    function showReasonModal(type, adjustment, studentName, onConfirm, onCancel) {
      const modal = document.getElementById('reasonModal');
      const icon = document.getElementById('reasonIcon');
      const title = document.getElementById('reasonTitle');
      const subtitle = document.getElementById('reasonSubtitle');
      const input = document.getElementById('reasonInput');

      // ตั้งค่า UI ตามประเภท
      if (type === 'decrease') {
        icon.className = 'reason-modal-icon decrease';
        icon.innerHTML = '<i class="fas fa-minus-circle"></i>';
        title.textContent = 'หักคะแนน';
        subtitle.textContent = `หัก ${Math.abs(adjustment)} คะแนนจาก ${studentName}`;
      } else {
        icon.className = 'reason-modal-icon increase';
        icon.innerHTML = '<i class="fas fa-plus-circle"></i>';
        title.textContent = 'เพิ่มคะแนน';
        subtitle.textContent = `เพิ่ม +${adjustment} คะแนนให้ ${studentName}`;
      }

      // Show/hide deduction reasons container and work detail/images based on type
      const deductionContainer = document.getElementById('deductionReasonsContainer');
      const workDetailContainer = document.getElementById('adjustWorkDetailContainer');
      const imageUploadContainer = document.getElementById('adjustImageUploadContainer');

      if (type === 'decrease') {
        deductionContainer.classList.add('show');
        resetDeductionCheckboxes();
        if (workDetailContainer) workDetailContainer.style.display = 'none';
        if (imageUploadContainer) imageUploadContainer.style.display = 'none';
      } else {
        deductionContainer.classList.remove('show');
        if (workDetailContainer) workDetailContainer.style.display = 'block';
        if (imageUploadContainer) imageUploadContainer.style.display = 'flex';
      }

      input.value = '';
      input.focus();

      reasonCallback = onConfirm;
      reasonCancelCallback = onCancel;

      modal.classList.add('show');
    }

    // Toggle checkbox visual state
    function toggleDeductionCheckbox(item) {
      const checkbox = item.querySelector('input[type="checkbox"]');
      checkbox.checked = !checkbox.checked;
      item.classList.toggle('checked', checkbox.checked);

      // If it's the "other" checkbox, toggle the input field
      if (checkbox.id === 'reasonOther') {
        toggleOtherReasonInput();
      }

      // Auto-populate the reason textarea
      updateReasonFromCheckboxes();
    }

    // Toggle other reason input visibility
    function toggleOtherReasonInput() {
      const otherCheckbox = document.getElementById('reasonOther');
      const otherInput = document.getElementById('otherReasonInput');

      if (otherCheckbox.checked) {
        otherInput.classList.add('show');
        document.getElementById('otherReasonText').focus();
      } else {
        otherInput.classList.remove('show');
        document.getElementById('otherReasonText').value = '';
      }

      updateReasonFromCheckboxes();
    }

    // Update reason textarea based on selected checkboxes
    function updateReasonFromCheckboxes() {
      const container = document.getElementById('deductionReasonsContainer');
      if (!container.classList.contains('show')) return;

      const checkboxes = container.querySelectorAll('input[type="checkbox"]:checked');
      const reasons = [];

      checkboxes.forEach(cb => {
        if (cb.id === 'reasonOther') {
          const otherText = document.getElementById('otherReasonText').value.trim();
          if (otherText) {
            reasons.push(otherText);
          }
        } else {
          reasons.push(cb.value);
        }
      });

      document.getElementById('reasonInput').value = reasons.join(', ');
    }

    // Reset all deduction checkboxes
    function resetDeductionCheckboxes() {
      const container = document.getElementById('deductionReasonsContainer');
      const checkboxItems = container.querySelectorAll('.deduction-checkbox-item');

      checkboxItems.forEach(item => {
        const checkbox = item.querySelector('input[type="checkbox"]');
        checkbox.checked = false;
        item.classList.remove('checked');
      });

      document.getElementById('otherReasonInput').classList.remove('show');
      document.getElementById('otherReasonText').value = '';
    }

    // Listen for changes in other reason input to update main textarea
    document.getElementById('otherReasonText').addEventListener('input', function () {
      updateReasonFromCheckboxes();
    });

    // ยืนยันเหตุผล
    function confirmReason() {
      const input = document.getElementById('reasonInput');
      const reason = input.value.trim();

      if (!reason) {
        showStatus('error', 'กรุณากรอกเหตุผล');
        input.focus();
        return;
      }

      document.getElementById('reasonModal').classList.remove('show');

      if (reasonCallback) {
        reasonCallback(reason);
        reasonCallback = null;
      }
    }

    // ยกเลิกเหตุผล
    function cancelReason() {
      document.getElementById('reasonModal').classList.remove('show');

      if (reasonCancelCallback) {
        reasonCancelCallback();
        reasonCancelCallback = null;
      }
    }

    // Keyboard support for reason modal
    document.getElementById('reasonInput').addEventListener('keydown', function (e) {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        confirmReason();
      } else if (e.key === 'Escape') {
        e.preventDefault();
        cancelReason();
      }
    });

    // อัปเดตคะแนน
    function updateScore(index, newScore) {
      const score = parseInt(newScore);
      if (isNaN(score) || score < 0 || score > 100) {
        alert('กรุณากรอกคะแนน 0-100');
        displayTable();
        return;
      }
      studentsData[index].score = score;
      updateStats();
      displayTable();
    }

    // ตั้งคะแนนทุกคน
    function setAllScores(score) {
      if (!confirm(`ต้องการตั้งคะแนนเป็น ${score} ทุกคนใช่หรือไม่?`)) return;

      studentsData.forEach(s => s.score = score);
      updateStats();
      displayTable();

      showMessage('success', `ตั้งคะแนนเป็น ${score} ทุกคนแล้ว`);
    }

    // เพิ่ม/ลดคะแนนทุกคน
    function addToAll(amount) {
      const action = amount > 0 ? 'เพิ่ม' : 'ลด';
      if (!confirm(`ต้องการ${action}คะแนน ${Math.abs(amount)} ทุกคนใช่หรือไม่?`)) return;

      studentsData.forEach(s => {
        s.score = Math.max(0, Math.min(100, s.score + amount));
      });
      updateStats();
      displayTable();

      showMessage('success', `${action}คะแนน ${Math.abs(amount)} ทุกคนแล้ว`);
    }

    // ยกเลิกการเปลี่ยนแปลง
    function resetChanges() {
      if (!confirm('ต้องการยกเลิกการเปลี่ยนแปลงทั้งหมดใช่หรือไม่?')) return;

      studentsData = JSON.parse(JSON.stringify(originalData));
      filteredData = [...studentsData];
      updateStats();
      displayTable();

      showMessage('info', 'ยกเลิกการเปลี่ยนแปลงแล้ว');
    }

    // เปิด Modal แก้ไข
    function openEditModal(index) {
      currentEditIndex = index;
      const student = studentsData[index];
      const originalScore = originalData.find(s => s.id === student.id)?.score || student.score;

      document.getElementById('modalId').textContent = student.id;
      document.getElementById('modalName').textContent = student.name;
      document.getElementById('modalOldScore').textContent = originalScore;
      document.getElementById('modalScore').value = student.score;
      document.getElementById('modalReason').value = '';

      document.getElementById('editModal').classList.add('show');
    }

    function closeEditModal() {
      document.getElementById('editModal').classList.remove('show');
      currentEditIndex = -1;
    }

    // บันทึกจาก Modal
    function saveEdit() {
      const newScore = parseInt(document.getElementById('modalScore').value);
      const reason = document.getElementById('modalReason').value.trim();

      if (isNaN(newScore) || newScore < 0 || newScore > 100) {
        alert('กรุณากรอกคะแนน 0-100');
        return;
      }

      studentsData[currentEditIndex].score = newScore;

      if (reason) {
        if (!studentsData[currentEditIndex].history) {
          studentsData[currentEditIndex].history = [];
        }
        studentsData[currentEditIndex].history.push({
          date: new Date().toISOString(),
          score: newScore,
          reason: reason
        });
      }

      updateStats();
      displayTable();
      closeEditModal();

      showMessage('success', 'แก้ไขคะแนนสำเร็จ');
    }

    // บันทึกเดี่ยว
    async function quickSave(index) {
      const student = studentsData[index];

      try {
        const response = await fetch('/api/save-score', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            id: student.id,
            score: student.score,
            reason: student.logReason || 'แก้ไขคะแนน'
          })
        });

        const result = await response.json();

        if (result.status === 'success') {
          originalData[index].score = student.score;
          // Clear the reason after save
          delete student.logReason;

          showMessage('success', `บันทึกคะแนน ${student.name} สำเร็จ`);
          displayTable();
        } else {
          showMessage('error', 'บันทึกไม่สำเร็จ: ' + result.message);
        }
      } catch (e) {
        showMessage('error', 'ไม่สามารถเชื่อมต่อ Server ได้ กรุณาตรวจสอบว่า Node.js Server ทำงานอยู่');
      }
    }

    // บันทึกทั้งหมด
    async function saveAll() {
      if (!confirm('ต้องการบันทึกการเปลี่ยนแปลงทั้งหมดใช่หรือไม่?')) return;

      const statusMsg = document.getElementById('statusMessage');
      statusMsg.className = 'status-box show status-info';
      statusMsg.innerHTML = '<i class="fas fa-spinner fa-spin"></i> กำลังบันทึก...';

      try {
        const response = await fetch('/api/save-all', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(studentsData)
        });

        const result = await response.json();

        if (result.status === 'success') {
          originalData = JSON.parse(JSON.stringify(studentsData));
          statusMsg.className = 'status-box show status-success';
          statusMsg.innerHTML = `<i class="fas fa-check-circle"></i> บันทึกสำเร็จ! (${result.students} คน)`;
          displayTable();
        } else {
          statusMsg.className = 'status-box show status-error';
          statusMsg.innerHTML = `<i class="fas fa-times-circle"></i> บันทึกไม่สำเร็จ: ${result.message}`;
        }
      } catch (e) {
        statusMsg.className = 'status-box show status-error';
        statusMsg.innerHTML = `
          <i class="fas fa-times-circle"></i> ไม่สามารถเชื่อมต่อ Server ได้<br>
          <small>วิธีแก้: รัน node server.js ก่อน หรือดาวน์โหลด JSON แล้วอัปโหลดทับไฟล์เดิม</small>
        `;
      }
    }

    // ดาวน์โหลด JSON
    function downloadJSON() {
      const dataStr = JSON.stringify(studentsData, null, 2);
      const blob = new Blob([dataStr], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      const timestamp = new Date().toISOString().replace(/[:.]/g, '-').slice(0, -5);
      a.href = url;
      a.download = `user2.1_edited_${timestamp}.json`;
      a.click();
      URL.revokeObjectURL(url);

      showMessage('success', 'ดาวน์โหลดไฟล์สำเร็จ');
    }

    // ดาวน์โหลดไฟล์สำรอง
    function downloadBackup() {
      const backupData = originalData.map(s => ({ ...s, score: 100 }));
      const dataStr = JSON.stringify(backupData, null, 2);
      const blob = new Blob([dataStr], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'user2.1_backup_100.json';
      a.click();
      URL.revokeObjectURL(url);

      showMessage('success', 'ดาวน์โหลดไฟล์สำรอง (คะแนน 100 ทุกคน)');
    }

    // ค้นหา
    document.getElementById('searchInput')?.addEventListener('input', (e) => {
      const query = e.target.value.toLowerCase().trim();

      // Show dropdown suggestions
      if (query.length >= 1 && studentsData.length > 0) {
        const suggestions = studentsData.filter(s => {
          const studentName = (s.name || '').toString().toLowerCase();
          const studentId = (s.id || '').toString();
          return studentName.includes(query) || studentId.includes(query);
        });
        showSearchDropdown(suggestions);
      } else {
        document.getElementById('searchDropdown').classList.remove('show');
      }

      // Apply filters with pagination reset
      currentPage = 1;
      applyFilters();
    });

    // =====================================================
    // Excel Export Function
    // =====================================================

    const thaiMonths = [
      'มกราคม', 'กุมภาพันธ์', 'มีนาคม', 'เมษายน',
      'พฤษภาคม', 'มิถุนายน', 'กรกฎาคม', 'สิงหาคม',
      'กันยายน', 'ตุลาคม', 'พฤศจิกายน', 'ธันวาคม'
    ];

    function exportToExcel() {
      if (filteredData.length === 0) {
        alert('ไม่มีข้อมูลที่จะส่งออก');
        return;
      }

      showMessage('info', 'กำลังสร้างไฟล์ Excel...');

      try {
        // Get selected month and year
        const monthSelect = document.getElementById('reportMonth');
        const yearSelect = document.getElementById('academicYear');
        const selectedMonthValue = monthSelect ? monthSelect.value : (new Date().getMonth() + 1);
        const selectedYear = yearSelect ? yearSelect.value : '2568';
        const selectedMonthName = thaiMonths[parseInt(selectedMonthValue) - 1];

        // Get class name
        const selectedClassName = selectedClass ? formatClassName(selectedClass) : 'ทุกห้อง';

        // Calculate statistics
        const avgScore = filteredData.reduce((sum, s) => sum + s.score, 0) / filteredData.length;
        const highScore = filteredData.filter(s => s.score >= 80).length;
        const lowScore = filteredData.filter(s => s.score < 60).length;

        // Create workbook
        const wb = XLSX.utils.book_new();

        // Prepare data for Excel
        const excelData = [];

        // Title rows
        excelData.push(['รายงานคะแนนพฤติกรรมนักเรียนโรงเรียนเทพา']);
        excelData.push([`ประจำเดือน${selectedMonthName} ปีการศึกษา ${selectedYear}`]);
        excelData.push([`ห้องเรียน: ${selectedClassName}`]);
        excelData.push([]); // Empty row

        // Table headers
        excelData.push(['ลำดับ', 'รหัส', 'ชื่อ-นามสกุล', 'ห้อง', 'คะแนน']);

        // Table data
        filteredData.forEach((student, index) => {
          excelData.push([
            index + 1,
            student.id,
            student.name,
            formatClassName(student.class),
            student.score
          ]);
        });

        // Empty row before summary
        excelData.push([]);

        // Summary
        excelData.push(['สรุปข้อมูล']);
        excelData.push(['จำนวนนักเรียนทั้งหมด:', `${filteredData.length} คน`]);
        excelData.push(['คะแนนเฉลี่ย:', `${avgScore.toFixed(1)} คะแนน`]);
        excelData.push(['คะแนนสูง (≥80):', `${highScore} คน`]);
        excelData.push(['คะแนนต่ำ (<60):', `${lowScore} คน`]);

        // Create worksheet
        const ws = XLSX.utils.aoa_to_sheet(excelData);

        // Set column widths
        ws['!cols'] = [
          { wch: 8 },  // ลำดับ
          { wch: 12 }, // รหัส
          { wch: 30 }, // ชื่อ-นามสกุล
          { wch: 10 }, // ห้อง
          { wch: 10 }  // คะแนน
        ];

        // Merge cells for title
        ws['!merges'] = [
          { s: { r: 0, c: 0 }, e: { r: 0, c: 4 } }, // Title row
          { s: { r: 1, c: 0 }, e: { r: 1, c: 4 } }, // Subtitle row
          { s: { r: 2, c: 0 }, e: { r: 2, c: 4 } }  // Class info row
        ];

        // Add worksheet to workbook
        XLSX.utils.book_append_sheet(wb, ws, 'รายงานคะแนน');

        // Generate filename
        const classFileStr = selectedClass ? `_${selectedClassName.replace('/', '-')}` : '_all';
        const filename = `รายงานคะแนน_${selectedMonthName}_${selectedYear}${classFileStr}.xlsx`;

        // Save file
        XLSX.writeFile(wb, filename);

        showMessage('success', `ส่งออก Excel สำเร็จ! (${filteredData.length} รายการ)`);

      } catch (error) {
        console.error('Excel Export Error:', error);
        showMessage('error', 'เกิดข้อผิดพลาดในการสร้าง Excel: ' + error.message);
      }
    }

    // แสดงข้อความ
    function showMessage(type, message) {
      const statusMsg = document.getElementById('statusMessage');
      const icons = {
        success: 'check-circle',
        error: 'times-circle',
        info: 'info-circle'
      };

      statusMsg.className = `status-box show status-${type}`;
      statusMsg.innerHTML = `<i class="fas fa-${icons[type]}"></i> ${message}`;

      setTimeout(() => {
        statusMsg.classList.remove('show');
      }, 5000);
    }

    // =====================================================
    // Excel Upload Functions
    // =====================================================
    let excelData = [];
    let uploadedFileName = '';

    // Handle Excel file upload
    function handleExcelUpload(event) {
      const file = event.target.files[0];
      if (!file) return;

      uploadedFileName = file.name.replace(/\.[^/.]+$/, ''); // Remove extension
      const statusBox = document.getElementById('excelStatus');

      statusBox.className = 'status-box show status-info';
      statusBox.innerHTML = '<i class="fas fa-spinner fa-spin"></i> กำลังอ่านไฟล์ Excel...';

      const reader = new FileReader();
      reader.onload = function (e) {
        try {
          const data = new Uint8Array(e.target.result);
          const workbook = XLSX.read(data, { type: 'array' });

          // Get first sheet
          const sheetName = workbook.SheetNames[0];
          const worksheet = workbook.Sheets[sheetName];

          // Convert to JSON
          const jsonData = XLSX.utils.sheet_to_json(worksheet);

          if (jsonData.length === 0) {
            statusBox.className = 'status-box show status-error';
            statusBox.innerHTML = '<i class="fas fa-times-circle"></i> ไฟล์ไม่มีข้อมูล';
            return;
          }

          // Validate and normalize data
          excelData = jsonData.map(row => ({
            id: String(row.id || row.รหัส || ''),
            name: String(row.name || row.ชื่อ || row['ชื่อ-นามสกุล'] || ''),
            password: String(row.password || row.รหัสผ่าน || row.id || row.รหัส || ''),
            status: String(row.status || row.สถานะ || 'normal'),
            score: parseInt(row.score || row.คะแนน || 100) || 100,
            class: parseInt(row.class || row.ห้องเรียน || row.ห้อง || '') || null
          }));

          // Update UI
          document.getElementById('jsonFileName').value = uploadedFileName + '.json';
          document.getElementById('previewCount').textContent = excelData.length;

          // Display preview table
          const tbody = document.getElementById('excelPreviewTable');
          tbody.innerHTML = excelData.slice(0, 10).map((s, i) => `
              <tr>
                <td>${i + 1}</td>
                <td>${s.id}</td>
                <td>${s.name}</td>
                <td><span class="class-badge">${formatClassName(s.class)}</span></td>
                <td>${s.password}</td>
                <td>${s.status}</td>
                <td>${s.score}</td>
              </tr>
            `).join('');

          if (excelData.length > 10) {
            tbody.innerHTML += `<tr><td colspan="7" style="text-align:center; color:#718096;">... และอีก ${excelData.length - 10} รายการ</td></tr>`;
          }

          document.getElementById('excelPreview').style.display = 'block';

          statusBox.className = 'status-box show status-success';
          statusBox.innerHTML = `<i class="fas fa-check-circle"></i> อ่านไฟล์สำเร็จ: <strong>${file.name}</strong> (${excelData.length} รายการ)`;

        } catch (err) {
          console.error(err);
          statusBox.className = 'status-box show status-error';
          statusBox.innerHTML = '<i class="fas fa-times-circle"></i> ไม่สามารถอ่านไฟล์ได้: ' + err.message;
        }
      };
      reader.readAsArrayBuffer(file);
    }

    // Download Excel data as JSON
    function downloadExcelAsJSON() {
      if (excelData.length === 0) {
        alert('ไม่มีข้อมูล');
        return;
      }

      let fileName = document.getElementById('jsonFileName').value.trim();
      if (!fileName) fileName = 'students.json';
      if (!fileName.endsWith('.json')) fileName += '.json';

      const dataStr = JSON.stringify(excelData, null, 2);
      const blob = new Blob([dataStr], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = fileName;
      a.click();
      URL.revokeObjectURL(url);

      document.getElementById('excelStatus').className = 'status-box show status-success';
      document.getElementById('excelStatus').innerHTML = `<i class="fas fa-check-circle"></i> ดาวน์โหลด ${fileName} สำเร็จ!`;
    }

    // Use Excel data in the table
    function useExcelData() {
      if (excelData.length === 0) {
        alert('ไม่มีข้อมูล');
        return;
      }

      if (!confirm('ต้องการใช้ข้อมูลจาก Excel แทนที่ข้อมูลปัจจุบันใช่หรือไม่?')) return;

      studentsData = JSON.parse(JSON.stringify(excelData));
      originalData = JSON.parse(JSON.stringify(excelData));
      filteredData = [...studentsData];

      updateStats();
      displayTable();

      showMessage('success', `โหลดข้อมูลจาก Excel สำเร็จ (${excelData.length} คน)`);
    }

    // Clear Excel data
    function clearExcelData() {
      excelData = [];
      uploadedFileName = '';
      document.getElementById('excelFile').value = '';
      document.getElementById('excelPreview').style.display = 'none';
      document.getElementById('excelStatus').className = 'status-box';
    }

    // Drag and drop support
    document.addEventListener('DOMContentLoaded', function () {
      const uploadArea = document.getElementById('uploadArea');
      if (uploadArea) {
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
          uploadArea.addEventListener(eventName, e => {
            e.preventDefault();
            e.stopPropagation();
          });
        });

        ['dragenter', 'dragover'].forEach(eventName => {
          uploadArea.addEventListener(eventName, () => uploadArea.classList.add('dragover'));
        });

        ['dragleave', 'drop'].forEach(eventName => {
          uploadArea.addEventListener(eventName, () => uploadArea.classList.remove('dragover'));
        });

        uploadArea.addEventListener('drop', e => {
          const files = e.dataTransfer.files;
          if (files.length > 0) {
            document.getElementById('excelFile').files = files;
            handleExcelUpload({ target: { files: files } });
          }
        });
      }
    });

    // เริ่มต้น
    window.onload = () => {
      console.log('🟢 Page loaded - starting data loading...');
      loadData().then(() => {
        console.log('✅ Data loaded successfully. Students:', studentsData.length);
        if (studentsData.length > 0) {
          console.log('📋 Sample data:', studentsData.slice(0, 2));
          console.log('✨ Search should work now');
        }
      }).catch(e => {
        console.error('❌ Error loading data:', e);
      });

      loadNotifications();

      // Auto-refresh notifications every 5 seconds (เช็คข้อมูลใหม่บ่อยขึ้น)
      notificationRefreshInterval = setInterval(() => {
        loadNotifications();
      }, 5000); // เปลี่ยนจาก 30000 (30 วินาที) เป็น 5000 (5 วินาที)
    };

    // Cleanup on page unload
    window.onbeforeunload = () => {
      if (notificationRefreshInterval) {
        clearInterval(notificationRefreshInterval);
      }
    };

    // Download single JSON file
    async function downloadJSON(filename) {
      try {
        showMessage('info', `กำลังดาวน์โหลด ${filename}...`);

        const response = await fetch(filename);
        if (!response.ok) {
          throw new Error(`ไม่พบไฟล์ ${filename}`);
        }

        const data = await response.json();
        const jsonStr = JSON.stringify(data, null, 2);
        const blob = new Blob([jsonStr], { type: 'application/json' });

        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);

        showMessage('success', `ดาวน์โหลด ${filename} สำเร็จ!`);
      } catch (error) {
        console.error('Download error:', error);
        showMessage('error', `เกิดข้อผิดพลาด: ${error.message}`);
      }
    }

    // Download all JSON files as ZIP
    async function downloadAllJSON() {
      const files = ['user2.1.json', 'th.json', 'log.json', 'toadmin.json', 'TPAC.json'];

      try {
        showMessage('info', 'กำลังเตรียมไฟล์ทั้งหมด...');

        // Load JSZip dynamically if not already loaded
        if (typeof JSZip === 'undefined') {
          await loadScript('https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js');
        }

        const zip = new JSZip();
        const timestamp = new Date().toISOString().slice(0, 10);

        // Fetch all files
        for (const filename of files) {
          try {
            const response = await fetch(filename);
            if (response.ok) {
              const data = await response.json();
              zip.file(filename, JSON.stringify(data, null, 2));
            }
          } catch (err) {
            console.warn(`Could not fetch ${filename}:`, err);
          }
        }

        // Generate ZIP
        const content = await zip.generateAsync({ type: 'blob' });

        // Download
        const url = URL.createObjectURL(content);
        const a = document.createElement('a');
        a.href = url;
        a.download = `ข้อมูลระบบ_${timestamp}.zip`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);

        showMessage('success', 'ดาวน์โหลดไฟล์ทั้งหมดสำเร็จ!');
      } catch (error) {
        console.error('ZIP download error:', error);
        showMessage('error', `เกิดข้อผิดพลาด: ${error.message}`);
      }
    }

    // Helper function to load external script
    function loadScript(src) {
      return new Promise((resolve, reject) => {
        const script = document.createElement('script');
        script.src = src;
        script.onload = resolve;
        script.onerror = reject;
        document.head.appendChild(script);
      });
    }

    // ========== Score History Functions ==========
    // Load score history from log.json (Explicitly Global)
    window.scoreHistoryData = [];

    // Helper to format timestamp for history
    function formatHistoryTimestamp(timestamp) {
      if (!timestamp) return '-';
      const date = new Date(timestamp);
      if (isNaN(date.getTime())) return '-';
      return date.toLocaleDateString('th-TH', {
        year: 'numeric',
        month: 'short',
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
      });
    }

    async function loadScoreHistory() {
      const controller = new AbortController();
      const timeoutId = setTimeout(() => controller.abort(), 3000); // 3 second timeout

      try {
        const timestamp = Date.now();
        const response = await fetch(`log.json?v=${timestamp}`, { signal: controller.signal });
        clearTimeout(timeoutId);

        if (!response.ok) throw new Error(`HTTP Error: ${response.status}`);

        const data = await response.json();
        window.scoreHistoryData = Array.isArray(data) ? data : [];
        console.log('Loaded score history:', window.scoreHistoryData.length, 'records');
      } catch (err) {
        if (err.name === 'AbortError') {
          console.error('Timeout loading score history');
        } else {
          console.error('Error loading score history:', err);
        }
        // Fallback to empty array if valid data not present
        if (!Array.isArray(window.scoreHistoryData)) window.scoreHistoryData = [];
      }
    }

    let currentStudentHistory = [];

    // Unified View Switching for Manage Student Modal
    async function switchManageStudentView(view) {
      const mainView = document.getElementById('manageMainView');
      const historyView = document.getElementById('manageHistoryView');
      const backBtn = document.getElementById('manageBackBtn');
      const title = document.getElementById('manageModalTitle');

      if (view === 'history') {
        const listContainer = document.getElementById('manageHistoryList');

        mainView.classList.remove('active');
        historyView.classList.add('active');
        backBtn.style.display = 'flex';
        title.innerHTML = '<i class="fas fa-history"></i> ประวัติคะแนน';

        // Show loading state
        listContainer.innerHTML = `
            <div style="display:flex; flex-direction:column; align-items:center; justify-content:center; padding:40px 20px; color:#94a3b8; text-align:center;">
              <i class="fas fa-spinner fa-spin" style="font-size:2rem; margin-bottom:15px;"></i>
              <p>กำลังโหลดข้อมูล...</p>
            </div>
        `;

        try {
          // Refresh data every time we open history
          await loadScoreHistory();

          // Load and render history for CURRENT student
          const targetId = String(currentManageId || '').trim();
          currentStudentHistory = (window.scoreHistoryData || []).filter(h => String(h.student_id || '').trim() === targetId);

          // Render initial 'all' view
          renderHistoryListUnified('all');
        } catch (error) {
          console.error('Critical Error in History View:', error);
          listContainer.innerHTML = `
                 <div style="text-align:center; padding: 20px; color: #ef4444;">
                    <i class="fas fa-exclamation-circle" style="font-size: 2rem; margin-bottom: 10px;"></i>
                    <p>เกิดข้อผิดพลาดในการแสดงผล</p>
                    <small style="color:#64748b;">${error.message}</small>
                 </div>
            `;
        }
      } else {
        historyView.classList.remove('active');
        mainView.classList.add('active');
        backBtn.style.display = 'none';
        title.innerHTML = '<i class="fas fa-user-cog"></i> จัดการข้อมูลนักเรียน';
      }
    }

    // Filter history for unified view
    function filterHistoryUnified(type, tabElement) {
      const tabs = document.querySelectorAll('.manage-history-tab');
      tabs.forEach(t => t.classList.remove('active'));
      tabElement.classList.add('active');
      renderHistoryListUnified(type);
    }

    // Render history for unified view
    function renderHistoryListUnified(filter) {
      const listContainer = document.getElementById('manageHistoryList');
      if (!listContainer) return;

      let filtered = [...currentStudentHistory];

      if (filter === 'positive') {
        filtered = filtered.filter(h => {
          const change = h.change || h.score_change || h.scoreChange || h.score || h.point || h.points || 0;
          return change > 0;
        });
      } else if (filter === 'negative') {
        filtered = filtered.filter(h => {
          const change = h.change || h.score_change || h.scoreChange || h.score || h.point || h.points || 0;
          return change < 0;
        });
      }

      if (filtered.length === 0) {
        let msg = 'ยังไม่มีประวัติการปรับคะแนน';
        if (filter === 'positive') msg = 'ไม่พบประวัติการเพิ่มคะแนน';
        if (filter === 'negative') msg = 'ไม่พบประวัติการลดคะแนน';

        listContainer.innerHTML = `
            <div style="display:flex; flex-direction:column; align-items:center; justify-content:center; padding:40px 20px; color:#94a3b8; text-align:center;">
              <i class="fas fa-clipboard-list" style="font-size:3rem; margin-bottom:15px; opacity:0.3;"></i>
              <p style="font-weight:600;">${msg}</p>
              <div style="font-size: 0.75rem; color: #cbd5e1; margin-top: 20px; text-align: left; background: #f8fafc; padding: 10px; border-radius: 8px; width: 100%;">
                <strong>Debug Info:</strong><br>
                Target ID: "${String(currentManageId || '').trim()}"<br>
                Total Records: ${window.scoreHistoryData ? window.scoreHistoryData.length : 'N/A'}<br>
                Filtered Count: ${filtered.length}<br>
                Data Source: window.scoreHistoryData
              </div>
            </div>
          `;
        return;
      }

      // Sort newest first
      filtered.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

      listContainer.innerHTML = filtered.map(h => {
        const scoreChange = h.change || h.score_change || h.scoreChange || h.score || h.point || h.points || 0;
        const isPositive = scoreChange > 0;
        const scoreText = isPositive ? `+${scoreChange}` : scoreChange.toString();
        const timestamp = formatHistoryTimestamp(h.timestamp);
        const teacher = h.teacher || h.admin || 'ไม่ระบุ';

        return `
            <div class="manage-history-item">
              <div class="manage-history-badge ${isPositive ? 'positive' : 'negative'}">
                ${scoreText}
              </div>
              <div class="manage-history-info">
                <div class="manage-history-reason">${h.reason || 'ไม่ระบุสาเหตุ'}</div>
                <div class="manage-history-meta">
                  <span><i class="fas fa-clock"></i> ${timestamp}</span>
                  <span><i class="fas fa-user-tie"></i> ${teacher}</span>
                </div>
              </div>
            </div>
          `;
      }).join('');
    }

    // View student score history (Bridge to unified modal)
    function viewStudentHistory(studentId, studentName) {
      openManageStudentModal(studentId, studentName);
      // Wait for modal to be ready
      setTimeout(() => switchManageStudentView('history'), 300);
    }

    // Load history when page loads
    document.addEventListener('DOMContentLoaded', function () {
      loadScoreHistory();
    });

    // ========== PDF Export Function ==========

    // Export students with score < 100 to PDF (uses filteredData based on selected class filter)
    function exportLowScorePDF() {
      // ใช้ filteredData แทน studentsData เพื่อให้ตรงกับ filter ที่เลือก
      var lowScoreStudents = filteredData.filter(function (s) { return s.score < 100; });
      if (lowScoreStudents.length === 0) {
        showStatus('warning', 'ไม่มีนักเรียนที่คะแนนต่ำกว่า 100 คะแนน' + (selectedClass ? ' ในห้อง ' + formatClassName(selectedClass) : ''));
        return;
      }
      var now = new Date();
      var thaiMonths = ['มกราคม', 'กุมภาพันธ์', 'มีนาคม', 'เมษายน', 'พฤษภาคม', 'มิถุนายน', 'กรกฎาคม', 'สิงหาคม', 'กันยายน', 'ตุลาคม', 'พฤศจิกายน', 'ธันวาคม'];
      var currentMonth = thaiMonths[now.getMonth()];
      var currentYear = now.getFullYear() + 543;
      // แสดงชื่อห้องเรียนที่เลือก
      var classDisplay = selectedClass ? formatClassName(selectedClass) : 'ทุกห้อง';
      lowScoreStudents.sort(function (a, b) {
        if (a.class !== b.class) return a.class - b.class;
        return a.score - b.score;
      });
      var tableRows = '';
      for (var i = 0; i < lowScoreStudents.length; i++) {
        var s = lowScoreStudents[i];
        var scoreClass = s.score < 60 ? 'score-low' : s.score < 80 ? 'score-med' : 'score-ok';
        var remark = s.score < 60 ? 'คะแนนวิกฤต' : s.score < 80 ? 'ต้องปรับปรุง' : 'ใกล้ปกติ';
        tableRows += '<tr><td style="text-align:center;">' + (i + 1) + '</td>';
        tableRows += '<td style="text-align:center;">' + s.id + '</td>';
        tableRows += '<td>' + s.name + '</td>';
        tableRows += '<td style="text-align:center;">' + formatClassName(s.class) + '</td>';
        tableRows += '<td class="' + scoreClass + '" style="text-align:center;">' + s.score + '</td>';
        tableRows += '<td style="text-align:center;font-size:11px;">' + remark + '</td></tr>';
      }
      var html = '<!DOCTYPE html><html><head><meta charset="UTF-8">';
      html += '<title>รายงานคะแนนต่ำ</title>';
      html += '<link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;600&display=swap" rel="stylesheet">';
      html += '<style>body{font-family:Sarabun,sans-serif;padding:15px;font-size:12px;}';
      html += '.header{text-align:center;margin-bottom:20px;}.header h1{font-size:18px;margin-bottom:5px;color:#dc3545;}';
      html += '.summary{background:#f8f9fa;padding:10px;border-left:4px solid #dc3545;margin-bottom:15px;}';
      html += 'table{width:100%;border-collapse:collapse;}th{background:#dc3545;color:white;padding:8px;text-align:center;}';
      html += 'td{padding:6px;border:1px solid #ddd;}tr:nth-child(even){background:#f9f9f9;}';
      html += '.score-low{color:#dc3545;font-weight:bold;}.score-med{color:#fd7e14;font-weight:bold;}.score-ok{color:#ffc107;font-weight:bold;}';
      html += '@media print{@page{margin:1cm;}}</style></head><body>';
      html += '<div class="header"><h1>รายงานนักเรียนคะแนนต่ำกว่า 100</h1>';
      html += '<p>ห้องเรียน: ' + classDisplay + '</p>';
      html += '<p>ประจำเดือน ' + currentMonth + ' พ.ศ. ' + currentYear + '</p></div>';
      html += '<div class="summary"><strong>สรุป:</strong> นักเรียนคะแนนต่ำ <strong style="color:#dc3545;">' + lowScoreStudents.length + '</strong> คน</div>';
      html += '<table><thead><tr><th>ลำดับ</th><th>รหัส</th><th>ชื่อ-นามสกุล</th><th>ห้อง</th><th>คะแนน</th><th>หมายเหตุ</th></tr></thead>';
      html += '<tbody>' + tableRows + '</tbody></table>';
      html += '<script>setTimeout(function(){window.print();},500);<\/script></body></html>';
      var printWindow = window.open('', '_blank');
      printWindow.document.write(html);
      printWindow.document.close();
      showStatus('success', 'เปิดหน้าพิมพ์แล้ว - เลือก "บันทึกเป็น PDF"');
    }

    // Export ALL students to PDF (uses filteredData based on selected class filter)
    function exportAllStudentsPDF() {
      // ใช้ filteredData แทน studentsData เพื่อให้ตรงกับ filter ที่เลือก
      if (filteredData.length === 0) {
        showStatus('error', 'ไม่มีข้อมูลนักเรียน' + (selectedClass ? ' ในห้อง ' + formatClassName(selectedClass) : '') + ' กรุณาโหลดข้อมูลก่อน');
        return;
      }
      var now = new Date();
      var thaiMonths = ['มกราคม', 'กุมภาพันธ์', 'มีนาคม', 'เมษายน', 'พฤษภาคม', 'มิถุนายน', 'กรกฎาคม', 'สิงหาคม', 'กันยายน', 'ตุลาคม', 'พฤศจิกายน', 'ธันวาคม'];
      var currentMonth = thaiMonths[now.getMonth()];
      var currentYear = now.getFullYear() + 543;
      // แสดงชื่อห้องเรียนที่เลือก
      var classDisplay = selectedClass ? formatClassName(selectedClass) : 'ทุกห้อง';
      var sortedStudents = filteredData.slice().sort(function (a, b) {
        if (a.class !== b.class) return a.class - b.class;
        return a.name.localeCompare(b.name, 'th');
      });
      var tableRows = '';
      for (var i = 0; i < sortedStudents.length; i++) {
        var s = sortedStudents[i];
        var scoreClass = s.score >= 100 ? 'score-high' : s.score >= 80 ? 'score-med' : 'score-low';
        tableRows += '<tr><td style="text-align:center;">' + (i + 1) + '</td>';
        tableRows += '<td style="text-align:center;">' + s.id + '</td>';
        tableRows += '<td>' + s.name + '</td>';
        tableRows += '<td style="text-align:center;">' + formatClassName(s.class) + '</td>';
        tableRows += '<td class="' + scoreClass + '" style="text-align:center;">' + s.score + '</td></tr>';
      }
      var html = '<!DOCTYPE html><html><head><meta charset="UTF-8">';
      html += '<title>รายงานคะแนนนักเรียน</title>';
      html += '<link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;600&display=swap" rel="stylesheet">';
      html += '<style>body{font-family:Sarabun,sans-serif;padding:15px;font-size:12px;}';
      html += '.header{text-align:center;margin-bottom:20px;}.header h1{font-size:18px;margin-bottom:5px;}';
      html += 'table{width:100%;border-collapse:collapse;}th{background:#6c63ff;color:white;padding:8px;text-align:center;}';
      html += 'td{padding:6px;border:1px solid #ddd;}tr:nth-child(even){background:#f9f9f9;}';
      html += '.score-high{color:#28a745;font-weight:bold;}.score-med{color:#ffc107;font-weight:bold;}.score-low{color:#dc3545;font-weight:bold;}';
      html += '@media print{@page{margin:1cm;}}</style></head><body>';
      html += '<div class="header"><h1>รายงานคะแนนพฤติกรรมนักเรียน</h1>';
      html += '<p>ห้องเรียน: ' + classDisplay + '</p>';
      html += '<p>ประจำเดือน ' + currentMonth + ' พ.ศ. ' + currentYear + '</p></div>';
      html += '<table><thead><tr><th>ลำดับ</th><th>รหัส</th><th>ชื่อ-นามสกุล</th><th>ห้อง</th><th>คะแนน</th></tr></thead>';
      html += '<tbody>' + tableRows + '</tbody></table>';
      html += '<script>setTimeout(function(){window.print();},500);<\/script></body></html>';
      var printWindow = window.open('', '_blank');
      printWindow.document.write(html);
      printWindow.document.close();
      showStatus('success', 'เปิดหน้าพิมพ์แล้ว - เลือก "บันทึกเป็น PDF"');
    }

    // ========== All History Viewer Functions ==========

    // Open All History Modal
    async function openAllHistoryModal() {
      const modal = document.getElementById('allHistoryModalOverlay');
      modal.classList.add('show');

      // Show loading state
      document.getElementById('allHistoryList').innerHTML = `
        <div class="history-empty">
          <i class="fas fa-spinner fa-spin"></i>
          <p>กำลังโหลดข้อมูล...</p>
        </div>
      `;

      // Reload score history data from log.json every time
      await loadScoreHistory();

      // Populate filters
      populateAllHistoryFilters();

      // Show all history initially
      filterAllHistory();
    }

    // Close All History Modal
    function closeAllHistoryModal() {
      const modal = document.getElementById('allHistoryModalOverlay');
      modal.classList.remove('show');
    }

    // Populate filter dropdowns
    function populateAllHistoryFilters() {
      // Populate class filter
      const classFilter = document.getElementById('allHistoryClassFilter');
      const classes = getUniqueClasses();

      classFilter.innerHTML = '<option value="">ทุกห้อง</option>';
      classes.forEach(classCode => {
        const option = document.createElement('option');
        option.value = classCode;
        option.textContent = formatClassName(classCode);
        classFilter.appendChild(option);
      });

      // Populate year filter from history data
      const yearFilter = document.getElementById('allHistoryYearFilter');
      const years = new Set();
      (window.scoreHistoryData || []).forEach(h => {
        if (h.timestamp) {
          const date = new Date(h.timestamp);
          const year = date.getFullYear() + 543; // Convert to พ.ศ.
          years.add(year);
        }
      });

      yearFilter.innerHTML = '<option value="">ทุกปี</option>';
      Array.from(years).sort((a, b) => b - a).forEach(year => {
        const option = document.createElement('option');
        option.value = year;
        option.textContent = year;
        yearFilter.appendChild(option);
      });
    }

    // Apply all filters and render history
    function filterAllHistory() {
      const classFilter = document.getElementById('allHistoryClassFilter').value;
      const monthFilter = document.getElementById('allHistoryMonthFilter').value;
      const yearFilter = document.getElementById('allHistoryYearFilter').value;
      const searchQuery = document.getElementById('allHistorySearchInput').value.toLowerCase().trim();

      let filtered = [...(window.scoreHistoryData || [])];

      // Filter by class
      if (classFilter) {
        filtered = filtered.filter(h => {
          const student = studentsData.find(s => s.id === h.student_id);
          return student && String(student.class) === classFilter;
        });
      }

      // Filter by month
      if (monthFilter) {
        filtered = filtered.filter(h => {
          if (!h.timestamp) return false;
          const date = new Date(h.timestamp);
          return (date.getMonth() + 1) === parseInt(monthFilter);
        });
      }

      // Filter by year (พ.ศ.)
      if (yearFilter) {
        filtered = filtered.filter(h => {
          if (!h.timestamp) return false;
          const date = new Date(h.timestamp);
          const yearBE = date.getFullYear() + 543;
          return yearBE === parseInt(yearFilter);
        });
      }

      // Filter by search (respects class filter - only searches within selected class)
      if (searchQuery) {
        filtered = filtered.filter(h => {
          const student = studentsData.find(s => s.id === h.student_id);
          if (!student) return false;

          const nameMatch = student.name.toLowerCase().includes(searchQuery);
          const idMatch = student.id.toLowerCase().includes(searchQuery);
          return nameMatch || idMatch;
        });
      }

      // Sort by timestamp (newest first)
      filtered.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

      // Render results
      renderAllHistory(filtered);
    }

    // Render all history items
    function renderAllHistory(historyItems) {
      const listContainer = document.getElementById('allHistoryList');
      const statsContainer = document.getElementById('allHistoryStats');

      // Calculate stats
      const totalRecords = historyItems.length;
      const positiveCount = historyItems.filter(h => {
        const change = h.change || h.score_change || h.scoreChange || h.score || h.point || h.points || 0;
        return change > 0;
      }).length;
      const negativeCount = historyItems.filter(h => {
        const change = h.change || h.score_change || h.scoreChange || h.score || h.point || h.points || 0;
        return change < 0;
      }).length;

      // Render stats
      statsContainer.innerHTML = `
        <div class="all-history-stat">
          <i class="fas fa-list"></i> ทั้งหมด: ${totalRecords} รายการ
        </div>
        <div class="all-history-stat" style="background: linear-gradient(135deg, #10b981, #059669);">
          <i class="fas fa-plus-circle"></i> เพิ่มคะแนน: ${positiveCount}
        </div>
        <div class="all-history-stat" style="background: linear-gradient(135deg, #ef4444, #dc2626);">
          <i class="fas fa-minus-circle"></i> ลดคะแนน: ${negativeCount}
        </div>
      `;

      // Render list
      if (historyItems.length === 0) {
        listContainer.innerHTML = `
          <div class="history-empty">
            <i class="fas fa-search"></i>
            <p>ไม่พบประวัติที่ตรงกับเงื่อนไข</p>
          </div>
        `;
        return;
      }

      // Limit to first 100 items for performance
      const displayItems = historyItems.slice(0, 100);

      listContainer.innerHTML = displayItems.map(h => {
        const student = studentsData.find(s => s.id === h.student_id);
        const studentName = student ? student.name : 'ไม่พบข้อมูลนักเรียน';
        const studentClass = student ? formatClassName(student.class) : '-';

        const scoreChange = h.change || h.score_change || h.scoreChange || h.score || h.point || h.points || 0;
        const isPositive = scoreChange > 0;
        const scoreText = isPositive ? '+' + scoreChange : scoreChange.toString();
        const timestamp = formatHistoryTimestamp(h.timestamp);
        const teacher = h.teacher || h.admin || 'ไม่ระบุ';

        return `
          <div class="all-history-item ${isPositive ? 'positive' : 'negative'}">
            <div class="all-history-student">
              <span class="all-history-student-name">${studentName}</span>
              <span class="all-history-student-class">${studentClass}</span>
            </div>
            <div class="all-history-details">
              <div class="all-history-reason">${h.reason || 'ไม่ระบุสาเหตุ'}</div>
              <div class="all-history-meta">
                <span><i class="fas fa-clock"></i> ${timestamp}</span>
                <span><i class="fas fa-user"></i> ${teacher}</span>
              </div>
            </div>
            <div class="all-history-score ${isPositive ? 'positive' : 'negative'}">
              ${scoreText}
            </div>
          </div>
        `;
      }).join('');

      // Add info about limited results
      if (historyItems.length > 100) {
        listContainer.innerHTML += `
          <div style="text-align: center; padding: 20px; color: #64748b; font-size: 0.9rem;">
            <i class="fas fa-info-circle"></i> แสดง 100 รายการแรก จากทั้งหมด ${historyItems.length} รายการ
          </div>
        `;
      }
    }
  </script>

  </div>
  </div>
  </div>


  <!-- ==================== NEW FEATURES MODALS ==================== -->

  <!-- Manual Input Modal -->
  <div class="manual-input-modal" id="manualInputModal">
    <div class="manual-input-content">
      <h3>กรอกรหัสนักเรียน</h3>
      <p>พิมพ์รหัสนักเรียนที่ต้องการเพิ่ม/ลดคะแนน</p>
      <input type="text" id="manualStudentId" placeholder="12345" maxlength="10"
        style="width: 100%; padding: 12px; margin: 15px 0; border: 2px solid #e2e8f0; border-radius: 10px; font-size: 1.2em; text-align: center;"
        onkeypress="if(event.key === 'Enter') submitManualInput()">
      <div style="display: flex; gap: 10px; justify-content: center;">
        <button onclick="closeManualInput()" class="btn btn-warning">ยกเลิก</button>
        <button onclick="submitManualInput()" class="btn btn-primary">ยืนยัน</button>
      </div>
    </div>
  </div>

  <!-- QR Scanner Modal -->
  <div class="qr-scanner-overlay" id="qrScannerModal">
    <div
      style="position: relative; width: 100%; height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center;">
      <button onclick="closeQRScanner()"
        style="position: absolute; top: 20px; right: 20px; background: white; border: none; width: 40px; height: 40px; border-radius: 50%; font-size: 1.5rem; z-index: 2100;">&times;</button>
      <div id="qr-reader" style="width: 100%; max-width: 500px;"></div>
      <p style="color: white; margin-top: 20px;">วาง QR Code ให้อยู่ในกรอบ</p>
    </div>
  </div>

  <!-- Student Search Modal -->
  <div class="student-search-overlay" id="studentSearchOverlay">
    <div class="student-search-modal">
      <div class="student-search-header">
        <h3><i class="fas fa-search"></i> ค้นหานักเรียน</h3>
        <button onclick="closeStudentSearchModal()"
          style="background:none; border:none; font-size:1.5rem; cursor:pointer;">&times;</button>
      </div>
      <div style="padding: 15px; display: flex; gap: 10px;">
        <input type="text" id="studentSearchInput" placeholder="พิมพ์ชื่อหรือรหัส..."
          style="flex:1; padding: 10px; border-radius: 8px; border: 1px solid #ccc;" oninput="filterStudentSearch()">
        <select id="studentSearchClassFilter" onchange="filterStudentSearch()"
          style="padding: 10px; border-radius: 8px; border: 1px solid #ccc;">
          <option value="">ทุกห้อง</option>
        </select>
      </div>
      <div class="student-search-results" id="studentSearchResults">
        <!-- Results -->
      </div>
    </div>
  </div>


  <script>
    // ==================== NEW FEATURES LOGIC ====================

    // 1. Manual Input
    function openManualInput() {
      const modal = document.getElementById('manualInputModal');
      const input = document.getElementById('manualStudentId');
      console.log('Opening manual input. allStudents available:', !!window.allStudents, 'Count:', window.allStudents?.length);
      modal.classList.add('show');
      input.value = '';
      setTimeout(() => input.focus(), 100);
    }

    function closeManualInput() {
      document.getElementById('manualInputModal').classList.remove('show');
    }

    function submitManualInput() {
      const input = document.getElementById('manualStudentId');
      const studentId = input.value.trim();
      console.log('Searching for student ID:', studentId);
      console.log('Available students:', window.allStudents?.length);

      if (studentId) {
        closeManualInput();
        processScannedQR(studentId);
      } else {
        showToast('error', 'กรุณากรอกรหัสนักเรียน');
        input.focus();
      }
    }

    // 2. Student Search
    function openStudentSearchModal() {
      const modal = document.getElementById('studentSearchOverlay');
      modal.classList.add('show');
      document.getElementById('studentSearchInput').value = '';
      populateSearchClassFilter();
      filterStudentSearch();
    }

    function closeStudentSearchModal() {
      document.getElementById('studentSearchOverlay').classList.remove('show');
    }

    function populateSearchClassFilter() {
      const filter = document.getElementById('studentSearchClassFilter');
      const classes = [...new Set(window.studentsData ? window.studentsData.map(s => s.class) : [])].sort((a, b) => a - b);
      filter.innerHTML = '<option value="">ทุกห้อง</option>' + classes.map(c => `<option value="${c}">ห้อง ${c}</option>`).join('');
    }

    function filterStudentSearch() {
      const query = document.getElementById('studentSearchInput').value.toLowerCase();
      const cls = document.getElementById('studentSearchClassFilter').value;
      const results = (window.studentsData || []).filter(s =>
        (cls === '' || String(s.class) === cls) &&
        (s.name.toLowerCase().includes(query) || s.id.includes(query))
      ).slice(0, 50);

      document.getElementById('studentSearchResults').innerHTML = results.length ? results.map(s => `
            <div class="student-search-item" onclick="selectStudent('${s.id}')">
                <div class="student-search-item-info">
                    <div class="student-search-item-name">${s.name}</div>
                    <div class="student-search-item-meta">รหัส: ${s.id} | ห้อง: ${s.class}</div>
                </div>
                <button class="btn btn-sm btn-success">เลือก</button>
            </div>
        `).join('') : '<div style="text-align:center; padding:20px; color:#666;">ไม่พบข้อมูล</div>';
    }

    function selectStudent(id) {
      closeStudentSearchModal();
      processScannedQR(id);
    }

    // 3. QR Processing & Action Form
    async function processScannedQR(decodedText) {
      // Robust Data Check: Try all possible sources
      let sourceData = window.allStudents;

      if (!sourceData || !Array.isArray(sourceData) || sourceData.length === 0) {
        // Fallback 1: Global studentsData
        if (Array.isArray(studentsData) && studentsData.length > 0) {
          sourceData = studentsData;
          window.allStudents = studentsData; // Sync back
        }
        // Fallback 2: Cached data
        else if (Array.isArray(cachedStudentsData) && cachedStudentsData.length > 0) {
          sourceData = cachedStudentsData;
          window.allStudents = cachedStudentsData; // Sync back
        }
      }

      // Final Attempt: Lazy load if absolutely nothing exists
      if (!sourceData || !Array.isArray(sourceData) || sourceData.length === 0) {
        console.warn('QR Scanner: Data unavailable, attempting emergency load...');
        try {
          await loadData();
          sourceData = window.allStudents || studentsData; // Re-check after load
        } catch (e) { console.error('Emergency load failed', e); }
      }

      // If STILL no data, then show error
      if (!sourceData || !Array.isArray(sourceData) || sourceData.length === 0) {
        console.error('CRITICAL: Student data missing in QR Scanner. sources:', {
          allStudents: window.allStudents?.length,
          studentsData: studentsData?.length,
          cached: cachedStudentsData?.length
        });
        showToast('error', 'ระบบกำลังโหลดข้อมูลนักเรียน กรุณาลองใหม่อีกครั้งใน 5 วินาที');
        return;
      }

      // Ensure decodedText is string for comparison
      const searchId = String(decodedText).trim();

      // Find student by ID from ALL students
      const student = window.allStudents.find(s => String(s.id).trim() === searchId);

      if (student) {
        openActionFormForStudent(student.id, student.name);
      } else {
        showToast('error', 'ไม่พบรหัสนักเรียน: ' + searchId);
      }
    }

    // 4. QR Scanner
    let scanner = null;
    function openQRScanner() {
      document.getElementById('qrScannerModal').classList.add('show');
      const width = window.innerWidth > 500 ? 500 : 250;
      scanner = new Html5Qrcode("qr-reader");
      scanner.start({ facingMode: "environment" }, { fps: 10, qrbox: width },
        (decodedText) => {
          scanner.stop().then(() => {
            closeQRScanner();
            processScannedQR(decodedText);
          });
        }
      ).catch(err => {
        console.error(err);
        // alert('ไม่สามารถเปิดกล้องได้');
      });
    }

    function closeQRScanner() {
      document.getElementById('qrScannerModal').classList.remove('show');
      if (scanner) {
        try { scanner.stop(); } catch (e) { }
        scanner = null;
      }
    }

    function processQRImage(input) {
      if (input.files && input.files[0]) {
        const reader = new FileReader();
        reader.onload = function (e) {
          const img = new Image();
          img.onload = function () {
            const canvas = document.createElement("canvas");
            const context = canvas.getContext("2d");
            canvas.width = img.width;
            canvas.height = img.height;
            context.drawImage(img, 0, 0, img.width, img.height);
            const imageData = context.getImageData(0, 0, canvas.width, canvas.height);
            const code = jsQR(imageData.data, imageData.width, imageData.height);
            if (code) {
              processScannedQR(code.data);
            } else {
              alert("ไม่พบ QR Code ในรูปภาพ");
            }
            input.value = ''; // Reset
          };
          img.src = e.target.result;
        };
        reader.readAsDataURL(input.files[0]);
      }
    }

    // ==================== STUDENT MANAGEMENT & PROFILE LOGIC (Ported from th.html) ====================
    let currentManageId = null;
    let currentManageName = null;
    let croppedImageBase64 = null;

    // Helper functions for status
    function getStatusPointText(statuspoint) {
      const statusMap = {
        'urgent': 'ไม่ผ่านเกณฑ์ ปรับแก้พฤติกรรมด่วน',
        'risk': 'เริ่มมีความเสี่ยงไม่ผ่านเกณฑ์',
        'normal': 'ปกติ (ผ่านเกณฑ์)',
        'excellent': 'เด็กดีศรีเทพพธา'
      };
      return statusMap[statuspoint] || 'ปกติ (ผ่านเกณฑ์)';
    }

    function getStatusPointIcon(statuspoint) {
      const iconMap = {
        'urgent': '🚨',
        'risk': '⚠️',
        'normal': '✅',
        'excellent': '⭐'
      };
      return iconMap[statuspoint] || '✅';
    }

    function getAcademicStatusText(status) {
      const statusMap = {
        'normal': 'กำลังศึกษาอยู่',
        'Absent': 'ขาดเรียนนาน',
        'moved': 'ย้ายแล้ว',
        'notnormal': 'พักการเรียน'
      };
      return statusMap[status] || 'กำลังศึกษาอยู่';
    }

    function openManageStudentModal(id, name) {
      currentManageId = id;
      currentManageName = name;

      // Reset to main view
      switchManageStudentView('main');

      document.getElementById('manageStudentName').textContent = name;
      document.getElementById('manageStudentId').textContent = `รหัส: ${id}`;

      // Find student details
      const student = window.allStudents ? window.allStudents.find(s => String(s.id) === String(id)) : null;

      if (student) {
        document.getElementById('manageStudentAcademic').textContent = getAcademicStatusText(student.status);
        const statusIcon = getStatusPointIcon(student.statuspoint || 'normal');
        const statusText = getStatusPointText(student.statuspoint || 'normal');
        document.getElementById('manageStudentStatus').textContent = `${statusIcon} ${statusText}`;
        document.getElementById('manageStudentScore').textContent = `${student.score} คะแนน`;
      } else {
        document.getElementById('manageStudentAcademic').textContent = '-';
        document.getElementById('manageStudentStatus').textContent = '-';
        document.getElementById('manageStudentScore').textContent = '-';
      }

      // Set Avatar
      const avatarDiv = document.getElementById('manageStudentAvatar');
      const timestamp = new Date().getTime();
      avatarDiv.innerHTML = `<img src="./edstudent/${id}.jpg?v=${timestamp}" onerror="this.onerror=null; this.innerHTML='<i class=\'fas fa-user-graduate\'></i>'">`;

      document.getElementById('manageStudentModal').classList.add('show');
    }

    function closeManageStudentModal() {
      document.getElementById('manageStudentModal').classList.remove('show');
    }

    function openProfileViewerFromAvatar() {
      if (typeof openProfileViewer === 'function') {
        openProfileViewer(currentManageId, currentManageName);
      }
    }

    function openHistoryFromManage() {
      if (typeof viewStudentHistory === 'function') {
        viewStudentHistory(currentManageId, currentManageName);
      } else {
        Swal.fire({ icon: 'info', title: 'แจ้งเตือน', text: 'ฟังก์ชันประวัติคะแนนยังไม่พร้อมใช้งาน' });
      }
    }

    // ========== Profile Viewer Functions ==========
    function openProfileViewer(studentId, studentName) {
      const modal = document.getElementById('profileViewerModal');
      const container = document.getElementById('profileViewerImageContainer');
      const timestamp = new Date().getTime();
      const imagePath = `./edstudent/${studentId}.jpg?v=${timestamp}`;

      document.getElementById('profileViewerName').textContent = studentName;
      document.getElementById('profileViewerId').textContent = `รหัส: ${studentId}`;

      // Show loading first
      container.innerHTML = `<div class="no-profile-image"><i class="fas fa-spinner fa-spin"></i></div>`;
      modal.classList.add('show');

      // Try to load image
      const img = new Image();
      img.onload = function () {
        container.innerHTML = `<img class="profile-viewer-image" src="${imagePath}">`;
      };
      img.onerror = function () {
        container.innerHTML = `<div class="no-profile-image"><i class="fas fa-user-graduate"></i></div>`;
      };
      img.src = imagePath;
    }

    function closeProfileViewer(event) {
      if (event) event.stopPropagation();
      document.getElementById('profileViewerModal').classList.remove('show');
    }

    function setupAvatarClickHandler(avatarElement, studentId, studentName) {
      if (avatarElement) {
        avatarElement.style.cursor = 'pointer';
        avatarElement.onclick = function () { openProfileViewer(studentId, studentName); };
      }
    }

    // ========== Profile Upload Functions ==========
    function openUploadProfileModal() {
      document.getElementById('uploadProfileModal').classList.add('show');
      document.getElementById('profileImageInput').value = '';
      croppedImageBase64 = null;

      const previewImg = document.getElementById('profilePreview');
      const placeholder = document.getElementById('profilePlaceholder');
      const timestamp = new Date().getTime();

      previewImg.src = `./edstudent/${currentManageId}.jpg?v=${timestamp}`;
      previewImg.onload = function () {
        previewImg.style.display = 'block';
        placeholder.style.display = 'none';
      };
      previewImg.onerror = function () {
        previewImg.style.display = 'none';
        placeholder.style.display = 'block';
        previewImg.src = '';
      };
    }

    function closeUploadProfileModal() {
      document.getElementById('uploadProfileModal').classList.remove('show');
    }

    function previewProfileImage(input) {
      if (input.files && input.files[0]) {
        const reader = new FileReader();
        reader.onload = function (e) {
          const img = new Image();
          img.onload = function () {
            const canvas = document.createElement('canvas');
            const maxSize = 500;
            let width = img.width;
            let height = img.height;
            let sx, sy, sWidth, sHeight;

            if (width > height) {
              sWidth = height; sHeight = height;
              sx = (width - height) / 2; sy = 0;
            } else {
              sWidth = width; sHeight = width;
              sx = 0; sy = (height - width) / 2;
            }

            canvas.width = maxSize;
            canvas.height = maxSize;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(img, sx, sy, sWidth, sHeight, 0, 0, maxSize, maxSize);

            const base64Data = canvas.toDataURL('image/jpeg', 0.9);
            const previewImg = document.getElementById('profilePreview');
            previewImg.src = base64Data;
            previewImg.style.display = 'block';
            document.getElementById('profilePlaceholder').style.display = 'none';
            croppedImageBase64 = base64Data;
          };
          img.src = e.target.result;
        };
        reader.readAsDataURL(input.files[0]);
      }
    }

    async function saveProfileImage() {
      if (!croppedImageBase64) {
        showToast('error', 'กรุณาเลือกรูปภาพ');
        return;
      }
      sendProfileImage(croppedImageBase64);
    }

    async function sendProfileImage(base64Data) {
      if (typeof showLoading === 'function') showLoading(true);
      try {
        const response = await fetch('/api/upload-student-profile', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            student_id: currentManageId,
            image_data: base64Data
          })
        });

        const result = await response.json();
        if (result.status === 'success') {
          showToast('success', 'อัปโหลดรูปโปรไฟล์เรียบร้อย');
          closeUploadProfileModal();
          // Update avatars on page
          const avatars = document.querySelectorAll(`img[src*="${currentManageId}.jpg"]`);
          const timestamp = new Date().getTime();
          avatars.forEach(img => {
            const baseSrc = img.src.split('?')[0];
            img.src = `${baseSrc}?v=${timestamp}`;
          });
          // Also update the manage modal avatar
          openManageStudentModal(currentManageId, currentManageName);
        } else {
          showToast('error', 'อัปโหลดไม่สำเร็จ: ' + result.message);
        }
      } catch (e) {
        console.error(e);
        showToast('error', 'เกิดข้อผิดพลาดในการเชื่อมต่อเซิร์ฟเวอร์');
      } finally {
        if (typeof showLoading === 'function') showLoading(false);
      }
    }



    function openAdjustScoreModal(notificationIndex) {
      const notification = notificationsData[notificationIndex];
      if (!notification) return;

      pendingAdjustment = {
        notificationIndex: notificationIndex,
        studentId: notification.student_id,
        studentName: notification.student_name,
        notification: notification
      };

      // Set UI
      document.getElementById('adjustModalTitle').textContent = 'ปรับคะแนนพฤติกรรม';
      document.getElementById('adjustModalSubtitle').textContent = `ให้คะแนน / หักคะแนน ${notification.student_name}`;

      const iconWrapper = document.getElementById('adjustModalIcon');
      const icon = iconWrapper.querySelector('i');

      // Default Icon (Neutral)
      iconWrapper.className = 'adjust-modal-icon-wrapper plus';
      icon.className = 'fas fa-pen';

      // Reset Inputs
      const scoreInput = document.getElementById('adjustScoreInput');
      if (scoreInput) {
        scoreInput.value = '';
        // Removed dynamic hiding to match new design requirement (all fields visible)
        scoreInput.oninput = null;
      }

      const reasonInput = document.getElementById('adjustReason');
      if (reasonInput) {
        reasonInput.value = notification.reason || '';
      }

      const workDetailInput = document.getElementById('adjustWorkDetail');
      if (workDetailInput) workDetailInput.value = '';

      // Reset Images
      const beforeInput = document.getElementById('adjustBeforeInput');
      if (beforeInput) beforeInput.value = '';

      const afterInput = document.getElementById('adjustAfterInput');
      if (afterInput) afterInput.value = '';

      const beforePreview = document.getElementById('adjustBeforePreview');
      if (beforePreview) {
        beforePreview.src = '';
        beforePreview.classList.remove('show');
      }
      const beforePlaceholder = document.getElementById('adjustBeforePlaceholder');
      if (beforePlaceholder) beforePlaceholder.classList.remove('hidden');

      const afterPreview = document.getElementById('adjustAfterPreview');
      if (afterPreview) {
        afterPreview.src = '';
        afterPreview.classList.remove('show');
      }
      const afterPlaceholder = document.getElementById('adjustAfterPlaceholder');
      if (afterPlaceholder) afterPlaceholder.classList.remove('hidden');

      // Default state: Show all
      const workDetailContainer = document.getElementById('adjustWorkDetailContainer');
      const imageContainer = document.getElementById('adjustImageContainer');
      // No longer need to force block since we removed them from HTML
      if (workDetailContainer) workDetailContainer.style.display = 'block';
      if (imageContainer) imageContainer.style.display = 'block';

      document.getElementById('adjustScoreModal').classList.add('show');
    }

    function closeAdjustScoreModal() {
      document.getElementById('adjustScoreModal').classList.remove('show');
      pendingAdjustment = null;
    }

    function previewAdjustImage(input, previewId, placeholderId) {
      if (input.files && input.files[0]) {
        const reader = new FileReader();
        reader.onload = function (e) {
          const img = document.getElementById(previewId);
          img.src = e.target.result;
          img.classList.add('show');
          document.getElementById(placeholderId).classList.add('hidden');
        }
        reader.readAsDataURL(input.files[0]);
      }
    }

    async function submitAdjustScore() {
      if (!pendingAdjustment) return;

      const reasonInput = document.getElementById('adjustReason');
      // If no reason input, use default text
      const reason = reasonInput ? reasonInput.value.trim() : 'ปรับคะแนนโดยครู';

      const workDetailInput = document.getElementById('adjustWorkDetail');
      const workDetail = workDetailInput ? workDetailInput.value.trim() : '';

      const beforeInput = document.getElementById('adjustBeforeInput');
      const beforeFile = beforeInput && beforeInput.files ? beforeInput.files[0] : null;

      const afterInput = document.getElementById('adjustAfterInput');
      const afterFile = afterInput && afterInput.files ? afterInput.files[0] : null;

      if (reasonInput && !reason) {
        Swal.fire({ icon: 'warning', title: 'แจ้งเตือน', text: 'กรุณาระบุเหตุผล' });
        return;
      }

      try {
        if (typeof showLoading === 'function') showLoading(true);

        // 1. Process Images
        const beforeBase64 = beforeFile ? await processImage(beforeFile) : null;
        const afterBase64 = afterFile ? await processImage(afterFile) : null;

        // 2. Prepare Data
        const currentUser = JSON.parse(sessionStorage.getItem('currentUser') || '{}');

        // Read score from input for manual adjustment
        let scoreChange = 0;
        const scoreInput = document.getElementById('adjustScoreInput');
        if (scoreInput && scoreInput.value !== '') {
          scoreChange = parseInt(scoreInput.value);
        } else if (pendingAdjustment.scoreChange !== undefined) {
          scoreChange = pendingAdjustment.scoreChange;
        }

        if (isNaN(scoreChange) || scoreChange === 0) {
          Swal.fire({ icon: 'warning', title: 'แจ้งเตือน', text: 'กรุณาระบุคะแนนที่ต้องการปรับ (ตัวเลขที่ไม่ใช่ 0)' });
          if (typeof showLoading === 'function') showLoading(false);
          return;
        }

        const studentId = pendingAdjustment.studentId;
        const student = window.allStudents ? window.allStudents.find(s => String(s.id) === String(studentId)) : studentsData.find(s => String(s.id) === String(studentId));

        if (!student) throw new Error('ไม่พบข้อมูลนักเรียน');

        const newScore = Math.max(0, student.score + scoreChange);
        const finalReason = `[${scoreChange > 0 ? '+' : ''}${scoreChange}] ${reason}${workDetail ? ' - ' + workDetail : ''}`;

        // 3. Update Score (Real-time to user2.1.json via API)
        const scoreRes = await fetch('/api/save-score', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            id: student.id,
            score: newScore,
            reason: finalReason
          })
        });

        if (!scoreRes.ok) throw new Error('ไม่สามารถบันทึกคะแนนได้');

        // 4. Save Work/Record (with images)
        if (scoreChange !== 0 || beforeBase64 || afterBase64) {
          await fetch('/api/save-work', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              student_id: student.id,
              student_name: student.name,
              detail: finalReason,
              image_before: beforeBase64,
              image_after: afterBase64,
              teacher: currentUser.name || 'Admin',
              timestamp: new Date().toISOString(),
              status: 'completed', // Prevent new pending task
              admin_name: currentUser.name || 'Admin',
              admin_reason: finalReason
            })
          });
        }

        // 5. Update toadmin.json Status
        // Find the actual index in toadmin.json
        const allToAdminRes = await fetch('/toadmin.json');
        const allData = await allToAdminRes.json();
        const actualIndex = allData.findIndex(item =>
          item.student_id === pendingAdjustment.notification.student_id &&
          item.timestamp === pendingAdjustment.notification.timestamp
        );

        if (actualIndex !== -1) {
          await fetch('/api/update-toadmin-status', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              index: actualIndex,
              admin_name: currentUser.name || 'Admin',
              reason: finalReason // Store the specific reason in toadmin.json as requested
            })
          });
        }

        // 6. UI Update (Real-time)
        student.score = newScore;

        // Update local notification status for transient display
        if (notificationsData[pendingAdjustment.notificationIndex]) {
          notificationsData[pendingAdjustment.notificationIndex].status = 'completed';
          notificationsData[pendingAdjustment.notificationIndex].reason = finalReason;

          // Re-render to show success state
          renderNotifications();

          // Remove after 10 seconds
          setTimeout(() => {
            loadNotifications();
          }, 10000);
        } else {
          notificationsData.splice(pendingAdjustment.notificationIndex, 1);
          renderNotifications();
        }

        showToast('success', 'บันทึกข้อมูลเรียบร้อยแล้ว');
        closeAdjustScoreModal();

        if (typeof filterData === 'function') filterData();
        else if (typeof displayTable === 'function') displayTable();

      } catch (error) {
        console.error(error);
        Swal.fire({ icon: 'error', title: 'เกิดข้อผิดพลาด', text: error.message });
      } finally {
        if (typeof showLoading === 'function') showLoading(false);
      }
    }
  </script>

  <!-- All History Viewer Modal -->
  <div class="all-history-modal-overlay" id="allHistoryModalOverlay">
    <div class="all-history-modal">
      <div class="all-history-header">
        <h2><i class="fas fa-history"></i> ประวัติคะแนนทั้งหมด</h2>
        <button class="history-close-btn" onclick="closeAllHistoryModal()">×</button>
      </div>

      <div class="all-history-filters">
        <div class="filter-item">
          <label><i class="fas fa-school"></i> ห้องเรียน</label>
          <select id="allHistoryClassFilter" onchange="filterAllHistory()">
            <option value="">ทุกห้อง</option>
          </select>
        </div>
        <div class="filter-item">
          <label><i class="fas fa-calendar"></i> เดือน</label>
          <select id="allHistoryMonthFilter" onchange="filterAllHistory()">
            <option value="">ทุกเดือน</option>
            <option value="1">มกราคม</option>
            <option value="2">กุมภาพันธ์</option>
            <option value="3">มีนาคม</option>
            <option value="4">เมษายน</option>
            <option value="5">พฤษภาคม</option>
            <option value="6">มิถุนายน</option>
            <option value="7">กรกฎาคม</option>
            <option value="8">สิงหาคม</option>
            <option value="9">กันยายน</option>
            <option value="10">ตุลาคม</option>
            <option value="11">พฤศจิกายน</option>
            <option value="12">ธันวาคม</option>
          </select>
        </div>
        <div class="filter-item">
          <label><i class="fas fa-calendar-alt"></i> ปี (พ.ศ.)</label>
          <select id="allHistoryYearFilter" onchange="filterAllHistory()">
            <option value="">ทุกปี</option>
          </select>
        </div>
        <div class="filter-item">
          <label><i class="fas fa-search"></i> ค้นหานักเรียน</label>
          <input type="text" id="allHistorySearchInput" placeholder="พิมพ์ชื่อหรือรหัส..." oninput="filterAllHistory()">
        </div>
      </div>

      <div class="all-history-stats" id="allHistoryStats">
        <!-- Stats will be rendered here -->
      </div>

      <div class="all-history-list-container">
        <div class="all-history-list" id="allHistoryList">
          <!-- History items will be rendered here -->
        </div>
      </div>
    </div>
  </div>

  <!-- Copyright Footer -->
  <div
    style="background: white; color: #718096; text-align: center; padding: 20px; font-size: 0.9rem; margin-top: 30px; border-top: 2px solid #f0f0f0; border-radius: 0 0 15px 15px;">
    © 2026 นางสาวสโรชา เมืองมุสิก & ด.ช.เทิดศักดิ์ สุวรรณมาลี
  </div>

  <!-- Image Viewer Modal -->
  <div id="imageViewerModal" class="modal" onclick="closeImageViewer()">
    <span class="close-btn"
      style="position: absolute; top: 20px; right: 30px; color: white; font-size: 3em;">&times;</span>
    <img class="modal-content" id="fullImage"
      style="max-width: 90%; max-height: 90vh; object-fit: contain; background: transparent; padding: 0;">
  </div>


  <script>
    let pendingNotificationDiff = null;

    // Toast Notification Helper
    function showToast(icon, title) {
      const Toast = Swal.mixin({
        toast: true,
        position: 'top-end',
        showConfirmButton: false,
        timer: 3000,
        timerProgressBar: true,
        didOpen: (toast) => {
          toast.addEventListener('mouseenter', Swal.stopTimer)
          toast.addEventListener('mouseleave', Swal.resumeTimer)
        }
      })

      Toast.fire({
        icon: icon,
        title: title
      })
    }

    function viewImage(src) {
      const modal = document.getElementById('imageViewerModal');
      const img = document.getElementById('fullImage');
      img.src = src;
      modal.classList.add('show');
    }

    function closeImageViewer() {
      document.getElementById('imageViewerModal').classList.remove('show');
    }

    function closeManualScoreModal() {
      document.getElementById('manualScoreModal').classList.remove('show');
      pendingNotificationDiff = null;
    }

    async function confirmManualScore() {
      const input = document.getElementById('manualScoreInput');
      const scoreChange = parseInt(input.value);

      if (isNaN(scoreChange)) {
        Swal.fire({ icon: 'warning', title: 'ข้อมูลไม่ถูกต้อง', text: 'กรุณากรอกตัวเลข' });
        return;
      }

      if (!pendingNotificationDiff) return;

      const { notification, actualIndex, adminName, index } = pendingNotificationDiff;

      try {
        // Apply Score Change
        const student = studentsData.find(s => s.id === notification.student_id);
        if (student) {
          const newScore = Math.max(0, student.score + scoreChange);

          // Call API
          const scoreResponse = await fetch('/api/save-score', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              id: student.id,
              score: newScore,
              reason: `ปรับคะแนนแบบฟอร์ม: ${notification.reason || 'Manual'}`
            })
          });

          if (scoreResponse.ok) {
            student.score = newScore;
          }
        }

        // Finalize
        closeManualScoreModal();
        await finalizeCompletion(index, actualIndex, adminName);

      } catch (e) {
        console.error(e);
        showToast('error', 'เกิดข้อผิดพลาด');
      }
    }
  </script>
  <!-- ==================== NEW FEATURES MODALS ==================== -->

  <!-- Manual Input Modal -->
  <div class="manual-input-modal" id="manualInputModal">
    <div class="manual-input-content">
      <h3>กรอกรหัสนักเรียน</h3>
      <p>พิมพ์รหัสนักเรียนที่ต้องการเพิ่ม/ลดคะแนน</p>
      <input type="text" id="manualStudentId" placeholder="12345" maxlength="10"
        style="width: 100%; padding: 12px; margin: 15px 0; border: 2px solid #e2e8f0; border-radius: 10px; font-size: 1.2em; text-align: center;"
        onkeypress="if(event.key === 'Enter') submitManualInput()">
      <div style="display: flex; gap: 10px; justify-content: center;">
        <button onclick="closeManualInput()" class="btn btn-warning">ยกเลิก</button>
        <button onclick="submitManualInput()" class="btn btn-primary">ยืนยัน</button>
      </div>
    </div>
  </div>

  <!-- QR Scanner Modal -->
  <div class="qr-scanner-overlay" id="qrScannerModal">
    <div
      style="position: relative; width: 100%; height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center;">
      <button onclick="closeQRScanner()"
        style="position: absolute; top: 20px; right: 20px; background: white; border: none; width: 40px; height: 40px; border-radius: 50%; font-size: 1.5rem; z-index: 2100;">&times;</button>
      <div id="qr-reader" style="width: 100%; max-width: 500px;"></div>
      <p style="color: white; margin-top: 20px;">วาง QR Code ให้อยู่ในกรอบ</p>
    </div>
  </div>

  <!-- Student Search Modal -->
  <div class="student-search-overlay" id="studentSearchOverlay">
    <div class="student-search-modal">
      <div class="student-search-header">
        <h3><i class="fas fa-search"></i> ค้นหานักเรียน</h3>
        <button onclick="closeStudentSearchModal()"
          style="background:none; border:none; font-size:1.5rem; cursor:pointer;">&times;</button>
      </div>
      <div style="padding: 15px; display: flex; gap: 10px;">
        <input type="text" id="studentSearchInput" placeholder="พิมพ์ชื่อหรือรหัส..."
          style="flex:1; padding: 10px; border-radius: 8px; border: 1px solid #ccc;" oninput="filterStudentSearch()">
        <select id="studentSearchClassFilter" onchange="filterStudentSearch()"
          style="padding: 10px; border-radius: 8px; border: 1px solid #ccc;">
          <option value="">ทุกห้อง</option>
        </select>
      </div>
      <div class="student-search-results" id="studentSearchResults">
        <!-- Results -->
      </div>
    </div>
  </div>

  <!-- Action Form Modal (Previously qrForm) -->
  <div class="modal" id="actionFormModal">
    <div class="modal-content" style="max-width: 600px;">
      <div class="modal-header">
        <h3><i class="fas fa-user-edit"></i> บันทึกคะแนนพฤติกรรม</h3>
        <button class="close-btn" onclick="closeActionForm()">&times;</button>
      </div>

      <div
        style="background: #f0f9ff; padding: 15px; border-radius: 10px; margin-bottom: 20px; border-left: 4px solid #3b82f6;">
        <div style="font-weight: bold; font-size: 1.1em;" id="actionStudentName"></div>
        <div style="color: #64748b;" id="actionStudentId"></div>
      </div>

      <div class="modal-tabs">
        <button class="modal-tab active" onclick="switchModalTab('deduct')" id="tab-deduct">ตัดคะแนน</button>
        <button class="modal-tab" onclick="switchModalTab('add')" id="tab-add">แก้ไข/เพิ่มคะแนน</button>
      </div>

      <!-- Section: Deduct -->
      <div id="section-deduct" class="section-content show">
        <div class="form-group">
          <label>เลือกสาเหตุ (หักคะแนน):</label>
          <div class="deduction-reasons-grid" id="deductionReasonsContainer">
            <div class="deduction-checkbox-item" onclick="toggleQRDeductionCheckbox(this)">
              <input type="checkbox" id="qrReason1" value="มาสาย">
              <label for="qrReason1">1. มาสาย</label>
            </div>
            <div class="deduction-checkbox-item" onclick="toggleQRDeductionCheckbox(this)">
              <input type="checkbox" id="qrReason2" value="ไม่สวมหมวกกันน็อค">
              <label for="qrReason2">2. ไม่สวมหมวกกันน็อค</label>
            </div>
            <div class="deduction-checkbox-item" onclick="toggleQRDeductionCheckbox(this)">
              <input type="checkbox" id="qrReason3" value="หนีเรียน">
              <label for="qrReason3">3. หนีเรียน</label>
            </div>
            <div class="deduction-checkbox-item" onclick="toggleQRDeductionCheckbox(this)">
              <input type="checkbox" id="qrReason4" value="สูบบุหรี่">
              <label for="qrReason4">4. สูบบุหรี่</label>
            </div>
            <div class="deduction-checkbox-item" onclick="toggleQRDeductionCheckbox(this)">
              <input type="checkbox" id="qrReason5" value="บุหรี่ไฟฟ้า">
              <label for="qrReason5">5. บุหรี่ไฟฟ้า</label>
            </div>
            <div class="deduction-checkbox-item" onclick="toggleQRDeductionCheckbox(this)">
              <input type="checkbox" id="qrReason6" value="การแต่งกายผิดระเบียบ">
              <label for="qrReason6">6. การแต่งกายผิดระเบียบ</label>
            </div>
            <div class="deduction-checkbox-item" onclick="toggleQRDeductionCheckbox(this)">
              <input type="checkbox" id="qrReason7" value="ทะเลาะวิวาท">
              <label for="qrReason7">7. ทะเลาะวิวาท</label>
            </div>
            <div class="deduction-checkbox-item" onclick="toggleQRDeductionCheckbox(this)">
              <input type="checkbox" id="qrReason8" value="ใช้สื่อโซเชียลไม่เหมาะสม">
              <label for="qrReason8">8. ใช้สื่อโซเชียลไม่เหมาะสม</label>
            </div>
            <div class="deduction-checkbox-item" onclick="toggleQRDeductionCheckbox(this)">
              <input type="checkbox" id="qrReason9" value="เล่นการพนัน">
              <label for="qrReason9">9. เล่นการพนัน</label>
            </div>
            <div class="deduction-checkbox-item" onclick="toggleQRDeductionCheckbox(this)">
              <input type="checkbox" id="qrReason10" value="สิงห้องน้ำ">
              <label for="qrReason10">10. สิงห้องน้ำ</label>
            </div>
            <div class="deduction-checkbox-item" onclick="toggleQRDeductionCheckbox(this)">
              <input type="checkbox" id="qrReason11" value="บูลลี่">
              <label for="qrReason11">11. บูลลี่</label>
            </div>
            <div class="deduction-checkbox-item" onclick="toggleQRDeductionCheckbox(this)">
              <input type="checkbox" id="qrReason12" value="ทำลายทรัพย์สินโรงเรียน">
              <label for="qrReason12">12. ทำลายทรัพย์สินโรงเรียน</label>
            </div>
            <div class="deduction-checkbox-item" onclick="toggleQRDeductionCheckbox(this)">
              <input type="checkbox" id="qrReason13" value="แอบถ่ายรูป">
              <label for="qrReason13">13. แอบถ่ายรูป</label>
            </div>
            <div class="deduction-checkbox-item" onclick="toggleQRDeductionCheckbox(this)">
              <input type="checkbox" id="qrReasonOther" value="อื่นๆ">
              <label for="qrReasonOther">อื่นๆ (ระบุ)</label>
            </div>
          </div>
          <div id="qrOtherReasonInput" style="display: none; margin-top: 10px;">
            <input type="text" id="qrOtherReasonText" placeholder="ระบุสาเหตุอื่นๆ..."
              style="width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 8px;"
              oninput="updateQRReasonFromCheckboxes()">
          </div>
        </div>
        <div class="form-group">
          <label>สาเหตุที่เลือก:</label>
          <textarea id="actionReason" rows="3" placeholder="สาเหตุจะแสดงที่นี่เมื่อเลือกจากรายการด้านบน..."
            readonly></textarea>
        </div>
      </div>

      <!-- Section: Add / Work -->
      <div id="section-add" class="section-content">
        <div class="form-group">
          <label>รายละเอียดงาน / การแก้ไข</label>
          <textarea id="workDetail" rows="3" placeholder="ระบุรายละเอียดงานหรือสิ่งที่แก้ไข..."></textarea>
        </div>

        <div class="image-upload-grid">
          <!-- Before Image -->
          <div class="image-upload-box" onclick="document.getElementById('actionBeforeImageInput').click()">
            <input type="file" id="actionBeforeImageInput" class="file-input" accept="image/*"
              onchange="previewImage(this, 'actionBeforePreview', 'actionBeforePlaceholder')">
            <div id="actionBeforePlaceholder" class="upload-placeholder">
              <i class="fas fa-camera"></i>
              <p>ก่อนทำ</p>
            </div>
            <img id="actionBeforePreview" class="image-preview" alt="Before Preview">
          </div>

          <!-- After Image -->
          <div class="image-upload-box" onclick="document.getElementById('actionAfterImageInput').click()">
            <input type="file" id="actionAfterImageInput" class="file-input" accept="image/*"
              onchange="previewImage(this, 'actionAfterPreview', 'actionAfterPlaceholder')">
            <div id="actionAfterPlaceholder" class="upload-placeholder">
              <i class="fas fa-magic"></i>
              <p>หลังทำ</p>
            </div>
            <img id="actionAfterPreview" class="image-preview" alt="After Preview">
          </div>
        </div>
      </div>

      <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
        <button class="btn btn-warning" onclick="closeActionForm()">ยกเลิก</button>
        <button class="btn btn-success" id="btnSubmitAction" onclick="submitActionForm()">
          <i class="fas fa-save"></i> บันทึก
        </button>
      </div>
    </div>
  </div>

  <script>
    // Action Form Logic (consolidated above)
    // let currentActionType = 'deduct'; // Removed duplicate

    async function handlePendingNotificationSubmission(student, reason, scoreChange) {
      if (!pendingNotificationDiff) return;
      const { notification, actualIndex, adminName, index } = pendingNotificationDiff;

      // Apply Logic
      try {
        // Calculate New Score
        // For manual adjust, scoreChange is what we ADD (or SUBTRACT if negative)
        // But logic says: "Add Score Mode" -> Positive. "Deduct Mode" -> Negative?
        // "Action Form" has "Deduct" (Implicit negative) and "Add" (Implicit positive).

        // If currentActionType is 'deduct', scoreChange is usually 0 in the form logic unless we add values to checkboxes?
        // The checkboxes have NO values in the new form (just text).
        // So if 'deduct', we rely on `reason` and maybe a default deduction?
        // The user asked for "Adjust (+/-)" with input.
        // My new "Add Score" tab has a numeric input.
        // If the user wants to DEDUCT manually with a specific number, they could use "Add Score" with negative?
        // But the input is `min="0"`.

        // Wait, the legacy modal allowed negative.
        // "Add Score" tab input should allow negative? Or I should add a "Manual Deduct" score input in Deduct tab?
        // For now, let's assume "Add Score" tab can handle negative if I remove `min="0"`.
        // OR, `deduct` mode implies automatic deduction? No, custom reason = 0?

        // Let's allow negative in the "Add Score" input.
        // I will update the HTML for input to remove min="0" or allow negative.

        let finalScoreChange = scoreChange;

        // If mode is DEDUCT and we have no score change?
        // The legacy modal was explicit numbers.
        // The new modal "Deduct" is checklist based.
        // If user wants to deduct 5 points manually:
        // They should go to "Add Score" and type -5?
        // That's reasonable ("Adjust Score").

        // Update Student Score
        // Note: student.score is local.
        const newScore = Math.max(0, student.score + finalScoreChange);

        // Save Score
        const scoreResponse = await fetch('/api/save-score', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            id: student.id,
            score: newScore,
            reason: reason // Includes score change info? "Adjust: ..."
          })
        });

        if (scoreResponse.ok) {
          // Update local data
          student.score = newScore;
          showStatus('success', `บันทึกการปรับคะแนนเรียบร้อยแล้ว`);

          // Finalize
          await finalizeCompletion(index, actualIndex, adminName);

          // Close
          closeActionForm();
          pendingNotificationDiff = null;

        } else {
          Swal.fire({ icon: 'error', title: 'ล้มเหลว', text: 'บันทึกคะแนนไม่สำเร็จ' });
        }
      } catch (e) {
        console.error(e);
        Swal.fire({ icon: 'error', title: 'เกิดข้อผิดพลาด', text: e.message });
      }
    }

    const REASONS_DEDUCT = [
      "มาสาย", "ไม่สวมหมวกกันน็อค", "หนีเรียน", "สูบบุหรี่", "บุหรี่ไฟฟ้า",
      "การแต่งกายผิดระเบียบ", "สิงห้องน้ำ", "ใช้สื่อโซเชียลไม่เหมาะสม",
      "บูลลี่", "แอบถ่ายรูป", "เล่นไพ่/การพนัน", "ทำลายทรัพย์สิน", "ทะเลาะวิวาท"
    ];

    const REASONS_ADD = [
      "จิตอาสาช่วยงานครู", "เก็บของได้ส่งคืน", "ช่วยเหลือเพื่อน",
      "ร่วมกิจกรรมโรงเรียน", "แต่งกายเรียบร้อยดีเยี่ยม", "ผู้นำกิจกรรม",
      "ดูแลความสะอาดห้องเรียน", "มีความรับผิดชอบสูง"
    ];

    // Image Processing Helpers (Ported from th.html)
    function previewImage(input, previewId, placeholderId) {
      if (input.files && input.files[0]) {
        const reader = new FileReader();
        reader.onload = function (e) {
          const img = document.getElementById(previewId);
          img.src = e.target.result;
          img.classList.add('show');
          document.getElementById(placeholderId).classList.add('hidden');
        }
        reader.readAsDataURL(input.files[0]);
      }
    }

    function processImage(file, maxWidth = 800) {
      return new Promise((resolve, reject) => {
        if (!file) { resolve(null); return; }
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = (event) => {
          const img = new Image();
          img.src = event.target.result;
          img.onload = () => {
            const canvas = document.createElement('canvas');
            let width = img.width;
            let height = img.height;
            if (width > maxWidth) {
              height = Math.round((height * maxWidth) / width);
              width = maxWidth;
            }
            canvas.width = width;
            canvas.height = height;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(img, 0, 0, width, height);
            resolve(canvas.toDataURL('image/jpeg', 0.8));
          };
          img.onerror = (error) => reject(error);
        };
        reader.onerror = (error) => reject(error);
      });
    }

    async function submitWorkForm() {
      try {
        const studentId = document.getElementById('actionStudentId').dataset.id;
        const studentName = document.getElementById('actionStudentName').textContent;
        const detail = document.getElementById('workDetail').value.trim();
        const beforeFile = document.getElementById('actionBeforeImageInput').files[0];
        const afterFile = document.getElementById('actionAfterImageInput').files[0];

        if (!detail) {
          Swal.fire({ icon: 'warning', title: 'แจ้งเตือน', text: 'กรุณาระบุรายละเอียดงาน / การแก้ไข' });
          return;
        }

        // Optional: Require images? th.html requires them, but here maybe optional?
        // The screenshot implies "Before/After". Let's require at least detail.

        // Show loading
        const btn = document.getElementById('btnSubmitAction');
        const originalText = btn.innerHTML;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> กำลังส่ง...';
        btn.disabled = true;

        // Process images
        const beforeBase64 = await processImage(beforeFile);
        const afterBase64 = await processImage(afterFile);

        // Get current user
        const currentUser = JSON.parse(sessionStorage.getItem('currentUser') || '{}');

        const data = {
          student_id: studentId,
          student_name: studentName,
          detail: detail,
          image_before: beforeBase64,
          image_after: afterBase64,
          teacher: currentUser.name || 'Unknown',
          timestamp: new Date().toISOString(),
          status: 'pending'
        };

        // Send to server (using same endpoint as th.html)
        const response = await fetch('/api/save-work', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });

        const result = await response.json();

        btn.innerHTML = originalText;
        btn.disabled = false;

        if (result.status === 'success' || response.ok) { // Handle varied API responses
          showToast('success', 'บันทึกข้อมูลเรียบร้อยแล้ว');
          closeActionForm();
          closeQRScanner();

          // Refresh Manage Modal History if open
          if (document.getElementById('manageStudentModal').classList.contains('show')) {
            if (typeof loadScoreHistory === 'function' && currentManageId) {
              loadScoreHistory(currentManageId);
            }
            // Also update local stats if needed
            if (typeof updateStatistics === 'function') {
              updateStatistics();
            }
          }

        } else {
          throw new Error(result.message || 'Unknown error');
        }
      } catch (error) {
        console.error('Submit work error:', error);
        Swal.fire({ icon: 'error', title: 'บันทึกไม่สำเร็จ', text: error.message });
        // Reset button
        const btn = document.getElementById('btnSubmitAction');
        if (btn) {
          btn.innerHTML = '<i class="fas fa-save"></i> บันทึก';
          btn.disabled = false;
        }
      }
    }

    // Close Action Form Modal
    function closeActionForm() {
      const modal = document.getElementById('actionFormModal');
      if (modal) {
        modal.classList.remove('show');
      }
    }

    // Toggle QR deduction checkbox visual state
    function toggleQRDeductionCheckbox(item) {
      const checkbox = item.querySelector('input[type="checkbox"]');
      checkbox.checked = !checkbox.checked;
      item.classList.toggle('checked', checkbox.checked);

      // If it's the "other" checkbox, toggle the input field
      if (checkbox.id === 'qrReasonOther') {
        const otherInput = document.getElementById('qrOtherReasonInput');
        otherInput.style.display = checkbox.checked ? 'block' : 'none';
        if (checkbox.checked) {
          document.getElementById('qrOtherReasonText').focus();
        }
      }

      // Auto-populate the reason textarea
      updateQRReasonFromCheckboxes();
    }

    // Update the reason textarea based on checked boxes
    function updateQRReasonFromCheckboxes() {
      const checkboxes = document.querySelectorAll('#deductionReasonsContainer input[type="checkbox"]:checked');
      const reasons = Array.from(checkboxes).map(cb => {
        if (cb.id === 'qrReasonOther') {
          return document.getElementById('qrOtherReasonText').value.trim();
        }
        return cb.value;
      }).filter(r => r !== '');

      document.getElementById('actionReason').value = reasons.join(', ');
    }

    async function submitActionForm() {
      try {
        const studentId = document.getElementById('actionStudentId').dataset.id;
        const studentName = document.getElementById('actionStudentName').textContent;
        const reason = document.getElementById('actionReason').value.trim();

        if (!reason) {
          showToast('warning', 'กรุณาระบุสาเหตุหรือเลือกจากรายการ');
          return;
        }

        // Show loading
        const btn = document.getElementById('btnSubmitAction');
        const originalText = btn.innerHTML;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> กำลังบันทึก...';
        btn.disabled = true;

        // Get current user
        const currentUser = JSON.parse(sessionStorage.getItem('currentUser') || '{}');

        const data = {
          student_id: studentId,
          student_name: studentName,
          reason: reason,
          teacher: currentUser.name || 'Admin',
          timestamp: new Date().toISOString(),
          status: 'pending'
        };

        const response = await fetch('/api/save-toadmin', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });

        const result = await response.json();
        btn.innerHTML = originalText;
        btn.disabled = false;

        if (result.status === 'success' || response.ok) {
          showToast('success', 'บันทึกคะแนนพฤติกรรมเรียบร้อยแล้ว');
          closeActionForm();
          closeQRScanner();

          // Refresh Manage Modal if open
          if (document.getElementById('manageStudentModal').classList.contains('show')) {
            if (typeof loadScoreHistory === 'function' && currentManageId) {
              loadScoreHistory(currentManageId);
            }
            if (typeof updateStatistics === 'function') {
              updateStatistics();
            }
          }
        } else {
          throw new Error(result.message || 'Unknown error');
        }
      } catch (error) {
        console.error('Submit action error:', error);
        Swal.fire({ icon: 'error', title: 'บันทึกไม่สำเร็จ', text: error.message });
        const btn = document.getElementById('btnSubmitAction');
        if (btn) {
          btn.innerHTML = '<i class="fas fa-save"></i> บันทึก';
          btn.disabled = false;
        }
      }
    }

    function switchModalTab(type) {
      currentActionType = type;

      // Update Tabs
      document.querySelectorAll('.modal-tab').forEach(t => t.classList.remove('active'));
      const activeTab = document.getElementById(`tab-${type}`);
      if (activeTab) activeTab.classList.add('active');

      // Update Sections
      document.querySelectorAll('.section-content').forEach(s => s.classList.remove('show'));
      const activeSection = document.getElementById(`section-${type}`);
      if (activeSection) activeSection.classList.add('show');

      // Update Submit Button Action
      const btn = document.getElementById('btnSubmitAction');
      if (type === 'deduct') {
        btn.onclick = submitActionForm;
        btn.innerHTML = '<i class="fas fa-save"></i> บันทึก';
        btn.classList.remove('btn-info');
        btn.classList.add('btn-success');
      } else {
        btn.onclick = submitWorkForm;
        btn.innerHTML = '<i class="fas fa-paper-plane"></i> บันทึกผลงาน';
        btn.classList.remove('btn-success');
        btn.classList.add('btn-info');
      }
    }

    // ===== Real-time Statistics System =====
    let statsInterval;
    let cachedStudentsData = [];

    // Calculate and update statistics
    async function updateStatistics() {
      try {
        // Fetch latest data with cache busting
        const timestamp = new Date().getTime();
        const response = await fetch(`user2.1.json?v=${timestamp}`);
        if (!response.ok) {
          console.error('Failed to fetch student data');
          return;
        }

        const students = await response.json();
        cachedStudentsData = students;

        // Fix for QR Scanner: Keep global data fresh
        if (Array.isArray(students) && students.length > 0) {
          window.allStudents = students;
        }

        // Calculate statistics
        const totalStudents = students.length;
        const avgScore = students.reduce((sum, s) => sum + (s.score || 100), 0) / totalStudents;
        const highScore = students.filter(s => (s.score || 100) >= 80).length;
        const lowScore = students.filter(s => (s.score || 100) < 60).length; // Update UI
        document.getElementById('statTotal').textContent = totalStudents;
        document.getElementById('statAvg').textContent = avgScore.toFixed(1);
        document.getElementById('statHigh').textContent = highScore; document.getElementById('statLow').textContent = lowScore;
        console.log('Statistics updated:', { totalStudents, avgScore: avgScore.toFixed(1), highScore, lowScore });
      } catch
      (error) { console.error('Error updating statistics:', error); }
    }

    function startStatisticsMonitoring() {
      // Update immediately 
      updateStatistics();
      // Then update every 5 seconds
      statsInterval = setInterval(() => {
        updateStatistics();
      }, 5000);

      console.log('Statistics monitoring started (updates every 5 seconds)');
    }

    // Stop monitoring (cleanup)
    function stopStatisticsMonitoring() {
      if (statsInterval) {
        clearInterval(statsInterval);
        console.log('Statistics monitoring stopped');
      }
    }

    // Start monitoring when page loads
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', startStatisticsMonitoring);
    } else {
      startStatisticsMonitoring();
    }

    // Stop monitoring when page unloads
    window.addEventListener('beforeunload', stopStatisticsMonitoring);

    // Helper to open modal for student
    function openActionFormForStudent(studentId, studentName, defaultTab = 'deduct') {
      const modal = document.getElementById('actionFormModal');
      document.getElementById('actionStudentName').textContent = studentName;
      document.getElementById('actionStudentId').textContent = 'รหัส: ' + studentId;
      document.getElementById('actionStudentId').dataset.id = studentId;

      // Reset Inputs
      document.getElementById('actionReason').value = '';
      if (document.getElementById('workDetail')) document.getElementById('workDetail').value = '';
      if (document.getElementById('qrOtherReasonText')) document.getElementById('qrOtherReasonText').value = '';
      if (document.getElementById('qrOtherReasonInput')) document.getElementById('qrOtherReasonInput').style.display = 'none';

      // Reset Checkboxes
      document.querySelectorAll('.deduction-checkbox-item input').forEach(cb => cb.checked = false);
      document.querySelectorAll('.deduction-checkbox-item').forEach(div => div.classList.remove('checked'));

      // Reset Images
      document.querySelectorAll('.image-preview').forEach(img => {
        img.src = '';
        img.classList.remove('show');
      });
      document.querySelectorAll('.upload-placeholder').forEach(p => p.classList.remove('hidden'));

      switchModalTab(defaultTab);
      modal.classList.add('show');
      // Ensure z-index is high if called from another modal
      modal.style.zIndex = '10600';
    }
  </script>

  <!-- ==================== STUDENT MANAGEMENT MODALS ==================== -->

  <!-- Specialized Score Adjustment Modal (Design from screenshot) -->
  <div id="adjustScoreModal" class="student-search-overlay" style="z-index: 10700;">
    <div class="adjust-modal-content">
      <div class="adjust-modal-icon-wrapper" id="adjustModalIcon">
        <i class="fas fa-pen"></i>
      </div>

      <div class="adjust-modal-title" id="adjustModalTitle">ปรับคะแนนพฤติกรรม</div>
      <div class="adjust-modal-subtitle" id="adjustModalSubtitle">ให้คะแนน / หักคะแนน ...</div>

      <div class="adjust-form-group">
        <label class="adjust-label"
          style="text-align: center; font-size: 1.1rem; color: #6b7280;">ระบุคะแนนที่ต้องการปรับ</label>
        <input type="number" id="adjustScoreInput" class="adjust-input-field" placeholder="0">
        <div style="text-align: center; margin-top: 10px; font-size: 0.9rem; color: #9ca3af;">
          ( ใส่เครื่องหมาย - เพื่อหักคะแนน เช่น -5 )
        </div>
      </div>

      <!-- Reason field REMOVED as per user request -->
      <!-- Work Detail and Image Upload sections REMOVED as per user request -->
      <!-- Fields for workDetail and images are now optional in submitAdjustScore logic -->

      <!-- Work Detail and Image Upload sections REMOVED as per user request -->
      <!-- Fields for workDetail and images are now optional in submitAdjustScore logic -->

      <div class="adjust-modal-actions">
        <button class="adjust-btn adjust-btn-cancel" onclick="closeAdjustScoreModal()">
          <i class="fas fa-times"></i> ยกเลิก
        </button>
        <button class="adjust-btn adjust-btn-confirm" onclick="submitAdjustScore()">
          <i class="fas fa-check"></i> ยืนยัน
        </button>
      </div>
    </div>
  </div>
  <div class="student-search-overlay" id="manageStudentModal">
    <div class="manage-student-modal">
      <div class="manage-student-header">
        <div class="manage-header-left">
          <button class="manage-back-btn" id="manageBackBtn" onclick="switchManageStudentView('main')">
            <i class="fas fa-arrow-left"></i>
          </button>
          <h3 id="manageModalTitle"><i class="fas fa-user-cog"></i> จัดการข้อมูลนักเรียน</h3>
        </div>
        <button onclick="closeManageStudentModal()"
          style="background:none; border:none; color:white; font-size:1.5rem; cursor:pointer;">&times;</button>
      </div>

      <!-- Main Profile View -->
      <div id="manageMainView" class="manage-view active">
        <div class="manage-student-profile">
          <div class="manage-avatar-wrapper">
            <div class="manage-avatar" id="manageStudentAvatar" onclick="openProfileViewerFromAvatar()">
              <i class="fas fa-user-graduate"></i>
            </div>
            <div class="manage-avatar-badge" onclick="openUploadProfileModal()">
              <i class="fas fa-camera"></i>
            </div>
          </div>
          <div class="manage-student-name" id="manageStudentName">-</div>
          <div class="manage-student-id" id="manageStudentId">รหัส: -</div>
        </div>

        <div class="student-stats-grid">
          <!-- Academic Status -->
          <div class="stat-card">
            <div class="stat-icon academic">
              <i class="fas fa-graduation-cap"></i>
            </div>
            <div class="stat-info">
              <div class="stat-label">สถานะการเรียน</div>
              <div class="stat-value" id="manageStudentAcademic">-</div>
            </div>
          </div>

          <!-- Behavior Status -->
          <div class="stat-card">
            <div class="stat-icon behavior">
              <i class="fas fa-star"></i>
            </div>
            <div class="stat-info">
              <div class="stat-label">สถานะพฤติกรรม</div>
              <div class="stat-value" id="manageStudentStatus">-</div>
            </div>
          </div>

          <!-- Current Score -->
          <div class="stat-card">
            <div class="stat-icon score">
              <i class="fas fa-chart-line"></i>
            </div>
            <div class="stat-info">
              <div class="stat-label">คะแนนปัจจุบัน</div>
              <div class="stat-value" id="manageStudentScore">-</div>
            </div>
          </div>
        </div>

        <!-- Action Buttons Grid -->
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 25px;">
          <!-- Add Score Button (New) -->
          <button class="history-primary-btn" onclick="openManualScoreModal()"
            style="background: linear-gradient(135deg, #10b981, #059669); padding: 15px; border-radius: 16px; border: none; box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3);">
            <div style="display: flex; align-items: center; gap: 12px;">
              <div
                style="width: 40px; height: 40px; background: rgba(255,255,255,0.2); border-radius: 12px; display: flex; align-items: center; justify-content: center;">
                <i class="fas fa-plus" style="font-size: 1.2rem;"></i>
              </div>
              <div style="text-align: left;">
                <h4 style="margin: 0; font-size: 1rem;">เพิ่มคะแนน</h4>
                <p style="margin: 0; font-size: 0.8rem; opacity: 0.9;">บวกคะแนนเพิ่ม</p>
              </div>
            </div>
          </button>

          <!-- History Button -->
          <button class="history-primary-btn" onclick="switchManageStudentView('history')"
            style="margin: 0; padding: 15px; border-radius: 16px;">
            <div style="display: flex; align-items: center; gap: 12px;">
              <div
                style="width: 40px; height: 40px; background: rgba(255,255,255,0.2); border-radius: 12px; display: flex; align-items: center; justify-content: center;">
                <i class="fas fa-history" style="font-size: 1.2rem;"></i>
              </div>
              <div style="text-align: left;">
                <h4 style="margin: 0; font-size: 1rem;">ประวัติ</h4>
                <p style="margin: 0; font-size: 0.8rem; opacity: 0.9;">ดูรายการย้อนหลัง</p>
              </div>
            </div>
          </button>
        </div>

        <div style="padding: 0 25px 25px;">
          <button class="btn btn-warning" style="width: 100%; padding: 12px; border-radius: 12px;"
            onclick="closeManageStudentModal()">ปิดหน้าต่าง</button>
        </div>
      </div>

      <!-- History Detail View -->
      <div id="manageHistoryView" class="manage-view">
        <div class="manage-history-container">
          <div class="manage-history-tabs">
            <button class="manage-history-tab active" data-filter="all" onclick="filterHistoryUnified('all', this)">
              <i class="fas fa-list"></i> ทั้งหมด
            </button>
            <button class="manage-history-tab positive" data-filter="positive"
              onclick="filterHistoryUnified('positive', this)">
              <i class="fas fa-plus-circle"></i> เพิ่ม
            </button>
            <button class="manage-history-tab negative" data-filter="negative"
              onclick="filterHistoryUnified('negative', this)">
              <i class="fas fa-minus-circle"></i> ลด
            </button>
          </div>

          <div class="manage-history-list" id="manageHistoryList">
            <!-- History items will be rendered here -->
          </div>
        </div>
      </div>
    </div>
  </div>

  <!--Profile Viewer Modal-->
  <div class="student-search-overlay" id="profileViewerModal" onclick="closeProfileViewer(event)"
    style="z-index: 10200;">
    <div class="report-modal" style="max-width: 400px; padding: 25px;" onclick="event.stopPropagation()">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h3 id="profileViewerName" style="margin: 0; font-size: 1.5rem; color: #1e293b;">-</h3>
        <button onclick="closeProfileViewer()"
          style="border: none; background: #f1f5f9; width: 36px; height: 36px; border-radius: 50%; cursor: pointer; color: #64748b; font-size: 1.2rem; display: flex; align-items: center; justify-content: center; transition: all 0.2s;">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <div id="profileViewerId"
        style="color: #6366f1; background: #eef2ff; padding: 4px 12px; border-radius: 20px; font-size: 0.9rem; margin-bottom: 20px; display: inline-block; font-weight: 600;">
        รหัส: -</div>
      <div id="profileViewerImageContainer" class="profile-viewer-image-container">
        <div class="no-profile-image">
          <i class="fas fa-user-graduate"></i>
          <p>ไม่มีรูปโปรไฟล์</p>
        </div>
      </div>
      <div style="margin-top: 20px; text-align: center;">
        <p style="color: #64748b; font-size: 0.85rem;"><i class="fas fa-info-circle"></i> รูปภาพที่จัดเก็บในระบบ
          edstudent
        </p>
      </div>
    </div>
  </div>

  <!--Upload Profile Modal-->
  <div class="student-search-overlay" id="uploadProfileModal" style="z-index: 10100;">
    <div class="report-modal" style="max-width: 450px;">
      <div class="report-header" style="background: linear-gradient(135deg, #6366f1, #8b5cf6); padding: 20px 25px;">
        <h3><i class="fas fa-camera"></i> อัปโหลดรูปโปรไฟล์</h3>
      </div>
      <div class="report-body" style="padding: 30px;">
        <div class="upload-preview-container"
          style="background: #f8fafc; border: 2px dashed #e2e8f0; border-radius: 24px; padding: 40px 20px;">
          <div class="upload-preview" onclick="document.getElementById('profileImageInput').click()"
            style="width: 200px; height: 200px; border: 4px solid white; box-shadow: 0 15px 35px rgba(0,0,0,0.1);">
            <input type="file" id="profileImageInput" class="hidden-input" accept="image/*"
              onchange="previewProfileImage(this)" style="display: none;">
            <div id="profilePlaceholder">
              <i class="fas fa-cloud-upload-alt" style="font-size: 4rem; color: #cbd5e1;"></i>
              <p style="margin-top: 10px; font-weight: 600; color: #94a3b8;">คลิกเพื่อเลือกรูป</p>
            </div>
            <img id="profilePreview"
              style="display: none; width: 100%; height: 100%; object-fit: cover; border-radius: 50%;">
          </div>
          <p class="profile-instruction" style="margin-top: 20px;">เลือกรูปภาพนักเรียนที่ชัดเจน (JPG/PNG)</p>
          <p style="font-size: 0.8rem; color: #94a3b8; margin-top: 5px;">
            ระบบจะทำการตัดรูปส่วนกลางให้อัตโนมัติเป็นวงกลม</p>
        </div>
        <div class="report-actions" style="grid-template-columns: 1fr 1fr; margin-top: 25px;">
          <button class="report-btn" onclick="closeUploadProfileModal()"
            style="background: #f1f5f9; color: #475569; padding: 12px; border-radius: 12px; font-weight: 600; border: none; cursor: pointer;">ยกเลิก</button>
          <button class="report-btn" onclick="saveProfileImage()"
            style="background: linear-gradient(135deg, #10b981, #059669); color: white; padding: 12px; border-radius: 12px; font-weight: 700; border: none; cursor: pointer;">บันทึกรูปภาพ</button>
        </div>
      </div>
    </div>
  </div>


  <!-- Reporting Modal (New) -->


  <script>
    // Manual Score -> Opens the Action Form Modal (Unified Interface)
    function openManualScoreModal() {
      // Use existing currentManageId/Name
      const studentId = currentManageId;
      const studentName = currentManageName;

      if (!studentId) {
        console.error('No student selected for manual score');
        return;
      }

      // Populate Action Modal
      const modal = document.getElementById('actionFormModal');
      document.getElementById('actionStudentName').textContent = studentName;
      document.getElementById('actionStudentId').textContent = 'รหัส: ' + studentId;
      document.getElementById('actionStudentId').dataset.id = studentId;

      // Reset Form
      document.getElementById('actionReason').value = '';
      document.getElementById('workDetail').value = '';
      document.getElementById('beforeImageInput').value = '';
      document.getElementById('afterImageInput').value = '';

      // Clear previews
      document.getElementById('beforePreview').removeAttribute('src');
      document.getElementById('beforePreview').classList.remove('show');
      document.getElementById('beforePlaceholder').classList.remove('hidden');

      document.getElementById('afterPreview').removeAttribute('src');
      document.getElementById('afterPreview').classList.remove('show');
      document.getElementById('afterPlaceholder').classList.remove('hidden');

      // Default to "Add Score" tab based on user request context
      if (typeof switchModalTab === 'function') {
        switchModalTab('add');
      }

      modal.classList.add('show');
      // Hide Manage Modal temporarily? Or keep it open behind?
      // Screenshot shows it's an overlay. Let's keep manage modal open behind it.
      // But ensure z-index of actionFormModal is higher than manageStudentModal.
      modal.style.zIndex = "10400"; // Ensure it's on top of manage modal (usually ~10200)
    }

    function closeActionForm() {
      document.getElementById('actionFormModal').classList.remove('show');
    }

    function closeManualScoreModal() {
      document.getElementById('manualScoreModal').classList.remove('show');
    }

    function updateManualScorePreview() {
      const input = document.getElementById('manualScoreInput');
      let val = parseInt(input.value);
      if (isNaN(val) || val < 1) val = 0;
      document.getElementById('manualScoreValueDisplay').textContent = val;
    }

    async function submitManualScore() {
      const score = document.getElementById('manualScoreInput').value;
      let reason = document.getElementById('manualScoreReason').value.trim();

      if (!reason) {
        alert('กรุณาระบุเหตุผล');
        return;
      }

      if (score < 1) {
        alert('คะแนนต้องมากกว่า 0');
        return;
      }

      // Format reason to include score
      const finalReason = `[เพิ่มคะแนน +${score}] ${reason}`;

      try {
        const currentUser = JSON.parse(sessionStorage.getItem('currentUser') || '{}');
        const data = {
          student_id: currentManageId,
          student_name: currentManageName,
          reason: finalReason,
          teacher: currentUser.name || 'Admin',
          timestamp: new Date().toISOString(),
          score_change: parseInt(score) // Try sending this in case backend supports it
        };

        const response = await fetch('/api/save-toadmin', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });

        const result = await response.json();

        if (result.status === 'success' || response.ok) {
          // Close modal
          closeManualScoreModal();

          // Show success (maybe SweetAlert or Toast if available, or just alert)
          // alert('เพิ่มคะแนนเรียบร้อยแล้ว');

          // Refresh History
          if (typeof loadScoreHistory === 'function') {
            loadScoreHistory(currentManageId);
          }

          // Switch to History View to show the new entry?
          switchManageStudentView('history');

        } else {
          alert('เกิดข้อผิดพลาด: ' + (result.message || 'Unknown'));
        }
      } catch (error) {
        console.error(error);
        alert('ไม่สามารถเชื่อมต่อเซิร์ฟเวอร์ได้');
      }
    }

    // ==========================================
    // REPORT GENERATION (Ported from th.html)
    // ==========================================

    function openReportModal() {
      populateReportYears();
      populateReportClasses();
      document.getElementById('reportModal').classList.add('show');
    }

    function closeReportModal() {
      document.getElementById('reportModal').classList.remove('show');
    }

    function populateReportClasses() {
      const classSelect = document.getElementById('reportClass');
      const classes = getUniqueClasses();
      classSelect.innerHTML = '<option value="">ทุกห้อง</option>';

      classes.forEach(c => {
        const option = document.createElement('option');
        option.value = c;
        option.textContent = formatClassName(c);
        classSelect.appendChild(option);
      });
    }

    function populateReportYears() {
      const yearSelect = document.getElementById('reportYear');
      const currentYearEn = new Date().getFullYear();
      const currentYearTh = currentYearEn + 543;

      yearSelect.innerHTML = '';
      for (let i = 0; i < 3; i++) {
        const yearTh = currentYearTh - i;
        const yearEn = currentYearEn - i;
        const option = document.createElement('option');
        option.value = yearEn;
        option.textContent = `ปีการศึกษา ${yearTh}`;
        yearSelect.appendChild(option);
      }
    }

    function formatClassName(classCode) {
      if (!classCode) return '-';
      const code = String(classCode);
      if (code.length === 3) {
        return 'ม.' + code[0] + '/' + code.substring(1);
      }
      return classCode;
    }

    async function exportReport(type) {
      const month = document.getElementById('reportMonth').value;
      const year = parseInt(document.getElementById('reportYear').value);
      const filter = document.getElementById('reportFilter').value;
      const selectedClass = document.getElementById('reportClass').value;

      // Show loading
      if (typeof showLoading === 'function') {
        showLoading(true);
      } else {
        console.log('Generating report...');
      }

      try {
        // Fetch logs for history reconstruction
        const timestamp = new Date().getTime();
        const logRes = await fetch(`log.json?v=${timestamp}`);
        const logs = await logRes.json();

        // Use current student data
        const sourceStudents = window.allStudents || cachedStudentsData || [];
        if (sourceStudents.length === 0) throw new Error('ไม่พบข้อมูลนักเรียน');

        // 1. Reconstruct historical scores
        let reportStudents = JSON.parse(JSON.stringify(sourceStudents));

        // Determine end date
        let endDate;
        if (month === 'all') {
          endDate = new Date(year, 11, 31, 23, 59, 59, 999);
        } else {
          const m = parseInt(month);
          endDate = new Date(year, m + 1, 0, 23, 59, 59, 999);
        }

        // Undo logs AFTER endDate
        const logsToUndo = logs.filter(l => new Date(l.timestamp) > endDate);

        reportStudents.forEach(s => {
          const studentLogs = logsToUndo.filter(l => String(l.student_id) === String(s.id));
          studentLogs.forEach(l => {
            const change = l.change || l.score_change || l.deduction || 0;
            s.score -= change;
          });
        });

        // 2. Filter
        if (selectedClass && selectedClass !== '') {
          reportStudents = reportStudents.filter(s => String(s.class) === selectedClass);
        }

        // Calculate Evaluation and Filter
        let finalData = [];
        const allWithEval = reportStudents.map(s => {
          const score = s.score || 100;
          // Check for any negative history (deductions or negative changes)
          const hasBadHistory = logs.some(l =>
            String(l.student_id) === String(s.id) &&
            (l.change < 0 || l.deduction < 0) &&
            new Date(l.timestamp) <= endDate
          );

          let evalStatus = '';
          if (score >= 100 && !hasBadHistory) {
            evalStatus = 'เด็กดีศรีเทพา';
          } else if (score < 60) {
            evalStatus = 'ไม่ผ่าน';
          } else {
            evalStatus = 'ผ่าน';
          }

          return { ...s, score, evaluation: evalStatus, hasBadHistory };
        });

        if (filter === 'all') {
          finalData = allWithEval;
        } else if (filter === 'failed') {
          finalData = allWithEval.filter(s => s.score < 60);
        } else if (filter === 'passed') {
          finalData = allWithEval.filter(s => s.score >= 60);
        } else if (filter === 'excellent') {
          finalData = allWithEval.filter(s => s.evaluation === 'เด็กดีศรีเทพา');
        }

        if (finalData.length === 0) {
          alert('ไม่พบข้อมูลตามเงื่อนไขที่เลือก');
          if (typeof showLoading === 'function') showLoading(false);
          return;
        }

        // Sort by name (Thai locale)
        finalData.sort((a, b) => (a.name || '').localeCompare(b.name || '', 'th'));

        const monthName = month === 'all' ? 'ทุกเดือน' :
          ['มกราคม', 'กุมภาพันธ์', 'มีนาคม', 'เมษายน', 'พฤษภาคม', 'มิถุนายน', 'กรกฎาคม', 'สิงหาคม', 'กันยายน', 'ตุลาคม', 'พฤศจิกายน', 'ธันวาคม'][parseInt(month)];
        const yearTh = year + 543;

        // Grouping Logic for PDF/Export
        let groups = [];
        if (selectedClass) {
          // Single Class
          const classInt = parseInt(selectedClass);
          let teacherName = 'Admin';
          if (teachersData.length > 0) {
            const advisors = teachersData.filter(t => t.class === classInt && !/^\d+$/.test(t.id));
            if (advisors.length > 0) {
              teacherName = advisors.map(t => t.name).join(' / ');
            }
          }
          groups.push({
            className: formatClassName(selectedClass),
            teacherName: teacherName,
            data: finalData
          });
        } else {
          // All Classes - Group students by their class
          const distinctClasses = [...new Set(finalData.map(s => s.class))].sort((a, b) => a - b);
          distinctClasses.forEach(cid => {
            const classData = finalData.filter(s => s.class === cid);
            let advisorName = 'Admin';
            const advisors = teachersData.filter(t => t.class === parseInt(cid) && !/^\d+$/.test(t.id));
            if (advisors.length > 0) {
              advisorName = advisors.map(t => t.name).join(' / ');
            }
            groups.push({
              className: formatClassName(cid),
              teacherName: advisorName,
              data: classData
            });
          });
        }

        const title = `รายงานสรุปคะแนนพฤติกรรม ${monthName} ปีการศึกษา ${yearTh}`;
        await generateExport(groups, title, type === 'pdf');

      } catch (err) {
        console.error('Report error:', err);
        alert('เกิดข้อผิดพลาดในการสร้างรายงาน: ' + err.message);
      } finally {
        if (typeof showLoading === 'function') showLoading(false);
      }
    }

    async function generateExport(groups, title, isPdf) {
      if (isPdf) {
        // ============ PDF EXPORT: GROUPED BY CLASS ============
        try {
          const { jsPDF } = window.jspdf;
          if (!jsPDF) { throw new Error('jsPDF ไม่โหลด กรุณารีเฟรชหน้า'); }

          const pdf = new jsPDF('p', 'mm', 'a4');
          const pdfWidth = pdf.internal.pageSize.getWidth();
          const pdfHeight = pdf.internal.pageSize.getHeight();
          const ITEMS_PER_PAGE = 25;

          // 1. Calculate Total Physical Pages for accurate progress display
          let totalPhysicalPages = 0;
          groups.forEach(g => {
            totalPhysicalPages += Math.ceil(g.data.length / ITEMS_PER_PAGE);
          });

          // 2. Create Loading Overlay
          const loadingOverlay = document.createElement('div');
          loadingOverlay.id = 'export-loading-overlay';
          loadingOverlay.style.cssText = `
            position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
            background: #ffffff; z-index: 20000; display: flex;
            flex-direction: column; align-items: center; justify-content: center;
            font-family: 'Prompt', sans-serif;
          `;
          loadingOverlay.innerHTML = `
            <div style="font-size: 24px; color: #333; margin-bottom: 20px;">กำลังสร้างรายงาน PDF...</div>
            <div style="font-size: 18px; color: #666;">ประมวลผลหน้า <b id="export-progress">1</b> จาก ${totalPhysicalPages}</div>
            <div style="margin-top: 20px; color: #999; font-size: 14px;">กรุณาอย่าปิดหน้าต่าง</div>
          `;
          document.body.appendChild(loadingOverlay);

          window.scrollTo(0, 0);
          await document.fonts.ready;

          let currentPageGlobal = 0;

          // 3. Process each Class Group
          for (const group of groups) {
            const groupData = group.data;
            const groupPages = Math.ceil(groupData.length / ITEMS_PER_PAGE);

            for (let pageIdx = 0; pageIdx < groupPages; pageIdx++) {
              currentPageGlobal++;
              const b = document.getElementById('export-progress');
              if (b) b.textContent = currentPageGlobal;

              const start = pageIdx * ITEMS_PER_PAGE;
              const end = start + ITEMS_PER_PAGE;
              const pageData = groupData.slice(start, end);

              const tempDiv = document.createElement('div');
              tempDiv.style.cssText = `
                position: fixed; left: 0; top: 0; width: 800px;
                min-height: 1000px; background: #ffffff; padding: 40px;
                color: #000000; font-family: 'Prompt', 'Sarabun', Arial, sans-serif;
                z-index: 19999; box-sizing: border-box;
              `;

              // TABLE CONTENT
              const tableRows = pageData.map((s, idx) => `
                <tr style="border-bottom: 1px solid #eee;">
                  <td style="padding: 10px; text-align: center; font-size: 14px;">${start + idx + 1}</td>
                  <td style="padding: 10px; text-align: center; font-size: 14px;">${s.id}</td>
                  <td style="padding: 10px; font-size: 14px;">${s.name}</td>
                  <td style="padding: 10px; text-align: center; font-weight: bold; font-size: 14px; color: ${s.score < 60 ? '#ef4444' : '#10b981'};">${s.score}</td>
                  <td style="padding: 10px; text-align: center; font-size: 14px; color: ${s.score < 60 ? '#ef4444' : '#10b981'};">${s.evaluation || (s.score < 60 ? 'ไม่ผ่าน' : 'ผ่าน')}</td>
                </tr>
              `).join('');

              tempDiv.innerHTML = `
                <div style="text-align: center; margin-bottom: 20px; border-bottom: 2px solid #e2e8f0; padding-bottom: 15px;">
                  <h1 style="color: #1e293b; margin: 0 0 5px 0; font-size: 22px;">${title}</h1>
                  <p style="color: #64748b; margin: 0; font-size: 14px;">
                    ห้องเรียน: ${group.className} | ครูที่ปรึกษา: ${group.teacherName}
                  </p>
                </div>
                <table style="width: 100%; border-collapse: collapse;">
                  <thead>
                    <tr style="background: #f8fafc; border-bottom: 2px solid #e2e8f0;">
                      <th style="padding: 12px; text-align: center; font-size: 14px; width: 10%;">ลำดับ</th>
                      <th style="padding: 12px; text-align: center; font-size: 14px; width: 15%;">รหัส</th>
                      <th style="padding: 12px; text-align: left; font-size: 14px; width: 45%;">ชื่อ-นามสกุล</th>
                      <th style="padding: 12px; text-align: center; font-size: 14px; width: 15%;">คะแนน</th>
                      <th style="padding: 12px; text-align: center; font-size: 14px; width: 15%;">ผลประเมิน</th>
                    </tr>
                  </thead>
                  <tbody>${tableRows}</tbody>
                </table>
                <div style="margin-top: 20px; text-align: right; border-top: 1px solid #f1f5f9; padding-top: 10px; display: flex; justify-content: space-between;">
                  <p style="margin: 0; color: #94a3b8; font-size: 12px;">หน้า ${currentPageGlobal} จาก ${totalPhysicalPages}</p>
                  <p style="margin: 0; color: #94a3b8; font-size: 12px;">สร้างรายงานเมื่อ: ${new Date().toLocaleString('th-TH')}</p>
                </div>
              `;

              document.body.appendChild(tempDiv);
              await new Promise(resolve => setTimeout(resolve, 500));

              const canvas = await html2canvas(tempDiv, {
                scale: 2, useCORS: true, logging: false,
                backgroundColor: '#ffffff', windowWidth: 1200, width: 800
              });

              document.body.removeChild(tempDiv);

              if (currentPageGlobal > 1) pdf.addPage();
              const imgData = canvas.toDataURL('image/jpeg', 0.95);
              const imgHeight = (canvas.height * pdfWidth) / canvas.width;
              pdf.addImage(imgData, 'JPEG', 0, 0, pdfWidth, imgHeight);

              await new Promise(resolve => setTimeout(resolve, 50));
            }
          }

          const fileName = title.replace(/ /g, '_') + '.pdf';
          pdf.save(fileName);
          document.body.removeChild(loadingOverlay);

          Swal.fire({
            icon: 'success',
            title: 'สำเร็จ!',
            text: `ส่งออก PDF เรียบร้อยแล้ว (${totalPhysicalPages} หน้า)`,
            timer: 3000,
            showConfirmButton: false
          });

        } catch (err) {
          console.error('PDF Batch Export error:', err);
          if (document.getElementById('export-loading-overlay')) {
            document.body.removeChild(document.getElementById('export-loading-overlay'));
          }
          Swal.fire({ icon: 'error', title: 'เกิดข้อผิดพลาด', text: 'ไม่สามารถส่งออก PDF ได้: ' + err.message });
        }
      } else {
        // ============ IMAGE EXPORT (Legacy/Adjusted) ============
        // For image export, we compress into one continuous view but headers remain.
        try {
          // Combine all groups for counting
          const totalStudents = groups.reduce((sum, g) => sum + g.data.length, 0);
          if (totalStudents > 100) {
            const confirm = await Swal.fire({
              title: 'ข้อมูลมีจำนวนมาก',
              text: `มีข้อมูลนักเรียน ${totalStudents} คน แนะนำให้ส่งออกเป็น PDF แทนเพื่อความชัดเจน`,
              icon: 'warning',
              showCancelButton: true,
              confirmButtonText: 'ยังคงส่งออกรูปภาพ',
              cancelButtonText: 'ยกเลิก'
            });
            if (!confirm.isConfirmed) return;
          }

          const loadingOverlay = document.createElement('div');
          loadingOverlay.style.cssText = `
              position: fixed; top: 0; left: 0; width: 100%; height: 100%;
              background: rgba(255,255,255,0.9); z-index: 20000;
              display: flex; align-items: center; justify-content: center; font-size: 24px;
          `;
          loadingOverlay.textContent = 'กำลังสร้างรูปภาพ...';
          document.body.appendChild(loadingOverlay);

          const tempDiv = document.createElement('div');
          tempDiv.style.cssText = `
              position: fixed; left: 0; top: 0; width: 800px; height: auto;
              background: #ffffff; padding: 40px; color: #000000;
              font-family: 'Prompt', 'Sarabun', Arial, sans-serif; z-index: 19999;
          `;

          const groupsHtml = groups.map(group => {
            const rows = group.data.map((s, idx) => `
                <tr style="border-bottom: 1px solid #eee;">
                  <td style="padding: 10px; text-align: center;">${idx + 1}</td>
                  <td style="padding: 10px; text-align: center;">${s.id}</td>
                  <td style="padding: 10px;">${s.name}</td>
                  <td style="padding: 10px; text-align: center; font-weight: bold; color: ${s.score < 60 ? '#ef4444' : '#10b981'};">${s.score}</td>
                  <td style="padding: 10px; text-align: center;">${s.evaluation}</td>
                </tr>
              `).join('');

            return `
                <div style="margin-bottom: 40px;">
                  <div style="text-align: center; margin-bottom: 20px; border-bottom: 2px solid #e2e8f0; padding-bottom: 15px;">
                    <h2 style="margin: 0 0 5px 0; font-size: 20px;">ห้องเรียน: ${group.className}</h2>
                    <p style="margin: 0; font-size: 14px;">ครูที่ปรึกษา: ${group.teacherName}</p>
                  </div>
                  <table style="width: 100%; border-collapse: collapse;">
                    <thead>
                      <tr style="background: #f8fafc; border-bottom: 2px solid #e2e8f0;">
                         <th style="padding: 10px; text-align: center;">ลำดับ</th>
                         <th style="padding: 10px; text-align: center;">รหัส</th>
                         <th style="padding: 10px; text-align: left;">ชื่อ-นามสกุล</th>
                         <th style="padding: 10px; text-align: center;">คะแนน</th>
                         <th style="padding: 10px; text-align: center;">ผลประเมิน</th>
                      </tr>
                    </thead>
                    <tbody>${rows}</tbody>
                  </table>
                </div>
              `;
          }).join('');

          tempDiv.innerHTML = `
            <div style="text-align: center; margin-bottom: 30px;">
               <h1 style="color: #1e293b; font-size: 24px;">${title}</h1>
            </div>
            ${groupsHtml}
            <div style="margin-top: 20px; text-align: right; border-top: 1px solid #f1f5f9; padding-top: 10px;">
                <p style="margin: 0; color: #94a3b8; font-size: 12px;">สร้างรายงานเมื่อ: ${new Date().toLocaleString('th-TH')}</p>
            </div>
          `;

          document.body.appendChild(tempDiv);
          await new Promise(resolve => setTimeout(resolve, 1000));

          const canvas = await html2canvas(tempDiv, {
            scale: 2, useCORS: true, logging: false, backgroundColor: '#ffffff'
          });

          const link = document.createElement('a');
          link.download = title.replace(/ /g, '_') + '.png';
          link.href = canvas.toDataURL('image/png');
          link.click();

          document.body.removeChild(tempDiv);
          document.body.removeChild(loadingOverlay);
          Swal.fire({ icon: 'success', title: 'สำเร็จ!', text: 'ส่งออกรูปภาพเรียบร้อยแล้ว', timer: 2000, showConfirmButton: false });
        } catch (err) {
          console.error('Image Export error:', err);
          Swal.fire({ icon: 'error', title: 'เกิดข้อผิดพลาด', text: 'ไม่สามารถส่งออกข้อมูลได้: ' + err.message });
        }
      }
    }
  </script>

  <!-- Reporting Modal (Restored & Enhanced) -->
  <div class="student-search-overlay" id="reportModal">
    <div class="report-modal">
      <div class="report-header">
        <h3><i class="fas fa-file-alt"></i> รายงานสรุปคะแนนพฤติกรรม</h3>
        <button class="qr-close-btn" onclick="closeReportModal()"
          style="position: absolute; right: 20px; top: 20px; color: white; background: none; border: none; font-size: 1.5rem; cursor: pointer;">×</button>
      </div>
      <div class="report-body">
        <div class="report-form-group">
          <label>ระดับชั้น <span class="required-indicator" style="color: red;">*</span></label>
          <select class="report-select" id="reportClass"
            style="width: 100%; padding: 10px; border-radius: 8px; border: 1px solid #ccc; margin-bottom: 15px;">
            <!-- Populated by JS -->
          </select>
        </div>
        <div class="report-form-group">
          <label>รายเดือน <span class="required-indicator" style="color: red;">*</span></label>
          <select class="report-select" id="reportMonth"
            style="width: 100%; padding: 10px; border-radius: 8px; border: 1px solid #ccc; margin-bottom: 15px;">
            <option value="all">ทุกเดือน (ทั้งปี)</option>
            <option value="0">มกราคม</option>
            <option value="1">กุมภาพันธ์</option>
            <option value="2">มีนาคม</option>
            <option value="3">เมษายน</option>
            <option value="4">พฤษภาคม</option>
            <option value="5">มิถุนายน</option>
            <option value="6">กรกฎาคม</option>
            <option value="7">สิงหาคม</option>
            <option value="8">กันยายน</option>
            <option value="9">ตุลาคม</option>
            <option value="10">พฤศจิกายน</option>
            <option value="11">ธันวาคม</option>
          </select>
        </div>
        <div class="report-form-group">
          <label>เลือกปีการศึกษา <span class="required-indicator" style="color: red;">*</span></label>
          <select class="report-select" id="reportYear"
            style="width: 100%; padding: 10px; border-radius: 8px; border: 1px solid #ccc; margin-bottom: 15px;">
            <!-- Populated by JS -->
          </select>
        </div>
        <div class="report-form-group">
          <label>สถานะพฤติกรรม <span class="required-indicator" style="color: red;">*</span></label>
          <select class="report-select" id="reportFilter"
            style="width: 100%; padding: 10px; border-radius: 8px; border: 1px solid #ccc; margin-bottom: 20px;">
            <option value="all">ทั้งหมด (ทุกคน)</option>
            <option value="failed">ไม่ผ่านเกณฑ์ (ปรับแก้คะแนนด่วน)</option>
            <option value="passed">ผ่านเกณฑ์ (คะแนนปกติ)</option>
            <option value="excellent">เด็กดีศรีเทพา</option>
          </select>
        </div>

        <div class="report-actions" style="display: flex; gap: 10px;">
          <button class="report-btn btn-image" onclick="exportReport('image')"
            style="flex: 1; padding: 12px; border-radius: 10px; border: none; background: #3b82f6; color: white; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px;">
            <i class="fas fa-image"></i> ส่งออกรูปภาพ
          </button>
          <button class="report-btn btn-pdf" onclick="exportReport('pdf')"
            style="flex: 1; padding: 12px; border-radius: 10px; border: none; background: #ef4444; color: white; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px;">
            <i class="fas fa-file-pdf"></i> ส่งออก PDF
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Photos Manager Modal -->
  <div class="student-search-overlay" id="photosManagerModal">
    <div class="student-search-modal" style="max-width: 900px; max-height: 90vh;">
      <div class="student-search-header"
        style="background: linear-gradient(135deg, #38b2ac, #319795); color: white; border-radius: 20px 20px 0 0;">
        <h3 style="margin: 0;"><i class="fas fa-images"></i> จัดการรูปนักเรียน (edstudent)</h3>
        <button onclick="closePhotosManager()"
          style="background: none; border: none; color: white; font-size: 1.5rem; cursor: pointer;">&times;</button>
      </div>
      <div style="padding: 20px;">
        <div style="display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap;">
          <button class="btn btn-success" onclick="document.getElementById('folderUploadInput').click()">
            <i class="fas fa-folder-open"></i> อัพโหลดโฟลเดอร์
          </button>
          <input type="file" id="folderUploadInput" webkitdirectory directory multiple accept="image/*"
            style="display: none;" onchange="uploadFolderPhotos(this)">
          <button class="btn btn-primary" onclick="loadStudentPhotos()">
            <i class="fas fa-sync"></i> โหลดรูปภาพ
          </button>
          <button class="btn btn-info" onclick="downloadAllPhotos()"
            style="background: linear-gradient(135deg, #f59e0b, #d97706);">
            <i class="fas fa-download"></i> ดาวน์โหลดทั้งหมด
          </button>
          <div id="photosCount" style="display: flex; align-items: center; color: #64748b;">
            รวม: <span id="photosTotal" style="font-weight: bold; margin-left: 5px;">0</span> รูป
          </div>
        </div>
        <div id="uploadProgress"
          style="display: none; margin-bottom: 15px; background: #f0fdf4; padding: 15px; border-radius: 10px; border-left: 4px solid #10b981;">
          <div style="display: flex; align-items: center; gap: 10px;">
            <i class="fas fa-spinner fa-spin" style="color: #10b981;"></i>
            <span id="uploadProgressText">กำลังอัพโหลด...</span>
          </div>
          <div style="background: #e2e8f0; height: 8px; border-radius: 4px; margin-top: 10px; overflow: hidden;">
            <div id="uploadProgressBar"
              style="background: linear-gradient(90deg, #10b981, #059669); height: 100%; width: 0%; transition: width 0.3s;">
            </div>
          </div>
        </div>
        <div id="photosGallery"
          style="display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 15px; max-height: 60vh; overflow-y: auto; padding: 10px;">
          <div style="grid-column: 1/-1; text-align: center; padding: 40px; color: #94a3b8;">
            <i class="fas fa-images" style="font-size: 3rem; margin-bottom: 10px; opacity: 0.5;"></i>
            <p>กดปุ่ม "โหลดรูปภาพ" เพื่อดูรายการ</p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Photo Preview Modal -->
  <div class="student-search-overlay" id="photoPreviewModal" style="z-index: 10000;">
    <div style="background: white; border-radius: 20px; padding: 20px; max-width: 500px; width: 95%;">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
        <h3 style="margin: 0;"><i class="fas fa-user"></i> <span id="previewStudentId">-</span></h3>
        <button onclick="closePhotoPreview()"
          style="background: none; border: none; font-size: 1.5rem; cursor: pointer;">&times;</button>
      </div>
      <img id="previewImage" src="" style="width: 100%; border-radius: 15px; margin-bottom: 15px;">
      <div style="display: flex; gap: 10px;">
        <button class="btn btn-danger" onclick="deleteCurrentPhoto()" style="flex: 1;">
          <i class="fas fa-trash"></i> ลบรูปภาพ
        </button>
        <button class="btn btn-primary" onclick="closePhotoPreview()" style="flex: 1;">
          <i class="fas fa-check"></i> ปิด
        </button>
      </div>
    </div>
  </div>

  <!-- Late Report Modal -->
  <style>
    .rpt-cat-card {
      padding: 14px 10px;
      border-radius: 16px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      border: 2px solid #e2e8f0;
      background: white;
      position: relative;
      overflow: hidden;
    }

    .rpt-cat-card:hover {
      transform: translateY(-3px);
      box-shadow: 0 8px 25px rgba(99, 102, 241, 0.15);
      border-color: #a5b4fc;
    }

    .rpt-cat-card.active {
      border-color: #818cf8 !important;
      background: linear-gradient(135deg, #eef2ff, #e0e7ff) !important;
      box-shadow: 0 4px 20px rgba(99, 102, 241, 0.2);
      transform: translateY(-2px);
    }

    .rpt-cat-card.active .rpt-cat-label {
      color: #4338ca !important;
    }

    .rpt-cat-card .rpt-cat-label {
      font-weight: 700;
      font-size: 0.85rem;
      color: #64748b;
      transition: color 0.3s;
    }

    .rpt-cat-card .rpt-cat-icon {
      font-size: 1.6rem;
      margin-bottom: 4px;
      transition: transform 0.3s;
    }

    .rpt-cat-card:hover .rpt-cat-icon {
      transform: scale(1.15);
    }

    .rpt-filter-select {
      padding: 8px 14px;
      border-radius: 10px;
      border: 1.5px solid #e2e8f0;
      background: #f8fafc;
      font-weight: 500;
      color: #334155;
      font-size: 0.9rem;
      cursor: pointer;
      transition: border-color 0.3s, box-shadow 0.3s;
      outline: none;
    }

    .rpt-filter-select:focus {
      border-color: #818cf8;
      box-shadow: 0 0 0 3px rgba(129, 140, 248, 0.15);
    }

    #lateReportResults::-webkit-scrollbar {
      width: 6px;
    }

    #lateReportResults::-webkit-scrollbar-track {
      background: transparent;
    }

    #lateReportResults::-webkit-scrollbar-thumb {
      background: #cbd5e1;
      border-radius: 3px;
    }

    #lateReportResults::-webkit-scrollbar-thumb:hover {
      background: #94a3b8;
    }

    .rpt-export-btn {
      background: linear-gradient(135deg, #10b981, #059669);
      color: white;
      border: none;
      padding: 10px 18px;
      border-radius: 12px;
      font-weight: 600;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 0.88rem;
      box-shadow: 0 4px 14px rgba(16, 185, 129, 0.3);
      transition: all 0.3s;
    }

    .rpt-export-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(16, 185, 129, 0.4);
    }
  </style>
  <div class="student-search-overlay" id="lateReportModal">
    <div class="student-search-modal"
      style="max-width: 960px; max-height: 92vh; border-radius: 24px; overflow: hidden; box-shadow: 0 25px 60px rgba(0,0,0,0.3);">

      <!-- Header -->
      <div style="
        background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
        padding: 24px 28px;
        display: flex; align-items: center; justify-content: space-between;
        position: relative; overflow: hidden;
      ">
        <div
          style="position: absolute; top: -50%; left: -20%; width: 200px; height: 200px; background: rgba(255,255,255,0.08); border-radius: 50%;">
        </div>
        <div
          style="position: absolute; bottom: -60%; right: -10%; width: 250px; height: 250px; background: rgba(255,255,255,0.05); border-radius: 50%;">
        </div>
        <div style="display: flex; align-items: center; gap: 14px; z-index: 1;">
          <div
            style="width: 48px; height: 48px; background: rgba(255,255,255,0.2); backdrop-filter: blur(10px); border-radius: 14px; display: flex; align-items: center; justify-content: center; font-size: 1.4rem;">
            📊</div>
          <div>
            <h3
              style="margin: 0; color: white; font-size: 1.3rem; font-weight: 700; text-shadow: 0 2px 4px rgba(0,0,0,0.1);">
              สรุปรายงานพฤติกรรม</h3>
            <p style="margin: 2px 0 0; color: rgba(255,255,255,0.75); font-size: 0.82rem;">
              ระบบติดตามและวิเคราะห์พฤติกรรมนักเรียน</p>
          </div>
        </div>
        <button onclick="closeLateReportModal()" style="
          background: rgba(255,255,255,0.15); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.2);
          color: white; width: 40px; height: 40px; border-radius: 12px; font-size: 1.2rem; cursor: pointer;
          display: flex; align-items: center; justify-content: center; transition: all 0.3s; z-index: 1;
        " onmouseover="this.style.background='rgba(255,255,255,0.3)'"
          onmouseout="this.style.background='rgba(255,255,255,0.15)'">&times;</button>
      </div>

      <div style="padding: 24px; background: #f8fafc;">
        <!-- Category Cards -->
        <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-bottom: 20px;"
          id="reportCategoryCards">
          <div class="rpt-cat-card active" data-value="มาสาย" onclick="selectReportCategory(this)">
            <div class="rpt-cat-icon">🕐</div>
            <div class="rpt-cat-label">มาสาย</div>
          </div>
          <div class="rpt-cat-card" data-value="บุหรี่" onclick="selectReportCategory(this)">
            <div class="rpt-cat-icon">🚬</div>
            <div class="rpt-cat-label">บุหรี่</div>
          </div>
          <div class="rpt-cat-card" data-value="บุหรี่ไฟฟ้า" onclick="selectReportCategory(this)">
            <div class="rpt-cat-icon">⚡</div>
            <div class="rpt-cat-label">บุหรี่ไฟฟ้า</div>
          </div>
          <div class="rpt-cat-card" data-value="โดดเรียน" onclick="selectReportCategory(this)">
            <div class="rpt-cat-icon">🏃</div>
            <div class="rpt-cat-label">โดดเรียน</div>
          </div>
        </div>

        <!-- Hidden select -->
        <select id="lateReportCategory" style="display: none;">
          <option value="มาสาย" selected>มาสาย</option>
          <option value="บุหรี่">บุหรี่</option>
          <option value="บุหรี่ไฟฟ้า">บุหรี่ไฟฟ้า</option>
          <option value="โดดเรียน">โดดเรียน</option>
        </select>

        <!-- Filter Bar -->
        <div style="
          display: flex; gap: 12px; align-items: center; flex-wrap: wrap;
          background: white; padding: 16px 20px; border-radius: 16px;
          box-shadow: 0 2px 12px rgba(0,0,0,0.04); border: 1px solid #e2e8f0; margin-bottom: 20px;
        ">
          <div style="display: flex; align-items: center; gap: 8px;">
            <i class="fas fa-calendar-alt" style="color: #818cf8;"></i>
            <select id="lateReportMonth" onchange="loadLateReport()" class="rpt-filter-select">
              <option value="">ทุกเดือน</option>
              <option value="1">มกราคม</option>
              <option value="2">กุมภาพันธ์</option>
              <option value="3">มีนาคม</option>
              <option value="4">เมษายน</option>
              <option value="5">พฤษภาคม</option>
              <option value="6">มิถุนายน</option>
              <option value="7">กรกฎาคม</option>
              <option value="8">สิงหาคม</option>
              <option value="9">กันยายน</option>
              <option value="10">ตุลาคม</option>
              <option value="11">พฤศจิกายน</option>
              <option value="12">ธันวาคม</option>
            </select>
          </div>
          <div style="display: flex; align-items: center; gap: 8px;">
            <i class="fas fa-layer-group" style="color: #818cf8;"></i>
            <select id="lateReportYear" onchange="loadLateReport()" class="rpt-filter-select">
              <option value="2567">พ.ศ. 2567</option>
              <option value="2568">พ.ศ. 2568</option>
              <option value="2569">พ.ศ. 2569</option>
            </select>
          </div>
          <div style="margin-left: auto; display: flex; gap: 10px; align-items: center;">
            <span id="lateReportCount" style="
              background: linear-gradient(135deg, #fef3c7, #fde68a); color: #92400e;
              padding: 8px 18px; border-radius: 30px; font-weight: 700; font-size: 0.9rem;
              box-shadow: 0 2px 8px rgba(245,158,11,0.15);
            ">รวม: 0 ครั้ง</span>
            <button onclick="exportLateReportToExcel()" class="rpt-export-btn">
              <i class="fas fa-file-excel"></i> ส่งออก Excel
            </button>
          </div>
        </div>

        <!-- Results -->
        <div id="lateReportResults" style="
          max-height: 50vh; overflow-y: auto; border-radius: 16px;
          background: white; box-shadow: 0 2px 12px rgba(0,0,0,0.04); border: 1px solid #e2e8f0;
        ">
          <div style="text-align: center; padding: 50px 20px; color: #94a3b8;">
            <div
              style="width: 80px; height: 80px; background: linear-gradient(135deg, #eef2ff, #e0e7ff); border-radius: 20px; display: flex; align-items: center; justify-content: center; margin: 0 auto 15px; font-size: 2rem;">
              📋</div>
            <p style="font-weight: 600; color: #64748b; margin-bottom: 4px;">เลือกประเภทและเดือน</p>
            <p style="font-size: 0.85rem;">เพื่อดูรายงานพฤติกรรมนักเรียน</p>
          </div>
        </div>
      </div>
    </div>
  </div>


  <script>
    // Photos Manager Functions
    let currentPreviewStudentId = null;

    function openPhotosManager() {
      document.getElementById('photosManagerModal').classList.add('show');
      loadStudentPhotos();
    }

    function closePhotosManager() {
      document.getElementById('photosManagerModal').classList.remove('show');
    }

    async function loadStudentPhotos() {
      const gallery = document.getElementById('photosGallery');
      gallery.innerHTML = '<div style="grid-column: 1/-1; text-align: center; padding: 40px;"><i class="fas fa-spinner fa-spin" style="font-size: 2rem; color: #38b2ac;"></i><p>กำลังโหลด...</p></div>';

      try {
        const response = await fetch('/api/list-student-photos');
        const result = await response.json();

        if (result.status === 'success') {
          const photos = result.photos;
          document.getElementById('photosTotal').textContent = photos.length;

          if (photos.length === 0) {
            gallery.innerHTML = '<div style="grid-column: 1/-1; text-align: center; padding: 40px; color: #94a3b8;"><i class="fas fa-folder-open" style="font-size: 3rem; margin-bottom: 10px; opacity: 0.5;"></i><p>ไม่พบรูปภาพในโฟลเดอร์ edstudent</p></div>';
            return;
          }

          gallery.innerHTML = photos.map(photo => `
            <div class="photo-card" onclick="previewPhoto('${photo.student_id}', '${photo.path}')" 
                 style="background: #f8fafc; border-radius: 12px; overflow: hidden; cursor: pointer; transition: all 0.3s; border: 2px solid transparent;">
              <img src="${photo.path}" style="width: 100%; height: 150px; object-fit: cover;" onerror="this.src='data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><rect fill=%22%23e2e8f0%22 width=%22100%22 height=%22100%22/><text x=%2250%22 y=%2255%22 text-anchor=%22middle%22 fill=%22%2394a3b8%22 font-size=%2212%22>No Image</text></svg>'">
              <div style="padding: 10px; text-align: center;">
                <div style="font-weight: 600; color: #1e293b;">${photo.student_id}</div>
                <div style="font-size: 0.75rem; color: #94a3b8;">${formatFileSize(photo.size)}</div>
              </div>
            </div>
          `).join('');

        } else {
          throw new Error(result.message || 'Failed to load photos');
        }
      } catch (error) {
        console.error('Load photos error:', error);
        gallery.innerHTML = `<div style="grid-column: 1/-1; text-align: center; padding: 40px; color: #ef4444;"><i class="fas fa-exclamation-circle" style="font-size: 3rem; margin-bottom: 10px;"></i><p>เกิดข้อผิดพลาด: ${error.message}</p></div>`;
      }
    }

    function formatFileSize(bytes) {
      if (bytes < 1024) return bytes + ' B';
      if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
      return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
    }

    function previewPhoto(studentId, imagePath) {
      currentPreviewStudentId = studentId;
      document.getElementById('previewStudentId').textContent = 'รหัส: ' + studentId;
      document.getElementById('previewImage').src = imagePath;
      document.getElementById('photoPreviewModal').classList.add('show');
    }

    function closePhotoPreview() {
      document.getElementById('photoPreviewModal').classList.remove('show');
      currentPreviewStudentId = null;
    }

    async function deleteCurrentPhoto() {
      if (!currentPreviewStudentId) return;

      const confirmed = await Swal.fire({
        icon: 'warning',
        title: 'ยืนยันการลบ',
        text: `ต้องการลบรูปของรหัส ${currentPreviewStudentId} หรือไม่?`,
        showCancelButton: true,
        confirmButtonColor: '#ef4444',
        confirmButtonText: 'ลบ',
        cancelButtonText: 'ยกเลิก'
      });

      if (!confirmed.isConfirmed) return;

      try {
        const response = await fetch('/api/delete-student-photo', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ student_id: currentPreviewStudentId })
        });

        const result = await response.json();

        if (result.status === 'success') {
          showToast('success', 'ลบรูปภาพเรียบร้อยแล้ว');
          closePhotoPreview();
          loadStudentPhotos();
        } else {
          throw new Error(result.message || 'Failed to delete');
        }
      } catch (error) {
        Swal.fire({ icon: 'error', title: 'ลบไม่สำเร็จ', text: error.message });
      }
    }

    // Upload folder photos function
    async function uploadFolderPhotos(input) {
      const files = Array.from(input.files).filter(f => /\.(jpg|jpeg|png|gif)$/i.test(f.name));

      if (files.length === 0) {
        Swal.fire({ icon: 'warning', title: 'ไม่พบรูปภาพ', text: 'ไม่พบไฟล์รูปภาพ (jpg, png, gif) ในโฟลเดอร์ที่เลือก' });
        input.value = '';
        return;
      }

      // Show progress
      const progressDiv = document.getElementById('uploadProgress');
      const progressText = document.getElementById('uploadProgressText');
      const progressBar = document.getElementById('uploadProgressBar');
      progressDiv.style.display = 'block';
      progressBar.style.width = '0%';

      let success = 0;
      let failed = 0;

      for (let i = 0; i < files.length; i++) {
        const file = files[i];
        // Use filename (without extension) as student ID
        const studentId = file.name.replace(/\.(jpg|jpeg|png|gif)$/i, '');

        progressText.textContent = `กำลังอัพโหลด ${i + 1}/${files.length}: ${studentId}`;
        progressBar.style.width = `${((i + 1) / files.length) * 100}%`;

        try {
          // Read file as base64
          const base64 = await new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = () => resolve(reader.result);
            reader.onerror = reject;
            reader.readAsDataURL(file);
          });

          // Upload to server
          const response = await fetch('/api/upload-student-profile', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              student_id: studentId,
              image_data: base64
            })
          });

          const result = await response.json();
          if (result.status === 'success') {
            success++;
          } else {
            failed++;
          }
        } catch (error) {
          console.error(`Failed to upload ${studentId}:`, error);
          failed++;
        }
      }

      // Hide progress
      progressDiv.style.display = 'none';
      input.value = '';

      // Show result
      Swal.fire({
        icon: failed === 0 ? 'success' : 'info',
        title: 'อัพโหลดเสร็จสิ้น',
        html: `สำเร็จ: <strong>${success}</strong> รูป<br>ล้มเหลว: <strong>${failed}</strong> รูป`
      });

      // Refresh gallery
      loadStudentPhotos();
    }

    // Download all photos as ZIP function
    async function downloadAllPhotos() {
      const progressDiv = document.getElementById('uploadProgress');
      const progressText = document.getElementById('uploadProgressText');
      const progressBar = document.getElementById('uploadProgressBar');

      try {
        // First, get list of photos
        progressDiv.style.display = 'block';
        progressText.textContent = 'กำลังดึงรายการรูปภาพ...';
        progressBar.style.width = '0%';

        const response = await fetch('/api/list-student-photos');
        const result = await response.json();

        if (result.status !== 'success' || !result.photos || result.photos.length === 0) {
          progressDiv.style.display = 'none';
          Swal.fire({ icon: 'warning', title: 'ไม่พบรูปภาพ', text: 'ไม่มีรูปภาพในโฟลเดอร์ edstudent' });
          return;
        }

        const photos = result.photos;
        const zip = new JSZip();
        const folder = zip.folder('edstudent');
        let added = 0;

        for (let i = 0; i < photos.length; i++) {
          const photo = photos[i];
          progressText.textContent = `กำลังเตรียมไฟล์ ${i + 1}/${photos.length}: ${photo.student_id}`;
          progressBar.style.width = `${((i + 1) / photos.length) * 80}%`;

          try {
            // Fetch image
            const imgResponse = await fetch(photo.path);
            const blob = await imgResponse.blob();

            // Add to ZIP
            folder.file(photo.filename, blob);
            added++;
          } catch (err) {
            console.error(`Failed to add ${photo.student_id}:`, err);
          }
        }

        // Generate ZIP
        progressText.textContent = 'กำลังสร้างไฟล์ ZIP...';
        progressBar.style.width = '90%';

        const zipBlob = await zip.generateAsync({ type: 'blob' });

        // Download ZIP
        progressText.textContent = 'กำลังดาวน์โหลด...';
        progressBar.style.width = '100%';

        const url = URL.createObjectURL(zipBlob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `edstudent_${new Date().toISOString().slice(0, 10)}.zip`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);

        progressDiv.style.display = 'none';

        Swal.fire({
          icon: 'success',
          title: 'ดาวน์โหลดเสร็จสิ้น',
          text: `สร้างไฟล์ ZIP สำเร็จ (${added} รูป)`
        });

      } catch (error) {
        progressDiv.style.display = 'none';
        Swal.fire({ icon: 'error', title: 'เกิดข้อผิดพลาด', text: error.message });
      }
    }

    // Late Report Functions
    function openLateReportModal() {
      document.getElementById('lateReportModal').classList.add('show');
      // Set default month to current month
      const now = new Date();
      document.getElementById('lateReportMonth').value = now.getMonth() + 1;
      // Set default year to current Buddhist year
      const buddhistYear = now.getFullYear() + 543;
      const yearSelect = document.getElementById('lateReportYear');
      // Find and select the closest year option
      for (let opt of yearSelect.options) {
        if (parseInt(opt.value) === buddhistYear) {
          opt.selected = true;
          break;
        }
      }
      loadLateReport();
    }

    function closeLateReportModal() {
      document.getElementById('lateReportModal').classList.remove('show');
    }

    function selectReportCategory(el) {
      document.querySelectorAll('.rpt-cat-card').forEach(c => c.classList.remove('active'));
      el.classList.add('active');
      document.getElementById('lateReportCategory').value = el.dataset.value;
      loadLateReport();
    }

    function getFilterKeywords(category) {
      const map = {
        'มาสาย': ['มาสาย', 'late'],
        'บุหรี่': ['สูบบุหรี่', 'บุหรี่'],
        'บุหรี่ไฟฟ้า': ['บุหรี่ไฟฟ้า'],
        'โดดเรียน': ['โดดเรียน', 'หนีเรียน']
      };
      return map[category] || [category];
    }

    async function exportLateReportToExcel() {
      const month = document.getElementById('lateReportMonth').value;
      const yearBE = parseInt(document.getElementById('lateReportYear').value);
      const yearCE = yearBE - 543;
      const category = document.getElementById('lateReportCategory').value;
      const keywords = getFilterKeywords(category);

      try {
        const response = await fetch('log.json?v=' + Date.now());
        const logs = await response.json();

        // Filter by category keywords
        let lateEntries = logs.filter(log => {
          const reason = (log.reason || '');
          return keywords.some(kw => reason.includes(kw));
        });

        // Filter by month and year
        if (month || yearBE) {
          lateEntries = lateEntries.filter(log => {
            const logDate = new Date(log.timestamp);
            if (month && (logDate.getMonth() + 1) !== parseInt(month)) return false;
            if (yearBE && logDate.getFullYear() !== yearCE) return false;
            return true;
          });
        }

        if (lateEntries.length === 0) {
          Swal.fire({ icon: 'warning', title: 'ไม่มีข้อมูล', text: `ไม่พบข้อมูล "${category}" ในเดือนที่เลือก` });
          return;
        }

        // Group by student
        const studentMap = {};
        lateEntries.forEach(entry => {
          const id = entry.student_id;
          if (!studentMap[id]) {
            studentMap[id] = { name: entry.student_name, count: 0, lastDate: entry.timestamp };
          }
          studentMap[id].count++;
          if (new Date(entry.timestamp) > new Date(studentMap[id].lastDate)) {
            studentMap[id].lastDate = entry.timestamp;
          }
        });

        // Convert to array
        const studentList = Object.entries(studentMap)
          .map(([id, data]) => ({ id, ...data }))
          .sort((a, b) => b.count - a.count);

        // Prepare Excel data
        const monthNames = ['', 'มกราคม', 'กุมภาพันธ์', 'มีนาคม', 'เมษายน', 'พฤษภาคม', 'มิถุนายน', 'กรกฎาคม', 'สิงหาคม', 'กันยายน', 'ตุลาคม', 'พฤศจิกายน', 'ธันวาคม'];
        const monthName = month ? monthNames[parseInt(month)] : 'ทั้งหมด';
        const sheetName = `รายงาน${category}`;

        const excelData = studentList.map((s, i) => ({
          'ลำดับ': i + 1,
          'รหัสนักเรียน': s.id,
          'ชื่อ-นามสกุล': s.name,
          'จำนวนครั้ง': s.count,
          'วันที่ล่าสุด': new Date(s.lastDate).toLocaleDateString('th-TH')
        }));

        // Create workbook
        const wb = XLSX.utils.book_new();
        const ws = XLSX.utils.json_to_sheet(excelData);

        // Set column widths
        ws['!cols'] = [
          { wch: 8 },   // ลำดับ
          { wch: 15 },  // รหัส
          { wch: 30 },  // ชื่อ
          { wch: 12 },  // จำนวน
          { wch: 15 }   // วันที่
        ];

        XLSX.utils.book_append_sheet(wb, ws, sheetName);

        // Generate filename
        const filename = `รายงาน${category}_${monthName}_${yearBE}.xlsx`;
        XLSX.writeFile(wb, filename);

        Swal.fire({ icon: 'success', title: 'ส่งออกสำเร็จ', text: `บันทึกไฟล์ ${filename}` });

      } catch (error) {
        console.error('Export error:', error);
        Swal.fire({ icon: 'error', title: 'เกิดข้อผิดพลาด', text: error.message });
      }
    }

    async function loadLateReport() {
      const resultsDiv = document.getElementById('lateReportResults');
      const countSpan = document.getElementById('lateReportCount');
      const month = document.getElementById('lateReportMonth').value;
      const yearBE = parseInt(document.getElementById('lateReportYear').value);
      const yearCE = yearBE - 543; // Convert to Christian Era

      resultsDiv.innerHTML = '<div style="text-align: center; padding: 40px;"><i class="fas fa-spinner fa-spin" style="font-size: 2rem; color: #f59e0b;"></i><p>กำลังโหลดข้อมูล...</p></div>';

      try {
        const response = await fetch('log.json?v=' + Date.now());
        const logs = await response.json();

        // Filter by selected category
        const category = document.getElementById('lateReportCategory').value;
        const keywords = getFilterKeywords(category);
        let lateEntries = logs.filter(log => {
          const reason = (log.reason || '');
          return keywords.some(kw => reason.includes(kw));
        });

        // Filter by month and year
        if (month || yearBE) {
          lateEntries = lateEntries.filter(log => {
            const logDate = new Date(log.timestamp);
            if (month && (logDate.getMonth() + 1) !== parseInt(month)) return false;
            if (yearBE && logDate.getFullYear() !== yearCE) return false;
            return true;
          });
        }

        // Sort by date descending
        lateEntries.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

        countSpan.textContent = `รวม: ${lateEntries.length} ครั้ง`;

        if (lateEntries.length === 0) {
          resultsDiv.innerHTML = `
            <div style="text-align: center; padding: 40px; color: #94a3b8;">
              <i class="fas fa-check-circle" style="font-size: 3rem; margin-bottom: 10px; color: #10b981;"></i>
              <p>ไม่พบข้อมูล "${category}" ในเดือนที่เลือก</p>
            </div>
          `;
          return;
        }

        // Group by student
        const studentMap = {};
        lateEntries.forEach(entry => {
          const id = entry.student_id;
          if (!studentMap[id]) {
            studentMap[id] = {
              name: entry.student_name,
              count: 0,
              entries: []
            };
          }
          studentMap[id].count++;
          studentMap[id].entries.push(entry);
        });

        // Convert to array and sort by count
        const studentList = Object.entries(studentMap)
          .map(([id, data]) => ({ id, ...data }))
          .sort((a, b) => b.count - a.count);

        // Build table HTML
        const categoryIcons = { 'มาสาย': '🕐', 'บุหรี่': '🚬', 'บุหรี่ไฟฟ้า': '⚡', 'โดดเรียน': '🏃' };
        const catIcon = categoryIcons[category] || '📋';
        let html = `
          <table style="width: 100%; border-collapse: separate; border-spacing: 0;">
            <thead>
              <tr style="background: linear-gradient(135deg, #667eea, #764ba2); color: white;">
                <th style="padding: 14px 16px; text-align: center; font-size: 0.85rem; font-weight: 600; letter-spacing: 0.5px;">#</th>
                <th style="padding: 14px 16px; text-align: left; font-size: 0.85rem; font-weight: 600; letter-spacing: 0.5px;">รหัส</th>
                <th style="padding: 14px 16px; text-align: left; font-size: 0.85rem; font-weight: 600; letter-spacing: 0.5px;">ชื่อ-นามสกุล</th>
                <th style="padding: 14px 16px; text-align: center; font-size: 0.85rem; font-weight: 600; letter-spacing: 0.5px;">จำนวนครั้ง</th>
                <th style="padding: 14px 16px; text-align: left; font-size: 0.85rem; font-weight: 600; letter-spacing: 0.5px;">วันที่ล่าสุด</th>
              </tr>
            </thead>
            <tbody>
        `;

        studentList.forEach((student, index) => {
          const latestDate = new Date(student.entries[0].timestamp).toLocaleDateString('th-TH', {
            day: 'numeric', month: 'short', year: 'numeric'
          });
          const countColor = student.count >= 5 ? 'linear-gradient(135deg, #ef4444, #dc2626)' : (student.count >= 3 ? 'linear-gradient(135deg, #f59e0b, #d97706)' : 'linear-gradient(135deg, #10b981, #059669)');
          const rankBg = index === 0 ? 'linear-gradient(135deg, #fbbf24, #f59e0b)' : (index === 1 ? 'linear-gradient(135deg, #94a3b8, #64748b)' : (index === 2 ? 'linear-gradient(135deg, #d97706, #b45309)' : 'none'));
          const rankColor = index < 3 ? 'white' : '#64748b';

          html += `
            <tr style="border-bottom: 1px solid #f1f5f9; transition: all 0.2s;" onmouseover="this.style.background='#f8fafc'" onmouseout="this.style.background='white'">
              <td style="padding: 14px 16px; text-align: center;">
                <span style="
                  display: inline-flex; align-items: center; justify-content: center;
                  width: 30px; height: 30px; border-radius: 10px;
                  background: ${rankBg}; color: ${rankColor};
                  font-weight: 700; font-size: 0.85rem;
                  ${index < 3 ? 'box-shadow: 0 2px 8px rgba(0,0,0,0.15);' : ''}
                ">${index + 1}</span>
              </td>
              <td style="padding: 14px 16px; font-family: 'Courier New', monospace; font-size: 0.9rem; color: #475569;">${student.id}</td>
              <td style="padding: 14px 16px; font-weight: 600; color: #1e293b;">
                <div style="display: flex; align-items: center; gap: 8px;">
                  <span>${student.name}</span>
                </div>
              </td>
              <td style="padding: 14px 16px; text-align: center;">
                <span style="
                  background: ${countColor}; color: white;
                  padding: 5px 16px; border-radius: 20px;
                  font-weight: 700; font-size: 0.9rem;
                  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
                  display: inline-block;
                ">${student.count}</span>
              </td>
              <td style="padding: 14px 16px; color: #64748b; font-size: 0.9rem;">
                <i class="fas fa-calendar-day" style="margin-right: 6px; color: #a5b4fc;"></i>${latestDate}
              </td>
            </tr>
          `;
        });

        html += `</tbody></table>`;
        resultsDiv.innerHTML = html;

      } catch (error) {
        console.error('Load late report error:', error);
        resultsDiv.innerHTML = `
          <div style="text-align: center; padding: 40px; color: #ef4444;">
            <i class="fas fa-exclamation-circle" style="font-size: 3rem; margin-bottom: 10px;"></i>
            <p>เกิดข้อผิดพลาด: ${error.message}</p>
          </div>
        `;
      }
    }

    // Add hover effect via JS
    document.head.insertAdjacentHTML('beforeend', `
      <style>
        .photo-card:hover {
          transform: translateY(-5px);
          border-color: #38b2ac !important;
          box-shadow: 0 10px 25px rgba(56, 178, 172, 0.2);
        }
      </style>
    `);
  </script>

</body>


</html>
