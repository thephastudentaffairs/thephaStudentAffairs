<!DOCTYPE html>
<html lang="th">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>จัดการข้อมูลนักเรียน</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.1/jspdf.plugin.autotable.min.js"></script>
  <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
  <script src="https://unpkg.com/jsqr@1.4.0/dist/jsQR.js"></script>
  <script>
    // Authentication check - redirect to login if not authenticated as admin
    (function () {
      const currentUser = sessionStorage.getItem('currentUser');
      if (!currentUser) {
        window.location.href = 'index.html';
        return;
      }

      try {
        const user = JSON.parse(currentUser);
        if (user.role !== 'admin') {
          window.location.href = 'index.html';
          return;
        }
      } catch (e) {
        window.location.href = 'index.html';
        return;
      }
    })();
  </script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Sarabun', Arial, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
    }

    .header {
      background: white;
      padding: 30px;
      border-radius: 15px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
      margin-bottom: 30px;
      text-align: center;
    }

    .header h1 {
      color: #667eea;
      font-size: 2em;
      margin-bottom: 10px;
    }

    .card {
      background: white;
      border-radius: 15px;
      padding: 25px;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
      margin-bottom: 20px;
    }

    .card h2 {
      color: #333;
      margin-bottom: 20px;
      padding-bottom: 10px;
      border-bottom: 2px solid #f0f0f0;
    }

    .btn-group {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-bottom: 20px;
    }

    code {
      background: #f0f0f0;
      padding: 2px 6px;
      border-radius: 4px;
      font-family: 'Courier New', monospace;
      font-size: 0.9em;
    }

    .btn {
      padding: 12px 24px;
      border: none;
      border-radius: 10px;
      font-size: 1em;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      display: flex;
      align-items: center;
      gap: 8px;
      font-family: inherit;
    }

    .btn-primary {
      background: linear-gradient(135deg, #667eea, #764ba2);
      color: white;
    }

    .btn-success {
      background: linear-gradient(135deg, #48bb78, #38a169);
      color: white;
    }

    .btn-danger {
      background: linear-gradient(135deg, #f56565, #e53e3e);
      color: white;
    }

    .btn-warning {
      background: linear-gradient(135deg, #ed8936, #dd6b20);
      color: white;
    }

    .btn-info {
      background: linear-gradient(135deg, #4299e1, #3182ce);
      color: white;
    }

    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
    }

    .btn-sm {
      padding: 6px 12px;
      font-size: 0.85em;
    }

    .status-box {
      padding: 15px;
      border-radius: 10px;
      margin-bottom: 15px;
      display: none;
    }

    .status-box.show {
      display: block;
    }

    .status-success {
      background: #d4edda;
      border: 1px solid #c3e6cb;
      color: #155724;
    }

    .status-error {
      background: #f8d7da;
      border: 1px solid #f5c6cb;
      color: #721c24;
    }

    .status-info {
      background: #d1ecf1;
      border: 1px solid #bee5eb;
      color: #0c5460;
    }

    .status-warning {
      background: #fff3cd;
      border: 1px solid #ffc107;
      color: #856404;
    }

    .search-box {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      flex-wrap: wrap;
      align-items: center;
    }

    .search-input-container {
      flex: 1;
      min-width: 250px;
      position: relative;
    }

    .search-box input[type="text"] {
      width: 100%;
      padding: 12px 15px;
      border: 2px solid #e2e8f0;
      border-radius: 10px;
      font-size: 1em;
      font-family: inherit;
      box-sizing: border-box;
    }

    .search-box input[type="text"]:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.15);
    }

    .class-filter {
      padding: 12px 15px;
      border: 2px solid #e2e8f0;
      border-radius: 10px;
      font-size: 1em;
      font-family: inherit;
      background: white;
      min-width: 120px;
      cursor: pointer;
    }

    .class-filter:focus {
      outline: none;
      border-color: #667eea;
    }

    .table-container {
      overflow-x: auto;
      margin-top: 15px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
    }

    th,
    td {
      padding: 12px;
      text-align: left;
      border-bottom: 1px solid #e2e8f0;
    }

    th {
      background: #f7fafc;
      font-weight: 600;
      color: #4a5568;
      position: sticky;
      top: 0;
    }

    tbody tr:hover {
      background: #f7fafc;
    }

    .score-input {
      width: 80px;
      padding: 6px 10px;
      border: 2px solid #e2e8f0;
      border-radius: 5px;
      font-size: 1em;
      text-align: center;
      font-weight: 600;
    }

    .score-input:focus {
      outline: none;
      border-color: #667eea;
    }

    .score-input.changed {
      border-color: #ed8936;
      background: #fffaf0;
    }

    .score-badge {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 20px;
      font-weight: 600;
      font-size: 0.9em;
    }

    .score-high {
      background: #c6f6d5;
      color: #22543d;
    }

    .score-medium {
      background: #feebc8;
      color: #7c2d12;
    }

    .score-low {
      background: #fed7d7;
      color: #742a2a;
    }

    .status-badge {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 20px;
      font-weight: 600;
      font-size: 0.85em;
    }

    .status-normal {
      background: #c6f6d5;
      color: #22543d;
    }

    .status-absent {
      background: #fed7d7;
      color: #742a2a;
    }

    .action-buttons {
      display: flex;
      gap: 5px;
    }

    .adjust-input {
      width: 70px;
      padding: 6px 8px;
      border: 2px solid #e2e8f0;
      border-radius: 5px;
      font-size: 0.9em;
      text-align: center;
      font-weight: 600;
    }

    .adjust-input:focus {
      outline: none;
      border-color: #667eea;
    }

    .adjust-input.positive {
      border-color: #48bb78;
      background: #f0fff4;
    }

    .adjust-input.negative {
      border-color: #f56565;
      background: #fff5f5;
    }

    .score-cell {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .score-result {
      font-weight: 700;
      font-size: 1.1em;
      min-width: 40px;
      text-align: center;
    }

    .score-result.changed {
      color: #ed8936;
    }

    .upload-area {
      border: 3px dashed #cbd5e0;
      border-radius: 15px;
      padding: 40px 20px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s;
      background: #f7fafc;
    }

    .upload-area:hover {
      border-color: #667eea;
      background: #edf2f7;
    }

    .upload-area.dragover {
      border-color: #667eea;
      background: #e8ecff;
    }

    /* Modal */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.7);
      z-index: 1000;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }

    .modal.show {
      display: flex;
    }

    .modal-content {
      background: white;
      border-radius: 20px;
      padding: 30px;
      max-width: 500px;
      width: 100%;
      animation: slideDown 0.3s;
    }

    @keyframes slideDown {
      from {
        opacity: 0;
        transform: translateY(-50px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 15px;
      border-bottom: 2px solid #f0f0f0;
    }

    .modal-header h3 {
      color: #667eea;
      font-size: 1.5em;
    }

    .close-btn {
      background: none;
      border: none;
      font-size: 1.5em;
      color: #999;
      cursor: pointer;
      transition: color 0.3s;
    }

    .close-btn:hover {
      color: #333;
    }

    /* Action Buttons from th.html */
    .action-btn {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 6px;
      padding: 14px 24px;
      border-radius: 16px;
      font-weight: 600;
      font-size: 0.9rem;
      cursor: pointer;
      border: none;
      transition: all 0.3s ease;
      text-decoration: none;
      color: white;
    }

    .action-btn .btn-icon {
      width: 40px;
      height: 40px;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.2rem;
      background: rgba(255, 255, 255, 0.25);
      transition: all 0.3s ease;
    }

    .btn-enter-id {
      background: linear-gradient(135deg, #10b981, #059669);
      box-shadow: 0 4px 15px rgba(16, 185, 129, 0.4);
    }

    .btn-enter-id:hover {
      transform: translateY(-3px);
      box-shadow: 0 8px 25px rgba(16, 185, 129, 0.5);
    }

    .btn-camera {
      background: linear-gradient(135deg, #6366f1, #8b5cf6);
      box-shadow: 0 4px 15px rgba(99, 102, 241, 0.4);
    }

    .btn-camera:hover {
      transform: translateY(-3px);
      box-shadow: 0 8px 25px rgba(99, 102, 241, 0.5);
    }

    .btn-scan-qr {
      background: linear-gradient(135deg, #f59e0b, #d97706);
      box-shadow: 0 4px 15px rgba(245, 158, 11, 0.4);
    }

    .btn-scan-qr:hover {
      transform: translateY(-3px);
      box-shadow: 0 8px 25px rgba(245, 158, 11, 0.5);
    }

    .btn-search-all {
      background: linear-gradient(135deg, #10b981, #059669);
      box-shadow: 0 4px 15px rgba(16, 185, 129, 0.4);
    }

    .btn-search-all:hover {
      transform: translateY(-3px);
      box-shadow: 0 8px 25px rgba(16, 185, 129, 0.5);
    }

    /* Student Search Modal */
    .student-search-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.7);
      backdrop-filter: blur(8px);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 2000;
    }

    .student-search-overlay.show {
      display: flex;
    }

    .student-search-modal {
      background: white;
      border-radius: 20px;
      width: 95%;
      max-width: 600px;
      max-height: 85vh;
      display: flex;
      flex-direction: column;
      box-shadow: 0 25px 50px rgba(0, 0, 0, 0.3);
    }

    .student-search-header {
      padding: 20px 25px;
      border-bottom: 1px solid #e2e8f0;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .student-search-results {
      flex: 1;
      overflow-y: auto;
      padding: 15px 25px;
      max-height: 400px;
    }

    .student-search-item {
      display: flex;
      align-items: center;
      padding: 14px 16px;
      border-radius: 12px;
      background: #f8fafc;
      margin-bottom: 10px;
      cursor: pointer;
      transition: all 0.3s;
      border: 2px solid transparent;
    }

    .student-search-item:hover {
      background: #ecfdf5;
      border-color: #10b981;
    }

    .student-search-item-info {
      flex: 1;
    }

    .student-search-item-name {
      font-weight: 600;
      color: #1e293b;
    }

    .student-search-item-meta {
      font-size: 0.85rem;
      color: #64748b;
    }

    /* QR Scanner Modal */
    .qr-scanner-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.9);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 2000;
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s ease;
    }

    .qr-scanner-overlay.show {
      opacity: 1;
      visibility: visible;
    }

    /* Manual Input Modal */
    .manual-input-modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.6);
      backdrop-filter: blur(5px);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 3000;
    }

    .manual-input-modal.show {
      display: flex;
    }

    .manual-input-content {
      background: white;
      padding: 30px;
      border-radius: 24px;
      width: 90%;
      max-width: 400px;
      text-align: center;
      box-shadow: 0 20px 50px rgba(0, 0, 0, 0.2);
    }

    /* Deduction Reasons Checkbox Grid */
    .deduction-reasons-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 8px;
      max-height: 250px;
      overflow-y: auto;
      padding: 12px;
      background: #f8fafc;
      border-radius: 12px;
      border: 2px solid #e2e8f0;
    }

    .deduction-checkbox-item {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 10px;
      background: white;
      border-radius: 8px;
      cursor: pointer;
      border: 1px solid #e2e8f0;
    }

    .deduction-checkbox-item.checked {
      border-color: #ef4444;
      background: #fef2f2;
    }


    .form-group {
      margin-bottom: 20px;
    }

    .form-group label {
      display: block;
      color: #333;
      font-weight: 600;
      margin-bottom: 8px;
    }

    .form-group input,
    .form-group textarea {
      width: 100%;
      padding: 12px;
      border: 2px solid #e2e8f0;
      border-radius: 10px;
      font-size: 1em;
      font-family: inherit;
    }

    .form-group input:focus,
    .form-group textarea:focus {
      outline: none;
      border-color: #667eea;
    }

    .info-display {
      background: #f7fafc;
      padding: 12px;
      border-radius: 8px;
      margin-bottom: 15px;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin-bottom: 20px;
    }

    .stat-card {
      background: #f7fafc;
      padding: 15px;
      border-radius: 10px;
      text-align: center;
    }

    .stat-card .label {
      color: #718096;
      font-size: 0.9em;
      margin-bottom: 5px;
    }

    .stat-card .value {
      color: #667eea;
      font-size: 1.8em;
      font-weight: bold;
    }

    /* Search Input Container */
    .search-input-container {
      position: relative;
      flex: 1;
    }

    .search-input-container input {
      width: 100%;
      padding: 12px;
      border: 2px solid #e2e8f0;
      border-radius: 10px;
      font-size: 1em;
      font-family: inherit;
    }

    .search-input-container input:focus {
      outline: none;
      border-color: #667eea;
    }

    .search-dropdown {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: white;
      border: 2px solid #667eea;
      border-top: none;
      border-radius: 0 0 10px 10px;
      max-height: 300px;
      overflow-y: auto;
      z-index: 1000;
      display: none;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.15);
    }

    .search-dropdown.show {
      display: block;
    }

    .dropdown-item {
      padding: 12px 15px;
      cursor: pointer;
      border-bottom: 1px solid #f0f0f0;
      display: flex;
      justify-content: space-between;
      align-items: center;
      transition: background 0.2s;
    }

    .dropdown-item:hover {
      background: #f7fafc;
    }

    .dropdown-item:last-child {
      border-bottom: none;
    }

    .dropdown-item .student-info {
      display: flex;
      flex-direction: column;
    }

    .dropdown-item .student-name {
      font-weight: 600;
      color: #333;
    }

    .dropdown-item .student-id {
      font-size: 0.85em;
      color: #718096;
    }

    .dropdown-item .student-class {
      font-size: 0.85em;
      background: linear-gradient(135deg, #667eea, #764ba2);
      color: white;
      padding: 3px 10px;
      border-radius: 15px;
    }

    /* Class Filter */
    .class-filter {
      padding: 12px 20px;
      border: 2px solid #e2e8f0;
      border-radius: 10px;
      font-size: 1em;
      font-family: inherit;
      background: white;
      cursor: pointer;
      min-width: 120px;
      color: #333;
    }

    .class-filter:focus {
      outline: none;
      border-color: #667eea;
    }

    /* Pagination */
    .pagination-container {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 20px 0;
      margin-top: 15px;
      border-top: 2px solid #f0f0f0;
      flex-wrap: wrap;
      gap: 15px;
    }

    .pagination-info {
      color: #718096;
      font-size: 0.95em;
    }

    .pagination-controls {
      display: flex;
      align-items: center;
      gap: 5px;
    }

    .pagination-controls .btn {
      background: #f7fafc;
      color: #4a5568;
      border: 1px solid #e2e8f0;
      min-width: 40px;
      justify-content: center;
    }

    .pagination-controls .btn:hover {
      background: linear-gradient(135deg, #667eea, #764ba2);
      color: white;
      border-color: transparent;
    }

    .pagination-controls .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }

    .page-numbers {
      display: flex;
      gap: 5px;
    }

    .page-number {
      padding: 8px 14px;
      border: 1px solid #e2e8f0;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.2s;
      background: #f7fafc;
      color: #4a5568;
    }

    .page-number:hover {
      background: linear-gradient(135deg, #667eea, #764ba2);
      color: white;
      border-color: transparent;
    }

    .page-number.active {
      background: linear-gradient(135deg, #667eea, #764ba2);
      color: white;
      border-color: transparent;
    }

    .items-per-page {
      display: flex;
      align-items: center;
      gap: 8px;
      color: #718096;
    }

    .items-per-page select {
      padding: 8px 12px;
      border: 2px solid #e2e8f0;
      border-radius: 8px;
      font-family: inherit;
      cursor: pointer;
    }

    .items-per-page select:focus {
      outline: none;
      border-color: #667eea;
    }

    /* Class Badge */
    .class-badge {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 20px;
      font-weight: 600;
      font-size: 0.85em;
      background: linear-gradient(135deg, #667eea, #764ba2);
      color: white;
    }

    @media (max-width: 768px) {

      /* Container */
      .container {
        padding: 15px;
      }

      /* Header */
      .header {
        padding: 25px 20px;
        margin-bottom: 20px;
      }

      .header h1 {
        font-size: 1.6rem;
        margin-bottom: 8px;
      }

      .header p {
        font-size: 1rem;
      }

      /* Stats Grid */
      .stats-grid {
        grid-template-columns: repeat(2, 1fr);
        gap: 12px;
        margin-bottom: 20px;
      }

      .stat-card {
        padding: 15px;
      }

      .stat-value {
        font-size: 1.8rem;
      }

      .stat-label {
        font-size: 0.9rem;
      }

      /* Card */
      .card {
        padding: 20px;
        margin-bottom: 20px;
      }

      /* Filters */
      .filters {
        flex-direction: column;
        gap: 12px;
      }

      .filters select,
      .filters button {
        width: 100%;
        font-size: 1rem;
        padding: 12px;
      }

      /* Search Box */
      .search-box {
        flex-direction: column;
        margin-bottom: 20px;
      }

      .search-box input {
        width: 100%;
        font-size: 1rem;
        padding: 12px;
      }

      /* Button Groups */
      .btn-group {
        flex-direction: column;
        gap: 10px;
      }

      .btn {
        width: 100%;
        justify-content: center;
        font-size: 1rem;
        padding: 12px 18px;
      }

      /* Table */
      .table-container {
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
        margin: 0 -15px;
        padding: 0 15px;
        scroll-behavior: smooth;
      }

      table {
        font-size: 0.85rem;
        min-width: 700px;
      }

      th,
      td {
        padding: 10px 8px;
      }

      th {
        font-size: 0.8rem;
      }

      /* Score badges */
      .score-badge,
      .status-badge,
      .class-badge {
        font-size: 0.8rem;
        padding: 4px 8px;
      }

      /* Action Buttons */
      .action-buttons {
        display: flex;
        flex-direction: column;
        gap: 6px;
      }

      .btn-sm {
        width: 100%;
        justify-content: center;
        font-size: 0.85rem;
        padding: 8px 10px;
      }

      /* Adjust Input */
      .adjust-input {
        font-size: 0.85rem;
        padding: 6px 8px;
        width: 70px;
      }

      /* Pagination */
      .pagination-container {
        flex-direction: column;
        text-align: center;
        gap: 15px;
        padding: 20px 15px;
      }

      .pagination-info {
        font-size: 0.95rem;
        order: 1;
      }

      .pagination-controls {
        order: 2;
        justify-content: center;
        flex-wrap: wrap;
        gap: 8px;
      }

      .page-btn {
        min-width: 40px;
        height: 40px;
        font-size: 0.95rem;
      }

      /* Modals */
      .modal {
        padding: 15px;
      }

      .modal-content {
        width: 95%;
        max-width: none;
        padding: 25px 20px;
        margin: 0;
        max-height: 90vh;
      }

      .modal-header h3 {
        font-size: 1.4rem;
      }

      .form-group label {
        font-size: 1rem;
      }

      .form-group input,
      .form-group textarea,
      .form-group select {
        font-size: 1rem;
        padding: 12px;
      }

      /* Reason Modal */
      .reason-modal {
        width: 90%;
        padding: 25px 20px;
      }

      .reason-modal-icon {
        width: 55px;
        height: 55px;
        font-size: 1.6rem;
      }

      .reason-modal-title-group h3 {
        font-size: 1.4rem;
      }

      .reason-modal-subtitle {
        font-size: 0.95rem;
      }

      .reason-form-group textarea {
        font-size: 1rem;
        min-height: 100px;
      }

      .reason-btn {
        font-size: 1rem;
        padding: 14px;
      }

      /* Notification Card */
      .notification-card {
        padding: 18px;
        margin-bottom: 20px;
      }

      .notification-header h3 {
        font-size: 1.3rem;
      }

      .notification-badge {
        font-size: 0.9rem;
        padding: 4px 10px;
      }

      .notification-item {
        flex-direction: column;
        gap: 12px;
        padding: 15px;
      }

      .notification-student {
        font-size: 1rem;
      }

      .notification-reason {
        font-size: 0.95rem;
      }

      .notification-meta {
        font-size: 0.85rem;
      }

      .notification-actions {
        width: 100%;
      }

      .btn-complete {
        width: 100%;
        justify-content: center;
        font-size: 0.95rem;
        padding: 12px;
      }

      /* Status Messages */
      .status-box {
        font-size: 1rem;
        padding: 15px;
      }
    }

    @media (max-width: 480px) {

      /* Extra small screens */
      .container {
        padding: 12px;
      }

      .header {
        padding: 20px 15px;
      }

      .header h1 {
        font-size: 1.4rem;
      }

      .header p {
        font-size: 0.9rem;
      }

      /* Stats - Single column on very small screens */
      .stats-grid {
        grid-template-columns: 1fr;
      }

      .stat-card {
        padding: 12px;
      }

      .stat-value {
        font-size: 1.6rem;
      }

      .stat-label {
        font-size: 0.85rem;
      }

      /* Table */
      table {
        font-size: 0.8rem;
        min-width: 600px;
      }

      th,
      td {
        padding: 8px 6px;
      }

      /* Buttons */
      .btn {
        font-size: 0.95rem;
        padding: 10px 15px;
      }

      .btn-sm {
        font-size: 0.8rem;
        padding: 7px 8px;
      }

      /* Modal */
      .modal-content,
      .reason-modal {
        padding: 20px 15px;
      }

      .reason-modal-title-group h3 {
        font-size: 1.3rem;
      }

      /* Notification */
      .notification-card {
        padding: 15px;
      }

      .notification-item {
        padding: 12px;
      }
    }

    /* Notification Card */
    .notification-card {
      background: linear-gradient(135deg, #fff5e6 0%, #ffe8cc 100%);
      border-left: 5px solid #ed8936;
      padding: 20px;
      border-radius: 15px;
      margin-bottom: 20px;
      box-shadow: 0 5px 15px rgba(237, 131, 54, 0.2);
    }

    .notification-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
    }

    .notification-header h3 {
      color: #c05621;
      font-size: 1.3em;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .notification-badge {
      background: #ed8936;
      color: white;
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 0.85em;
      font-weight: 600;
    }

    .notification-list {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .notification-item {
      background: white;
      padding: 15px;
      border-radius: 10px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 15px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
      transition: all 0.3s;
      animation: slideInNotification 0.4s ease-out;
    }

    @keyframes slideInNotification {
      from {
        opacity: 0;
        transform: translateX(-20px);
      }

      to {
        opacity: 1;
        transform: translateX(0);
      }
    }

    .notification-item:hover {
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.12);
      transform: translateY(-2px);
    }

    .notification-info {
      flex: 1;
    }

    .notification-student {
      font-weight: 600;
      color: #333;
      font-size: 1.05em;
      margin-bottom: 5px;
    }

    .notification-reason {
      color: #718096;
      margin-bottom: 8px;
      font-size: 0.95em;
    }

    .notification-meta {
      display: flex;
      gap: 15px;
      font-size: 0.85em;
      color: #a0aec0;
    }

    .notification-meta i {
      margin-right: 5px;
    }

    .notification-actions {
      display: flex;
      gap: 8px;
    }

    .btn-complete {
      background: linear-gradient(135deg, #48bb78, #38a169);
      color: white;
      padding: 8px 16px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      font-size: 0.9em;
      transition: all 0.3s;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .btn-complete:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(72, 187, 120, 0.3);
    }

    .notification-empty {
      text-align: center;
      padding: 40px 20px;
      color: #a0aec0;
    }

    .notification-empty i {
      font-size: 3em;
      margin-bottom: 15px;
      opacity: 0.5;
    }

    /* Reason Modal */
    .reason-modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.7);
      backdrop-filter: blur(5px);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 10001;
      animation: fadeIn 0.3s;
    }

    .reason-modal-overlay.show {
      display: flex;
    }

    .reason-modal {
      background: white;
      border-radius: 24px;
      padding: 35px;
      max-width: 500px;
      width: 90%;
      box-shadow: 0 30px 60px rgba(0, 0, 0, 0.5);
      animation: slideUp 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    }

    @keyframes slideUp {
      from {
        opacity: 0;
        transform: translateY(30px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .reason-modal-header {
      display: flex;
      align-items: center;
      gap: 15px;
      margin-bottom: 25px;
    }

    .reason-modal-icon {
      width: 60px;
      height: 60px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.8rem;
      flex-shrink: 0;
    }

    .reason-modal-icon.increase {
      background: linear-gradient(135deg, #d1fae5, #a7f3d0);
      color: #065f46;
    }

    .reason-modal-icon.decrease {
      background: linear-gradient(135deg, #fee2e2, #fecaca);
      color: #991b1b;
    }

    .reason-modal-title-group h3 {
      font-size: 1.5rem;
      font-weight: 700;
      color: #1e293b;
      margin: 0 0 5px 0;
    }

    .reason-modal-subtitle {
      font-size: 0.95rem;
      color: #64748b;
    }

    .reason-form-group {
      margin-bottom: 20px;
    }

    .reason-form-group label {
      display: block;
      font-weight: 600;
      color: #334155;
      margin-bottom: 8px;
      font-size: 0.95rem;
    }

    .reason-form-group textarea {
      width: 100%;
      padding: 12px 15px;
      border: 2px solid #e2e8f0;
      border-radius: 12px;
      font-family: 'Sarabun', Arial, sans-serif;
      font-size: 1rem;
      resize: vertical;
      min-height: 100px;
      transition: all 0.3s;
    }

    .reason-form-group textarea:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.1);
    }

    .reason-modal-buttons {
      display: flex;
      gap: 12px;
      margin-top: 25px;
    }

    .reason-btn {
      flex: 1;
      padding: 14px;
      border: none;
      border-radius: 12px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      font-family: inherit;
    }

    .reason-btn-cancel {
      background: #f1f5f9;
      color: #64748b;
    }

    .reason-btn-cancel:hover {
      background: #e2e8f0;
      color: #1e293b;
    }

    .reason-btn-confirm {
      background: linear-gradient(135deg, #667eea, #764ba2);
      color: white;
    }

    .reason-btn-confirm:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(102, 126, 234, 0.4);
    }

    /* Checkbox Group for Deduction Reasons */
    .deduction-reasons-container {
      display: none;
      margin-bottom: 15px;
    }

    .deduction-reasons-container.show {
      display: block;
    }

    .deduction-reasons-label {
      display: block;
      font-weight: 600;
      color: #334155;
      margin-bottom: 10px;
      font-size: 0.95rem;
    }

    .deduction-reasons-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 8px;
      max-height: 250px;
      overflow-y: auto;
      padding: 12px;
      background: #f8fafc;
      border-radius: 12px;
      border: 2px solid #e2e8f0;
    }

    .deduction-checkbox-item {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 10px;
      background: white;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s;
      border: 1px solid #e2e8f0;
    }

    .deduction-checkbox-item:hover {
      background: #f1f5f9;
      border-color: #cbd5e1;
    }

    .deduction-checkbox-item.checked {
      background: linear-gradient(135deg, #fee2e2, #fecaca);
      border-color: #f87171;
    }

    .deduction-checkbox-item input[type="checkbox"] {
      width: 18px;
      height: 18px;
      cursor: pointer;
      accent-color: #ef4444;
    }

    .deduction-checkbox-item label {
      font-size: 0.9rem;
      color: #334155;
      cursor: pointer;
      flex: 1;
      margin: 0;
    }

    .other-reason-input {
      display: none;
      margin-top: 10px;
    }

    .other-reason-input.show {
      display: block;
    }

    .other-reason-input input {
      width: 100%;
      padding: 10px 12px;
      border: 2px solid #e2e8f0;
      border-radius: 8px;
      font-family: 'Sarabun', Arial, sans-serif;
      font-size: 0.95rem;
    }

    .other-reason-input input:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    @media (max-width: 768px) {
      .deduction-reasons-grid {
        grid-template-columns: 1fr;
      }
    }

    /* History Button */
    .btn-history {
      padding: 6px 12px;
      border-radius: 8px;
      background: linear-gradient(135deg, #3b82f6, #1d4ed8);
      color: white;
      border: none;
      font-weight: 600;
      font-size: 0.8rem;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 5px;
      transition: all 0.3s ease;
      box-shadow: 0 2px 8px rgba(59, 130, 246, 0.3);
      font-family: inherit;
    }

    .btn-history:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 15px rgba(59, 130, 246, 0.4);
    }

    /* History Modal */
    .history-modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.6);
      backdrop-filter: blur(8px);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 10002;
      padding: 20px;
    }

    .history-modal-overlay.show {
      display: flex;
    }

    .history-modal {
      background: white;
      border-radius: 24px;
      padding: 30px;
      max-width: 700px;
      width: 100%;
      max-height: 80vh;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      box-shadow: 0 25px 60px rgba(0, 0, 0, 0.3);
      animation: slideDown 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
    }

    .history-modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 15px;
      border-bottom: 2px solid #f1f5f9;
    }

    .history-modal-header h3 {
      font-size: 1.4rem;
      color: #1e293b;
      display: flex;
      align-items: center;
      gap: 10px;
      margin: 0;
    }

    .history-modal-header h3 i {
      color: #3b82f6;
    }

    .history-close-btn {
      width: 40px;
      height: 40px;
      border-radius: 10px;
      background: #f1f5f9;
      border: none;
      cursor: pointer;
      font-size: 1.3rem;
      color: #64748b;
      transition: all 0.3s;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .history-close-btn:hover {
      background: #e2e8f0;
      color: #1e293b;
    }

    .history-student-info {
      background: linear-gradient(135deg, #f0f9ff, #e0f2fe);
      padding: 15px 20px;
      border-radius: 12px;
      margin-bottom: 20px;
      display: flex;
      align-items: center;
      gap: 15px;
    }

    .history-student-avatar {
      width: 50px;
      height: 50px;
      border-radius: 12px;
      background: linear-gradient(135deg, #3b82f6, #1d4ed8);
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 1.3rem;
    }

    .history-student-details h4 {
      font-size: 1.1rem;
      color: #1e293b;
      margin: 0 0 4px 0;
    }

    .history-student-details span {
      font-size: 0.9rem;
      color: #64748b;
    }

    .history-list-container {
      flex: 1;
      overflow-y: auto;
      padding-right: 10px;
    }

    .history-list {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .history-item {
      background: #f8fafc;
      border-radius: 12px;
      padding: 15px 20px;
      display: flex;
      align-items: flex-start;
      gap: 15px;
      border-left: 4px solid #3b82f6;
      transition: all 0.3s ease;
    }

    .history-item:hover {
      background: #f1f5f9;
      transform: translateX(5px);
    }

    .history-item.positive {
      border-left-color: #10b981;
    }

    .history-item.negative {
      border-left-color: #ef4444;
    }

    .history-score-badge {
      min-width: 70px;
      padding: 8px 12px;
      border-radius: 10px;
      font-weight: 700;
      font-size: 1rem;
      text-align: center;
    }

    .history-score-badge.positive {
      background: #dcfce7;
      color: #15803d;
    }

    .history-score-badge.negative {
      background: #fee2e2;
      color: #991b1b;
    }

    .history-content {
      flex: 1;
    }

    .history-reason {
      font-size: 0.95rem;
      color: #1e293b;
      margin-bottom: 6px;
      font-weight: 500;
    }

    .history-meta {
      font-size: 0.85rem;
      color: #64748b;
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
    }

    .history-meta span {
      display: flex;
      align-items: center;
      gap: 5px;
    }

    .history-empty {
      text-align: center;
      padding: 40px 20px;
      color: #64748b;
    }

    .history-empty i {
      font-size: 3rem;
      color: #e2e8f0;
      margin-bottom: 15px;
      display: block;
    }

    .history-empty p {
      font-size: 1rem;
      margin: 0;
    }

    @media (max-width: 768px) {
      .history-modal {
        padding: 20px;
        max-height: 90vh;
      }

      .history-item {
        flex-direction: column;
        gap: 10px;
      }

      .history-score-badge {
        min-width: auto;
      }
    }

    /* All History Viewer Modal */
    .all-history-modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.7);
      backdrop-filter: blur(8px);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 10003;
      padding: 20px;
    }

    .all-history-modal-overlay.show {
      display: flex;
    }

    .all-history-modal {
      background: white;
      border-radius: 24px;
      padding: 30px;
      max-width: 900px;
      width: 100%;
      max-height: 90vh;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      box-shadow: 0 25px 60px rgba(0, 0, 0, 0.3);
      animation: slideDown 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
    }

    .all-history-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 15px;
      border-bottom: 2px solid #f1f5f9;
    }

    .all-history-header h2 {
      font-size: 1.5rem;
      color: #1e293b;
      display: flex;
      align-items: center;
      gap: 12px;
      margin: 0;
    }

    .all-history-header h2 i {
      color: #667eea;
    }

    .all-history-filters {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 15px;
      margin-bottom: 20px;
      padding: 20px;
      background: linear-gradient(135deg, #f8fafc, #f1f5f9);
      border-radius: 16px;
      border: 2px solid #e2e8f0;
    }

    .filter-item {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .filter-item label {
      font-weight: 600;
      color: #475569;
      font-size: 0.85rem;
    }

    .filter-item select,
    .filter-item input {
      padding: 10px 14px;
      border: 2px solid #e2e8f0;
      border-radius: 10px;
      font-family: inherit;
      font-size: 0.95rem;
      background: white;
      transition: all 0.3s;
    }

    .filter-item select:focus,
    .filter-item input:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.15);
    }

    .all-history-stats {
      display: flex;
      gap: 15px;
      margin-bottom: 15px;
      flex-wrap: wrap;
    }

    .all-history-stat {
      background: linear-gradient(135deg, #667eea, #764ba2);
      color: white;
      padding: 10px 18px;
      border-radius: 12px;
      font-weight: 600;
      font-size: 0.9rem;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .all-history-stat i {
      opacity: 0.9;
    }

    .all-history-list-container {
      flex: 1;
      overflow-y: auto;
      padding-right: 5px;
    }

    .all-history-list {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .all-history-item {
      background: #f8fafc;
      border-radius: 14px;
      padding: 18px 20px;
      display: grid;
      grid-template-columns: auto 1fr auto;
      gap: 15px;
      align-items: center;
      border-left: 4px solid #3b82f6;
      transition: all 0.3s ease;
    }

    .all-history-item:hover {
      background: #f1f5f9;
      transform: translateX(5px);
    }

    .all-history-item.positive {
      border-left-color: #10b981;
    }

    .all-history-item.negative {
      border-left-color: #ef4444;
    }

    .all-history-student {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .all-history-student-name {
      font-weight: 600;
      color: #1e293b;
      font-size: 0.95rem;
    }

    .all-history-student-class {
      font-size: 0.8rem;
      color: #64748b;
      background: #e2e8f0;
      padding: 2px 8px;
      border-radius: 6px;
      display: inline-block;
      width: fit-content;
    }

    .all-history-details {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .all-history-reason {
      font-weight: 500;
      color: #334155;
    }

    .all-history-meta {
      font-size: 0.85rem;
      color: #64748b;
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
    }

    .all-history-meta span {
      display: flex;
      align-items: center;
      gap: 5px;
    }

    .all-history-score {
      min-width: 70px;
      padding: 10px 15px;
      border-radius: 12px;
      font-weight: 700;
      font-size: 1.1rem;
      text-align: center;
    }

    .all-history-score.positive {
      background: linear-gradient(135deg, #dcfce7, #bbf7d0);
      color: #15803d;
    }

    .all-history-score.negative {
      background: linear-gradient(135deg, #fee2e2, #fecaca);
      color: #991b1b;
    }

    .btn-view-all-history {
      padding: 12px 24px;
      background: linear-gradient(135deg, #667eea, #764ba2);
      color: white;
      border: none;
      border-radius: 12px;
      font-weight: 600;
      font-size: 1rem;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 10px;
      transition: all 0.3s ease;
      box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
      font-family: inherit;
    }

    .btn-view-all-history:hover {
      transform: translateY(-3px);
      box-shadow: 0 6px 25px rgba(102, 126, 234, 0.4);
    }

    @media (max-width: 768px) {
      .all-history-modal {
        padding: 20px;
        max-height: 95vh;
      }

      .all-history-filters {
        grid-template-columns: 1fr;
        padding: 15px;
      }

      .all-history-item {
        grid-template-columns: 1fr;
        gap: 12px;
      }

      .all-history-score {
        justify-self: start;
      }

      .all-history-stats {
        flex-direction: column;
      }
    }
  </style>
</head>

<body>
  <div class="container">
    <!-- Header -->
    <div class="header">
      <h1><i class="fas fa-edit"></i> จัดการและแก้ไขคะแนนนักเรียน</h1>
      <p>แก้ไขคะแนนได้โดยตรง พร้อมบันทึกอัตโนมัติ</p>
    </div>

    <!-- Actions Bar -->
    <div class="card" style="margin-bottom: 20px;">
      <div class="action-buttons" style="display: flex; gap: 15px; flex-wrap: wrap; justify-content: center;">
        <button class="action-btn btn-enter-id" onclick="openManualInput()">
          <div class="btn-icon"><i class="fas fa-keyboard"></i></div>
          กรอกรหัส
        </button>
        <button class="action-btn btn-camera" onclick="document.getElementById('qrInputFile').click()">
          <div class="btn-icon"><i class="fas fa-camera"></i></div>
          ถ่ายรูป QR
        </button>
        <input type="file" id="qrInputFile" accept="image/*" style="display: none;" onchange="processQRImage(this)">

        <button class="action-btn btn-scan-qr" onclick="openQRScanner()">
          <div class="btn-icon"><i class="fas fa-qrcode"></i></div>
          สแกน QR
        </button>

        <button class="action-btn btn-search-all" onclick="openStudentSearchModal()">
          <div class="btn-icon"><i class="fas fa-search"></i></div>
          ค้นหา นร.
        </button>
      </div>
    </div>

    <!-- การแจ้งเตือน -->
    <div class="notification-card" id="notificationCard" style="display: none;">
      <div class="notification-header">
        <h3>
          <i class="fas fa-bell"></i>
          การแจ้งเตือนจากครู
        </h3>
        <span class="notification-badge" id="notificationCount">0</span>
      </div>
      <div class="notification-list" id="notificationList">
        <!-- Notifications will be rendered here -->
      </div>
    </div>

    <!-- สถิติ -->
    <div class="card">
      <h2><i class="fas fa-chart-bar"></i> สถิติคะแนน</h2>
      <div class="stats-grid" id="statsGrid">
        <div class="stat-card">
          <div class="label">นักเรียนทั้งหมด</div>
          <div class="value" id="statTotal">0</div>
        </div>
        <div class="stat-card">
          <div class="label">คะแนนเฉลี่ย</div>
          <div class="value" id="statAvg">0</div>
        </div>
        <div class="stat-card">
          <div class="label">คะแนนสูง (≥80)</div>
          <div class="value" id="statHigh">0</div>
        </div>
        <div class="stat-card">
          <div class="label">คะแนนต่ำ (<60)< /div>
              <div class="value" id="statLow">0</div>
          </div>
        </div>
      </div>

      <!-- View All History Button -->
      <div style="margin-top: 20px; text-align: center;">
        <button class="btn-view-all-history" onclick="openAllHistoryModal()">
          <i class="fas fa-history"></i> ดูประวัติทั้งหมด
        </button>
      </div>
    </div>



    <!-- ตารางแก้ไขคะแนน -->
    <div class="card">
      <h2><i class="fas fa-table"></i> แก้ไขคะแนนนักเรียน</h2>

      <div id="statusMessage" class="status-box"></div>

      <div class="search-box">
        <div class="search-input-container">
          <input type="text" id="searchInput" placeholder="ค้นหาชื่อหรือรหัสนักเรียน...">
          <div id="searchDropdown" class="search-dropdown"></div>
        </div>
        <select id="classFilter" class="class-filter" onchange="filterByClass()">
          <option value="">ทุกห้อง</option>
        </select>
        <select id="reportMonth" class="class-filter">
          <option value="1">มกราคม</option>
          <option value="2">กุมภาพันธ์</option>
          <option value="3">มีนาคม</option>
          <option value="4">เมษายน</option>
          <option value="5">พฤษภาคม</option>
          <option value="6">มิถุนายน</option>
          <option value="7">กรกฎาคม</option>
          <option value="8">สิงหาคม</option>
          <option value="9">กันยายน</option>
          <option value="10">ตุลาคม</option>
          <option value="11">พฤศจิกายน</option>
          <option value="12">ธันวาคม</option>
        </select>
        <select id="academicYear" class="class-filter">
          <option value="2567">2567</option>
          <option value="2568">2568</option>
          <option value="2569">2569</option>
          <option value="2570">2570</option>
        </select>
        <button class="btn btn-success" onclick="exportToExcel()">
          <i class="fas fa-file-excel"></i> ส่งออก Excel
        </button>
        <button class="btn btn-primary" onclick="loadData()">
          <i class="fas fa-sync"></i> โหลดข้อมูล
        </button>
        <button class="btn btn-success" onclick="saveAll()">
          <i class="fas fa-save"></i> บันทึกทั้งหมด
        </button>
        <button class="btn btn-danger" onclick="exportLowScorePDF()">
          <i class="fas fa-file-pdf"></i> PDF (คะแนน<100) </button>
            <button class="btn btn-primary" onclick="exportAllStudentsPDF()"
              style="background: linear-gradient(135deg, #9f7aea, #805ad5);">
              <i class="fas fa-file-pdf"></i> PDF ทั้งหมด
            </button>
      </div>

      <div class="btn-group">
        <button class="btn btn-info btn-sm" onclick="setAllScores(100)">
          <i class="fas fa-star"></i> ตั้งเป็น 100 ทุกคน
        </button>
        <button class="btn btn-warning btn-sm" onclick="addToAll(5)">
          <i class="fas fa-plus"></i> +5 ทุกคน
        </button>
        <button class="btn btn-warning btn-sm" onclick="addToAll(-5)">
          <i class="fas fa-minus"></i> -5 ทุกคน
        </button>
        <button class="btn btn-danger btn-sm" onclick="resetChanges()">
          <i class="fas fa-undo"></i> ยกเลิกการเปลี่ยนแปลง
        </button>
      </div>

      <div class="table-container">
        <table>
          <thead>
            <tr>
              <th>ลำดับ</th>
              <th>รหัส</th>
              <th>ชื่อ-นามสกุล</th>
              <th>ห้องเรียน</th>
              <th>สถานะ</th>
              <th>คะแนนเดิม</th>
              <th>ปรับ (+/-)</th>
              <th>คะแนนใหม่</th>
              <th>เครื่องมือ</th>
            </tr>
          </thead>
          <tbody id="studentTable">
            <tr>
              <td colspan="9" style="text-align: center; padding: 40px;">
                <i class="fas fa-spinner fa-spin" style="font-size: 2em; color: #cbd5e0;"></i>
                <p style="margin-top: 10px; color: #a0aec0;">กำลังโหลดข้อมูล...</p>
              </td>
            </tr>
          </tbody>
        </table>
      </div>

      <!-- Pagination -->
      <div class="pagination-container" id="paginationContainer">
        <div class="pagination-info">
          แสดง <span id="showingFrom">0</span> - <span id="showingTo">0</span> จาก <span id="showingTotal">0</span>
          รายการ
        </div>
        <div class="pagination-controls">
          <button class="btn btn-sm" onclick="goToPage(1)" id="btnFirst"><i
              class="fas fa-angle-double-left"></i></button>
          <button class="btn btn-sm" onclick="goToPage(currentPage - 1)" id="btnPrev"><i
              class="fas fa-angle-left"></i></button>
          <div class="page-numbers" id="pageNumbers"></div>
          <button class="btn btn-sm" onclick="goToPage(currentPage + 1)" id="btnNext"><i
              class="fas fa-angle-right"></i></button>
          <button class="btn btn-sm" onclick="goToPage(totalPages)" id="btnLast"><i
              class="fas fa-angle-double-right"></i></button>
        </div>
        <div class="items-per-page">
          <label>แสดง:</label>
          <select id="itemsPerPage" onchange="changeItemsPerPage()">
            <option value="10">10</option>
            <option value="20" selected>20</option>
            <option value="50">50</option>
            <option value="100">100</option>
          </select>
          <label>รายการ</label>
        </div>
      </div>
    </div>

    <!-- จัดการไฟล์ -->
    <div class="card">
      <h2><i class="fas fa-file-export"></i> จัดการไฟล์</h2>
      <div class="btn-group">
        <button class="btn btn-success" onclick="downloadJSON()">
          <i class="fas fa-download"></i> ดาวน์โหลด JSON
        </button>
        <button class="btn btn-warning" onclick="downloadBackup()">
          <i class="fas fa-history"></i> ดาวน์โหลดไฟล์สำรอง (คะแนน 100)
        </button>
      </div>
    </div>

    <!-- อัปโหลด Excel -->
    <div class="card">
      <h2><i class="fas fa-file-excel"></i> อัปโหลดไฟล์ Excel และแปลงเป็น JSON</h2>
      <p style="color: #718096; margin-bottom: 15px;">เลือกไฟล์ Excel (.xlsx) ที่มีคอลัมน์: id, name, password,
        status, score, class (ห้องเรียน)</p>

      <div class="upload-area" id="uploadArea">
        <input type="file" id="excelFile" accept=".xlsx,.xls" style="display: none;"
          onchange="handleExcelUpload(event)">
        <div class="upload-content" onclick="document.getElementById('excelFile').click()">
          <i class="fas fa-cloud-upload-alt" style="font-size: 3em; color: #667eea; margin-bottom: 15px;"></i>
          <p style="font-size: 1.1em; font-weight: 600; color: #333;">คลิกเพื่อเลือกไฟล์ Excel</p>
          <p style="color: #718096;">หรือลากไฟล์มาที่นี่</p>
        </div>
      </div>

      <div id="excelStatus" class="status-box" style="margin-top: 15px;"></div>

      <div id="excelPreview" style="display: none; margin-top: 20px;">
        <h3 style="margin-bottom: 15px;"><i class="fas fa-eye"></i> ตัวอย่างข้อมูล (<span id="previewCount">0</span>
          รายการ)</h3>
        <div class="table-container" style="max-height: 300px;">
          <table>
            <thead>
              <tr>
                <th>ลำดับ</th>
                <th>รหัส (id)</th>
                <th>ชื่อ (name)</th>
                <th>ห้องเรียน (class)</th>
                <th>รหัสผ่าน (password)</th>
                <th>สถานะ (status)</th>
                <th>คะแนน (score)</th>
              </tr>
            </thead>
            <tbody id="excelPreviewTable"></tbody>
          </table>
        </div>

        <div class="form-group" style="margin-top: 20px;">
          <label for="jsonFileName">ชื่อไฟล์ JSON ที่ต้องการบันทึก:</label>
          <input type="text" id="jsonFileName" placeholder="เช่น students.json" style="margin-top: 8px;">
        </div>

        <div class="btn-group" style="margin-top: 15px;">
          <button class="btn btn-success" onclick="downloadExcelAsJSON()">
            <i class="fas fa-download"></i> ดาวน์โหลดเป็น JSON
          </button>
          <button class="btn btn-primary" onclick="useExcelData()">
            <i class="fas fa-check"></i> ใช้ข้อมูลนี้ในตาราง
          </button>
          <button class="btn btn-danger" onclick="clearExcelData()">
            <i class="fas fa-times"></i> ยกเลิก
          </button>
        </div>
      </div>
    </div>

    <!-- ดาวน์โหลดข้อมูล JSON -->
    <div class="card">
      <h2><i class="fas fa-download"></i> ดาวน์โหลดข้อมูล JSON</h2>
      <p style="color: #718096; margin-bottom: 20px;">ดาวน์โหลดไฟล์ข้อมูลทั้งหมดในระบบ</p>

      <div class="btn-group" style="flex-wrap: wrap;">
        <button class="btn btn-primary" onclick="downloadJSON('user2.1.json')">
          <i class="fas fa-users"></i> user2.1.json (นักเรียน)
        </button>
        <button class="btn btn-success" onclick="downloadJSON('th.json')">
          <i class="fas fa-chalkboard-teacher"></i> th.json (ครูที่ปรึกษา)
        </button>
        <button class="btn btn-warning" onclick="downloadJSON('log.json')">
          <i class="fas fa-history"></i> log.json (ประวัติคะแนน)
        </button>
        <button class="btn btn-info" onclick="downloadJSON('toadmin.json')">
          <i class="fas fa-bell"></i> toadmin.json (แจ้งเตือน)
        </button>
        <button class="btn btn-danger" onclick="downloadJSON('TPAC.json')">
          <i class="fas fa-user-shield"></i> TPAC.json (แอดมิน)
        </button>
      </div>

      <div style="margin-top: 15px; padding-top: 15px; border-top: 2px solid #f0f0f0;">
        <button class="btn btn-primary" onclick="downloadAllJSON()"
          style="background: linear-gradient(135deg, #1a202c, #2d3748);">
          <i class="fas fa-file-archive"></i> ดาวน์โหลดทั้งหมด (ZIP)
        </button>
      </div>
    </div>
  </div>

  <!-- Modal แก้ไขนักเรียน -->
  <div id="editModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3><i class="fas fa-user-edit"></i> แก้ไขข้อมูลนักเรียน</h3>
        <button class="close-btn" onclick="closeEditModal()">
          <i class="fas fa-times"></i>
        </button>
      </div>

      <div class="form-group">
        <label>รหัสนักเรียน</label>
        <div class="info-display" id="modalId">-</div>
      </div>

      <div class="form-group">
        <label>ชื่อ-นามสกุล</label>
        <div class="info-display" id="modalName">-</div>
      </div>

      <div class="form-group">
        <label>คะแนนเดิม</label>
        <div class="info-display" id="modalOldScore">-</div>
      </div>

      <div class="form-group">
        <label>คะแนนใหม่ (0-100)</label>
        <input type="number" id="modalScore" min="0" max="100" placeholder="กรอกคะแนนใหม่">
      </div>

      <div class="form-group">
        <label>เหตุผล</label>
        <textarea id="modalReason" rows="3" placeholder="ระบุเหตุผล (ถ้ามี)"></textarea>
      </div>

      <div class="btn-group">
        <button class="btn btn-success" onclick="saveEdit()">
          <i class="fas fa-save"></i> บันทึก
        </button>
        <button class="btn btn-danger" onclick="closeEditModal()">
          <i class="fas fa-times"></i> ยกเลิก
        </button>
      </div>
    </div>
  </div>

  <!-- Reason Modal -->
  <div class="reason-modal-overlay" id="reasonModal">
    <div class="reason-modal">
      <div class="reason-modal-header">
        <div class="reason-modal-icon" id="reasonIcon">
          <i class="fas fa-edit"></i>
        </div>
        <div class="reason-modal-title-group">
          <h3 id="reasonTitle">ระบุเหตุผล</h3>
          <p class="reason-modal-subtitle" id="reasonSubtitle">กรุณาระบุเหตุผลในการปรับคะแนน</p>
        </div>
      </div>

      <!-- Checkbox group for deduction reasons -->
      <div class="deduction-reasons-container" id="deductionReasonsContainer">
        <label class="deduction-reasons-label">เลือกสาเหตุการหักคะแนน <span style="color: #ef4444;">*</span></label>
        <div class="deduction-reasons-grid">
          <div class="deduction-checkbox-item" onclick="toggleDeductionCheckbox(this)">
            <input type="checkbox" id="reason1" value="มาสาย">
            <label for="reason1">1. มาสาย</label>
          </div>
          <div class="deduction-checkbox-item" onclick="toggleDeductionCheckbox(this)">
            <input type="checkbox" id="reason2" value="ไม่สวมหมวกกันน็อค">
            <label for="reason2">2. ไม่สวมหมวกกันน็อค</label>
          </div>
          <div class="deduction-checkbox-item" onclick="toggleDeductionCheckbox(this)">
            <input type="checkbox" id="reason3" value="หนีเรียน">
            <label for="reason3">3. หนีเรียน</label>
          </div>
          <div class="deduction-checkbox-item" onclick="toggleDeductionCheckbox(this)">
            <input type="checkbox" id="reason4" value="สูบบุหรี่">
            <label for="reason4">4. สูบบุหรี่</label>
          </div>
          <div class="deduction-checkbox-item" onclick="toggleDeductionCheckbox(this)">
            <input type="checkbox" id="reason5" value="บุหรี่ไฟฟ้า">
            <label for="reason5">5. บุหรี่ไฟฟ้า</label>
          </div>
          <div class="deduction-checkbox-item" onclick="toggleDeductionCheckbox(this)">
            <input type="checkbox" id="reason6" value="การแต่งกายผิดระเบียบ">
            <label for="reason6">6. การแต่งกายผิดระเบียบ</label>
          </div>
          <div class="deduction-checkbox-item" onclick="toggleDeductionCheckbox(this)">
            <input type="checkbox" id="reason7" value="ทะเลาะวิวาท">
            <label for="reason7">7. ทะเลาะวิวาท</label>
          </div>
          <div class="deduction-checkbox-item" onclick="toggleDeductionCheckbox(this)">
            <input type="checkbox" id="reason8" value="ใช้สื่อโซเชียลไม่เหมาะสม">
            <label for="reason8">8. ใช้สื่อโซเชียลไม่เหมาะสม</label>
          </div>
          <div class="deduction-checkbox-item" onclick="toggleDeductionCheckbox(this)">
            <input type="checkbox" id="reason9" value="เล่นการพนัน">
            <label for="reason9">9. เล่นการพนัน</label>
          </div>
          <div class="deduction-checkbox-item" onclick="toggleDeductionCheckbox(this)">
            <input type="checkbox" id="reason10" value="สิงห้องน้ำ">
            <label for="reason10">10. สิงห้องน้ำ</label>
          </div>
          <div class="deduction-checkbox-item" onclick="toggleDeductionCheckbox(this)">
            <input type="checkbox" id="reason11" value="บูลลี่">
            <label for="reason11">11. บูลลี่</label>
          </div>
          <div class="deduction-checkbox-item" onclick="toggleDeductionCheckbox(this)">
            <input type="checkbox" id="reason12" value="ทำลายทรัพย์สินโรงเรียน">
            <label for="reason12">12. ทำลายทรัพย์สินโรงเรียน</label>
          </div>
          <div class="deduction-checkbox-item" onclick="toggleDeductionCheckbox(this)">
            <input type="checkbox" id="reason13" value="แอบถ่ายรูป">
            <label for="reason13">13. แอบถ่ายรูป</label>
          </div>
          <div class="deduction-checkbox-item" onclick="toggleDeductionCheckbox(this)">
            <input type="checkbox" id="reasonOther" value="อื่นๆ" onchange="toggleOtherReasonInput()">
            <label for="reasonOther">อื่นๆ (ระบุ)</label>
          </div>
        </div>
        <div class="other-reason-input" id="otherReasonInput">
          <input type="text" id="otherReasonText" placeholder="ระบุสาเหตุอื่นๆ...">
        </div>
      </div>

      <div class="reason-form-group">
        <label for="reasonInput">เหตุผล <span style="color: #ef4444;">*</span></label>
        <textarea id="reasonInput" placeholder="เช่น มาสาย, ไม่ส่งการบ้าน, ช่วยเหลือเพื่อน, เป็นตัวอย่างที่ดี..."
          required></textarea>
      </div>

      <div class="reason-modal-buttons">
        <button class="reason-btn reason-btn-cancel" onclick="cancelReason()">
          <i class="fas fa-times"></i> ยกเลิก
        </button>
        <button class="reason-btn reason-btn-confirm" onclick="confirmReason()">
          <i class="fas fa-check"></i> ยืนยัน
        </button>
      </div>
    </div>
  </div>

  <script>
    let studentsData = [];
    let originalData = [];
    let filteredData = [];
    let currentEditIndex = -1;

    // Reason modal variables
    let reasonCallback = null;
    let reasonCancelCallback = null;
    let pendingAdjustment = null;

    // Pagination variables
    let currentPage = 1;
    let itemsPerPage = 20;
    let totalPages = 1;
    let selectedClass = '';

    // Notification variables
    let notificationsData = [];
    let notificationRefreshInterval = null;

    // โหลดการแจ้งเตือน
    async function loadNotifications() {
      try {
        const response = await fetch('/toadmin.json');
        const data = await response.json();

        // กรองเฉพาะที่ยังไม่ได้ดำเนินการ
        notificationsData = data.filter(item => item.status !== 'completed');

        renderNotifications();
      } catch (error) {
        console.error('Error loading notifications:', error);
        notificationsData = [];
        renderNotifications();
      }
    }

    // แสดงการแจ้งเตือน
    function renderNotifications() {
      const card = document.getElementById('notificationCard');
      const list = document.getElementById('notificationList');
      const count = document.getElementById('notificationCount');

      if (notificationsData.length === 0) {
        card.style.display = 'none';
        return;
      }

      card.style.display = 'block';
      count.textContent = notificationsData.length;

      list.innerHTML = notificationsData.map((item, index) => {
        const timestamp = formatDateTime(item.timestamp);
        const reason = item.reason || item.detail || 'ไม่ระบุรายละเอียด';

        let imagesHtml = '';
        if (item.image_before || item.image_after) {
          imagesHtml = '<div class="notification-images">';
          if (item.image_before) {
            imagesHtml += `
              <div class="notification-img-wrapper">
                <span class="img-label">Before</span>
                <img src="${item.image_before}" onclick="viewImage('${item.image_before}')">
              </div>`;
          }
          if (item.image_after) {
            imagesHtml += `
              <div class="notification-img-wrapper">
                <span class="img-label">After</span>
                <img src="${item.image_after}" onclick="viewImage('${item.image_after}')">
              </div>`;
          }
          imagesHtml += '</div>';
        }

        return `
            <div class="notification-item">
              <div class="notification-info">
                <div class="notification-student">
                  ${item.student_id} - ${item.student_name}
                </div>
                <div class="notification-reason">
                  <i class="fas fa-comment-dots"></i> ${reason}
                </div>
                ${imagesHtml}
                <div class="notification-meta">
                  <span><i class="fas fa-user"></i> ${item.teacher}</span>
                  <span><i class="fas fa-clock"></i> ${timestamp}</span>
                </div>
              </div>
              <div class="notification-actions">
                <button class="btn-complete" onclick="markAsCompleted(${index})">
                  <i class="fas fa-check"></i> ดำเนินการแล้ว
                </button>
              </div>
            </div>
          `;
      }).join('');
    }

    // ทำเครื่องหมายว่าดำเนินการแล้ว
    async function markAsCompleted(index) {
      try {
        // Get current user
        const currentUser = JSON.parse(sessionStorage.getItem('currentUser'));
        const adminName = currentUser ? currentUser.name : 'Admin';

        // Find the original index in toadmin.json
        const response = await fetch('/toadmin.json');
        const allData = await response.json();

        // Find the actual index of this notification in the full array
        const notification = notificationsData[index];
        const actualIndex = allData.findIndex(item =>
          item.student_id === notification.student_id &&
          item.timestamp === notification.timestamp
        );

        if (actualIndex === -1) {
          showStatus('error', 'ไม่พบข้อมูลการแจ้งเตือน');
          return;
        }

        // ==========================================
        // Automated Deduction Logic
        // ==========================================
        const reason = notification.reason || '';
        const deductionRules = {
          'มาสาย': 10,
          'ไม่สวมหมวกกันน็อค': 10,
          'หนีเรียน': 10,
          'สูบบุหรี่': 30,
          'เล่นการพนัน': 30,
          'บุหรี่ไฟฟ้า': 60,
          'สิงห้องน้ำ': 10,
          'บูลลี่': 60,
          'แอบถ่ายรูป': 20, // Updated to 20
          'การแต่งกายผิดระเบียบ': 10,
          'ใช้สื่อโซเชียลไม่เหมาะสม': 60,
          'ทะเลาะวิวาท': 30,
          'ทำลายทรัพย์สินโรงเรียน': 30
        };

        // Check if reason contains any keyword
        let deduction = 0;
        let matchedReason = '';

        for (const [key, score] of Object.entries(deductionRules)) {
          if (reason.includes(key)) {
            deduction += score;
            matchedReason += key + ' ';
          }
        }

        if (deduction > 0) {
          // Automated Path
          const student = studentsData.find(s => s.id === notification.student_id);
          if (student) {
            const newScore = Math.max(0, student.score - deduction);

            const scoreResponse = await fetch('/api/save-score', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                id: student.id,
                score: newScore,
                reason: `หักคะแนนอัตโนมัติ: ${matchedReason.trim()}`
              })
            });

            if (scoreResponse.ok) {
              student.score = newScore;
              showStatus('info', `หัก ${deduction} คะแนน (${matchedReason.trim()})`);
            }
          }
          // Proceed to finish
          await finalizeCompletion(index, actualIndex, adminName);

        } else {
          // Manual Path - Open Modal
          pendingNotificationDiff = { notification, actualIndex, adminName, index };
          document.getElementById('manualScoreInput').value = ''; // Reset
          document.getElementById('manualScoreModal').classList.add('show');
          setTimeout(() => document.getElementById('manualScoreInput').focus(), 100);
        }

      } catch (error) {
        console.error('Error marking as completed:', error);
        showStatus('error', 'เกิดข้อผิดพลาดในการดำเนินการ');
        loadNotifications();
      }
    }

    // ฟังก์ชันจบงาน (Mark as Done)
    async function finalizeCompletion(index, actualIndex, adminName) {
      // ลบออกจาก array ทันทีและ re-render
      if (index < notificationsData.length) {
        notificationsData.splice(index, 1);
        renderNotifications();
      }

      try {
        // Send update to server
        const updateResponse = await fetch('/api/update-toadmin-status', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            index: actualIndex,
            admin_name: adminName
          })
        });

        const result = await updateResponse.json();

        if (result.status === 'success') {
          showStatus('success', 'ดำเนินการเรียบร้อยแล้ว');

          // Refresh table
          if (typeof filterData === 'function') filterData();
          else if (typeof displayTable === 'function') displayTable();

        } else {
          showStatus('error', 'เกิดข้อผิดพลาด: ' + (result.message || 'Unknown error'));
          loadNotifications();
        }
      } catch (e) {
        console.error(e);
        loadNotifications();
      }
    }

    // แปลงวันที่และเวลา
    function formatDateTime(isoString) {
      if (!isoString) return '-';
      const date = new Date(isoString);
      const now = new Date();
      const diffMs = now - date;
      const diffMins = Math.floor(diffMs / 60000);
      const diffHours = Math.floor(diffMs / 3600000);
      const diffDays = Math.floor(diffMs / 86400000);

      if (diffMins < 1) return 'เมื่อสักครู่';
      if (diffMins < 60) return `${diffMins} นาทีที่แล้ว`;
      if (diffHours < 24) return `${diffHours} ชั่วโมงที่แล้ว`;
      if (diffDays < 7) return `${diffDays} วันที่แล้ว`;

      const day = date.getDate().toString().padStart(2, '0');
      const month = (date.getMonth() + 1).toString().padStart(2, '0');
      const year = date.getFullYear() + 543; // พ.ศ.
      const hours = date.getHours().toString().padStart(2, '0');
      const minutes = date.getMinutes().toString().padStart(2, '0');

      return `${day}/${month}/${year} ${hours}:${minutes}`;
    }

    // แปลง class code เป็นชื่อห้องเรียน (201 -> ม.2/1)
    function formatClassName(classCode) {
      if (!classCode) return '-';
      const codeStr = String(classCode);
      if (codeStr.length >= 2) {
        const grade = codeStr.charAt(0); // ชั้น
        const room = codeStr.substring(1); // ห้อง
        return `ม.${grade}/${parseInt(room)}`;
      }
      return codeStr;
    }

    // ดึงรายการห้องเรียนทั้งหมด
    function getUniqueClasses() {
      const classes = new Set();
      studentsData.forEach(s => {
        if (s.class) classes.add(s.class);
      });
      return Array.from(classes).sort((a, b) => a - b);
    }

    // อัปเดต dropdown ห้องเรียน
    function updateClassFilter() {
      const select = document.getElementById('classFilter');
      const classes = getUniqueClasses();

      select.innerHTML = '<option value="">ทุกห้อง</option>';
      classes.forEach(classCode => {
        const option = document.createElement('option');
        option.value = classCode;
        option.textContent = formatClassName(classCode);
        select.appendChild(option);
      });
    }

    // กรองตามห้องเรียน
    function filterByClass() {
      selectedClass = document.getElementById('classFilter').value;
      currentPage = 1;
      applyFilters();
    }

    // Apply all filters (search + class)
    function applyFilters() {
      const query = document.getElementById('searchInput').value.toLowerCase().trim();

      filteredData = studentsData.filter(s => {
        // Ensure name exists and is a string
        const studentName = (s.name || '').toString().toLowerCase();
        const studentId = (s.id || '').toString();
        
        const matchSearch = !query || studentName.includes(query) || studentId.includes(query);
        const matchClass = !selectedClass || String(s.class) === selectedClass;
        return matchSearch && matchClass;
      });

      updatePagination();
      displayTable();
    }

    // Update pagination
    function updatePagination() {
      totalPages = Math.ceil(filteredData.length / itemsPerPage);
      if (totalPages < 1) totalPages = 1;
      if (currentPage > totalPages) currentPage = totalPages;

      renderPagination();
    }

    // Render pagination controls
    function renderPagination() {
      const from = filteredData.length > 0 ? (currentPage - 1) * itemsPerPage + 1 : 0;
      const to = Math.min(currentPage * itemsPerPage, filteredData.length);

      document.getElementById('showingFrom').textContent = from;
      document.getElementById('showingTo').textContent = to;
      document.getElementById('showingTotal').textContent = filteredData.length;

      // Page numbers
      const pageNumbersDiv = document.getElementById('pageNumbers');
      pageNumbersDiv.innerHTML = '';

      let startPage = Math.max(1, currentPage - 2);
      let endPage = Math.min(totalPages, currentPage + 2);

      if (currentPage <= 3) {
        endPage = Math.min(5, totalPages);
      }
      if (currentPage >= totalPages - 2) {
        startPage = Math.max(1, totalPages - 4);
      }

      for (let i = startPage; i <= endPage; i++) {
        const pageSpan = document.createElement('span');
        pageSpan.className = 'page-number' + (i === currentPage ? ' active' : '');
        pageSpan.textContent = i;
        pageSpan.onclick = () => goToPage(i);
        pageNumbersDiv.appendChild(pageSpan);
      }

      // Update button states
      document.getElementById('btnFirst').disabled = currentPage === 1;
      document.getElementById('btnPrev').disabled = currentPage === 1;
      document.getElementById('btnNext').disabled = currentPage === totalPages;
      document.getElementById('btnLast').disabled = currentPage === totalPages;
    }

    // Go to specific page
    function goToPage(page) {
      if (page < 1 || page > totalPages) return;
      currentPage = page;
      displayTable();
      renderPagination();
    }

    // Change items per page
    function changeItemsPerPage() {
      itemsPerPage = parseInt(document.getElementById('itemsPerPage').value);
      currentPage = 1;
      updatePagination();
      displayTable();
    }

    // Search dropdown
    function showSearchDropdown(results) {
      const dropdown = document.getElementById('searchDropdown');

      // Filter results by selected class if a class is selected
      let filteredResults = results;
      if (selectedClass) {
        filteredResults = results.filter(student => String(student.class) === selectedClass);
      }

      if (filteredResults.length === 0) {
        dropdown.classList.remove('show');
        return;
      }

      dropdown.innerHTML = filteredResults.slice(0, 8).map(student => {
        const studentName = student.name || 'ไม่ระบุชื่อ';
        return `
          <div class="dropdown-item" onclick="selectStudent('${student.id}')">
            <div class="student-info">
              <span class="student-name">${studentName}</span>
              <span class="student-id">รหัส: ${student.id}</span>
            </div>
            <span class="student-class">${formatClassName(student.class)}</span>
          </div>
        `;
      }).join('');

      dropdown.classList.add('show');
    }

    function selectStudent(studentId) {
      document.getElementById('searchInput').value = studentId;
      document.getElementById('searchDropdown').classList.remove('show');
      applyFilters();
    }

    // Hide dropdown when clicking outside
    document.addEventListener('click', (e) => {
      if (!e.target.closest('.search-input-container')) {
        document.getElementById('searchDropdown')?.classList.remove('show');
      }
    });

    // โหลดข้อมูล
    async function loadData() {
      const statusMsg = document.getElementById('statusMessage');
      statusMsg.className = 'status-box show status-info';
      statusMsg.innerHTML = '<i class="fas fa-spinner fa-spin"></i> กำลังโหลดข้อมูล...';

      const files = ['user2.1.json', 'user2_1.json'];
      let foundFile = null;

      for (let file of files) {
        try {
          const response = await fetch(file);
          if (response.ok) {
            foundFile = file;
            const data = await response.json();
            
            // Verify data is array
            if (!Array.isArray(data)) {
              console.error('Data is not an array:', data);
              continue;
            }
            
            // Ensure all records have name field and required properties
            studentsData = data.map(student => ({
              id: student.id || '',
              name: student.name || student.studentName || 'ไม่ระบุชื่อ',
              password: student.password || '',
              status: student.status || 'normal',
              score: student.score || 0,
              class: student.class || 0
            }));
            
            console.log('Loaded data sample:', studentsData.slice(0, 3));
            
            originalData = JSON.parse(JSON.stringify(studentsData)); // Backup
            filteredData = [...studentsData];
            break;
          } else {
            console.log(`File ${file} not found (HTTP ${response.status})`);
          }
        } catch (e) {
          console.log(`Error loading ${file}:`, e.message);
        }
      }

      if (foundFile && studentsData.length > 0) {
        statusMsg.className = 'status-box show status-success';
        statusMsg.innerHTML = `<i class="fas fa-check-circle"></i> โหลดข้อมูลสำเร็จจากไฟล์: <strong>${foundFile}</strong> (${studentsData.length} คน)`;
        updateClassFilter();
        updateStats();
        currentPage = 1;
        updatePagination();
        displayTable();
      } else {
        statusMsg.className = 'status-box show status-error';
        const helpText = `
          <strong>ไม่พบไฟล์ข้อมูล!</strong><br>
          วิธีแก้:<br>
          1. โปรดตรวจสอบว่ามีไฟล์ <strong>user2.1.json</strong> หรือ <strong>user2_1.json</strong> ในโฟลเดอร์เดียวกัน<br>
          2. หากเปิดไฟล์ HTML โดยตรง ให้เปิดผ่านเซิร์ฟเวอร์แทน:<br>
          &nbsp;&nbsp;&nbsp;- เปิด Command Prompt/Terminal ไปที่โฟลเดอร์นี้<br>
          &nbsp;&nbsp;&nbsp;- พิมพ์: <code>node server.js</code><br>
          &nbsp;&nbsp;&nbsp;- เข้าไปที่: <strong>http://localhost:8000</strong><br>
          3. ถ้าไม่มี server.js ให้ใช้เซิร์ฟเวอร์อื่น เช่น:<br>
          &nbsp;&nbsp;&nbsp;- <code>python -m http.server 8000</code> (Python)<br>
          &nbsp;&nbsp;&nbsp;- <code>php -S localhost:8000</code> (PHP)<br>
          &nbsp;&nbsp;&nbsp;- <code>npx http-server</code> (Node.js)
        `;
        statusMsg.innerHTML = helpText;
        statusMsg.style.textAlign = 'left';
        statusMsg.style.lineHeight = '1.6';
        // Show empty table instead of stuck loading state
        displayTable();
      }
    }

    // Helper function to show status messages
    function showStatus(type, message) {
      const statusMsg = document.getElementById('statusMessage');
      if (!statusMsg) {
        console.log(`[${type}] ${message}`);
        return;
      }

      const icons = {
        'info': 'fa-spinner fa-spin',
        'success': 'fa-check-circle',
        'error': 'fa-exclamation-triangle',
        'warning': 'fa-exclamation-circle'
      };

      const statusClasses = {
        'info': 'status-info',
        'success': 'status-success',
        'error': 'status-error',
        'warning': 'status-warning'
      };

      statusMsg.className = `status-box show ${statusClasses[type] || 'status-info'}`;
      statusMsg.innerHTML = `<i class="fas ${icons[type] || 'fa-info-circle'}"></i> ${message}`;

      // Auto-hide after 5 seconds for success/info
      if (type === 'success' || type === 'info') {
        setTimeout(() => {
          statusMsg.classList.remove('show');
        }, 5000);
      }
    }

    // อัปเดตสถิติ
    function updateStats() {
      const total = studentsData.length;
      const avg = total > 0 ? studentsData.reduce((sum, s) => sum + s.score, 0) / total : 0;
      const high = studentsData.filter(s => s.score >= 80).length;
      const low = studentsData.filter(s => s.score < 60).length;

      document.getElementById('statTotal').textContent = total;
      document.getElementById('statAvg').textContent = avg.toFixed(1);
      document.getElementById('statHigh').textContent = high;
      document.getElementById('statLow').textContent = low;
    }

    // อัปเดตสถานะนักเรียน
    async function updateStatus(studentId, newStatus) {
      try {
        const response = await fetch('/api/save-status', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ id: studentId, status: newStatus })
        });

        const result = await response.json();

        if (result.status === 'success') {
          // Update local data
          const student = studentsData.find(s => s.id === studentId);
          if (student) student.status = newStatus;

          showStatus('success', `อัปเดตสถานะ ${studentId} เรียบร้อย`);
        } else {
          showStatus('error', 'อัปเดตไม่สำเร็จ: ' + result.message);
          displayTable(); // Revert
        }
      } catch (e) {
        console.error(e);
        showStatus('error', 'เกิดข้อผิดพลาดในการเชื่อมต่อ');
        displayTable(); // Revert
      }
    }

    // แสดงตาราง
    function displayTable() {
      const tbody = document.getElementById('studentTable');

      if (filteredData.length === 0) {
        tbody.innerHTML = `
          <tr>
            <td colspan="9" style="text-align: center; padding: 40px; color: #a0aec0;">
              <i class="fas fa-inbox" style="font-size: 3em; margin-bottom: 10px; display: block;"></i>
              ไม่พบข้อมูล
            </td>
          </tr>
        `;
        return;
      }

      // Pagination slice
      const startIndex = (currentPage - 1) * itemsPerPage;
      const endIndex = startIndex + itemsPerPage;
      const pageData = filteredData.slice(startIndex, endIndex);

      tbody.innerHTML = pageData.map((student, index) => {
        const actualIndex = studentsData.findIndex(s => s.id === student.id);
        const originalScore = originalData.find(s => s.id === student.id)?.score || student.score;
        const isChanged = student.score !== originalScore;
        const scoreClass = student.score >= 80 ? 'score-high' : student.score < 60 ? 'score-low' : 'score-medium';
        const diff = student.score - originalScore;
        const displayIndex = startIndex + index + 1;
        const studentName = student.name || 'ไม่ระบุชื่อ';
        const studentStatus = student.status || 'normal';

        return `
          <tr>
            <td>${displayIndex}</td>
            <td>${student.id}</td>
            <td>${studentName}</td>
            <td><span class="class-badge">${formatClassName(student.class)}</span></td>
            <td>
              <select onchange="updateStatus('${student.id}', this.value)" style="padding: 6px; border-radius: 6px; border: 1px solid #cbd5e0; background: white; font-family: inherit; font-size: 0.9em; cursor: pointer;">
                <option value="normal" ${studentStatus === 'normal' ? 'selected' : ''}>กำลังศึกษาอยู่</option>
                <option value="Absent" ${studentStatus === 'Absent' ? 'selected' : ''}>ขาดเรียนนาน</option>
                <option value="moved" ${studentStatus === 'moved' ? 'selected' : ''}>ย้ายแล้ว</option>
                <option value="notnormal" ${student.status === 'notnormal' ? 'selected' : ''}>พักการเรียน</option>
              </select>
            </td>
            <td><span class="score-badge ${scoreClass}">${originalScore}</span></td>
            <td>
              <input 
                type="text" 
                class="adjust-input" 
                id="adjust-${actualIndex}"
                placeholder="+10 / -5"
                onchange="adjustScore(${actualIndex}, this.value)"
                onkeypress="if(event.key==='Enter') this.blur()"
              >
            </td>
            <td>
              <span class="score-result ${isChanged ? 'changed' : ''}">${student.score}</span>
            </td>
            <td>
              <div class="action-buttons">
                <button class="btn btn-success btn-sm" onclick="quickSave(${actualIndex})" title="บันทึกเดี่ยว">
                  <i class="fas fa-check"></i>
                </button>
                <button class="btn-history" onclick="viewStudentHistory('${student.id}', '${student.name.replace(/'/g, "\\\\'")}')" title="ดูประวัติ">
                  <i class="fas fa-history"></i>
                </button>
              </div>
            </td>
          </tr>
        `;
      }).join('');
    }

    // ปรับคะแนนด้วย +/-
    function adjustScore(index, value) {
      const input = document.getElementById(`adjust-${index}`);
      const trimmed = value.trim();

      if (!trimmed) {
        input.className = 'adjust-input';
        return;
      }

      let adjustment = 0;

      // รองรับรูปแบบ +10, -5, 10 (บวกโดยปริยาย)
      if (trimmed.startsWith('+')) {
        adjustment = parseInt(trimmed.substring(1));
        input.className = 'adjust-input positive';
      } else if (trimmed.startsWith('-')) {
        adjustment = -parseInt(trimmed.substring(1));
        input.className = 'adjust-input negative';
      } else {
        adjustment = parseInt(trimmed);
        input.className = adjustment >= 0 ? 'adjust-input positive' : 'adjust-input negative';
      }

      if (isNaN(adjustment)) {
        showStatus('error', 'กรุณากรอกตัวเลข เช่น +10 หรือ -5');
        input.value = '';
        input.className = 'adjust-input';
        return;
      }

      // เก็บข้อมูลไว้ใช้ใน modal
      pendingAdjustment = {
        index: index,
        adjustment: adjustment,
        input: input
      };

      // แสดง modal ให้กรอกเหตุผล
      showReasonModal(
        adjustment < 0 ? 'decrease' : 'increase',
        adjustment,
        studentsData[index].name,
        (reason) => {
          // เมื่อยืนยัน
          studentsData[index].logReason = reason;

          const originalScore = originalData.find(s => s.id === studentsData[index].id)?.score || studentsData[index].score;
          const newScore = originalScore + pendingAdjustment.adjustment;
          studentsData[pendingAdjustment.index].score = newScore;

          updateStats();
          displayTable();

          // บันทึกลง server และ log.json ทันที
          quickSave(pendingAdjustment.index).then(() => {
            showStatus('success', `ปรับคะแนน ${pendingAdjustment.adjustment > 0 ? '+' : ''}${pendingAdjustment.adjustment} และบันทึกสำเร็จ!`);
          });

          pendingAdjustment.input.value = '';
          pendingAdjustment.input.className = 'adjust-input';
          pendingAdjustment = null;
        },
        () => {
          // เมื่อยกเลิก
          pendingAdjustment.input.value = '';
          pendingAdjustment.input.className = 'adjust-input';
          pendingAdjustment = null;
        }
      );
    }

    // แสดง Reason Modal
    function showReasonModal(type, adjustment, studentName, onConfirm, onCancel) {
      const modal = document.getElementById('reasonModal');
      const icon = document.getElementById('reasonIcon');
      const title = document.getElementById('reasonTitle');
      const subtitle = document.getElementById('reasonSubtitle');
      const input = document.getElementById('reasonInput');

      // ตั้งค่า UI ตามประเภท
      if (type === 'decrease') {
        icon.className = 'reason-modal-icon decrease';
        icon.innerHTML = '<i class="fas fa-minus-circle"></i>';
        title.textContent = 'หักคะแนน';
        subtitle.textContent = `หัก ${Math.abs(adjustment)} คะแนนจาก ${studentName}`;
      } else {
        icon.className = 'reason-modal-icon increase';
        icon.innerHTML = '<i class="fas fa-plus-circle"></i>';
        title.textContent = 'เพิ่มคะแนน';
        subtitle.textContent = `เพิ่ม +${adjustment} คะแนนให้ ${studentName}`;
      }

      // Show/hide deduction reasons container based on type
      const deductionContainer = document.getElementById('deductionReasonsContainer');
      if (type === 'decrease') {
        deductionContainer.classList.add('show');
        resetDeductionCheckboxes();
      } else {
        deductionContainer.classList.remove('show');
      }

      input.value = '';
      input.focus();

      reasonCallback = onConfirm;
      reasonCancelCallback = onCancel;

      modal.classList.add('show');
    }

    // Toggle checkbox visual state
    function toggleDeductionCheckbox(item) {
      const checkbox = item.querySelector('input[type="checkbox"]');
      checkbox.checked = !checkbox.checked;
      item.classList.toggle('checked', checkbox.checked);

      // If it's the "other" checkbox, toggle the input field
      if (checkbox.id === 'reasonOther') {
        toggleOtherReasonInput();
      }

      // Auto-populate the reason textarea
      updateReasonFromCheckboxes();
    }

    // Toggle other reason input visibility
    function toggleOtherReasonInput() {
      const otherCheckbox = document.getElementById('reasonOther');
      const otherInput = document.getElementById('otherReasonInput');

      if (otherCheckbox.checked) {
        otherInput.classList.add('show');
        document.getElementById('otherReasonText').focus();
      } else {
        otherInput.classList.remove('show');
        document.getElementById('otherReasonText').value = '';
      }

      updateReasonFromCheckboxes();
    }

    // Update reason textarea based on selected checkboxes
    function updateReasonFromCheckboxes() {
      const container = document.getElementById('deductionReasonsContainer');
      if (!container.classList.contains('show')) return;

      const checkboxes = container.querySelectorAll('input[type="checkbox"]:checked');
      const reasons = [];

      checkboxes.forEach(cb => {
        if (cb.id === 'reasonOther') {
          const otherText = document.getElementById('otherReasonText').value.trim();
          if (otherText) {
            reasons.push(otherText);
          }
        } else {
          reasons.push(cb.value);
        }
      });

      document.getElementById('reasonInput').value = reasons.join(', ');
    }

    // Reset all deduction checkboxes
    function resetDeductionCheckboxes() {
      const container = document.getElementById('deductionReasonsContainer');
      const checkboxItems = container.querySelectorAll('.deduction-checkbox-item');

      checkboxItems.forEach(item => {
        const checkbox = item.querySelector('input[type="checkbox"]');
        checkbox.checked = false;
        item.classList.remove('checked');
      });

      document.getElementById('otherReasonInput').classList.remove('show');
      document.getElementById('otherReasonText').value = '';
    }

    // Listen for changes in other reason input to update main textarea
    document.getElementById('otherReasonText').addEventListener('input', function () {
      updateReasonFromCheckboxes();
    });

    // ยืนยันเหตุผล
    function confirmReason() {
      const input = document.getElementById('reasonInput');
      const reason = input.value.trim();

      if (!reason) {
        showStatus('error', 'กรุณากรอกเหตุผล');
        input.focus();
        return;
      }

      document.getElementById('reasonModal').classList.remove('show');

      if (reasonCallback) {
        reasonCallback(reason);
        reasonCallback = null;
      }
    }

    // ยกเลิกเหตุผล
    function cancelReason() {
      document.getElementById('reasonModal').classList.remove('show');

      if (reasonCancelCallback) {
        reasonCancelCallback();
        reasonCancelCallback = null;
      }
    }

    // Keyboard support for reason modal
    document.getElementById('reasonInput').addEventListener('keydown', function (e) {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        confirmReason();
      } else if (e.key === 'Escape') {
        e.preventDefault();
        cancelReason();
      }
    });

    // อัปเดตคะแนน
    function updateScore(index, newScore) {
      const score = parseInt(newScore);
      if (isNaN(score) || score < 0 || score > 100) {
        alert('กรุณากรอกคะแนน 0-100');
        displayTable();
        return;
      }
      studentsData[index].score = score;
      updateStats();
      displayTable();
    }

    // ตั้งคะแนนทุกคน
    function setAllScores(score) {
      if (!confirm(`ต้องการตั้งคะแนนเป็น ${score} ทุกคนใช่หรือไม่?`)) return;

      studentsData.forEach(s => s.score = score);
      updateStats();
      displayTable();

      showMessage('success', `ตั้งคะแนนเป็น ${score} ทุกคนแล้ว`);
    }

    // เพิ่ม/ลดคะแนนทุกคน
    function addToAll(amount) {
      const action = amount > 0 ? 'เพิ่ม' : 'ลด';
      if (!confirm(`ต้องการ${action}คะแนน ${Math.abs(amount)} ทุกคนใช่หรือไม่?`)) return;

      studentsData.forEach(s => {
        s.score = Math.max(0, Math.min(100, s.score + amount));
      });
      updateStats();
      displayTable();

      showMessage('success', `${action}คะแนน ${Math.abs(amount)} ทุกคนแล้ว`);
    }

    // ยกเลิกการเปลี่ยนแปลง
    function resetChanges() {
      if (!confirm('ต้องการยกเลิกการเปลี่ยนแปลงทั้งหมดใช่หรือไม่?')) return;

      studentsData = JSON.parse(JSON.stringify(originalData));
      filteredData = [...studentsData];
      updateStats();
      displayTable();

      showMessage('info', 'ยกเลิกการเปลี่ยนแปลงแล้ว');
    }

    // เปิด Modal แก้ไข
    function openEditModal(index) {
      currentEditIndex = index;
      const student = studentsData[index];
      const originalScore = originalData.find(s => s.id === student.id)?.score || student.score;

      document.getElementById('modalId').textContent = student.id;
      document.getElementById('modalName').textContent = student.name;
      document.getElementById('modalOldScore').textContent = originalScore;
      document.getElementById('modalScore').value = student.score;
      document.getElementById('modalReason').value = '';

      document.getElementById('editModal').classList.add('show');
    }

    function closeEditModal() {
      document.getElementById('editModal').classList.remove('show');
      currentEditIndex = -1;
    }

    // บันทึกจาก Modal
    function saveEdit() {
      const newScore = parseInt(document.getElementById('modalScore').value);
      const reason = document.getElementById('modalReason').value.trim();

      if (isNaN(newScore) || newScore < 0 || newScore > 100) {
        alert('กรุณากรอกคะแนน 0-100');
        return;
      }

      studentsData[currentEditIndex].score = newScore;

      if (reason) {
        if (!studentsData[currentEditIndex].history) {
          studentsData[currentEditIndex].history = [];
        }
        studentsData[currentEditIndex].history.push({
          date: new Date().toISOString(),
          score: newScore,
          reason: reason
        });
      }

      updateStats();
      displayTable();
      closeEditModal();

      showMessage('success', 'แก้ไขคะแนนสำเร็จ');
    }

    // บันทึกเดี่ยว
    async function quickSave(index) {
      const student = studentsData[index];

      try {
        const response = await fetch('/api/save-score', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            id: student.id,
            score: student.score,
            reason: student.logReason || 'แก้ไขคะแนน'
          })
        });

        const result = await response.json();

        if (result.status === 'success') {
          originalData[index].score = student.score;
          // Clear the reason after save
          delete student.logReason;

          showMessage('success', `บันทึกคะแนน ${student.name} สำเร็จ`);
          displayTable();
        } else {
          showMessage('error', 'บันทึกไม่สำเร็จ: ' + result.message);
        }
      } catch (e) {
        showMessage('error', 'ไม่สามารถเชื่อมต่อ Server ได้ กรุณาตรวจสอบว่า Node.js Server ทำงานอยู่');
      }
    }

    // บันทึกทั้งหมด
    async function saveAll() {
      if (!confirm('ต้องการบันทึกการเปลี่ยนแปลงทั้งหมดใช่หรือไม่?')) return;

      const statusMsg = document.getElementById('statusMessage');
      statusMsg.className = 'status-box show status-info';
      statusMsg.innerHTML = '<i class="fas fa-spinner fa-spin"></i> กำลังบันทึก...';

      try {
        const response = await fetch('/api/save-all', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(studentsData)
        });

        const result = await response.json();

        if (result.status === 'success') {
          originalData = JSON.parse(JSON.stringify(studentsData));
          statusMsg.className = 'status-box show status-success';
          statusMsg.innerHTML = `<i class="fas fa-check-circle"></i> บันทึกสำเร็จ! (${result.students} คน)`;
          displayTable();
        } else {
          statusMsg.className = 'status-box show status-error';
          statusMsg.innerHTML = `<i class="fas fa-times-circle"></i> บันทึกไม่สำเร็จ: ${result.message}`;
        }
      } catch (e) {
        statusMsg.className = 'status-box show status-error';
        statusMsg.innerHTML = `
          <i class="fas fa-times-circle"></i> ไม่สามารถเชื่อมต่อ Server ได้<br>
          <small>วิธีแก้: รัน node server.js ก่อน หรือดาวน์โหลด JSON แล้วอัปโหลดทับไฟล์เดิม</small>
        `;
      }
    }

    // ดาวน์โหลด JSON
    function downloadJSON() {
      const dataStr = JSON.stringify(studentsData, null, 2);
      const blob = new Blob([dataStr], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      const timestamp = new Date().toISOString().replace(/[:.]/g, '-').slice(0, -5);
      a.href = url;
      a.download = `user2.1_edited_${timestamp}.json`;
      a.click();
      URL.revokeObjectURL(url);

      showMessage('success', 'ดาวน์โหลดไฟล์สำเร็จ');
    }

    // ดาวน์โหลดไฟล์สำรอง
    function downloadBackup() {
      const backupData = originalData.map(s => ({ ...s, score: 100 }));
      const dataStr = JSON.stringify(backupData, null, 2);
      const blob = new Blob([dataStr], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'user2.1_backup_100.json';
      a.click();
      URL.revokeObjectURL(url);

      showMessage('success', 'ดาวน์โหลดไฟล์สำรอง (คะแนน 100 ทุกคน)');
    }

    // ค้นหา
    document.getElementById('searchInput')?.addEventListener('input', (e) => {
      const query = e.target.value.toLowerCase().trim();

      // Show dropdown suggestions
      if (query.length >= 1 && studentsData.length > 0) {
        const suggestions = studentsData.filter(s => {
          const studentName = (s.name || '').toString().toLowerCase();
          const studentId = (s.id || '').toString();
          return studentName.includes(query) || studentId.includes(query);
        });
        showSearchDropdown(suggestions);
      } else {
        document.getElementById('searchDropdown').classList.remove('show');
      }

      // Apply filters with pagination reset
      currentPage = 1;
      applyFilters();
    });

    // =====================================================
    // Excel Export Function
    // =====================================================

    const thaiMonths = [
      'มกราคม', 'กุมภาพันธ์', 'มีนาคม', 'เมษายน',
      'พฤษภาคม', 'มิถุนายน', 'กรกฎาคม', 'สิงหาคม',
      'กันยายน', 'ตุลาคม', 'พฤศจิกายน', 'ธันวาคม'
    ];

    function exportToExcel() {
      if (filteredData.length === 0) {
        alert('ไม่มีข้อมูลที่จะส่งออก');
        return;
      }

      showMessage('info', 'กำลังสร้างไฟล์ Excel...');

      try {
        // Get selected month and year
        const monthSelect = document.getElementById('reportMonth');
        const yearSelect = document.getElementById('academicYear');
        const selectedMonthValue = monthSelect ? monthSelect.value : (new Date().getMonth() + 1);
        const selectedYear = yearSelect ? yearSelect.value : '2568';
        const selectedMonthName = thaiMonths[parseInt(selectedMonthValue) - 1];

        // Get class name
        const selectedClassName = selectedClass ? formatClassName(selectedClass) : 'ทุกห้อง';

        // Calculate statistics
        const avgScore = filteredData.reduce((sum, s) => sum + s.score, 0) / filteredData.length;
        const highScore = filteredData.filter(s => s.score >= 80).length;
        const lowScore = filteredData.filter(s => s.score < 60).length;

        // Create workbook
        const wb = XLSX.utils.book_new();

        // Prepare data for Excel
        const excelData = [];

        // Title rows
        excelData.push(['รายงานคะแนนพฤติกรรมนักเรียนโรงเรียนเทพา']);
        excelData.push([`ประจำเดือน${selectedMonthName} ปีการศึกษา ${selectedYear}`]);
        excelData.push([`ห้องเรียน: ${selectedClassName}`]);
        excelData.push([]); // Empty row

        // Table headers
        excelData.push(['ลำดับ', 'รหัส', 'ชื่อ-นามสกุล', 'ห้อง', 'คะแนน']);

        // Table data
        filteredData.forEach((student, index) => {
          excelData.push([
            index + 1,
            student.id,
            student.name,
            formatClassName(student.class),
            student.score
          ]);
        });

        // Empty row before summary
        excelData.push([]);

        // Summary
        excelData.push(['สรุปข้อมูล']);
        excelData.push(['จำนวนนักเรียนทั้งหมด:', `${filteredData.length} คน`]);
        excelData.push(['คะแนนเฉลี่ย:', `${avgScore.toFixed(1)} คะแนน`]);
        excelData.push(['คะแนนสูง (≥80):', `${highScore} คน`]);
        excelData.push(['คะแนนต่ำ (<60):', `${lowScore} คน`]);

        // Create worksheet
        const ws = XLSX.utils.aoa_to_sheet(excelData);

        // Set column widths
        ws['!cols'] = [
          { wch: 8 },  // ลำดับ
          { wch: 12 }, // รหัส
          { wch: 30 }, // ชื่อ-นามสกุล
          { wch: 10 }, // ห้อง
          { wch: 10 }  // คะแนน
        ];

        // Merge cells for title
        ws['!merges'] = [
          { s: { r: 0, c: 0 }, e: { r: 0, c: 4 } }, // Title row
          { s: { r: 1, c: 0 }, e: { r: 1, c: 4 } }, // Subtitle row
          { s: { r: 2, c: 0 }, e: { r: 2, c: 4 } }  // Class info row
        ];

        // Add worksheet to workbook
        XLSX.utils.book_append_sheet(wb, ws, 'รายงานคะแนน');

        // Generate filename
        const classFileStr = selectedClass ? `_${selectedClassName.replace('/', '-')}` : '_all';
        const filename = `รายงานคะแนน_${selectedMonthName}_${selectedYear}${classFileStr}.xlsx`;

        // Save file
        XLSX.writeFile(wb, filename);

        showMessage('success', `ส่งออก Excel สำเร็จ! (${filteredData.length} รายการ)`);

      } catch (error) {
        console.error('Excel Export Error:', error);
        showMessage('error', 'เกิดข้อผิดพลาดในการสร้าง Excel: ' + error.message);
      }
    }

    // แสดงข้อความ
    function showMessage(type, message) {
      const statusMsg = document.getElementById('statusMessage');
      const icons = {
        success: 'check-circle',
        error: 'times-circle',
        info: 'info-circle'
      };

      statusMsg.className = `status-box show status-${type}`;
      statusMsg.innerHTML = `<i class="fas fa-${icons[type]}"></i> ${message}`;

      setTimeout(() => {
        statusMsg.classList.remove('show');
      }, 5000);
    }

    // =====================================================
    // Excel Upload Functions
    // =====================================================
    let excelData = [];
    let uploadedFileName = '';

    // Handle Excel file upload
    function handleExcelUpload(event) {
      const file = event.target.files[0];
      if (!file) return;

      uploadedFileName = file.name.replace(/\.[^/.]+$/, ''); // Remove extension
      const statusBox = document.getElementById('excelStatus');

      statusBox.className = 'status-box show status-info';
      statusBox.innerHTML = '<i class="fas fa-spinner fa-spin"></i> กำลังอ่านไฟล์ Excel...';

      const reader = new FileReader();
      reader.onload = function (e) {
        try {
          const data = new Uint8Array(e.target.result);
          const workbook = XLSX.read(data, { type: 'array' });

          // Get first sheet
          const sheetName = workbook.SheetNames[0];
          const worksheet = workbook.Sheets[sheetName];

          // Convert to JSON
          const jsonData = XLSX.utils.sheet_to_json(worksheet);

          if (jsonData.length === 0) {
            statusBox.className = 'status-box show status-error';
            statusBox.innerHTML = '<i class="fas fa-times-circle"></i> ไฟล์ไม่มีข้อมูล';
            return;
          }

          // Validate and normalize data
          excelData = jsonData.map(row => ({
            id: String(row.id || row.รหัส || ''),
            name: String(row.name || row.ชื่อ || row['ชื่อ-นามสกุล'] || ''),
            password: String(row.password || row.รหัสผ่าน || row.id || row.รหัส || ''),
            status: String(row.status || row.สถานะ || 'normal'),
            score: parseInt(row.score || row.คะแนน || 100) || 100,
            class: parseInt(row.class || row.ห้องเรียน || row.ห้อง || '') || null
          }));

          // Update UI
          document.getElementById('jsonFileName').value = uploadedFileName + '.json';
          document.getElementById('previewCount').textContent = excelData.length;

          // Display preview table
          const tbody = document.getElementById('excelPreviewTable');
          tbody.innerHTML = excelData.slice(0, 10).map((s, i) => `
              <tr>
                <td>${i + 1}</td>
                <td>${s.id}</td>
                <td>${s.name}</td>
                <td><span class="class-badge">${formatClassName(s.class)}</span></td>
                <td>${s.password}</td>
                <td>${s.status}</td>
                <td>${s.score}</td>
              </tr>
            `).join('');

          if (excelData.length > 10) {
            tbody.innerHTML += `<tr><td colspan="7" style="text-align:center; color:#718096;">... และอีก ${excelData.length - 10} รายการ</td></tr>`;
          }

          document.getElementById('excelPreview').style.display = 'block';

          statusBox.className = 'status-box show status-success';
          statusBox.innerHTML = `<i class="fas fa-check-circle"></i> อ่านไฟล์สำเร็จ: <strong>${file.name}</strong> (${excelData.length} รายการ)`;

        } catch (err) {
          console.error(err);
          statusBox.className = 'status-box show status-error';
          statusBox.innerHTML = '<i class="fas fa-times-circle"></i> ไม่สามารถอ่านไฟล์ได้: ' + err.message;
        }
      };
      reader.readAsArrayBuffer(file);
    }

    // Download Excel data as JSON
    function downloadExcelAsJSON() {
      if (excelData.length === 0) {
        alert('ไม่มีข้อมูล');
        return;
      }

      let fileName = document.getElementById('jsonFileName').value.trim();
      if (!fileName) fileName = 'students.json';
      if (!fileName.endsWith('.json')) fileName += '.json';

      const dataStr = JSON.stringify(excelData, null, 2);
      const blob = new Blob([dataStr], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = fileName;
      a.click();
      URL.revokeObjectURL(url);

      document.getElementById('excelStatus').className = 'status-box show status-success';
      document.getElementById('excelStatus').innerHTML = `<i class="fas fa-check-circle"></i> ดาวน์โหลด ${fileName} สำเร็จ!`;
    }

    // Use Excel data in the table
    function useExcelData() {
      if (excelData.length === 0) {
        alert('ไม่มีข้อมูล');
        return;
      }

      if (!confirm('ต้องการใช้ข้อมูลจาก Excel แทนที่ข้อมูลปัจจุบันใช่หรือไม่?')) return;

      studentsData = JSON.parse(JSON.stringify(excelData));
      originalData = JSON.parse(JSON.stringify(excelData));
      filteredData = [...studentsData];

      updateStats();
      displayTable();

      showMessage('success', `โหลดข้อมูลจาก Excel สำเร็จ (${excelData.length} คน)`);
    }

    // Clear Excel data
    function clearExcelData() {
      excelData = [];
      uploadedFileName = '';
      document.getElementById('excelFile').value = '';
      document.getElementById('excelPreview').style.display = 'none';
      document.getElementById('excelStatus').className = 'status-box';
    }

    // Drag and drop support
    document.addEventListener('DOMContentLoaded', function () {
      const uploadArea = document.getElementById('uploadArea');
      if (uploadArea) {
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
          uploadArea.addEventListener(eventName, e => {
            e.preventDefault();
            e.stopPropagation();
          });
        });

        ['dragenter', 'dragover'].forEach(eventName => {
          uploadArea.addEventListener(eventName, () => uploadArea.classList.add('dragover'));
        });

        ['dragleave', 'drop'].forEach(eventName => {
          uploadArea.addEventListener(eventName, () => uploadArea.classList.remove('dragover'));
        });

        uploadArea.addEventListener('drop', e => {
          const files = e.dataTransfer.files;
          if (files.length > 0) {
            document.getElementById('excelFile').files = files;
            handleExcelUpload({ target: { files: files } });
          }
        });
      }
    });

    // เริ่มต้น
    window.onload = () => {
      console.log('🟢 Page loaded - starting data loading...');
      loadData().then(() => {
        console.log('✅ Data loaded successfully. Students:', studentsData.length);
        if (studentsData.length > 0) {
          console.log('📋 Sample data:', studentsData.slice(0, 2));
          console.log('✨ Search should work now');
        }
      }).catch(e => {
        console.error('❌ Error loading data:', e);
      });
      
      loadNotifications();

      // Auto-refresh notifications every 5 seconds (เช็คข้อมูลใหม่บ่อยขึ้น)
      notificationRefreshInterval = setInterval(() => {
        loadNotifications();
      }, 5000); // เปลี่ยนจาก 30000 (30 วินาที) เป็น 5000 (5 วินาที)
    };

    // Cleanup on page unload
    window.onbeforeunload = () => {
      if (notificationRefreshInterval) {
        clearInterval(notificationRefreshInterval);
      }
    };

    // Download single JSON file
    async function downloadJSON(filename) {
      try {
        showMessage('info', `กำลังดาวน์โหลด ${filename}...`);

        const response = await fetch(filename);
        if (!response.ok) {
          throw new Error(`ไม่พบไฟล์ ${filename}`);
        }

        const data = await response.json();
        const jsonStr = JSON.stringify(data, null, 2);
        const blob = new Blob([jsonStr], { type: 'application/json' });

        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);

        showMessage('success', `ดาวน์โหลด ${filename} สำเร็จ!`);
      } catch (error) {
        console.error('Download error:', error);
        showMessage('error', `เกิดข้อผิดพลาด: ${error.message}`);
      }
    }

    // Download all JSON files as ZIP
    async function downloadAllJSON() {
      const files = ['user2.1.json', 'th.json', 'log.json', 'toadmin.json', 'TPAC.json'];

      try {
        showMessage('info', 'กำลังเตรียมไฟล์ทั้งหมด...');

        // Load JSZip dynamically if not already loaded
        if (typeof JSZip === 'undefined') {
          await loadScript('https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js');
        }

        const zip = new JSZip();
        const timestamp = new Date().toISOString().slice(0, 10);

        // Fetch all files
        for (const filename of files) {
          try {
            const response = await fetch(filename);
            if (response.ok) {
              const data = await response.json();
              zip.file(filename, JSON.stringify(data, null, 2));
            }
          } catch (err) {
            console.warn(`Could not fetch ${filename}:`, err);
          }
        }

        // Generate ZIP
        const content = await zip.generateAsync({ type: 'blob' });

        // Download
        const url = URL.createObjectURL(content);
        const a = document.createElement('a');
        a.href = url;
        a.download = `ข้อมูลระบบ_${timestamp}.zip`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);

        showMessage('success', 'ดาวน์โหลดไฟล์ทั้งหมดสำเร็จ!');
      } catch (error) {
        console.error('ZIP download error:', error);
        showMessage('error', `เกิดข้อผิดพลาด: ${error.message}`);
      }
    }

    // Helper function to load external script
    function loadScript(src) {
      return new Promise((resolve, reject) => {
        const script = document.createElement('script');
        script.src = src;
        script.onload = resolve;
        script.onerror = reject;
        document.head.appendChild(script);
      });
    }

    // ========== Score History Functions ==========
    let scoreHistoryData = [];

    // Load score history from log.json
    async function loadScoreHistory() {
      try {
        const response = await fetch('log.json');
        const data = await response.json();
        scoreHistoryData = data;
        console.log('Loaded score history:', scoreHistoryData.length, 'records');
      } catch (err) {
        console.error('Error loading score history:', err);
        scoreHistoryData = [];
      }
    }

    // View student score history
    function viewStudentHistory(studentId, studentName) {
      const modal = document.getElementById('historyModalOverlay');
      const studentHistory = scoreHistoryData.filter(h => h.student_id === studentId);

      // Update student info in modal
      document.getElementById('historyStudentName').textContent = studentName;
      document.getElementById('historyStudentId').textContent = `รหัส: ${studentId}`;

      // Render history list
      const listContainer = document.getElementById('historyList');

      if (studentHistory.length === 0) {
        listContainer.innerHTML = `
            <div class="history-empty">
              <i class="fas fa-clipboard-list"></i>
              <p>ยังไม่มีประวัติการปรับคะแนน</p>
            </div>
          `;
      } else {
        // Sort by timestamp (newest first)
        studentHistory.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

        listContainer.innerHTML = studentHistory.map(h => {
          // รองรับหลาย field names สำหรับคะแนน
          const scoreChange = h.change || h.score_change || h.scoreChange || h.score || h.point || h.points || 0;
          const isPositive = scoreChange > 0;
          const scoreText = isPositive ? `+${scoreChange}` : scoreChange.toString();
          const timestamp = formatHistoryTimestamp(h.timestamp);
          const teacher = h.teacher || h.admin || 'ไม่ระบุ';

          return `
              <div class="history-item ${isPositive ? 'positive' : 'negative'}">
                <div class="history-score-badge ${isPositive ? 'positive' : 'negative'}">
                  ${scoreText}
                </div>
                <div class="history-content">
                  <div class="history-reason">${h.reason || 'ไม่ระบุสาเหตุ'}</div>
                  <div class="history-meta">
                    <span><i class="fas fa-clock"></i> ${timestamp}</span>
                    <span><i class="fas fa-user"></i> ${teacher}</span>
                  </div>
                </div>
              </div>
            `;
        }).join('');
      }

      modal.classList.add('show');
    }

    // Format timestamp to Thai locale
    function formatHistoryTimestamp(isoString) {
      if (!isoString) return 'ไม่ระบุเวลา';
      try {
        const date = new Date(isoString);
        return date.toLocaleDateString('th-TH', {
          year: 'numeric',
          month: 'long',
          day: 'numeric',
          hour: '2-digit',
          minute: '2-digit'
        });
      } catch (e) {
        return isoString;
      }
    }

    // Close history modal
    function closeHistoryModal() {
      const modal = document.getElementById('historyModalOverlay');
      modal.classList.remove('show');
    }

    // Load history when page loads
    document.addEventListener('DOMContentLoaded', function () {
      loadScoreHistory();
    });

    // ========== PDF Export Function ==========

    // Export students with score < 100 to PDF (uses filteredData based on selected class filter)
    function exportLowScorePDF() {
      // ใช้ filteredData แทน studentsData เพื่อให้ตรงกับ filter ที่เลือก
      var lowScoreStudents = filteredData.filter(function (s) { return s.score < 100; });
      if (lowScoreStudents.length === 0) {
        showStatus('warning', 'ไม่มีนักเรียนที่คะแนนต่ำกว่า 100 คะแนน' + (selectedClass ? ' ในห้อง ' + formatClassName(selectedClass) : ''));
        return;
      }
      var now = new Date();
      var thaiMonths = ['มกราคม', 'กุมภาพันธ์', 'มีนาคม', 'เมษายน', 'พฤษภาคม', 'มิถุนายน', 'กรกฎาคม', 'สิงหาคม', 'กันยายน', 'ตุลาคม', 'พฤศจิกายน', 'ธันวาคม'];
      var currentMonth = thaiMonths[now.getMonth()];
      var currentYear = now.getFullYear() + 543;
      // แสดงชื่อห้องเรียนที่เลือก
      var classDisplay = selectedClass ? formatClassName(selectedClass) : 'ทุกห้อง';
      lowScoreStudents.sort(function (a, b) {
        if (a.class !== b.class) return a.class - b.class;
        return a.score - b.score;
      });
      var tableRows = '';
      for (var i = 0; i < lowScoreStudents.length; i++) {
        var s = lowScoreStudents[i];
        var scoreClass = s.score < 60 ? 'score-low' : s.score < 80 ? 'score-med' : 'score-ok';
        var remark = s.score < 60 ? 'คะแนนวิกฤต' : s.score < 80 ? 'ต้องปรับปรุง' : 'ใกล้ปกติ';
        tableRows += '<tr><td style="text-align:center;">' + (i + 1) + '</td>';
        tableRows += '<td style="text-align:center;">' + s.id + '</td>';
        tableRows += '<td>' + s.name + '</td>';
        tableRows += '<td style="text-align:center;">' + formatClassName(s.class) + '</td>';
        tableRows += '<td class="' + scoreClass + '" style="text-align:center;">' + s.score + '</td>';
        tableRows += '<td style="text-align:center;font-size:11px;">' + remark + '</td></tr>';
      }
      var html = '<!DOCTYPE html><html><head><meta charset="UTF-8">';
      html += '<title>รายงานคะแนนต่ำ</title>';
      html += '<link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;600&display=swap" rel="stylesheet">';
      html += '<style>body{font-family:Sarabun,sans-serif;padding:15px;font-size:12px;}';
      html += '.header{text-align:center;margin-bottom:20px;}.header h1{font-size:18px;margin-bottom:5px;color:#dc3545;}';
      html += '.summary{background:#f8f9fa;padding:10px;border-left:4px solid #dc3545;margin-bottom:15px;}';
      html += 'table{width:100%;border-collapse:collapse;}th{background:#dc3545;color:white;padding:8px;text-align:center;}';
      html += 'td{padding:6px;border:1px solid #ddd;}tr:nth-child(even){background:#f9f9f9;}';
      html += '.score-low{color:#dc3545;font-weight:bold;}.score-med{color:#fd7e14;font-weight:bold;}.score-ok{color:#ffc107;font-weight:bold;}';
      html += '@media print{@page{margin:1cm;}}</style></head><body>';
      html += '<div class="header"><h1>รายงานนักเรียนคะแนนต่ำกว่า 100</h1>';
      html += '<p>ห้องเรียน: ' + classDisplay + '</p>';
      html += '<p>ประจำเดือน ' + currentMonth + ' พ.ศ. ' + currentYear + '</p></div>';
      html += '<div class="summary"><strong>สรุป:</strong> นักเรียนคะแนนต่ำ <strong style="color:#dc3545;">' + lowScoreStudents.length + '</strong> คน</div>';
      html += '<table><thead><tr><th>ลำดับ</th><th>รหัส</th><th>ชื่อ-นามสกุล</th><th>ห้อง</th><th>คะแนน</th><th>หมายเหตุ</th></tr></thead>';
      html += '<tbody>' + tableRows + '</tbody></table>';
      html += '<script>setTimeout(function(){window.print();},500);<\/script></body></html>';
      var printWindow = window.open('', '_blank');
      printWindow.document.write(html);
      printWindow.document.close();
      showStatus('success', 'เปิดหน้าพิมพ์แล้ว - เลือก "บันทึกเป็น PDF"');
    }

    // Export ALL students to PDF (uses filteredData based on selected class filter)
    function exportAllStudentsPDF() {
      // ใช้ filteredData แทน studentsData เพื่อให้ตรงกับ filter ที่เลือก
      if (filteredData.length === 0) {
        showStatus('error', 'ไม่มีข้อมูลนักเรียน' + (selectedClass ? ' ในห้อง ' + formatClassName(selectedClass) : '') + ' กรุณาโหลดข้อมูลก่อน');
        return;
      }
      var now = new Date();
      var thaiMonths = ['มกราคม', 'กุมภาพันธ์', 'มีนาคม', 'เมษายน', 'พฤษภาคม', 'มิถุนายน', 'กรกฎาคม', 'สิงหาคม', 'กันยายน', 'ตุลาคม', 'พฤศจิกายน', 'ธันวาคม'];
      var currentMonth = thaiMonths[now.getMonth()];
      var currentYear = now.getFullYear() + 543;
      // แสดงชื่อห้องเรียนที่เลือก
      var classDisplay = selectedClass ? formatClassName(selectedClass) : 'ทุกห้อง';
      var sortedStudents = filteredData.slice().sort(function (a, b) {
        if (a.class !== b.class) return a.class - b.class;
        return a.name.localeCompare(b.name, 'th');
      });
      var tableRows = '';
      for (var i = 0; i < sortedStudents.length; i++) {
        var s = sortedStudents[i];
        var scoreClass = s.score >= 100 ? 'score-high' : s.score >= 80 ? 'score-med' : 'score-low';
        tableRows += '<tr><td style="text-align:center;">' + (i + 1) + '</td>';
        tableRows += '<td style="text-align:center;">' + s.id + '</td>';
        tableRows += '<td>' + s.name + '</td>';
        tableRows += '<td style="text-align:center;">' + formatClassName(s.class) + '</td>';
        tableRows += '<td class="' + scoreClass + '" style="text-align:center;">' + s.score + '</td></tr>';
      }
      var html = '<!DOCTYPE html><html><head><meta charset="UTF-8">';
      html += '<title>รายงานคะแนนนักเรียน</title>';
      html += '<link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;600&display=swap" rel="stylesheet">';
      html += '<style>body{font-family:Sarabun,sans-serif;padding:15px;font-size:12px;}';
      html += '.header{text-align:center;margin-bottom:20px;}.header h1{font-size:18px;margin-bottom:5px;}';
      html += 'table{width:100%;border-collapse:collapse;}th{background:#6c63ff;color:white;padding:8px;text-align:center;}';
      html += 'td{padding:6px;border:1px solid #ddd;}tr:nth-child(even){background:#f9f9f9;}';
      html += '.score-high{color:#28a745;font-weight:bold;}.score-med{color:#ffc107;font-weight:bold;}.score-low{color:#dc3545;font-weight:bold;}';
      html += '@media print{@page{margin:1cm;}}</style></head><body>';
      html += '<div class="header"><h1>รายงานคะแนนพฤติกรรมนักเรียน</h1>';
      html += '<p>ห้องเรียน: ' + classDisplay + '</p>';
      html += '<p>ประจำเดือน ' + currentMonth + ' พ.ศ. ' + currentYear + '</p></div>';
      html += '<table><thead><tr><th>ลำดับ</th><th>รหัส</th><th>ชื่อ-นามสกุล</th><th>ห้อง</th><th>คะแนน</th></tr></thead>';
      html += '<tbody>' + tableRows + '</tbody></table>';
      html += '<script>setTimeout(function(){window.print();},500);<\/script></body></html>';
      var printWindow = window.open('', '_blank');
      printWindow.document.write(html);
      printWindow.document.close();
      showStatus('success', 'เปิดหน้าพิมพ์แล้ว - เลือก "บันทึกเป็น PDF"');
    }

    // ========== All History Viewer Functions ==========

    // Open All History Modal
    async function openAllHistoryModal() {
      const modal = document.getElementById('allHistoryModalOverlay');
      modal.classList.add('show');

      // Show loading state
      document.getElementById('allHistoryList').innerHTML = `
        <div class="history-empty">
          <i class="fas fa-spinner fa-spin"></i>
          <p>กำลังโหลดข้อมูล...</p>
        </div>
      `;

      // Reload score history data from log.json every time
      await loadScoreHistory();

      // Populate filters
      populateAllHistoryFilters();

      // Show all history initially
      filterAllHistory();
    }

    // Close All History Modal
    function closeAllHistoryModal() {
      const modal = document.getElementById('allHistoryModalOverlay');
      modal.classList.remove('show');
    }

    // Populate filter dropdowns
    function populateAllHistoryFilters() {
      // Populate class filter
      const classFilter = document.getElementById('allHistoryClassFilter');
      const classes = getUniqueClasses();

      classFilter.innerHTML = '<option value="">ทุกห้อง</option>';
      classes.forEach(classCode => {
        const option = document.createElement('option');
        option.value = classCode;
        option.textContent = formatClassName(classCode);
        classFilter.appendChild(option);
      });

      // Populate year filter from history data
      const yearFilter = document.getElementById('allHistoryYearFilter');
      const years = new Set();
      scoreHistoryData.forEach(h => {
        if (h.timestamp) {
          const date = new Date(h.timestamp);
          const year = date.getFullYear() + 543; // Convert to พ.ศ.
          years.add(year);
        }
      });

      yearFilter.innerHTML = '<option value="">ทุกปี</option>';
      Array.from(years).sort((a, b) => b - a).forEach(year => {
        const option = document.createElement('option');
        option.value = year;
        option.textContent = year;
        yearFilter.appendChild(option);
      });
    }

    // Apply all filters and render history
    function filterAllHistory() {
      const classFilter = document.getElementById('allHistoryClassFilter').value;
      const monthFilter = document.getElementById('allHistoryMonthFilter').value;
      const yearFilter = document.getElementById('allHistoryYearFilter').value;
      const searchQuery = document.getElementById('allHistorySearchInput').value.toLowerCase().trim();

      let filtered = [...scoreHistoryData];

      // Filter by class
      if (classFilter) {
        filtered = filtered.filter(h => {
          const student = studentsData.find(s => s.id === h.student_id);
          return student && String(student.class) === classFilter;
        });
      }

      // Filter by month
      if (monthFilter) {
        filtered = filtered.filter(h => {
          if (!h.timestamp) return false;
          const date = new Date(h.timestamp);
          return (date.getMonth() + 1) === parseInt(monthFilter);
        });
      }

      // Filter by year (พ.ศ.)
      if (yearFilter) {
        filtered = filtered.filter(h => {
          if (!h.timestamp) return false;
          const date = new Date(h.timestamp);
          const yearBE = date.getFullYear() + 543;
          return yearBE === parseInt(yearFilter);
        });
      }

      // Filter by search (respects class filter - only searches within selected class)
      if (searchQuery) {
        filtered = filtered.filter(h => {
          const student = studentsData.find(s => s.id === h.student_id);
          if (!student) return false;

          const nameMatch = student.name.toLowerCase().includes(searchQuery);
          const idMatch = student.id.toLowerCase().includes(searchQuery);
          return nameMatch || idMatch;
        });
      }

      // Sort by timestamp (newest first)
      filtered.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

      // Render results
      renderAllHistory(filtered);
    }

    // Render all history items
    function renderAllHistory(historyItems) {
      const listContainer = document.getElementById('allHistoryList');
      const statsContainer = document.getElementById('allHistoryStats');

      // Calculate stats
      const totalRecords = historyItems.length;
      const positiveCount = historyItems.filter(h => {
        const change = h.change || h.score_change || h.scoreChange || h.score || h.point || h.points || 0;
        return change > 0;
      }).length;
      const negativeCount = historyItems.filter(h => {
        const change = h.change || h.score_change || h.scoreChange || h.score || h.point || h.points || 0;
        return change < 0;
      }).length;

      // Render stats
      statsContainer.innerHTML = `
        <div class="all-history-stat">
          <i class="fas fa-list"></i> ทั้งหมด: ${totalRecords} รายการ
        </div>
        <div class="all-history-stat" style="background: linear-gradient(135deg, #10b981, #059669);">
          <i class="fas fa-plus-circle"></i> เพิ่มคะแนน: ${positiveCount}
        </div>
        <div class="all-history-stat" style="background: linear-gradient(135deg, #ef4444, #dc2626);">
          <i class="fas fa-minus-circle"></i> ลดคะแนน: ${negativeCount}
        </div>
      `;

      // Render list
      if (historyItems.length === 0) {
        listContainer.innerHTML = `
          <div class="history-empty">
            <i class="fas fa-search"></i>
            <p>ไม่พบประวัติที่ตรงกับเงื่อนไข</p>
          </div>
        `;
        return;
      }

      // Limit to first 100 items for performance
      const displayItems = historyItems.slice(0, 100);

      listContainer.innerHTML = displayItems.map(h => {
        const student = studentsData.find(s => s.id === h.student_id);
        const studentName = student ? student.name : 'ไม่พบข้อมูลนักเรียน';
        const studentClass = student ? formatClassName(student.class) : '-';

        const scoreChange = h.change || h.score_change || h.scoreChange || h.score || h.point || h.points || 0;
        const isPositive = scoreChange > 0;
        const scoreText = isPositive ? '+' + scoreChange : scoreChange.toString();
        const timestamp = formatHistoryTimestamp(h.timestamp);
        const teacher = h.teacher || h.admin || 'ไม่ระบุ';

        return `
          <div class="all-history-item ${isPositive ? 'positive' : 'negative'}">
            <div class="all-history-student">
              <span class="all-history-student-name">${studentName}</span>
              <span class="all-history-student-class">${studentClass}</span>
            </div>
            <div class="all-history-details">
              <div class="all-history-reason">${h.reason || 'ไม่ระบุสาเหตุ'}</div>
              <div class="all-history-meta">
                <span><i class="fas fa-clock"></i> ${timestamp}</span>
                <span><i class="fas fa-user"></i> ${teacher}</span>
              </div>
            </div>
            <div class="all-history-score ${isPositive ? 'positive' : 'negative'}">
              ${scoreText}
            </div>
          </div>
        `;
      }).join('');

      // Add info about limited results
      if (historyItems.length > 100) {
        listContainer.innerHTML += `
          <div style="text-align: center; padding: 20px; color: #64748b; font-size: 0.9rem;">
            <i class="fas fa-info-circle"></i> แสดง 100 รายการแรก จากทั้งหมด ${historyItems.length} รายการ
          </div>
        `;
      }
    }
  </script>

  </div>
  </div>
  </div>

  <!-- Score History Modal -->
  <div class="history-modal-overlay" id="historyModalOverlay">
    <!-- Included Content -->
    <!-- (Previous step verified this existed, so I assume I am appending to the file correctly) -->
  </div>

  <!-- ==================== NEW FEATURES MODALS ==================== -->

  <!-- Manual Input Modal -->
  <div class="manual-input-modal" id="manualInputModal">
    <div class="manual-input-content">
      <h3>กรอกรหัสนักเรียน</h3>
      <p>พิมพ์รหัสนักเรียนที่ต้องการเพิ่ม/ลดคะแนน</p>
      <input type="text" id="manualStudentId" placeholder="12345" maxlength="10"
        style="width: 100%; padding: 12px; margin: 15px 0; border: 2px solid #e2e8f0; border-radius: 10px; font-size: 1.2em; text-align: center;"
        onkeypress="if(event.key === 'Enter') submitManualInput()">
      <div style="display: flex; gap: 10px; justify-content: center;">
        <button onclick="closeManualInput()" class="btn btn-warning">ยกเลิก</button>
        <button onclick="submitManualInput()" class="btn btn-primary">ยืนยัน</button>
      </div>
    </div>
  </div>

  <!-- QR Scanner Modal -->
  <div class="qr-scanner-overlay" id="qrScannerModal">
    <div
      style="position: relative; width: 100%; height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center;">
      <button onclick="closeQRScanner()"
        style="position: absolute; top: 20px; right: 20px; background: white; border: none; width: 40px; height: 40px; border-radius: 50%; font-size: 1.5rem; z-index: 2100;">&times;</button>
      <div id="qr-reader" style="width: 100%; max-width: 500px;"></div>
      <p style="color: white; margin-top: 20px;">วาง QR Code ให้อยู่ในกรอบ</p>
    </div>
  </div>

  <!-- Student Search Modal -->
  <div class="student-search-overlay" id="studentSearchOverlay">
    <div class="student-search-modal">
      <div class="student-search-header">
        <h3><i class="fas fa-search"></i> ค้นหานักเรียน</h3>
        <button onclick="closeStudentSearchModal()"
          style="background:none; border:none; font-size:1.5rem; cursor:pointer;">&times;</button>
      </div>
      <div style="padding: 15px; display: flex; gap: 10px;">
        <input type="text" id="studentSearchInput" placeholder="พิมพ์ชื่อหรือรหัส..."
          style="flex:1; padding: 10px; border-radius: 8px; border: 1px solid #ccc;" oninput="filterStudentSearch()">
        <select id="studentSearchClassFilter" onchange="filterStudentSearch()"
          style="padding: 10px; border-radius: 8px; border: 1px solid #ccc;">
          <option value="">ทุกห้อง</option>
        </select>
      </div>
      <div class="student-search-results" id="studentSearchResults">
        <!-- Results -->
      </div>
    </div>
  </div>

  <!-- Action Form Modal (Previously qrForm) -->
  <div class="modal" id="actionFormModal">
    <div class="modal-content" style="max-width: 600px;">
      <div class="modal-header">
        <h3><i class="fas fa-user-edit"></i> บันทึกคะแนนพฤติกรรม</h3>
        <button class="close-btn" onclick="closeActionForm()">&times;</button>
      </div>

      <div
        style="background: #f0f9ff; padding: 15px; border-radius: 10px; margin-bottom: 20px; border-left: 4px solid #3b82f6;">
        <div style="font-weight: bold; font-size: 1.1em;" id="actionStudentName"></div>
        <div style="color: #64748b;" id="actionStudentId"></div>
      </div>

      <div class="form-group">
        <label>เลือกสาเหตุ (หักคะแนน):</label>
        <div class="deduction-reasons-grid" id="deductionReasonsContainer">
          <div class="deduction-checkbox-item" onclick="toggleDeduction(this)">
            <input type="checkbox" value="มาสาย"> <label>มาสาย</label>
          </div>
          <!-- Add more options as needed -->
          <div class="deduction-checkbox-item" onclick="toggleDeduction(this)">
            <input type="checkbox" value="ไม่สวมหมวกกันน็อค"> <label>ไม่สวมหมวกกันน็อค</label>
          </div>
          <div class="deduction-checkbox-item" onclick="toggleDeduction(this)">
            <input type="checkbox" value="หนีเรียน"> <label>หนีเรียน</label>
          </div>
          <div class="deduction-checkbox-item" onclick="toggleDeduction(this)">
            <input type="checkbox" value="สูบบุหรี่"> <label>สูบบุหรี่</label>
          </div>
          <div class="deduction-checkbox-item" onclick="toggleDeduction(this)">
            <input type="checkbox" value="บุหรี่ไฟฟ้า"> <label>บุหรี่ไฟฟ้า</label>
          </div>
          <div class="deduction-checkbox-item" onclick="toggleDeduction(this)">
            <input type="checkbox" value="การแต่งกายผิดระเบียบ"> <label>การแต่งกายผิดระเบียบ</label>
          </div>
          <div class="deduction-checkbox-item" onclick="toggleDeduction(this)">
            <input type="checkbox" value="สิงห้องน้ำ"> <label>สิงห้องน้ำ</label>
          </div>
          <div class="deduction-checkbox-item" onclick="toggleDeduction(this)">
            <input type="checkbox" value="ใช้สื่อโซเชียลไม่เหมาะสม"> <label>ใช้สื่อโซเชียลไม่เหมาะสม</label>
          </div>
          <div class="deduction-checkbox-item" onclick="toggleDeduction(this)">
            <input type="checkbox" value="บูลลี่"> <label>บูลลี่</label>
          </div>
          <div class="deduction-checkbox-item" onclick="toggleDeduction(this)">
            <input type="checkbox" value="แอบถ่ายรูป"> <label>แอบถ่ายรูป</label>
          </div>
          <div class="deduction-checkbox-item" onclick="toggleDeduction(this)">
            <input type="checkbox" value="เล่นไพ่/การพนัน"> <label>เล่นไพ่/การพนัน</label>
          </div>
          <div class="deduction-checkbox-item" onclick="toggleDeduction(this)">
            <input type="checkbox" value="ทะเลาะวิวาท"> <label>ทะเลาะวิวาท</label>
          </div>
          <div class="deduction-checkbox-item" onclick="toggleDeduction(this)">
            <input type="checkbox" value="ทำลายทรัพย์สิน"> <label>ทำลายทรัพย์สิน</label>
          </div>
        </div>
      </div>

      <div class="form-group">
        <label>ระบุเพิ่มเติม / อื่นๆ:</label>
        <textarea id="actionReason" rows="3" placeholder="ระบุรายละเอียด..."></textarea>
      </div>

      <div style="display: flex; gap: 10px; justify-content: flex-end;">
        <button class="btn btn-warning" onclick="closeActionForm()">ยกเลิก</button>
        <button class="btn btn-success" onclick="submitActionForm()"><i class="fas fa-save"></i> บันทึก</button>
      </div>
    </div>
  </div>

  <script>
    // ==================== NEW FEATURES LOGIC ====================

    // 1. Manual Input
    function openManualInput() {
      const modal = document.getElementById('manualInputModal');
      const input = document.getElementById('manualStudentId');
      console.log('Opening manual input. allStudents available:', !!window.allStudents, 'Count:', window.allStudents?.length);
      modal.classList.add('show');
      input.value = '';
      setTimeout(() => input.focus(), 100);
    }

    function closeManualInput() {
      document.getElementById('manualInputModal').classList.remove('show');
    }

    function submitManualInput() {
      const input = document.getElementById('manualStudentId');
      const studentId = input.value.trim();
      console.log('Searching for student ID:', studentId);
      console.log('Available students:', window.allStudents?.length);

      if (studentId) {
        closeManualInput();
        processScannedQR(studentId);
      } else {
        showToast('error', 'กรุณากรอกรหัสนักเรียน');
        input.focus();
      }
    }

    // 2. Student Search
    function openStudentSearchModal() {
      const modal = document.getElementById('studentSearchOverlay');
      modal.classList.add('show');
      document.getElementById('studentSearchInput').value = '';
      populateSearchClassFilter();
      filterStudentSearch();
    }

    function closeStudentSearchModal() {
      document.getElementById('studentSearchOverlay').classList.remove('show');
    }

    function populateSearchClassFilter() {
      const filter = document.getElementById('studentSearchClassFilter');
      const classes = [...new Set(window.studentsData ? window.studentsData.map(s => s.class) : [])].sort((a, b) => a - b);
      filter.innerHTML = '<option value="">ทุกห้อง</option>' + classes.map(c => `<option value="${c}">ห้อง ${c}</option>`).join('');
    }

    function filterStudentSearch() {
      const query = document.getElementById('studentSearchInput').value.toLowerCase();
      const cls = document.getElementById('studentSearchClassFilter').value;
      const results = (window.studentsData || []).filter(s =>
        (cls === '' || String(s.class) === cls) &&
        (s.name.toLowerCase().includes(query) || s.id.includes(query))
      ).slice(0, 50);

      document.getElementById('studentSearchResults').innerHTML = results.length ? results.map(s => `
            <div class="student-search-item" onclick="selectStudent('${s.id}')">
                <div class="student-search-item-info">
                    <div class="student-search-item-name">${s.name}</div>
                    <div class="student-search-item-meta">รหัส: ${s.id} | ห้อง: ${s.class}</div>
                </div>
                <button class="btn btn-sm btn-success">เลือก</button>
            </div>
        `).join('') : '<div style="text-align:center; padding:20px; color:#666;">ไม่พบข้อมูล</div>';
    }

    function selectStudent(id) {
      closeStudentSearchModal();
      processScannedQR(id);
    }

    // 3. QR Processing & Action Form
    async function processScannedQR(decodedText) {
      // Check if allStudents is loaded
      if (!window.allStudents || !Array.isArray(window.allStudents)) {
        console.error('allStudents not loaded:', window.allStudents);
        showToast('error', 'ข้อมูลนักเรียนยังไม่โหลด กรุณารอสักครู่');
        return;
      }

      // Ensure decodedText is string for comparison
      const searchId = String(decodedText).trim();
      
      // Find student by ID from ALL students
      const student = window.allStudents.find(s => String(s.id).trim() === searchId);

      if (student) {
        // Open Action Form Modal
        const modal = document.getElementById('actionFormModal');
        document.getElementById('actionStudentName').textContent = student.name;
        document.getElementById('actionStudentId').textContent = 'รหัส: ' + student.id;
        document.getElementById('actionStudentId').dataset.id = student.id;

        // Reset Form
        document.getElementById('actionReason').value = '';
        document.querySelectorAll('.deduction-checkbox-item input').forEach(cb => cb.checked = false);
        document.querySelectorAll('.deduction-checkbox-item').forEach(div => div.classList.remove('checked'));

        modal.classList.add('show');
        showToast('success', `พบนักเรียน: ${student.name}`);
      } else {
        console.warn('Student not found:', searchId, 'in', window.allStudents.length, 'students');
        showToast('error', `ไม่พบข้อมูลนักเรียน รหัส: ${decodedText}`);
      }
    }

    function closeActionForm() {
      document.getElementById('actionFormModal').classList.remove('show');
    }

    function toggleDeduction(div) {
      const cb = div.querySelector('input');
      cb.checked = !cb.checked;
      div.classList.toggle('checked', cb.checked);

      // Auto-update textarea
      const checked = Array.from(document.querySelectorAll('.deduction-checkbox-item input:checked')).map(c => c.value);
      document.getElementById('actionReason').value = checked.join(', ');
    }

    async function submitActionForm() {
      const studentId = document.getElementById('actionStudentId').dataset.id;
      const student = studentsData.find(s => s.id === studentId);
      const reason = document.getElementById('actionReason').value.trim();

      if (!reason) { alert('กรุณาระบุสาเหตุ'); return; }

      try {
        const currentUser = JSON.parse(sessionStorage.getItem('currentUser') || '{}');
        const data = {
          student_id: student.id,
          student_name: student.name,
          reason: reason,
          teacher: currentUser.name || 'Admin',
          timestamp: new Date().toISOString()
        };

        const res = await fetch('/api/save-toadmin', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });
        const result = await res.json();

        if (result.status === 'success') {
          alert('บันทึกข้อมูลเรียบร้อยแล้ว');
          closeActionForm();
          if (typeof loadNotifications === 'function') loadNotifications();
          closeQRScanner();
        } else {
          alert('Error: ' + result.message);
        }
      } catch (e) {
        console.error(e);
        alert('Error submitting form');
      }
    }

    // 4. QR Scanner
    let scanner = null;
    function openQRScanner() {
      document.getElementById('qrScannerModal').classList.add('show');
      const width = window.innerWidth > 500 ? 500 : 250;
      scanner = new Html5Qrcode("qr-reader");
      scanner.start({ facingMode: "environment" }, { fps: 10, qrbox: width },
        (decodedText) => {
          scanner.stop().then(() => {
            closeQRScanner();
            processScannedQR(decodedText);
          });
        }
      ).catch(err => {
        console.error(err);
        // alert('ไม่สามารถเปิดกล้องได้');
      });
    }

    function closeQRScanner() {
      document.getElementById('qrScannerModal').classList.remove('show');
      if (scanner) {
        try { scanner.stop(); } catch (e) { }
        scanner = null;
      }
    }

    function processQRImage(input) {
      if (input.files && input.files[0]) {
        const reader = new FileReader();
        reader.onload = function (e) {
          const img = new Image();
          img.onload = function () {
            const canvas = document.createElement("canvas");
            const context = canvas.getContext("2d");
            canvas.width = img.width;
            canvas.height = img.height;
            context.drawImage(img, 0, 0, img.width, img.height);
            const imageData = context.getImageData(0, 0, canvas.width, canvas.height);
            const code = jsQR(imageData.data, imageData.width, imageData.height);
            if (code) {
              processScannedQR(code.data);
            } else {
              alert("ไม่พบ QR Code ในรูปภาพ");
            }
            input.value = ''; // Reset
          };
          img.src = e.target.result;
        };
        reader.readAsDataURL(input.files[0]);
      }
    }
  </script>

  <!-- All History Viewer Modal -->
  <div class="all-history-modal-overlay" id="allHistoryModalOverlay">
    <div class="all-history-modal">
      <div class="all-history-header">
        <h2><i class="fas fa-history"></i> ประวัติคะแนนทั้งหมด</h2>
        <button class="history-close-btn" onclick="closeAllHistoryModal()">×</button>
      </div>

      <div class="all-history-filters">
        <div class="filter-item">
          <label><i class="fas fa-school"></i> ห้องเรียน</label>
          <select id="allHistoryClassFilter" onchange="filterAllHistory()">
            <option value="">ทุกห้อง</option>
          </select>
        </div>
        <div class="filter-item">
          <label><i class="fas fa-calendar"></i> เดือน</label>
          <select id="allHistoryMonthFilter" onchange="filterAllHistory()">
            <option value="">ทุกเดือน</option>
            <option value="1">มกราคม</option>
            <option value="2">กุมภาพันธ์</option>
            <option value="3">มีนาคม</option>
            <option value="4">เมษายน</option>
            <option value="5">พฤษภาคม</option>
            <option value="6">มิถุนายน</option>
            <option value="7">กรกฎาคม</option>
            <option value="8">สิงหาคม</option>
            <option value="9">กันยายน</option>
            <option value="10">ตุลาคม</option>
            <option value="11">พฤศจิกายน</option>
            <option value="12">ธันวาคม</option>
          </select>
        </div>
        <div class="filter-item">
          <label><i class="fas fa-calendar-alt"></i> ปี (พ.ศ.)</label>
          <select id="allHistoryYearFilter" onchange="filterAllHistory()">
            <option value="">ทุกปี</option>
          </select>
        </div>
        <div class="filter-item">
          <label><i class="fas fa-search"></i> ค้นหานักเรียน</label>
          <input type="text" id="allHistorySearchInput" placeholder="พิมพ์ชื่อหรือรหัส..." oninput="filterAllHistory()">
        </div>
      </div>

      <div class="all-history-stats" id="allHistoryStats">
        <!-- Stats will be rendered here -->
      </div>

      <div class="all-history-list-container">
        <div class="all-history-list" id="allHistoryList">
          <!-- History items will be rendered here -->
        </div>
      </div>
    </div>
  </div>

  <!-- Copyright Footer -->
  <div
    style="background: white; color: #718096; text-align: center; padding: 20px; font-size: 0.9rem; margin-top: 30px; border-top: 2px solid #f0f0f0; border-radius: 0 0 15px 15px;">
    © 2026 นางสาวสโรชา เมืองมุสิก & ด.ช.เทิดศักดิ์ สุวรรณมาลี
  </div>

  <!-- Image Viewer Modal -->
  <div id="imageViewerModal" class="modal" onclick="closeImageViewer()">
    <span class="close-btn"
      style="position: absolute; top: 20px; right: 30px; color: white; font-size: 3em;">&times;</span>
    <img class="modal-content" id="fullImage"
      style="max-width: 90%; max-height: 90vh; object-fit: contain; background: transparent; padding: 0;">
  </div>

  <!-- Manual Score Adjustment Modal -->
  <div id="manualScoreModal" class="modal">
    <div class="modal-content" style="max-width: 400px; padding: 20px; text-align: center;">
      <h3>⚡ ดำเนินการให้คะแนน</h3>
      <p>ไม่พบกฎการหักคะแนนอัตโนมัติ กรุณาระบุคะแนน:</p>

      <div style="margin: 20px 0;">
        <input type="number" id="manualScoreInput" placeholder="เช่น -5 หรือ 10"
          style="width: 100%; padding: 12px; font-size: 1.2em; text-align: center; border: 2px solid #e2e8f0; border-radius: 8px;">
        <div style="margin-top: 10px; font-size: 0.9em; color: #718096;">
          ใส่เครื่องหมาย - เพื่อหักคะแนน (เช่น -10)<br>
          ใส่ตัวเลขปกติเพื่อเพิ่มคะแนน (เช่น 5)
        </div>
      </div>

      <div class="modal-actions" style="justify-content: center; gap: 10px; display: flex;">
        <button onclick="closeManualScoreModal()"
          style="padding: 10px 20px; background: #cbd5e0; border: none; border-radius: 8px; cursor: pointer;">ยกเลิก</button>
        <button onclick="confirmManualScore()"
          style="padding: 10px 20px; background: #4299e1; color: white; border: none; border-radius: 8px; cursor: pointer;">ยืนยัน</button>
      </div>
    </div>
  </div>

  <script>
    let pendingNotificationDiff = null;

    function viewImage(src) {
      const modal = document.getElementById('imageViewerModal');
      const img = document.getElementById('fullImage');
      img.src = src;
      modal.classList.add('show');
    }

    function closeImageViewer() {
      document.getElementById('imageViewerModal').classList.remove('show');
    }

    function closeManualScoreModal() {
      document.getElementById('manualScoreModal').classList.remove('show');
      pendingNotificationDiff = null;
    }

    async function confirmManualScore() {
      const input = document.getElementById('manualScoreInput');
      const scoreChange = parseInt(input.value);

      if (isNaN(scoreChange)) {
        alert('กรุณากรอกตัวเลข');
        return;
      }

      if (!pendingNotificationDiff) return;

      const { notification, actualIndex, adminName, index } = pendingNotificationDiff;

      try {
        // Apply Score Change
        const student = studentsData.find(s => s.id === notification.student_id);
        if (student) {
          const newScore = Math.max(0, student.score + scoreChange);

          // Call API
          const scoreResponse = await fetch('/api/save-score', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              id: student.id,
              score: newScore,
              reason: `ปรับคะแนนแบบฟอร์ม: ${notification.reason || 'Manual'}`
            })
          });

          if (scoreResponse.ok) {
            student.score = newScore;
          }
        }

        // Finalize
        closeManualScoreModal();
        await finalizeCompletion(index, actualIndex, adminName);

      } catch (e) {
        console.error(e);
        showStatus('error', 'เกิดข้อผิดพลาด');
      }
    }
    .img-label {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      background: rgba(0, 0, 0, 0.6);
      color: white;
      font-size: 0.7em;
      text-align: center;
      padding: 2px 0;
      border-bottom-left-radius: 6px;
      border-bottom-right-radius: 6px;
    }
  </style>
  <!-- ==================== NEW FEATURES MODALS ==================== -->

  <!-- Manual Input Modal -->
  <div class="manual-input-modal" id="manualInputModal">
    <div class="manual-input-content">
      <h3>กรอกรหัสนักเรียน</h3>
      <p>พิมพ์รหัสนักเรียนที่ต้องการเพิ่ม/ลดคะแนน</p>
      <input type="text" id="manualStudentId" placeholder="12345" maxlength="10"
        style="width: 100%; padding: 12px; margin: 15px 0; border: 2px solid #e2e8f0; border-radius: 10px; font-size: 1.2em; text-align: center;"
        onkeypress="if(event.key === 'Enter') submitManualInput()">
      <div style="display: flex; gap: 10px; justify-content: center;">
        <button onclick="closeManualInput()" class="btn btn-warning">ยกเลิก</button>
        <button onclick="submitManualInput()" class="btn btn-primary">ยืนยัน</button>
      </div>
    </div>
  </div>

  <!-- QR Scanner Modal -->
  <div class="qr-scanner-overlay" id="qrScannerModal">
    <div
      style="position: relative; width: 100%; height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center;">
      <button onclick="closeQRScanner()"
        style="position: absolute; top: 20px; right: 20px; background: white; border: none; width: 40px; height: 40px; border-radius: 50%; font-size: 1.5rem; z-index: 2100;">&times;</button>
      <div id="qr-reader" style="width: 100%; max-width: 500px;"></div>
      <p style="color: white; margin-top: 20px;">วาง QR Code ให้อยู่ในกรอบ</p>
    </div>
  </div>

  <!-- Student Search Modal -->
  <div class="student-search-overlay" id="studentSearchOverlay">
    <div class="student-search-modal">
      <div class="student-search-header">
        <h3><i class="fas fa-search"></i> ค้นหานักเรียน</h3>
        <button onclick="closeStudentSearchModal()"
          style="background:none; border:none; font-size:1.5rem; cursor:pointer;">&times;</button>
      </div>
      <div style="padding: 15px; display: flex; gap: 10px;">
        <input type="text" id="studentSearchInput" placeholder="พิมพ์ชื่อหรือรหัส..."
          style="flex:1; padding: 10px; border-radius: 8px; border: 1px solid #ccc;" oninput="filterStudentSearch()">
        <select id="studentSearchClassFilter" onchange="filterStudentSearch()"
          style="padding: 10px; border-radius: 8px; border: 1px solid #ccc;">
          <option value="">ทุกห้อง</option>
        </select>
      </div>
      <div class="student-search-results" id="studentSearchResults">
        <!-- Results -->
      </div>
    </div>
  </div>

  <!-- Action Form Modal (Previously qrForm) -->
  <div class="modal" id="actionFormModal">
    <div class="modal-content" style="max-width: 600px;">
      <div class="modal-header">
        <h3><i class="fas fa-user-edit"></i> บันทึกคะแนนพฤติกรรม</h3>
        <button class="close-btn" onclick="closeActionForm()">&times;</button>
      </div>

      <div
        style="background: #f0f9ff; padding: 15px; border-radius: 10px; margin-bottom: 20px; border-left: 4px solid #3b82f6;">
        <div style="font-weight: bold; font-size: 1.1em;" id="actionStudentName"></div>
        <div style="color: #64748b;" id="actionStudentId"></div>
      </div>

      <div class="form-group">
        <label>เลือกสาเหตุ (หักคะแนน):</label>
        <div class="deduction-reasons-grid" id="deductionReasonsContainer">
          <div class="deduction-checkbox-item" onclick="toggleDeduction(this)">
            <input type="checkbox" value="มาสาย"> <label>มาสาย</label>
          </div>
          <div class="deduction-checkbox-item" onclick="toggleDeduction(this)">
            <input type="checkbox" value="ไม่สวมหมวกกันน็อค"> <label>ไม่สวมหมวกกันน็อค</label>
          </div>
          <div class="deduction-checkbox-item" onclick="toggleDeduction(this)">
            <input type="checkbox" value="หนีเรียน"> <label>หนีเรียน</label>
          </div>
          <div class="deduction-checkbox-item" onclick="toggleDeduction(this)">
            <input type="checkbox" value="สูบบุหรี่"> <label>สูบบุหรี่</label>
          </div>
          <div class="deduction-checkbox-item" onclick="toggleDeduction(this)">
            <input type="checkbox" value="บุหรี่ไฟฟ้า"> <label>บุหรี่ไฟฟ้า</label>
          </div>
          <div class="deduction-checkbox-item" onclick="toggleDeduction(this)">
            <input type="checkbox" value="การแต่งกายผิดระเบียบ"> <label>การแต่งกายผิดระเบียบ</label>
          </div>
          <div class="deduction-checkbox-item" onclick="toggleDeduction(this)">
            <input type="checkbox" value="สิงห้องน้ำ"> <label>สิงห้องน้ำ</label>
          </div>
          <div class="deduction-checkbox-item" onclick="toggleDeduction(this)">
            <input type="checkbox" value="ใช้สื่อโซเชียลไม่เหมาะสม"> <label>ใช้สื่อโซเชียลไม่เหมาะสม</label>
          </div>
          <div class="deduction-checkbox-item" onclick="toggleDeduction(this)">
            <input type="checkbox" value="บูลลี่"> <label>บูลลี่</label>
          </div>
          <div class="deduction-checkbox-item" onclick="toggleDeduction(this)">
            <input type="checkbox" value="แอบถ่ายรูป"> <label>แอบถ่ายรูป</label>
          </div>
          <div class="deduction-checkbox-item" onclick="toggleDeduction(this)">
            <input type="checkbox" value="เล่นไพ่/การพนัน"> <label>เล่นไพ่/การพนัน</label>
          </div>
          <div class="deduction-checkbox-item" onclick="toggleDeduction(this)">
            <input type="checkbox" value="ทะเลาะวิวาท"> <label>ทะเลาะวิวาท</label>
          </div>
          <div class="deduction-checkbox-item" onclick="toggleDeduction(this)">
            <input type="checkbox" value="ทำลายทรัพย์สิน"> <label>ทำลายทรัพย์สิน</label>
          </div>
        </div>
      </div>

      <div class="form-group">
        <label>ระบุเพิ่มเติม / อื่นๆ:</label>
        <textarea id="actionReason" rows="3" placeholder="ระบุรายละเอียด..."></textarea>
      </div>

      <div style="display: flex; gap: 10px; justify-content: flex-end;">
        <button class="btn btn-warning" onclick="closeActionForm()">ยกเลิก</button>
        <button class="btn btn-success" onclick="submitActionForm()"><i class="fas fa-save"></i> บันทึก</button>
      </div>
    </div>
  </div>
</body>

</html>
