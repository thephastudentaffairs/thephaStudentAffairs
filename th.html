<!DOCTYPE html>
<html lang="th">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ระบบครูที่ปรึกษา - จัดการคะแนน</title>
    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
    <script src="https://unpkg.com/jsqr@1.4.0/dist/jsQR.js"></script>
    <!-- Export Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.1/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        :root {
            --primary: #6366f1;
            --secondary: #a855f7;
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --dark: #1e293b;
            --light: #f8fafc;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Prompt', sans-serif;
        }

        body {
            background: #f1f5f9;
            color: var(--dark);
            min-height: 100vh;
        }

        /* Navbar */
        .navbar {
            background: rgba(15, 12, 41, 0.7);
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            padding: 8px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
            position: sticky;
            top: 0;
            z-index: 1000;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        .nav-brand {
            display: flex;
            align-items: center;
            gap: 12px;
            font-weight: 700;
            font-size: 1.25rem;
            color: #fff;
        }

        .nav-brand img {
            height: 100px;
            width: auto;
            object-fit: contain;
        }

        .nav-brand-tpac {
            height: 150px !important;
            /* 1.5x of School Logo (100px) */
            margin-left: 10px;
            mix-blend-mode: screen;
        }

        .nav-user {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .user-info {
            text-align: right;
            color: #fff;
        }

        .user-name {
            font-weight: 600;
            display: block;
            color: #fff;
        }

        .user-class {
            font-size: 0.85rem;
            color: rgba(255, 255, 255, 0.7);
            display: block;
        }

        .logout-btn {
            width: 44px;
            height: 44px;
            background: rgba(239, 68, 68, 0.15);
            color: #ef4444;
            border: 1px solid rgba(239, 68, 68, 0.3);
            border-radius: 12px;
            cursor: pointer;
            transition: 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.1rem;
            flex-shrink: 0;
        }

        .logout-btn:hover {
            background: rgba(239, 68, 68, 0.25);
            transform: translateY(-2px);
        }

        /* Container */
        .container {
            max-width: 1200px;
            margin: 30px auto;
            padding: 0 20px;
        }

        /* Header Section */
        .header-section {
            margin-bottom: 30px;
        }

        .page-title {
            font-size: 1.75rem;
            font-weight: 700;
            margin-bottom: 20px;
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.02);
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .stat-icon {
            width: 60px;
            height: 60px;
            border-radius: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
        }

        .icon-total {
            background: #e0e7ff;
            color: #4338ca;
        }

        .icon-avg {
            background: #dcfce7;
            color: #15803d;
        }

        .icon-high {
            background: #fef9c3;
            color: #a16207;
        }

        .icon-urgent {
            background: #fee2e2;
            color: #dc2626;
            animation: pulse-red 2s infinite;
        }

        @keyframes pulse-red {
            0% {
                box-shadow: 0 0 0 0 rgba(220, 38, 38, 0.4);
            }

            70% {
                box-shadow: 0 0 0 10px rgba(220, 38, 38, 0);
            }

            100% {
                box-shadow: 0 0 0 0 rgba(220, 38, 38, 0);
            }
        }

        .emergency-text {
            color: #dc2626;
            font-weight: 800;
            text-shadow: 0 0 10px rgba(220, 38, 38, 0.2);
        }

        .stat-info h4 {
            font-size: 0.9rem;
            color: #64748b;
            margin-bottom: 5px;
        }

        .stat-info .value {
            font-size: 1.5rem;
            font-weight: 700;
        }

        /* Main Card */
        .card {
            background: white;
            border-radius: 24px;
            padding: 30px;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            margin-bottom: 30px;
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
        }

        .card-title {
            font-size: 1.25rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* Controls */
        .controls {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            align-items: center;
        }

        .action-buttons {
            display: flex;
            gap: 12px;
        }

        .action-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 6px;
            padding: 14px 24px;
            border-radius: 16px;
            font-weight: 600;
            font-size: 0.9rem;
            cursor: pointer;
            border: none;
            transition: all 0.3s ease;
            text-decoration: none;
            color: white;
        }

        .action-btn .btn-icon {
            width: 40px;
            height: 40px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            background: rgba(255, 255, 255, 0.25);
            transition: all 0.3s ease;
        }

        .btn-enter-id {
            background: linear-gradient(135deg, #10b981, #059669);
            box-shadow: 0 4px 15px rgba(16, 185, 129, 0.4);
        }

        .btn-enter-id:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(16, 185, 129, 0.5);
        }

        .btn-enter-id:hover .btn-icon {
            transform: scale(1.1);
            background: rgba(255, 255, 255, 0.35);
        }

        .btn-camera {
            background: linear-gradient(135deg, #6366f1, #8b5cf6);
            box-shadow: 0 4px 15px rgba(99, 102, 241, 0.4);
        }

        .btn-camera:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(99, 102, 241, 0.5);
        }

        .btn-camera:hover .btn-icon {
            transform: scale(1.1);
            background: rgba(255, 255, 255, 0.35);
        }

        .btn-scan-qr {
            background: linear-gradient(135deg, #f59e0b, #d97706);
            box-shadow: 0 4px 15px rgba(245, 158, 11, 0.4);
        }

        .btn-scan-qr:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(245, 158, 11, 0.5);
        }

        .btn-scan-qr:hover .btn-icon {
            transform: scale(1.1);
            background: rgba(255, 255, 255, 0.35);
        }

        /* Search All Students Button */
        .btn-search-all {
            background: linear-gradient(135deg, #10b981, #059669);
            box-shadow: 0 4px 15px rgba(16, 185, 129, 0.4);
        }

        .btn-search-all:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(16, 185, 129, 0.5);
        }

        .btn-search-all:hover .btn-icon {
            transform: scale(1.1);
            background: rgba(255, 255, 255, 0.35);
        }

        /* Student Search Modal */
        .student-search-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            -webkit-backdrop-filter: blur(8px);
            backdrop-filter: blur(8px);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }

        .student-search-overlay.show {
            display: flex;
        }

        .student-search-modal {
            background: white;
            border-radius: 20px;
            width: 95%;
            max-width: 600px;
            max-height: 85vh;
            display: flex;
            flex-direction: column;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.3);
            animation: modalSlideIn 0.3s ease;
        }

        @keyframes modalSlideIn {
            from {
                transform: translateY(-20px);
                opacity: 0;
            }

            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .student-search-header {
            padding: 20px 25px;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .student-search-header h3 {
            font-size: 1.3rem;
            color: #1e293b;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .student-search-header h3 i {
            color: #10b981;
        }

        .student-search-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #64748b;
            transition: color 0.3s;
        }

        .student-search-close:hover {
            color: #ef4444;
        }

        .student-search-filters {
            padding: 15px 25px;
            background: #f8fafc;
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }

        .student-search-input {
            flex: 1;
            min-width: 200px;
            padding: 12px 16px;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            font-size: 1rem;
            font-family: 'Prompt', sans-serif;
            transition: border-color 0.3s;
        }

        .student-search-input:focus {
            outline: none;
            border-color: #10b981;
        }

        .student-search-class-filter {
            padding: 12px 16px;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            font-size: 1rem;
            font-family: 'Prompt', sans-serif;
            background: white;
            cursor: pointer;
            min-width: 120px;
        }

        .student-search-results {
            flex: 1;
            overflow-y: auto;
            padding: 15px 25px;
            max-height: 400px;
        }

        .student-search-item {
            display: flex;
            align-items: center;
            padding: 14px 16px;
            border-radius: 12px;
            background: #f8fafc;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.3s;
            border: 2px solid transparent;
        }

        .student-search-item:hover {
            background: #ecfdf5;
            border-color: #10b981;
            transform: translateX(5px);
        }

        .student-search-item-info {
            flex: 1;
        }

        .student-search-item-name {
            font-weight: 600;
            color: #1e293b;
            font-size: 1rem;
        }

        .student-search-item-meta {
            font-size: 0.85rem;
            color: #64748b;
            margin-top: 3px;
        }

        .student-search-item-btn {
            padding: 8px 16px;
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .student-search-item-btn:hover {
            transform: scale(1.05);
        }

        .student-search-empty {
            text-align: center;
            padding: 40px 20px;
            color: #64748b;
        }

        .student-search-empty i {
            font-size: 3rem;
            color: #e2e8f0;
            margin-bottom: 15px;
        }

        .student-search-count {
            text-align: center;
            padding: 10px;
            color: #64748b;
            font-size: 0.9rem;
            border-top: 1px solid #e2e8f0;
        }

        /* QR Scanner Modal */
        .qr-scanner-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .qr-scanner-overlay.show {
            opacity: 1;
            visibility: visible;
        }

        .qr-scanner-box {
            background: white;
            border-radius: 24px;
            padding: 30px;
            width: 90%;
            max-width: 450px;
            text-align: center;
        }

        .qr-scanner-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .qr-scanner-header h3 {
            font-size: 1.4rem;
            color: #1e293b;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .qr-scanner-header h3 i {
            color: #f59e0b;
        }

        .qr-scanner-close {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            background: #f1f5f9;
            border: none;
            cursor: pointer;
            font-size: 1.2rem;
            color: #64748b;
            transition: all 0.3s;
        }

        .qr-scanner-close:hover {
            background: #e2e8f0;
            color: #1e293b;
        }

        #qr-reader-container {
            width: 100%;
            border-radius: 16px;
            overflow: hidden;
            margin-bottom: 20px;
        }

        #qr-reader-container video {
            width: 100%;
            border-radius: 16px;
        }

        .qr-scanner-status {
            padding: 12px;
            border-radius: 10px;
            background: #fef3c7;
            color: #92400e;
            font-weight: 500;
            margin-bottom: 15px;
        }

        .qr-scanner-status.success {
            background: #d1fae5;
            color: #065f46;
        }

        .qr-scanner-status.error {
            background: #fee2e2;
            color: #991b1b;
        }

        /* Manual Input Modal */
        .manual-input-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            -webkit-backdrop-filter: blur(8px);
            backdrop-filter: blur(8px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .manual-input-modal.show {
            opacity: 1;
            visibility: visible;
        }

        .manual-input-content {
            background: white;
            border-radius: 24px;
            padding: 32px;
            width: 90%;
            max-width: 400px;
            text-align: center;
            transform: scale(0.9);
            transition: all 0.3s ease;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.25);
        }

        .manual-input-modal.show .manual-input-content {
            transform: scale(1);
        }

        .manual-input-icon {
            width: 80px;
            height: 80px;
            margin: 0 auto 20px;
            background: linear-gradient(135deg, #10b981, #059669);
            border-radius: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            color: white;
            box-shadow: 0 10px 30px rgba(16, 185, 129, 0.3);
        }

        .manual-input-content h3 {
            font-size: 1.5rem;
            color: #1e293b;
            margin-bottom: 8px;
        }

        .manual-input-content p {
            color: #64748b;
            margin-bottom: 24px;
        }

        .manual-input-field {
            width: 100%;
            padding: 16px 20px;
            font-size: 1.2rem;
            border: 2px solid #e2e8f0;
            border-radius: 16px;
            text-align: center;
            font-weight: 600;
            letter-spacing: 2px;
            outline: none;
            transition: all 0.3s ease;
            margin-bottom: 20px;
        }

        .manual-input-field:focus {
            border-color: #10b981;
            box-shadow: 0 0 0 4px rgba(16, 185, 129, 0.15);
        }

        .manual-input-buttons {
            display: flex;
            gap: 12px;
        }

        .manual-input-buttons button {
            flex: 1;
            padding: 14px 20px;
            border-radius: 12px;
            font-weight: 600;
            font-size: 1rem;
            cursor: pointer;
            border: none;
            transition: all 0.3s ease;
        }

        .btn-cancel {
            background: #f1f5f9;
            color: #64748b;
        }

        .btn-cancel:hover {
            background: #e2e8f0;
        }

        .btn-confirm {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
            box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3);
        }

        .btn-confirm:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(16, 185, 129, 0.4);
        }

        .search-input {
            flex: 1;
            padding: 12px 20px;
            border-radius: 12px;
            border: 2px solid #e2e8f0;
            font-size: 1rem;
            outline: none;
            transition: 0.3s;
        }

        .search-input:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.1);
        }

        .btn {
            padding: 12px 24px;
            border-radius: 12px;
            font-weight: 600;
            cursor: pointer;
            border: none;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: 0.3s;
        }

        .btn-save-all {
            background: var(--primary);
            color: white;
        }

        .btn-save-all:hover {
            background: #4f46e5;
            transform: translateY(-2px);
        }

        /* Table */
        .table-responsive {
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            text-align: left;
        }

        th {
            background: #f8fafc;
            padding: 15px;
            font-weight: 600;
            color: #64748b;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        td {
            padding: 15px;
            border-bottom: 1px solid #f1f5f9;
            font-size: 0.95rem;
        }

        tr:hover {
            background: #fcfdfe;
        }

        .score-badge {
            padding: 4px 12px;
            border-radius: 8px;
            font-weight: 700;
        }

        .score-high {
            background: #dcfce7;
            color: #15803d;
        }

        .score-mid {
            background: #fefabc;
            color: #a16207;
        }

        .score-low {
            background: #fee2e2;
            color: #991b1b;
        }

        .adjust-input {
            width: 80px;
            padding: 8px;
            border-radius: 8px;
            border: 2px solid #e2e8f0;
            text-align: center;
            font-weight: 600;
        }

        .adjust-input.negative {
            color: var(--danger);
            border-color: #fecaca;
        }

        .adjust-input.positive {
            color: var(--success);
            border-color: #a7f3d0;
        }

        .btn-sm {
            padding: 8px;
            border-radius: 8px;
            font-size: 0.9rem;
        }

        .btn-success-sm {
            background: #dcfce7;
            color: #15803d;
        }

        .btn-success-sm:hover {
            background: var(--success);
            color: white;
        }

        /* Loading Overlay */
        .loading-overlay {
            position: fixed;
            inset: 0;
            background: rgba(255, 255, 255, 0.8);
            -webkit-backdrop-filter: blur(4px);
            backdrop-filter: blur(4px);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 999;
        }

        .loading-overlay.show {
            display: flex;
        }

        .loader {
            width: 48px;
            height: 48px;
            border: 5px solid #e2e8f0;
            border-bottom-color: var(--primary);
            border-radius: 50%;
            animation: rotation 1s linear infinite;
        }

        @keyframes rotation {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        /* Toast */
        .toast-container {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .toast {
            background: white;
            padding: 16px 24px;
            border-radius: 12px;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            display: flex;
            align-items: center;
            gap: 12px;
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }

            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .toast-success i {
            color: var(--success);
        }

        .toast-error i {
            color: var(--danger);
        }

        /* Logout Confirmation Modal */
        .logout-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            -webkit-backdrop-filter: blur(4px);
            backdrop-filter: blur(4px);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 10000;
            animation: fadeIn 0.3s ease-out;
        }

        .logout-modal-overlay.show {
            display: flex;
        }

        .logout-modal {
            background: white;
            border-radius: 20px;
            padding: 40px 50px;
            text-align: center;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            animation: modalSlideIn 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
            max-width: 400px;
            width: 90%;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: scale(0.8) translateY(-20px);
            }

            to {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }

        .logout-icon {
            width: 80px;
            height: 80px;
            margin: 0 auto 20px;
            border-radius: 50%;
            background: linear-gradient(135deg, #d1fae5, #a7f3d0);
            border: 3px solid #10b981;
            display: flex;
            align-items: center;
            justify-content: center;
            animation: checkmarkPop 0.5s ease-out 0.2s both;
        }

        @keyframes checkmarkPop {
            0% {
                transform: scale(0);
            }

            50% {
                transform: scale(1.1);
            }

            100% {
                transform: scale(1);
            }
        }

        .logout-icon i {
            font-size: 2.5rem;
            color: #10b981;
        }

        .logout-modal h3 {
            font-size: 1.5rem;
            font-weight: 700;
            color: #1e293b;
            margin-bottom: 10px;
        }

        .logout-modal p {
            font-size: 1rem;
            color: #64748b;
            margin-bottom: 30px;
        }

        .logout-ok-btn {
            background: linear-gradient(135deg, #8b5cf6, #7c3aed);
            color: white;
            border: none;
            padding: 12px 40px;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 12px rgba(139, 92, 246, 0.3);
        }

        .logout-ok-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(139, 92, 246, 0.4);
        }

        .logout-ok-btn:active {
            transform: translateY(0);
        }

        .logout-warning-icon {
            width: 80px;
            height: 80px;
            margin: 0 auto 20px;
            border-radius: 50%;
            background: linear-gradient(135deg, #fef3c7, #fde68a);
            border: 3px solid #f59e0b;
            display: flex;
            align-items: center;
            justify-content: center;
            animation: checkmarkPop 0.5s ease-out 0.2s both;
        }

        .logout-warning-icon i {
            font-size: 2.5rem;
            color: #f59e0b;
        }

        .logout-buttons {
            display: flex;
            gap: 12px;
            justify-content: center;
        }

        .logout-cancel-btn {
            background: #f1f5f9;
            color: #64748b;
            border: none;
            padding: 12px 30px;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .logout-cancel-btn:hover {
            background: #e2e8f0;
            color: #1e293b;
        }

        .modal-content-hidden {
            display: none;
        }

        /* QR Scanner Modal */
        .qr-scanner-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 10000;
        }

        .qr-scanner-modal.show {
            display: flex;
        }

        .qr-scanner-content {
            background: white;
            border-radius: 20px;
            padding: 30px;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .qr-scanner-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .qr-scanner-header h3 {
            margin: 0;
            color: #1e293b;
        }

        .qr-close-btn {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #64748b;
        }

        #qr-reader {
            border-radius: 12px;
            overflow: hidden;
            margin-bottom: 20px;
        }

        .qr-form {
            display: none;
        }

        .qr-form.show {
            display: block;
        }

        .qr-form-group {
            margin-bottom: 15px;
        }

        .qr-form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #1e293b;
        }

        .qr-form-group input,
        .qr-form-group textarea {
            width: 100%;
            padding: 10px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-family: 'Prompt', sans-serif;
        }

        .qr-form-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .qr-btn {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .qr-btn-submit {
            background: linear-gradient(135deg, #8b5cf6, #7c3aed);
            color: white;
        }

        .qr-btn-cancel {
            background: #f1f5f9;
            color: #64748b;
        }

        /* Work Submission Styles */
        .modal-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            background: #f1f5f9;
            padding: 5px;
            border-radius: 12px;
        }

        .modal-tab {
            flex: 1;
            padding: 10px;
            text-align: center;
            border: none;
            border-radius: 10px;
            background: transparent;
            color: #64748b;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .modal-tab.active {
            background: white;
            color: var(--primary);
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
        }

        .upload-section {
            display: none;
        }

        .upload-section.show {
            display: block;
        }

        .image-upload-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 15px;
        }

        .image-upload-box {
            border: 2px dashed #e2e8f0;
            border-radius: 12px;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            transition: border-color 0.3s;
            position: relative;
            min-height: 150px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        .image-upload-box:hover {
            border-color: var(--primary);
            background: #f8fafc;
        }

        .image-upload-box i {
            font-size: 2rem;
            color: #cbd5e1;
            margin-bottom: 10px;
        }

        .image-upload-box p {
            font-size: 0.9rem;
            color: #64748b;
        }

        .image-preview {
            max-width: 100%;
            max-height: 130px;
            border-radius: 8px;
            display: none;
        }

        .image-preview.show {
            display: block;
        }

        .upload-placeholder.hidden {
            display: none;
        }

        .file-input {
            display: none;
        }

        /* History Button */
        .btn-history {
            padding: 8px 14px;
            border-radius: 10px;
            background: linear-gradient(135deg, #3b82f6, #1d4ed8);
            color: white;
            border: none;
            font-weight: 600;
            font-size: 0.85rem;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(59, 130, 246, 0.3);
        }

        .btn-history:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(59, 130, 246, 0.4);
        }

        /* History Modal */
        .history-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.6);
            -webkit-backdrop-filter: blur(8px);
            backdrop-filter: blur(8px);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 10000;
            padding: 20px;
        }

        .history-modal-overlay.show {
            display: flex;
        }

        .history-modal {
            background: white;
            border-radius: 24px;
            padding: 30px;
            max-width: 800px;
            width: 100%;
            max-height: 80vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            box-shadow: 0 25px 60px rgba(0, 0, 0, 0.3);
            animation: modalSlideIn 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        .history-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f1f5f9;
        }

        .history-modal-header h3 {
            font-size: 1.4rem;
            color: #1e293b;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .history-modal-header h3 i {
            color: #3b82f6;
        }

        .history-close-btn {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            background: #f1f5f9;
            border: none;
            cursor: pointer;
            font-size: 1.3rem;
            color: #64748b;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .history-close-btn:hover {
            background: #e2e8f0;
            color: #1e293b;
        }

        .history-student-info {
            background: linear-gradient(135deg, #f0f9ff, #e0f2fe);
            padding: 15px 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .history-student-avatar {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(135deg, #3b82f6, #1d4ed8);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.3rem;
            overflow: hidden;
            cursor: pointer;
            transition: transform 0.3s, box-shadow 0.3s;
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
        }

        .history-student-avatar:hover {
            transform: scale(1.05);
            box-shadow: 0 6px 20px rgba(59, 130, 246, 0.5);
        }

        .history-student-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 50%;
        }

        /* Profile Viewer Modal */
        .profile-viewer-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.9);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 15000;
            padding: 20px;
            animation: fadeIn 0.3s ease;
        }

        .profile-viewer-overlay.show {
            display: flex;
        }

        .profile-viewer-content {
            position: relative;
            max-width: 90%;
            max-height: 90%;
            animation: modalSlideIn 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        .profile-viewer-image {
            max-width: 100%;
            max-height: 80vh;
            border-radius: 20px;
            box-shadow: 0 25px 60px rgba(0, 0, 0, 0.5);
        }

        .profile-viewer-close {
            position: absolute;
            top: -15px;
            right: -15px;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: white;
            border: none;
            cursor: pointer;
            font-size: 1.5rem;
            color: #64748b;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
        }

        .profile-viewer-close:hover {
            background: #ef4444;
            color: white;
            transform: scale(1.1);
        }

        .profile-viewer-name {
            color: white;
            text-align: center;
            margin-top: 20px;
            font-size: 1.3rem;
            font-weight: 600;
            text-shadow: 0 2px 10px rgba(0, 0, 0, 0.5);
        }

        .profile-viewer-id {
            color: #94a3b8;
            text-align: center;
            margin-top: 8px;
            font-size: 1rem;
        }

        .no-profile-image {
            width: 200px;
            height: 200px;
            border-radius: 50%;
            background: linear-gradient(135deg, #3b82f6, #1d4ed8);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 5rem;
            box-shadow: 0 25px 60px rgba(0, 0, 0, 0.5);
        }

        .history-student-details h4 {
            font-size: 1.1rem;
            color: #1e293b;
            margin-bottom: 4px;
        }

        .history-student-details span {
            font-size: 0.9rem;
            color: #64748b;
        }

        .history-list-container {
            flex: 1;
            overflow-y: auto;
            padding-right: 10px;
        }

        .history-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .history-item {
            background: #f8fafc;
            border-radius: 12px;
            padding: 15px 20px;
            display: flex;
            align-items: flex-start;
            gap: 15px;
            border-left: 4px solid #3b82f6;
            transition: all 0.3s ease;
        }

        .history-item:hover {
            background: #f1f5f9;
            transform: translateX(5px);
        }

        .history-item.positive {
            border-left-color: #10b981;
        }

        .history-item.negative {
            border-left-color: #ef4444;
        }

        .history-score-badge {
            min-width: 70px;
            padding: 8px 12px;
            border-radius: 10px;
            font-weight: 700;
            font-size: 1rem;
            text-align: center;
        }

        .history-score-badge.positive {
            background: #dcfce7;
            color: #15803d;
        }

        .history-score-badge.negative {
            background: #fee2e2;
            color: #991b1b;
        }

        .history-content {
            flex: 1;
        }

        .history-reason {
            font-size: 0.95rem;
            color: #1e293b;
            margin-bottom: 6px;
            font-weight: 500;
        }

        .history-meta {
            font-size: 0.85rem;
            color: #64748b;
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
        }

        .history-meta span {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .history-empty {
            text-align: center;
            padding: 40px 20px;
            color: #64748b;
        }

        .history-empty i {
            font-size: 3rem;
            color: #e2e8f0;
            margin-bottom: 15px;
        }

        .history-empty p {
            font-size: 1rem;
        }

        @media (max-width: 768px) {
            .history-modal {
                padding: 20px;
                max-height: 90vh;
            }

            .history-item {
                flex-direction: column;
                gap: 10px;
            }

            .history-score-badge {
                align-self: flex-start;
            }
        }

        /* ===== Responsive Design ===== */
        @media (max-width: 768px) {

            /* Body */
            body {
                padding: 15px;
            }

            /* Navbar */
            .navbar {
                flex-direction: column;
                gap: 15px;
                padding: 15px;
            }

            .nav-brand {
                font-size: 1.1rem;
            }

            .nav-info {
                text-align: center;
            }

            .user-name {
                font-size: 0.95rem;
            }

            .user-class {
                font-size: 0.85rem;
            }

            /* Header */
            .header {
                padding: 20px;
                margin-bottom: 20px;
            }

            .header h1 {
                font-size: 1.5rem;
            }

            .header p {
                font-size: 0.95rem;
            }

            /* Stats Grid - 2 columns on tablet */
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 12px;
            }

            .stat-card {
                padding: 15px;
            }

            .stat-value {
                font-size: 1.8rem;
            }

            .stat-label {
                font-size: 0.9rem;
            }

            .stat-icon {
                font-size: 1.6rem;
            }

            /* Card */
            .card {
                padding: 20px;
                margin-bottom: 20px;
            }

            /* Controls */
            .controls {
                flex-direction: column;
                gap: 12px;
            }

            .search-box {
                width: 100%;
            }

            .search-box input {
                font-size: 1rem;
                padding: 12px;
            }

            .filter-group {
                flex-direction: column;
                gap: 10px;
            }

            .filter-group select,
            .filter-group button {
                width: 100%;
                font-size: 1rem;
                padding: 12px;
            }

            /* Table */
            .table-container {
                overflow-x: auto;
                margin: 0 -15px;
                padding: 0 15px;
                scroll-behavior: smooth;
            }

            table {
                font-size: 0.85rem;
                min-width: 650px;
            }

            th,
            td {
                padding: 10px 8px;
            }

            th {
                font-size: 0.8rem;
            }

            /* Badges */
            .status-badge,
            .class-badge {
                font-size: 0.8rem;
                padding: 4px 8px;
            }

            /* Action Buttons */
            .action-btn {
                padding: 8px 12px;
                font-size: 0.85rem;
            }

            /* QR Scanner Modal */
            .qr-modal {
                width: 95%;
                max-width: none;
                padding: 20px;
                margin: 10px;
            }

            .qr-modal-header h2 {
                font-size: 1.4rem;
            }

            .qr-form-group label {
                font-size: 1rem;
            }

            .qr-form-group input,
            .qr-form-group textarea {
                font-size: 1rem;
                padding: 12px;
            }

            .qr-form-buttons {
                flex-direction: column;
                gap: 10px;
            }

            .qr-btn {
                width: 100%;
                font-size: 1rem;
                padding: 12px;
            }

            /* Toast */
            .toast {
                min-width: auto;
                width: calc(100% - 40px);
                left: 20px;
                right: 20px;
                font-size: 0.95rem;
            }
        }

        @media (max-width: 480px) {

            /* Extra small screens */
            body {
                padding: 12px;
            }

            .navbar {
                padding: 12px;
            }

            .header {
                padding: 15px;
            }

            .header h1 {
                font-size: 1.3rem;
            }

            .header p {
                font-size: 0.9rem;
            }

            /* Stats - Single column */
            .stats-grid {
                grid-template-columns: 1fr;
            }

            .stat-card {
                padding: 12px;
            }

            .stat-value {
                font-size: 1.6rem;
            }

            .stat-label {
                font-size: 0.85rem;
            }

            /* Table */
            table {
                font-size: 0.8rem;
                min-width: 550px;
            }

            th,
            td {
                padding: 8px 6px;
            }

            /* Buttons */
            .action-btn {
                font-size: 0.8rem;
                padding: 7px 10px;
            }

            .filter-group button {
                font-size: 0.95rem;
                padding: 10px;
            }

            /* QR Modal */
            .qr-modal {
                padding: 15px;
            }

            .qr-modal-header h2 {
                font-size: 1.3rem;
            }

            .qr-btn {
                font-size: 0.95rem;
                padding: 10px;
            }
        }

        /* Checkbox Group for Deduction Reasons */
        .deduction-reasons-container {
            margin-bottom: 15px;
        }

        .deduction-reasons-label {
            display: block;
            font-weight: 600;
            color: #1e293b;
            margin-bottom: 10px;
            font-size: 0.95rem;
        }

        .deduction-reasons-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
            max-height: 250px;
            overflow-y: auto;
            padding: 12px;
            background: #f8fafc;
            border-radius: 12px;
            border: 2px solid #e2e8f0;
        }

        .deduction-checkbox-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 10px;
            background: white;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            border: 1px solid #e2e8f0;
        }

        .deduction-checkbox-item:hover {
            background: #f1f5f9;
            border-color: #cbd5e1;
        }

        .deduction-checkbox-item.checked {
            background: linear-gradient(135deg, #fee2e2, #fecaca);
            border-color: #f87171;
        }

        .deduction-checkbox-item input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
            accent-color: #ef4444;
        }

        .deduction-checkbox-item label {
            font-size: 0.85rem;
            color: #334155;
            cursor: pointer;
            flex: 1;
            margin: 0;
        }

        .other-reason-input {
            display: none;
            margin-top: 10px;
        }

        .other-reason-input.show {
            display: block;
        }

        .other-reason-input input {
            width: 100%;
            padding: 10px 12px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-family: 'Prompt', sans-serif;
            font-size: 0.95rem;
        }

        .other-reason-input input:focus {
            outline: none;
            border-color: #6366f1;
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }

        @media (max-width: 480px) {
            .deduction-reasons-grid {
                grid-template-columns: 1fr;
            }
        }

        /* ===== Student Search Modal Styles ===== */
        .student-search-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.6);
            -webkit-backdrop-filter: blur(8px);
            backdrop-filter: blur(8px);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 10000;
            padding: 20px;
        }

        .student-search-overlay.show {
            display: flex;
        }

        .student-search-modal {
            background: white;
            border-radius: 24px;
            padding: 25px;
            max-width: 600px;
            width: 100%;
            max-height: 80vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            box-shadow: 0 25px 60px rgba(0, 0, 0, 0.3);
            animation: modalSlideIn 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        .student-search-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f1f5f9;
        }

        .student-search-header h3 {
            font-size: 1.3rem;
            color: #1e293b;
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 0;
        }

        .student-search-header h3 i {
            color: #10b981;
        }

        .student-search-close {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            background: #f1f5f9;
            border: none;
            cursor: pointer;
            font-size: 1.5rem;
            color: #64748b;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .student-search-close:hover {
            background: #e2e8f0;
            color: #1e293b;
        }

        .student-search-filters {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .student-search-input {
            flex: 1;
            padding: 12px 15px;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            font-size: 1rem;
            font-family: 'Prompt', sans-serif;
            transition: all 0.3s;
        }

        .student-search-input:focus {
            outline: none;
            border-color: #10b981;
            box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1);
        }

        .student-search-class-filter {
            padding: 12px 15px;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            font-size: 0.95rem;
            font-family: 'Prompt', sans-serif;
            background: white;
            cursor: pointer;
            min-width: 120px;
        }

        .student-search-class-filter:focus {
            outline: none;
            border-color: #10b981;
        }

        .student-search-results {
            flex: 1;
            overflow-y: auto;
            max-height: 400px;
            padding-right: 5px;
        }

        .student-search-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 15px;
            background: #f8fafc;
            border-radius: 12px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.2s;
            border: 1px solid transparent;
        }

        .student-search-item:hover {
            background: #e0f2fe;
            border-color: #38bdf8;
            transform: translateX(5px);
        }

        .student-search-item-info {
            flex: 1;
        }

        .student-search-item-name {
            font-weight: 600;
            color: #1e293b;
            margin-bottom: 4px;
        }

        .student-search-item-meta {
            font-size: 0.85rem;
            color: #64748b;
        }

        .student-search-item-btn {
            padding: 8px 15px;
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            font-size: 0.85rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
            transition: all 0.3s;
        }

        .student-search-item-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4);
        }

        .student-search-empty {
            text-align: center;
            padding: 40px 20px;
            color: #64748b;
        }

        .student-search-empty i {
            font-size: 3rem;
            color: #e2e8f0;
            margin-bottom: 15px;
            display: block;
        }

        .student-search-count {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #e2e8f0;
            text-align: center;
            font-size: 0.9rem;
            color: #64748b;
        }

        @media (max-width: 480px) {
            .student-search-filters {
                flex-direction: column;
            }

            .student-search-class-filter {
                width: 100%;
            }
        }

        /* Utility Classes for Inline Styles */
        .hidden-input {
            display: none;
        }

        .text-center {
            text-align: center;
        }

        .qr-reader-container {
            width: 100%;
        }

        .qr-reader-hidden {
            display: none;
        }

        .section-hidden {
            display: none;
        }

        /* Upload Profile Preview Styles */
        .upload-preview-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 30px 20px;
            background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
            border-radius: 16px;
            margin-bottom: 20px;
        }

        .upload-preview {
            width: 180px;
            height: 180px;
            border-radius: 50%;
            background: linear-gradient(135deg, #ffffff 0%, #f1f5f9 100%);
            border: 4px dashed #94a3b8;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            overflow: hidden;
            position: relative;
        }

        .upload-preview:hover {
            border-color: #3b82f6;
            transform: scale(1.03);
            box-shadow: 0 10px 30px rgba(59, 130, 246, 0.2);
        }

        .upload-preview i {
            font-size: 3.5rem;
            color: #94a3b8;
            transition: all 0.3s;
        }

        .upload-preview:hover i {
            color: #3b82f6;
            transform: scale(1.1);
        }

        .upload-preview img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 50%;
        }

        .profile-preview-hidden {
            display: none;
        }

        .profile-instruction {
            color: #64748b;
            font-size: 0.95rem;
            margin-top: 15px;
            text-align: center;
        }

        /* ===== Profile Viewer Modal Styles ===== */
        .profile-viewer-image-container {
            width: 100%;
            aspect-ratio: 1/1;
            border-radius: 12px;
            overflow: hidden;
            background: #f8fafc;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            border: 4px solid white;
        }

        .profile-viewer-image {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: transform 0.3s ease;
        }

        .profile-viewer-image:hover {
            transform: scale(1.05);
        }

        .no-profile-image {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: #cbd5e1;
            text-align: center;
        }

        .no-profile-image i {
            font-size: 5rem;
            margin-bottom: 15px;
        }


        .modal-max-width-500 {
            max-width: 500px;
        }

        .modal-max-width-400 {
            max-width: 400px;
        }

        .footer-section {
            background: white;
            color: #64748b;
            text-align: center;
            padding: 15px 20px;
            font-size: 0.85rem;
            margin-top: 30px;
            border-top: 2px solid #f1f5f9;
        }

        /* ===== Enhanced Manage Student Modal Styles ===== */
        .manage-student-modal {
            background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
            border-radius: 28px;
            overflow: hidden;
            box-shadow: 0 30px 80px rgba(0, 0, 0, 0.25);
        }

        .manage-student-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 25px 30px;
            position: relative;
            overflow: hidden;
        }

        .manage-student-header::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 100%;
            height: 200%;
            background: radial-gradient(circle, rgba(255, 255, 255, 0.15) 0%, transparent 70%);
            animation: shimmer 3s infinite;
        }

        @keyframes shimmer {

            0%,
            100% {
                transform: rotate(0deg);
            }

            50% {
                transform: rotate(10deg);
            }
        }

        .manage-student-header h3 {
            color: white;
            font-size: 1.4rem;
            display: flex;
            align-items: center;
            gap: 12px;
            position: relative;
            z-index: 1;
            margin: 0;
            text-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
        }

        .manage-student-header h3 i {
            background: rgba(255, 255, 255, 0.2);
            padding: 10px;
            border-radius: 12px;
            backdrop-filter: blur(10px);
        }

        .manage-student-profile {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 30px 25px 25px;
            background: linear-gradient(180deg, #f0f4ff 0%, #ffffff 100%);
            border-bottom: 1px solid rgba(99, 102, 241, 0.1);
        }

        .manage-avatar-wrapper {
            position: relative;
            margin-bottom: 20px;
        }

        .manage-avatar {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            background: linear-gradient(135deg, #6366f1, #8b5cf6);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 3rem;
            box-shadow: 0 15px 40px rgba(99, 102, 241, 0.4);
            border: 5px solid white;
            overflow: hidden;
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        .manage-avatar:hover {
            transform: scale(1.08) rotate(5deg);
            box-shadow: 0 20px 50px rgba(99, 102, 241, 0.5);
        }

        .manage-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 50%;
        }

        .manage-avatar-badge {
            position: absolute;
            bottom: 5px;
            right: 5px;
            width: 36px;
            height: 36px;
            background: linear-gradient(135deg, #10b981, #059669);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 0.9rem;
            border: 3px solid white;
            box-shadow: 0 4px 15px rgba(16, 185, 129, 0.4);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {

            0%,
            100% {
                transform: scale(1);
            }

            50% {
                transform: scale(1.1);
            }
        }

        .manage-student-name {
            font-size: 1.4rem;
            font-weight: 700;
            color: #1e293b;
            margin-bottom: 6px;
            text-align: center;
        }

        .manage-student-id {
            font-size: 1rem;
            color: #6366f1;
            background: linear-gradient(135deg, #e0e7ff, #ede9fe);
            padding: 6px 16px;
            border-radius: 20px;
            font-weight: 600;
        }

        .manage-student-details {
            padding: 20px 30px;
            background: white;
            border-bottom: 1px solid #f1f5f9;
        }

        .detail-item {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 12px 0;
            border-bottom: 1px solid #f1f5f9;
        }

        .detail-item:last-child {
            border-bottom: none;
        }

        .detail-icon {
            width: 36px;
            height: 36px;
            background: #f1f5f9;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #6366f1;
            font-size: 1.1rem;
        }

        .detail-info {
            flex: 1;
        }

        .detail-label {
            font-size: 0.8rem;
            color: #64748b;
            margin-bottom: 2px;
        }

        .detail-value {
            font-size: 0.95rem;
            font-weight: 600;
            color: #1e293b;
        }

        .manage-options {
            display: flex;
            flex-direction: column;
            gap: 14px;
            padding: 25px;
        }

        .manage-option-btn {
            display: flex;
            align-items: center;
            gap: 18px;
            padding: 20px 24px;
            background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
            border: 2px solid #e2e8f0;
            border-radius: 18px;
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
            text-decoration: none;
            color: #334155;
            overflow: hidden;
            position: relative;
        }

        .manage-option-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.6), transparent);
            transition: left 0.5s ease;
        }

        .manage-option-btn:hover::before {
            left: 100%;
        }

        .manage-option-btn:hover {
            transform: translateX(10px) scale(1.02);
            border-color: transparent;
            box-shadow: 0 15px 40px rgba(99, 102, 241, 0.25);
        }

        .manage-option-btn:first-child {
            background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%);
            border-color: #93c5fd;
        }

        .manage-option-btn:first-child:hover {
            background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
            color: white;
        }

        .manage-option-btn:first-child:hover .manage-option-icon {
            background: rgba(255, 255, 255, 0.25);
            color: white;
        }

        .manage-option-btn:first-child:hover span {
            color: white;
        }

        .manage-option-btn:nth-child(2) {
            background: linear-gradient(135deg, #ecfdf5 0%, #d1fae5 100%);
            border-color: #6ee7b7;
        }

        .manage-option-btn:nth-child(2):hover {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
        }

        .manage-option-btn:nth-child(2):hover .manage-option-icon {
            background: rgba(255, 255, 255, 0.25);
            color: white;
        }

        .manage-option-btn:nth-child(2):hover span {
            color: white;
        }

        .manage-option-icon {
            width: 56px;
            height: 56px;
            border-radius: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            transition: all 0.4s ease;
            flex-shrink: 0;
        }

        .manage-option-btn:first-child .manage-option-icon {
            background: linear-gradient(135deg, #3b82f6, #1d4ed8);
            color: white;
            box-shadow: 0 8px 25px rgba(59, 130, 246, 0.4);
        }

        .manage-option-btn:nth-child(2) .manage-option-icon {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
            box-shadow: 0 8px 25px rgba(16, 185, 129, 0.4);
        }

        .manage-option-btn i {
            font-size: 1.5rem;
        }

        .manage-option-content {
            flex: 1;
        }

        .manage-option-btn span {
            font-weight: 700;
            font-size: 1.1rem;
            display: block;
            margin-bottom: 4px;
            color: #1e293b;
            transition: color 0.3s;
        }

        .manage-option-desc {
            font-size: 0.85rem;
            color: #64748b;
            font-weight: 400;
        }

        .manage-option-arrow {
            font-size: 1.2rem;
            color: #94a3b8;
            transition: all 0.3s;
        }

        .manage-option-btn:hover .manage-option-arrow {
            color: white;
            transform: translateX(5px);
        }

        @media (max-width: 480px) {
            .manage-student-header {
                padding: 20px;
            }

            .manage-student-profile {
                padding: 25px 20px 20px;
            }

            .manage-avatar {
                width: 100px;
                height: 100px;
                font-size: 2.5rem;
            }

            .manage-options {
                padding: 20px;
                gap: 12px;
            }

            .manage-option-btn {
                padding: 16px 18px;
            }

            .manage-option-icon {
                width: 48px;
                height: 48px;
                font-size: 1.3rem;
            }

            .manage-option-btn span {
                font-size: 1rem;
            }
        }

        /* ===== Monthly Report Modal Styles ===== */
        .report-modal {
            background: white;
            border-radius: 28px;
            overflow: hidden;
            box-shadow: 0 30px 80px rgba(0, 0, 0, 0.3);
            max-width: 500px;
            width: 95%;
            animation: modalSlideIn 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        .report-header {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            padding: 25px 30px;
            color: white;
            position: relative;
        }

        .report-header h3 {
            margin: 0;
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 1.4rem;
        }

        .report-body {
            padding: 30px;
        }

        .report-form-group {
            margin-bottom: 20px;
        }

        .report-form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #475569;
            font-size: 0.95rem;
        }

        .report-select {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            font-family: 'Prompt', sans-serif;
            font-size: 1rem;
            color: #1e293b;
            background-color: white;
            cursor: pointer;
            transition: all 0.3s;
        }

        .report-select:focus {
            outline: none;
            border-color: #f59e0b;
            box-shadow: 0 0 0 3px rgba(245, 158, 11, 0.1);
        }

        .report-actions {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-top: 30px;
        }

        .report-btn {
            padding: 14px;
            border: none;
            border-radius: 14px;
            font-weight: 700;
            font-family: 'Prompt', sans-serif;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            transition: all 0.3s;
            font-size: 1rem;
        }

        .btn-pdf {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            color: white;
        }

        .btn-image {
            background: linear-gradient(135deg, #3b82f6, #2563eb);
            color: white;
        }

        .report-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
            filter: brightness(1.1);
        }

        .report-btn:active {
            transform: translateY(-1px);
        }

        .required-indicator {
            color: #ef4444;
        }
    </style>
</head>

<body>

    <div class="loading-overlay" id="loadingOverlay">
        <div class="loader"></div>
    </div>

    <nav class="navbar">
        <div class="nav-brand">
            <img src="logo.png" alt="School Logo">
            <img src="LOGOprogram/logoV2.png" alt="TPAC System" class="nav-brand-tpac">
        </div>
        <div class="nav-user">
            <div class="user-info">
                <span class="user-name" id="teacherName">กำลังโหลด...</span>
                <span class="user-class" id="teacherClassDisplay">ห้อง -</span>
            </div>
            <button class="logout-btn" onclick="logout()" title="ออกจากระบบ">
                <i class="fas fa-power-off"></i>
            </button>
        </div>
    </nav>

    <div class="container">
        <div class="header-section"
            style="background: white; padding: 40px; border-radius: 32px; box-shadow: 0 10px 40px rgba(0,0,0,0.04); margin-bottom: 40px; border: 1px solid #edf2f7; position: relative; overflow: hidden;">
            <div
                style="position: absolute; top: -30px; right: -30px; width: 200px; height: 200px; background: radial-gradient(circle, rgba(99, 102, 241, 0.05) 0%, transparent 70%);">
            </div>

            <div style="display: flex; align-items: center; gap: 18px; margin-bottom: 20px;">
                <div
                    style="width: 48px; height: 48px; background: linear-gradient(135deg, #6366f1, #4338ca); border-radius: 16px; display: flex; align-items: center; justify-content: center; color: white; box-shadow: 0 8px 16px rgba(99, 102, 241, 0.25);">
                    <i class="fas fa-chalkboard-teacher" style="font-size: 1.4rem;"></i>
                </div>
                <h1 class="page-title"
                    style="margin-bottom: 0; font-size: 2.2rem; color: #0f172a; font-weight: 800; letter-spacing: -0.025em;">
                    ระบบครูที่ปรึกษา</h1>
            </div>

            <div style="padding-left: 66px;">
                <p class="page-description"
                    style="color: #475569; font-size: 1.1rem; max-width: 850px; line-height: 1.8; font-weight: 500;">
                    แจ้งเหตุนักเรียนที่พฤติกรรมไม่เหมาะสมทุกประเภท ส่งคำขอเพิ่มคะแนนให้นักเรียน
                    และสามารถจัดการแก้ไขข้อมูลนักเรียนได้แค่ห้องที่ปรึกษาเท่านั้น
                </p>
                <div style="margin-top: 15px; display: flex; gap: 10px;">
                    <span
                        style="background: #eff6ff; color: #1d4ed8; padding: 6px 14px; border-radius: 100px; font-size: 0.85rem; font-weight: 600; display: flex; align-items: center; gap: 6px;">
                        <i class="fas fa-check-circle" style="font-size: 0.9rem;"></i> จัดการเฉพาะห้องที่ปรึกษา
                    </span>
                    <span
                        style="background: #f0fdf4; color: #15803d; padding: 6px 14px; border-radius: 100px; font-size: 0.85rem; font-weight: 600; display: flex; align-items: center; gap: 6px;">
                        <i class="fas fa-plus-circle" style="font-size: 0.9rem;"></i> ขอเพิ่มคะแนนพฤติกรรม
                    </span>
                </div>
            </div>
        </div>

        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-icon icon-total"><i class="fas fa-users"></i></div>
                <div class="stat-info">
                    <h4>นักเรียนทั้งหมด</h4>
                    <div class="value" id="statTotal">0</div>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon icon-avg"><i class="fas fa-chart-line"></i></div>
                <div class="stat-info">
                    <h4>คะแนนเฉลี่ย</h4>
                    <div class="value" id="statAvg">0</div>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon icon-high"><i class="fas fa-award"></i></div>
                <div class="stat-info">
                    <h4>ดีเยี่ยม (>=80)</h4>
                    <div class="value" id="statHigh">0</div>
                </div>
            </div>
            <div class="stat-card"
                style="border: 2px solid rgba(220, 38, 38, 0.1); background: rgba(254, 242, 242, 0.5);">
                <div class="stat-icon icon-urgent"><i class="fas fa-exclamation-triangle"></i></div>
                <div class="stat-info">
                    <h4 class="emergency-text">คะแนนต่ำกว่า 60</h4>
                    <div class="value emergency-text" id="statUrgent" style="font-size: 1.8rem;">0</div>
                    <div style="font-size: 0.75rem; color: #dc2626; font-weight: 700;">ปรับแก้คะแนนด่วน!</div>
                </div>
            </div>
        </div>
    </div>

    <div class="card">
        <div class="card-header">
            <div class="card-title">
                <i class="fas fa-list-ul"></i> รายชื่อนักเรียนห้อง <span id="classTitle">-</span>
            </div>
        </div>

        <div class="controls">
            <input type="text" class="search-input" id="searchInput" placeholder="🔍 ค้นหาชื่อ หรือ รหัสนักเรียน..."
                oninput="handleSearch()">

            <div class="action-buttons">
                <!-- Manual ID Input Button -->
                <button class="action-btn btn-enter-id" onclick="openManualInput()">
                    <div class="btn-icon">
                        <i class="fas fa-keyboard"></i>
                    </div>
                    <span>กรอกรหัส</span>
                </button>

                <!-- Camera Capture Button -->
                <label class="action-btn btn-camera">
                    <div class="btn-icon">
                        <i class="fas fa-camera"></i>
                    </div>
                    <span>ถ่ายรูป QR</span>
                    <input type="file" id="qrCameraInput" accept="image/*" class="hidden-input"
                        onchange="processQRImage(this)">
                </label>

                <!-- Live QR Scanner Button -->
                <button class="action-btn btn-scan-qr" onclick="openQRScanner()">
                    <div class="btn-icon">
                        <i class="fas fa-qrcode"></i>
                    </div>
                    <span>สแกน QR</span>
                </button>

                <!-- Search All Students Button -->
                <button class="action-btn btn-search-all" onclick="openStudentSearchModal()">
                    <div class="btn-icon">
                        <i class="fas fa-users"></i>
                    </div>
                    <span>ค้นหา นร.</span>
                </button>

                <!-- Monthly Report Button -->
                <button class="action-btn" onclick="openReportModal()"
                    style="background: linear-gradient(135deg, #f59e0b, #d97706); color: white;">
                    <div class="btn-icon">
                        <i class="fas fa-file-alt"></i>
                    </div>
                    <span>รายงานสรุป</span>
                </button>
            </div>
        </div>

        <div class="table-responsive">
            <table>
                <thead>
                    <tr>
                        <th>รหัส</th>
                        <th>ชื่อ-นามสกุล</th>
                        <th>คะแนน</th>
                        <th class="text-center">ประวัติ</th>
                    </tr>
                </thead>
                <tbody id="studentTable">
                    <tr>
                        <td colspan="4" class="text-center">กำลังโหลดข้อมูล...</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
    </div>

    <div class="toast-container" id="toastContainer"></div>

    <script>
        let teacher = null;
        let students = [];
        let originalStudents = [];
        let filteredStudents = [];
        let teacherClass = null;
        let scoreHistory = []; // Store score history from log.json
        let refreshTimer = null; // Timer for real-time updates

        // Helper functions for status and academic info
        function getStatusPointText(statuspoint) {
            const statusMap = {
                'urgent': 'ไม่ผ่านเกณฑ์ (ปรับแก้คะแนนด่วน)',
                'risk': 'เริ่มมีความเสี่ยงไม่ผ่านเกณฑ์',
                'normal': 'ผ่านเกณฑ์ (คะแนนปกติ)',
                'excellent': 'เด็กดีศรีเทพา'
            };
            return statusMap[statuspoint] || 'ผ่านเกณฑ์ (คะแนนปกติ)';
        }

        function getStatusPointIcon(statuspoint) {
            const iconMap = {
                'urgent': '🚨',
                'risk': '⚠️',
                'normal': '✅',
                'excellent': '⭐'
            };
            return iconMap[statuspoint] || '✅';
        }

        function getAcademicStatusText(status) {
            const statusMap = {
                'normal': 'กำลังศึกษาอยู่',
                'Absent': 'ขาดเรียนนาน',
                'moved': 'ย้ายแล้ว',
                'notnormal': 'พักการเรียน'
            };
            return statusMap[status] || 'กำลังศึกษาอยู่';
        }

        // 1. Initial Load
        async function init() {
            const user = JSON.parse(sessionStorage.getItem('currentUser'));
            if (!user || user.role !== 'teacher') {
                window.location.href = 'index.html';
                return;
            }

            showLoading(true);
            try {
                // Fetch th.json to get class
                const thRes = await fetch('th.json');
                const thData = await thRes.json();
                const teacherProfile = thData.find(t => t.id === user.id);

                if (!teacherProfile || !teacherProfile.class) {
                    alert('ไม่พบข้อมูลห้องเรียนที่รับผิดชอบ');
                    window.location.href = 'index.html';
                    return;
                }

                teacher = teacherProfile;
                teacherClass = teacher.class;

                // UI Update
                document.getElementById('teacherName').textContent = teacher.name;
                document.getElementById('teacherClassDisplay').textContent = 'ห้อง ' + formatClassName(teacherClass);
                document.getElementById('classTitle').textContent = formatClassName(teacherClass);

                // First Load
                await loadData(false);

                // Start Polling
                startRealTimeMonitoring();

                document.addEventListener('visibilitychange', () => {
                    if (document.hidden) stopRealTimeMonitoring();
                    else startRealTimeMonitoring();
                });

            } catch (err) {
                console.error(err);
                showToast('error', 'เกิดข้อผิดพลาดในการโหลดข้อมูล');
            } finally {
                showLoading(false);
            }
        }

        function startRealTimeMonitoring() {
            if (refreshTimer) return;
            refreshTimer = setInterval(() => loadData(true), 5000);
        }

        function stopRealTimeMonitoring() {
            if (refreshTimer) {
                clearInterval(refreshTimer);
                refreshTimer = null;
            }
        }

        async function loadData(isSilent = false) {
            if (!isSilent) showLoading(true);
            try {
                const timestamp = new Date().getTime();
                const stRes = await fetch(`user2.1.json?v=${timestamp}`);
                const stData = await stRes.json();

                window.allStudents = stData;
                students = stData.filter(s => String(s.class) === String(teacherClass));
                originalStudents = JSON.parse(JSON.stringify(students));

                // Keep search filter
                const searchTerm = document.getElementById('searchInput').value.trim().toLowerCase();
                if (searchTerm) {
                    filteredStudents = students.filter(s =>
                        s.name.toLowerCase().includes(searchTerm) ||
                        String(s.id).includes(searchTerm)
                    );
                } else {
                    filteredStudents = [...students];
                }

                // Load logs
                const logRes = await fetch(`log.json?v=${timestamp}`);
                scoreHistory = await logRes.json();

                updateStats();
                renderTable();
            } catch (err) {
                console.error('Data Load Error:', err);
            } finally {
                if (!isSilent) showLoading(false);
            }
        }

        // 2. Formatting
        function formatClassName(code) {
            if (!code) return '-';
            const s = String(code);
            if (s.length >= 2) return `ม.${s[0]}/${parseInt(s.substring(1))}`;
            return s;
        }

        // 3. Stats
        function updateStats() {
            const total = students.length;
            const avg = total > 0 ? students.reduce((sum, s) => sum + s.score, 0) / total : 0;
            const high = students.filter(s => s.score >= 80).length;
            const urgent = students.filter(s => s.score < 60).length;

            document.getElementById('statTotal').textContent = total;
            document.getElementById('statAvg').textContent = avg.toFixed(1);
            document.getElementById('statHigh').textContent = high;
            document.getElementById('statUrgent').textContent = urgent;
        }

        // 4. Render Table
        function renderTable() {
            const tbody = document.getElementById('studentTable');
            if (filteredStudents.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" style="text-align:center; padding:30px; color:#64748b;">ไม่พบข้อมูลนักเรียน</td></tr>';
                return;
            }

            tbody.innerHTML = filteredStudents.map((s, idx) => {
                const scoreClass = s.score >= 80 ? 'score-high' : s.score < 60 ? 'score-low' : 'score-mid';
                const studentHistory = scoreHistory.filter(h => h.student_id === s.id);
                const historyCount = studentHistory.length;

                return `
          <tr>
            <td style="font-weight:600;">${s.id}</td>
            <td>${s.name}</td>
            <td><span class="score-badge ${scoreClass}">${s.score}</span></td>
            <td style="text-align: center;">
              <button class="btn-history" onclick="openManageStudentModal('${s.id}', '${s.name.replace(/'/g, "\\'")}')"
                title="จัดการนักเรียน">
                <i class="fas fa-user-cog"></i> จัดการ
              </button>
            </td>
          </tr>
        `;
            }).join('');
        }

        // 5. Logic
        function handleSearch() {
            const query = document.getElementById('searchInput').value.toLowerCase();
            filteredStudents = students.filter(s =>
                s.name.toLowerCase().includes(query) || s.id.includes(query)
            );
            renderTable();
        }

        // Load score history from log.json
        async function loadScoreHistory() {
            try {
                const response = await fetch('log.json');
                const data = await response.json();
                // Filter history for students in teacher's class
                scoreHistory = data.filter(h => {
                    const student = students.find(s => s.id === h.student_id);
                    return student !== undefined;
                });
                console.log('Loaded score history:', scoreHistory.length, 'records');
            } catch (err) {
                console.error('Error loading score history:', err);
                scoreHistory = [];
            }
        }

        // View student score history
        async function viewStudentHistory(studentId, studentName) {
            const modal = document.getElementById('historyModal');

            // Real-time Fetch latest history before showing
            try {
                const timestamp = new Date().getTime();
                const logRes = await fetch(`log.json?v=${timestamp}`);
                scoreHistory = await logRes.json();
            } catch (e) {
                console.error('Failed to pre-fetch history:', e);
            }

            const studentHistory = scoreHistory.filter(h => String(h.student_id) === String(studentId));

            // Update student info in modal
            document.getElementById('historyStudentName').textContent = studentName;
            document.getElementById('historyStudentId').textContent = `รหัส: ${studentId}`;

            // Set Avatar in History Modal
            const timestamp = new Date().getTime();
            const avatarContainer = document.querySelector('#historyModal .history-student-avatar');
            if (avatarContainer) {
                avatarContainer.innerHTML = `<img src="./edstudent/${studentId}.jpg?v=${timestamp}" onerror="this.onerror=null; this.parentElement.innerHTML='<i class=\'fas fa-user-graduate\'></i>'">`;
            }
            setupAvatarClickHandler(avatarContainer, studentId, studentName);

            // Render history list
            const listContainer = document.getElementById('historyList');

            if (studentHistory.length === 0) {
                listContainer.innerHTML = `
                    <div class="history-empty">
                        <i class="fas fa-clipboard-list"></i>
                        <p>ยังไม่มีประวัติการปรับคะแนน</p>
                    </div>
                `;
            } else {
                // Sort by timestamp (newest first)
                studentHistory.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

                listContainer.innerHTML = studentHistory.map(h => {
                    // รองรับหลาย field names สำหรับคะแนน
                    const scoreChange = h.change || h.score_change || h.scoreChange || h.score || h.point || h.points || 0;
                    const isPositive = scoreChange > 0;
                    const scoreText = isPositive ? `+${scoreChange}` : scoreChange.toString();
                    const timestamp = formatTimestamp(h.timestamp);

                    return `
                        <div class="history-item ${isPositive ? 'positive' : 'negative'}">
                            <div class="history-score-badge ${isPositive ? 'positive' : 'negative'}">
                                ${scoreText}
                            </div>
                            <div class="history-content">
                                <div class="history-reason">${h.reason || 'ไม่ระบุสาเหตุ'}</div>
                                <div class="history-meta">
                                    <span><i class="fas fa-clock"></i> ${timestamp}</span>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
            }

            modal.classList.add('show');
        }

        // Format timestamp to Thai locale
        function formatTimestamp(isoString) {
            if (!isoString) return 'ไม่ระบุเวลา';
            try {
                const date = new Date(isoString);
                return date.toLocaleDateString('th-TH', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
            } catch (e) {
                return isoString;
            }
        }

        // Close history modal
        function closeHistoryModal() {
            const modal = document.getElementById('historyModal');
            modal.classList.remove('show');
        }

        // Note: Score adjustment features removed as per request to make this a view-only dashboard

        // UTILS
        function showLoading(show) {
            document.getElementById('loadingOverlay').classList.toggle('show', show);
        }

        function showToast(type, message) {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            toast.innerHTML = `<i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-circle'}"></i> <span>${message}</span>`;
            container.appendChild(toast);
            setTimeout(() => {
                toast.style.opacity = '0';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        function logout() {
            Swal.fire({
                title: 'ยืนยันการออกจากระบบ?',
                text: "คุณต้องการออกจากระบบหรือไม่?",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#ef4444',
                cancelButtonColor: '#1e293b',
                confirmButtonText: 'ใช่, ออกจากระบบ',
                cancelButtonText: 'ยกเลิก',
                background: '#ffffff',
                color: '#1e293b'
            }).then((result) => {
                if (result.isConfirmed) {
                    sessionStorage.removeItem('currentUser');
                    window.location.href = 'index.html';
                }
            })
        }


        // QR Scanner Functions
        let html5QrcodeScanner = null;

        function openQRScanner() {
            const modal = document.getElementById('qrScannerModal');
            const qrForm = document.getElementById('qrForm');

            modal.classList.add('show');
            qrForm.classList.remove('show');

            // Calculate responsive qrbox size based on screen
            const screenWidth = window.innerWidth;
            const qrboxSize = Math.min(screenWidth - 80, 250);

            // Initialize QR Scanner
            html5QrcodeScanner = new Html5Qrcode("qr-reader");

            // Try to start with back camera first
            html5QrcodeScanner.start(
                { facingMode: "environment" },
                {
                    fps: 10,
                    qrbox: { width: qrboxSize, height: qrboxSize },
                    aspectRatio: 1.0
                },
                onScanSuccess
            ).catch(err => {
                console.error("Back camera error:", err);
                // Try front camera if back camera fails
                html5QrcodeScanner.start(
                    { facingMode: "user" },
                    {
                        fps: 10,
                        qrbox: { width: qrboxSize, height: qrboxSize },
                        aspectRatio: 1.0
                    },
                    onScanSuccess
                ).catch(err2 => {
                    console.error("Front camera error:", err2);
                    // Try any available camera
                    Html5Qrcode.getCameras().then(cameras => {
                        if (cameras && cameras.length > 0) {
                            html5QrcodeScanner.start(
                                cameras[0].id,
                                {
                                    fps: 10,
                                    qrbox: { width: qrboxSize, height: qrboxSize }
                                },
                                onScanSuccess
                            ).catch(err3 => {
                                console.error("Camera start error:", err3);
                                showToast('error', 'ไม่สามารถเปิดกล้องได้ กรุณาตรวจสอบการอนุญาตใช้งานกล้องในเบราว์เซอร์');
                                closeQRScanner();
                            });
                        } else {
                            showToast('error', 'ไม่พบกล้องในอุปกรณ์นี้');
                            closeQRScanner();
                        }
                    }).catch(err3 => {
                        console.error("Get cameras error:", err3);
                        showToast('error', 'ไม่สามารถเข้าถึงกล้องได้ กรุณาอนุญาตการใช้งานกล้องในการตั้งค่าเบราว์เซอร์');
                        closeQRScanner();
                    });
                });
            });
        }

        // Process QR image from camera capture - Simple version that works!
        function processQRImage(inputElement) {
            if (!inputElement.files || !inputElement.files[0]) {
                return;
            }

            const file = inputElement.files[0];
            console.log('Processing file:', file.name, file.size, 'bytes');
            showToast('info', 'กำลังอ่าน QR Code...');

            const reader = new FileReader();

            reader.onload = function (e) {
                const img = new Image();

                img.onload = function () {
                    console.log('Image loaded:', img.width, 'x', img.height);

                    // Create canvas
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');

                    // Resize to reasonable size for processing
                    const maxSize = 800;
                    let w = img.width;
                    let h = img.height;

                    if (w > maxSize || h > maxSize) {
                        const scale = maxSize / Math.max(w, h);
                        w = Math.round(w * scale);
                        h = Math.round(h * scale);
                    }

                    canvas.width = w;
                    canvas.height = h;

                    // Draw image
                    ctx.fillStyle = '#FFFFFF';
                    ctx.fillRect(0, 0, w, h);
                    ctx.drawImage(img, 0, 0, w, h);

                    // Get image data
                    const imageData = ctx.getImageData(0, 0, w, h);
                    console.log('Processing', w, 'x', h);

                    // Try to decode QR
                    try {
                        const qrCode = jsQR(imageData.data, imageData.width, imageData.height, {
                            inversionAttempts: "attemptBoth"
                        });

                        if (qrCode && qrCode.data) {
                            console.log('QR found:', qrCode.data);
                            processScannedQR(qrCode.data);
                        } else {
                            console.log('QR not found, trying smaller size...');
                            // Try smaller size
                            trySmaller(img, inputElement);
                        }
                    } catch (err) {
                        console.error('jsQR error:', err);
                        showToast('error', 'เกิดข้อผิดพลาดในการอ่าน QR');
                    }

                    inputElement.value = '';
                };

                img.onerror = function () {
                    console.error('Image load error');
                    showToast('error', 'ไม่สามารถโหลดรูปภาพได้');
                    inputElement.value = '';
                };

                img.src = e.target.result;
            };

            reader.onerror = function () {
                console.error('FileReader error');
                showToast('error', 'ไม่สามารถอ่านไฟล์ได้');
                inputElement.value = '';
            };

            reader.readAsDataURL(file);
        }

        // Try smaller sizes
        function trySmaller(img, inputElement) {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            const sizes = [600, 400, 300];

            for (let size of sizes) {
                const scale = size / Math.max(img.width, img.height);
                const w = Math.round(img.width * scale);
                const h = Math.round(img.height * scale);

                canvas.width = w;
                canvas.height = h;
                ctx.fillStyle = '#FFFFFF';
                ctx.fillRect(0, 0, w, h);
                ctx.drawImage(img, 0, 0, w, h);

                const imageData = ctx.getImageData(0, 0, w, h);

                try {
                    const qrCode = jsQR(imageData.data, imageData.width, imageData.height, {
                        inversionAttempts: "attemptBoth"
                    });

                    if (qrCode && qrCode.data) {
                        console.log('QR found at size', size, ':', qrCode.data);
                        processScannedQR(qrCode.data);
                        return;
                    }
                } catch (err) {
                    console.error('jsQR error at size', size);
                }
            }

            showToast('error', 'ไม่พบ QR Code กรุณาถ่ายรูปให้ชัดและ QR อยู่กลางภาพ');
        }

        // Manual ID input functions with beautiful modal
        function openManualInput() {
            const modal = document.getElementById('manualInputModal');
            const input = document.getElementById('manualStudentId');
            console.log('Opening manual input. allStudents available:', !!window.allStudents, 'Count:', window.allStudents?.length);
            modal.classList.add('show');
            input.value = '';
            setTimeout(() => input.focus(), 100);
        }

        function closeManualInput() {
            const modal = document.getElementById('manualInputModal');
            modal.classList.remove('show');
        }

        function submitManualInput() {
            const input = document.getElementById('manualStudentId');
            const studentId = input.value.trim();
            console.log('Searching for student ID:', studentId);
            console.log('Available students:', window.allStudents?.length);

            if (studentId) {
                closeManualInput();
                processScannedQR(studentId);
            } else {
                showToast('error', 'กรุณากรอกรหัสนักเรียน');
                input.focus();
            }
        }

        // Shared function to process scanned QR code
        async function processScannedQR(decodedText) {
            // Check if allStudents is loaded
            if (!window.allStudents || !Array.isArray(window.allStudents)) {
                console.error('allStudents not loaded:', window.allStudents);
                showToast('error', 'ข้อมูลนักเรียนยังไม่โหลด กรุณารอสักครู่');
                return;
            }

            // Ensure decodedText is string for comparison
            const searchId = String(decodedText).trim();

            // Find student by ID from ALL students
            const student = window.allStudents.find(s => String(s.id).trim() === searchId);

            if (student) {
                // Open the QR form modal
                const modal = document.getElementById('qrScannerModal');
                modal.classList.add('show');

                document.getElementById('qrStudentId').value = student.id;
                document.getElementById('qrStudentName').value = student.name || 'ไม่ระบุชื่อ';
                document.getElementById('qrReason').value = '';

                // Reset checkboxes when opening form
                resetQRDeductionCheckboxes();

                document.getElementById('qrForm').classList.add('show');
                showToast('success', `พบนักเรียน: ${student.name}`);
            } else {
                console.warn('Student not found:', searchId, 'in', window.allStudents.length, 'students');
                showToast('error', `ไม่พบข้อมูลนักเรียน รหัส: ${decodedText}`);
            }
        }

        // Manage Student Functions
        let currentManageId = null;
        let currentManageName = null;

        function openManageStudentModal(id, name) {
            currentManageId = id;
            currentManageName = name;

            document.getElementById('manageStudentName').textContent = name;
            document.getElementById('manageStudentId').textContent = `รหัส: ${id}`;

            // Find student details
            const student = window.allStudents ? window.allStudents.find(s => String(s.id) === String(id)) : null;

            if (student) {
                document.getElementById('manageStudentAcademic').textContent = getAcademicStatusText(student.status);
                const statusIcon = getStatusPointIcon(student.statuspoint || 'normal');
                const statusText = getStatusPointText(student.statuspoint || 'normal');
                document.getElementById('manageStudentStatus').textContent = `${statusIcon} ${statusText}`;
                document.getElementById('manageStudentScore').textContent = `${student.score} คะแนน`;
            } else {
                document.getElementById('manageStudentAcademic').textContent = '-';
                document.getElementById('manageStudentStatus').textContent = '-';
                document.getElementById('manageStudentScore').textContent = '-';
            }

            // Set Avatar
            const avatarDiv = document.getElementById('manageStudentAvatar');
            const timestamp = new Date().getTime();
            avatarDiv.innerHTML = `<img src="./edstudent/${id}.jpg?v=${timestamp}" onerror="this.onerror=null; this.parentElement.innerHTML='<i class=\'fas fa-user\'></i>'">`;

            document.getElementById('manageStudentModal').classList.add('show');
            setupAvatarClickHandler(avatarDiv, id, name);
        }

        function closeManageStudentModal() {
            document.getElementById('manageStudentModal').classList.remove('show');
        }

        function openHistoryFromManage() {
            closeManageStudentModal();
            viewStudentHistory(currentManageId, currentManageName);
        }

        // ========== Profile Viewer Functions ==========
        function openProfileViewer(studentId, studentName) {
            const modal = document.getElementById('profileViewerModal');
            const container = document.getElementById('profileViewerImageContainer');
            const timestamp = new Date().getTime();
            const imagePath = `./edstudent/${studentId}.jpg?v=${timestamp}`;

            document.getElementById('profileViewerName').textContent = studentName;
            document.getElementById('profileViewerId').textContent = `รหัส: ${studentId}`;

            // Show loading first
            container.innerHTML = `<div class="no-profile-image"><i class="fas fa-spinner fa-spin"></i></div>`;
            modal.classList.add('show');

            // Try to load image
            const img = new Image();
            img.onload = function () {
                // Image loaded successfully
                container.innerHTML = `<img class="profile-viewer-image" src="${imagePath}">`;
            };
            img.onerror = function () {
                // Image failed to load, show placeholder
                console.log('Profile image not found:', imagePath);
                container.innerHTML = `<div class="no-profile-image"><i class="fas fa-user-graduate"></i></div>`;
            };
            img.src = imagePath;
        }

        function closeProfileViewer(event) {
            if (event) event.stopPropagation();
            document.getElementById('profileViewerModal').classList.remove('show');
        }

        // Setup avatar click handlers - called after setting avatar innerHTML
        function setupAvatarClickHandler(avatarElement, studentId, studentName) {
            if (avatarElement) {
                avatarElement.style.cursor = 'pointer';
                avatarElement.onclick = function () { openProfileViewer(studentId, studentName); };
            }
        }

        // Profile Image State
        let croppedImageBase64 = null;

        function openUploadProfileModal() {
            document.getElementById('uploadProfileModal').classList.add('show');

            // Reset file input
            document.getElementById('profileImageInput').value = '';
            croppedImageBase64 = null;

            // Load current profile image from edstudent folder
            const previewImg = document.getElementById('profilePreview');
            const placeholder = document.getElementById('profilePlaceholder');
            const timestamp = new Date().getTime();

            // Try to load existing profile image
            previewImg.src = `./edstudent/${currentManageId}.jpg?v=${timestamp}`;
            previewImg.onload = function () {
                // Image exists, show it
                previewImg.style.display = 'block';
                placeholder.style.display = 'none';
            };
            previewImg.onerror = function () {
                // Image doesn't exist, show placeholder
                previewImg.style.display = 'none';
                placeholder.style.display = 'block';
                previewImg.src = '';
            };
        }

        function closeUploadProfileModal() {
            document.getElementById('uploadProfileModal').classList.remove('show');
        }

        function previewProfileImage(input) {
            if (input.files && input.files[0]) {
                const file = input.files[0];

                const reader = new FileReader();
                reader.onload = function (e) {
                    const img = new Image();
                    img.onload = function () {
                        // Center Crop Logic
                        const canvas = document.createElement('canvas');
                        const maxSize = 500;
                        let width = img.width;
                        let height = img.height;

                        let sx, sy, sWidth, sHeight;

                        // Calculate square crop from center
                        if (width > height) {
                            sHeight = height;
                            sWidth = height;
                            sx = (width - height) / 2;
                            sy = 0;
                        } else {
                            sWidth = width;
                            sHeight = width;
                            sx = 0;
                            sy = (height - width) / 2;
                        }

                        canvas.width = maxSize;
                        canvas.height = maxSize;
                        const ctx = canvas.getContext('2d');

                        // Draw cropped image
                        ctx.drawImage(img, sx, sy, sWidth, sHeight, 0, 0, maxSize, maxSize);

                        const base64Data = canvas.toDataURL('image/jpeg', 0.9);

                        // Update UI
                        const previewImg = document.getElementById('profilePreview');
                        previewImg.src = base64Data;
                        previewImg.style.display = 'block';
                        document.getElementById('profilePlaceholder').style.display = 'none';

                        croppedImageBase64 = base64Data;
                    };
                    img.src = e.target.result;
                };
                reader.readAsDataURL(file);
            }
        }

        async function saveProfileImage() {
            if (!croppedImageBase64) {
                showToast('error', 'กรุณาเลือกรูปภาพ');
                return;
            }

            // Send to server
            sendProfileImage(croppedImageBase64);
        }

        async function sendProfileImage(base64Data) {
            showLoading(true);
            try {
                const response = await fetch('/api/upload-student-profile', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        student_id: currentManageId,
                        image_data: base64Data
                    })
                });

                const result = await response.json();

                if (result.status === 'success') {
                    showToast('success', 'อัปโหลดรูปโปรไฟล์เรียบร้อย');
                    closeUploadProfileModal();

                    // Refresh avatar in manage modal
                    const timestamp = new Date().getTime();
                    const avatarDiv = document.getElementById('manageStudentAvatar');
                    avatarDiv.innerHTML = `<img src="./edstudent/${currentManageId}.jpg?v=${timestamp}" onerror="this.onerror=null; this.parentElement.innerHTML='<i class=\'fas fa-user\'></i>'">`;

                } else {
                    showToast('error', 'เกิดข้อผิดพลาด: ' + result.message);
                }
            } catch (error) {
                console.error('Upload Error:', error);
                showToast('error', 'ไม่สามารถเชื่อมต่อเซิร์ฟเวอร์');
            } finally {
                showLoading(false);
            }
        }
        function toggleQRDeductionCheckbox(item) {
            const checkbox = item.querySelector('input[type="checkbox"]');
            checkbox.checked = !checkbox.checked;
            item.classList.toggle('checked', checkbox.checked);

            // If it's the "other" checkbox, toggle the input field
            if (checkbox.id === 'qrReasonOther') {
                toggleQROtherReasonInput();
            }

            // Auto-populate the reason textarea
            updateQRReasonFromCheckboxes();
        }

        // Toggle other reason input visibility for QR form
        function toggleQROtherReasonInput() {
            const otherCheckbox = document.getElementById('qrReasonOther');
            const otherInput = document.getElementById('qrOtherReasonInput');

            if (otherCheckbox.checked) {
                otherInput.classList.add('show');
                document.getElementById('qrOtherReasonText').focus();
            } else {
                otherInput.classList.remove('show');
                document.getElementById('qrOtherReasonText').value = '';
            }

            updateQRReasonFromCheckboxes();
        }

        // Update reason textarea based on selected checkboxes for QR form
        function updateQRReasonFromCheckboxes() {
            const container = document.getElementById('qrDeductionReasonsContainer');
            const checkboxes = container.querySelectorAll('input[type="checkbox"]:checked');
            const reasons = [];

            checkboxes.forEach(cb => {
                if (cb.id === 'qrReasonOther') {
                    const otherText = document.getElementById('qrOtherReasonText').value.trim();
                    if (otherText) {
                        reasons.push(otherText);
                    }
                } else {
                    reasons.push(cb.value);
                }
            });

            document.getElementById('qrReason').value = reasons.join(', ');
        }

        // Reset all deduction checkboxes for QR form
        function resetQRDeductionCheckboxes() {
            const container = document.getElementById('qrDeductionReasonsContainer');
            const checkboxItems = container.querySelectorAll('.deduction-checkbox-item');

            checkboxItems.forEach(item => {
                const checkbox = item.querySelector('input[type="checkbox"]');
                checkbox.checked = false;
                item.classList.remove('checked');
            });

            document.getElementById('qrOtherReasonInput').classList.remove('show');
            document.getElementById('qrOtherReasonText').value = '';
        }

        async function onScanSuccess(decodedText) {
            // Stop scanner safely
            try {
                if (html5QrcodeScanner && html5QrcodeScanner.getState() === Html5QrcodeScannerState.SCANNING) {
                    await html5QrcodeScanner.stop();
                }
            } catch (e) {
                console.log('Scanner already stopped');
            }

            // Use shared function
            await processScannedQR(decodedText);
        }

        async function submitQRForm() {
            try {
                const studentId = document.getElementById('qrStudentId').value;
                const studentName = document.getElementById('qrStudentName').value;
                const reason = document.getElementById('qrReason').value.trim();

                if (!reason) {
                    showToast('error', 'กรุณาระบุสาเหตุ');
                    return;
                }

                // Get current user
                let currentUser = null;
                try {
                    const userStr = sessionStorage.getItem('currentUser');
                    if (userStr) {
                        currentUser = JSON.parse(userStr);
                    }
                } catch (e) {
                    console.error('Error getting user:', e);
                }

                const data = {
                    student_id: studentId,
                    student_name: studentName,
                    reason: reason,
                    teacher: currentUser ? currentUser.name : 'Unknown',
                    timestamp: new Date().toISOString(),
                    status: 'pending'
                };

                // Send to server API
                showLoading(true);
                const response = await fetch('/api/save-toadmin', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });

                const result = await response.json();
                showLoading(false);

                if (result.status === 'success') {
                    console.log('Saved to server:', data);
                    showToast('success', 'บันทึกข้อมูลสำเร็จ');
                    closeQRScanner();
                } else {
                    showToast('error', 'เกิดข้อผิดพลาด: ' + (result.message || 'Unknown error'));
                }
            } catch (error) {
                showLoading(false);
                console.error('Submit error:', error);
                const errorMsg = error && error.message ? error.message : String(error);
                showToast('error', 'เกิดข้อผิดพลาด: ' + errorMsg);
            }
        }

        function cancelQRForm() {
            document.getElementById('qrForm').classList.remove('show');
            openQRScanner(); // Restart scanner
        }

        function closeQRScanner() {
            const modal = document.getElementById('qrScannerModal');
            modal.classList.remove('show');

            if (html5QrcodeScanner) {
                try {
                    html5QrcodeScanner.stop().catch(err => console.log('Scanner already stopped'));
                } catch (e) {
                    console.log('Scanner cleanup:', e.message);
                }
                html5QrcodeScanner = null;
            }
        }

        // ========== Student Search Modal Functions ==========
        let allStudentsForSearch = [];

        async function openStudentSearchModal() {
            const overlay = document.getElementById('studentSearchOverlay');
            overlay.classList.add('show');

            // Reset filters
            document.getElementById('studentSearchInput').value = '';
            document.getElementById('studentSearchClassFilter').value = '';

            // Always reload data to ensure fresh data
            try {
                document.getElementById('studentSearchResults').innerHTML = `
                    <div class="student-search-empty">
                        <i class="fas fa-spinner fa-spin"></i>
                        <p>กำลังโหลดข้อมูลนักเรียน...</p>
                    </div>
                `;
                document.getElementById('studentSearchCount').textContent = 'กำลังโหลด...';

                const response = await fetch('user2.1.json');
                if (!response.ok) {
                    throw new Error('HTTP error! status: ' + response.status);
                }
                allStudentsForSearch = await response.json();
                console.log('Loaded', allStudentsForSearch.length, 'students for search');

                // Populate class filter with all unique classes
                populateClassFilter();

                // Render all students initially
                filterStudentSearch();
            } catch (error) {
                console.error('Error loading students:', error);
                document.getElementById('studentSearchResults').innerHTML = `
                    <div class="student-search-empty">
                        <i class="fas fa-exclamation-circle"></i>
                        <p>ไม่สามารถโหลดข้อมูลได้: ${error.message}</p>
                    </div>
                `;
                document.getElementById('studentSearchCount').textContent = 'เกิดข้อผิดพลาด';
            }
        }

        function closeStudentSearchModal() {
            const overlay = document.getElementById('studentSearchOverlay');
            overlay.classList.remove('show');
        }

        function populateClassFilter() {
            const classFilter = document.getElementById('studentSearchClassFilter');
            const classes = [...new Set(allStudentsForSearch.map(s => s.class))]
                .filter(c => c !== undefined && c !== null)
                .sort((a, b) => Number(a) - Number(b));

            console.log('Found classes:', classes);

            classFilter.innerHTML = '<option value="">ทุกห้อง</option>';
            classes.forEach(classCode => {
                const option = document.createElement('option');
                option.value = classCode;
                option.textContent = formatClassNameSearch(classCode);
                classFilter.appendChild(option);
            });

            console.log('Class filter options:', classFilter.options.length);
        }

        function formatClassNameSearch(classCode) {
            const code = String(classCode);
            if (code.length === 3) {
                return 'ม.' + code[0] + '/' + code.substring(1);
            }
            return classCode;
        }

        function filterStudentSearch() {
            const searchQuery = document.getElementById('studentSearchInput').value.toLowerCase().trim();
            const classFilter = document.getElementById('studentSearchClassFilter').value;

            let filtered = allStudentsForSearch;

            // Filter by class
            if (classFilter) {
                filtered = filtered.filter(s => String(s.class) === classFilter);
            }

            // Filter by search query
            if (searchQuery) {
                filtered = filtered.filter(s =>
                    s.name.toLowerCase().includes(searchQuery) ||
                    s.id.includes(searchQuery)
                );
            }

            // Limit to 50 results for performance
            const displayResults = filtered.slice(0, 50);

            renderSearchResults(displayResults, filtered.length);
        }

        function renderSearchResults(results, totalCount) {
            const container = document.getElementById('studentSearchResults');
            const countEl = document.getElementById('studentSearchCount');

            if (results.length === 0) {
                container.innerHTML = `
                    <div class="student-search-empty">
                        <i class="fas fa-search"></i>
                        <p>ไม่พบนักเรียนที่ตรงกับเงื่อนไข</p>
                    </div>
                `;
                countEl.textContent = 'ไม่พบข้อมูล';
                return;
            }

            container.innerHTML = results.map(student => `
                <div class="student-search-item" onclick="selectStudentForAdmin('${student.id}')">
                    <div class="student-search-item-info">
                        <div class="student-search-item-name">${student.name}</div>
                        <div class="student-search-item-meta">
                            รหัส: ${student.id} | ห้อง: ${formatClassNameSearch(student.class)} | คะแนน: ${student.score}
                        </div>
                    </div>
                    <button class="student-search-item-btn" onclick="event.stopPropagation(); selectStudentForAdmin('${student.id}')">
                        <i class="fas fa-paper-plane"></i> เลือก
                    </button>
                </div>
            `).join('');

            if (totalCount > 50) {
                countEl.textContent = `แสดง 50 รายการแรก จากทั้งหมด ${totalCount} คน`;
            } else {
                countEl.textContent = `พบนักเรียน ${totalCount} คน`;
            }
        }

        function selectStudentForAdmin(studentId) {
            // Close the search modal
            closeStudentSearchModal();

            // Use the existing processScannedQR function (same as QR scan)
            processScannedQR(studentId);
        }

        // ========== Work Submission Functions ==========

        // Switch between Deduction and Work Submission tabs
        function switchModalTab(tab) {
            // Update Tab UI
            document.querySelectorAll('.modal-tab').forEach(t => t.classList.remove('active'));
            const activeTab = document.querySelector(`.modal-tab[onclick="switchModalTab('${tab}')"]`);
            if (activeTab) activeTab.classList.add('active');

            // Toggle Sections
            document.querySelectorAll('.section-content').forEach(s => s.style.display = 'none');
            document.getElementById(`section-${tab}`).style.display = 'block';

            // Check submission type for submit button
            const btn = document.querySelector('.qr-btn-submit');
            if (tab === 'deduction') {
                btn.onclick = submitQRForm;
                btn.innerHTML = '<i class="fas fa-check"></i> บันทึกผล';
            } else {
                btn.onclick = submitWorkForm;
                btn.innerHTML = '<i class="fas fa-paper-plane"></i> ส่งงาน';
            }
        }

        // Preview image and handle file input
        function previewImage(input, previewId, placeholderId) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function (e) {
                    const img = document.getElementById(previewId);
                    img.src = e.target.result;
                    img.classList.add('show');
                    document.getElementById(placeholderId).classList.add('hidden');
                }
                reader.readAsDataURL(input.files[0]);
            }
        }

        // Helper: Resize and compress image to Base64
        function processImage(file, maxWidth = 800) {
            return new Promise((resolve, reject) => {
                if (!file) {
                    resolve(null);
                    return;
                }

                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = (event) => {
                    const img = new Image();
                    img.src = event.target.result;
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        let width = img.width;
                        let height = img.height;

                        if (width > maxWidth) {
                            height = Math.round((height * maxWidth) / width);
                            width = maxWidth;
                        }

                        canvas.width = width;
                        canvas.height = height;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);

                        // Compress to JPEG 80% quality
                        resolve(canvas.toDataURL('image/jpeg', 0.8));
                    };
                    img.onerror = (error) => reject(error);
                };
                reader.onerror = (error) => reject(error);
            });
        }

        async function submitWorkForm() {
            try {
                const studentId = document.getElementById('qrStudentId').value;
                const studentName = document.getElementById('qrStudentName').value;
                const detail = document.getElementById('workDetail').value.trim();
                const beforeFile = document.getElementById('beforeImageInput').files[0];
                const afterFile = document.getElementById('afterImageInput').files[0];

                if (!detail || !beforeFile || !afterFile) {
                    showToast('error', 'กรุณากรอกข้อมูลให้ครบทุกช่อง (รายละเอียด, รูป Before, รูป After)');
                    return;
                }

                showLoading(true);

                // Process images
                const beforeBase64 = await processImage(beforeFile);
                const afterBase64 = await processImage(afterFile);

                // Get current user
                let currentUser = null;
                try {
                    const userStr = sessionStorage.getItem('currentUser');
                    if (userStr) currentUser = JSON.parse(userStr);
                } catch (e) { }

                const data = {
                    student_id: studentId,
                    student_name: studentName,
                    detail: detail,
                    image_before: beforeBase64,
                    image_after: afterBase64,
                    teacher: currentUser ? currentUser.name : 'Unknown',
                    timestamp: new Date().toISOString(),
                    status: 'pending'
                };

                // Send to server
                const response = await fetch('/api/save-work', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                const result = await response.json();
                showLoading(false);

                if (result.status === 'success') {
                    showToast('success', 'ส่งงานเรียบร้อยแล้ว');
                    closeQRScanner();

                    // Reset form
                    document.getElementById('workDetail').value = '';
                    document.getElementById('beforeImageInput').value = '';
                    document.getElementById('afterImageInput').value = '';

                    // Reset previews
                    document.getElementById('beforePreview').classList.remove('show');
                    document.getElementById('afterPreview').classList.remove('show');
                    document.getElementById('beforePlaceholder').classList.remove('hidden');
                    document.getElementById('afterPlaceholder').classList.remove('hidden');

                    // Switch back to deduction tab
                    switchModalTab('deduction');
                } else {
                    throw new Error(result.message || 'Unknown error');
                }
            } catch (error) {
                showLoading(false);
                console.error('Submit work error:', error);
                showToast('error', 'ส่งงานไม่สำเร็จ: ' + error.message);
            }
        }

        // Report Modal Logic
        function openReportModal() {
            const modal = document.getElementById('reportModal');
            populateReportYears();
            modal.classList.add('show');
        }

        function closeReportModal() {
            const modal = document.getElementById('reportModal');
            modal.classList.remove('show');
        }

        function populateReportYears() {
            const yearSelect = document.getElementById('reportYear');
            const currentYearEn = new Date().getFullYear();
            const currentYearTh = currentYearEn + 543;

            yearSelect.innerHTML = '';
            for (let i = 0; i < 3; i++) {
                const yearTh = currentYearTh - i;
                const yearEn = currentYearEn - i;
                const option = document.createElement('option');
                option.value = yearEn;
                option.textContent = `ปีการศึกษา ${yearTh}`;
                yearSelect.appendChild(option);
            }
        }

        function getClassSortValue(c) {
            if (!c || c === '-') return 999999;
            const s = String(c).trim();
            const match = s.match(/ม\.(\d+)\/(\d+)/);
            if (match) return parseInt(match[1]) * 100 + parseInt(match[2]);
            const num = parseInt(s.replace(/\D/g, ''));
            return isNaN(num) ? 999999 : num;
        }

        async function exportReport(type) {
            const month = document.getElementById('reportMonth').value;
            const year = parseInt(document.getElementById('reportYear').value);
            const filter = document.getElementById('reportFilter').value;

            showLoading(true, 'กำลังเตรียมรายงาน...');

            try {
                // Fetch latest data for report
                const timestamp = new Date().getTime();
                const logRes = await fetch(`log.json?v=${timestamp}`);
                const logs = await logRes.json();

                // 1. Reconstruct historical scores
                let reportStudents = JSON.parse(JSON.stringify(students));

                // Determine the end date of selected period
                let endDate;
                if (month === 'all') {
                    endDate = new Date(year, 11, 31, 23, 59, 59, 999); // End of year
                } else {
                    const m = parseInt(month);
                    endDate = new Date(year, m + 1, 0, 23, 59, 59, 999); // Last day of selected month
                }

                // Undo logs that happened AFTER the endDate
                const logsToUndo = logs.filter(l => new Date(l.timestamp) > endDate);

                reportStudents.forEach(s => {
                    const studentLogs = logsToUndo.filter(l => String(l.student_id) === String(s.id));
                    studentLogs.forEach(l => {
                        const change = l.change || l.score_change || l.deduction || 0;
                        s.score -= change; // Reverse the change to go back in time
                    });
                });

                let finalData = [];
                const allWithEval = reportStudents.map(s => {
                    const score = s.score || 0;
                    const hasDeductions = logs.some(l =>
                        String(l.student_id) === String(s.id) &&
                        (l.change < 0 || l.deduction < 0) &&
                        new Date(l.timestamp) <= endDate
                    );

                    let evalStatus = '';
                    if (score >= 100 && !hasDeductions) {
                        evalStatus = 'เด็กดีศรีเทพา';
                    } else if (score < 60) {
                        evalStatus = 'ไม่ผ่านเกณฑ์';
                    } else {
                        evalStatus = 'ผ่านเกณฑ์';
                    }
                    return { ...s, score, evaluation: evalStatus };
                });

                if (filter === 'all') {
                    finalData = allWithEval;
                } else if (filter === 'failed') {
                    finalData = allWithEval.filter(s => s.score < 60);
                } else if (filter === 'passed') {
                    finalData = allWithEval.filter(s => s.score >= 60);
                } else if (filter === 'excellent') {
                    finalData = allWithEval.filter(s => s.evaluation === 'เด็กดีศรีเทพา');
                }

                if (finalData.length === 0) {
                    showToast('error', 'ไม่พบข้อมูลตามเงื่อนไขที่เลือก');
                    return;
                }

                // Sort by Class (M.1-M.6) then name
                finalData.sort((a, b) => {
                    const valA = getClassSortValue(a.class);
                    const valB = getClassSortValue(b.class);
                    if (valA !== valB) return valA - valB;
                    return a.name.localeCompare(b.name, 'th');
                });

                const monthName = month === 'all' ? 'ทุกเดือน' :
                    ['มกราคม', 'กุมภาพันธ์', 'มีนาคม', 'เมษายน', 'พฤษภาคม', 'มิถุนายน', 'กรกฎาคม', 'สิงหาคม', 'กันยายน', 'ตุลาคม', 'พฤศจิกายน', 'ธันวาคม'][parseInt(month)];
                const yearTh = year + 543;
                const title = `รายงานสรุปคะแนนพฤติกรรม ${monthName} ปีการศึกษา ${yearTh}`;

                if (type === 'pdf') {
                    await generateExport(finalData, title, true);
                } else {
                    await generateExport(finalData, title, false);
                }

            } catch (err) {
                console.error('Report error:', err);
                showToast('error', 'เกิดข้อผิดพลาดในการสร้างรายงาน');
            } finally {
                showLoading(false);
            }
        }

        async function generateExport(data, title, isPdf) {
            if (isPdf) {
                try {
                    const { jsPDF } = window.jspdf;
                    const pdf = new jsPDF('p', 'mm', 'a4');
                    const pdfWidth = pdf.internal.pageSize.getWidth();
                    const pdfHeight = pdf.internal.pageSize.getHeight();
                    const ITEMS_PER_PAGE = 20;
                    const totalPages = Math.ceil(data.length / ITEMS_PER_PAGE);

                    for (let i = 0; i < totalPages; i++) {
                        const start = i * ITEMS_PER_PAGE;
                        const end = start + ITEMS_PER_PAGE;
                        const pageData = data.slice(start, end);
                        const isLastPage = (i === totalPages - 1);

                        const tempDiv = document.createElement('div');
                        tempDiv.style.cssText = `
                            position: fixed; left: -10000px; top: 0; width: 800px;
                            background: #ffffff; padding: 40px;
                            color: #000000; font-family: 'Prompt', 'Sarabun', Arial, sans-serif;
                            z-index: 1000; box-sizing: border-box;
                        `;

                        const tableRows = pageData.map((s, idx) => `
                            <tr style="border-bottom: 1px solid #eee;">
                                <td style="padding: 12px; text-align: center; font-size: 14px;">${start + idx + 1}</td>
                                <td style="padding: 12px; text-align: center; font-size: 14px;">${s.id}</td>
                                <td style="padding: 12px; font-size: 14px;">${s.name}</td>
                                <td style="padding: 12px; text-align: center; font-weight: bold; font-size: 14px; color: ${s.score < 60 ? '#ef4444' : '#10b981'};">${s.score}</td>
                                <td style="padding: 12px; text-align: center; font-size: 14px;">${s.evaluation || (s.score < 60 ? 'ไม่ผ่านเกณฑ์' : 'ผ่านเกณฑ์')}</td>
                            </tr>
                        `).join('');

                        let signaturesHtml = '';
                        if (isLastPage) {
                            signaturesHtml = `
                                <div style="margin-top: 50px; display: flex; justify-content: space-around; text-align: center; font-size: 14px;">
                                    <div style="width: 250px;">
                                        <p style="margin-bottom: 40px;">ลงชื่อ.......................................................</p>
                                        <p>(.......................................................)</p>
                                        <p style="margin-top: 8px; font-weight: 600;">ผู้รายงาน</p>
                                    </div>
                                    <div style="width: 250px;">
                                        <p style="margin-bottom: 40px;">ลงชื่อ.......................................................</p>
                                        <p>(.......................................................)</p>
                                        <p style="margin-top: 8px; font-weight: 600;">หัวหน้างานกิจการนักเรียน</p>
                                    </div>
                                </div>
                            `;
                        }

                        tempDiv.innerHTML = `
                            <div style="text-align: center; margin-bottom: 25px; border-bottom: 2px solid #3b82f6; padding-bottom: 15px;">
                                <h1 style="color: #1e3a8a; margin: 0 0 5px 0; font-size: 24px; font-weight: 700;">รายงานสรุปคะแนนพฤติกรรม</h1>
                                <h2 style="color: #1e40af; margin: 0 0 10px 0; font-size: 20px; font-weight: 600;">โรงเรียนเทพา</h2>
                                <p style="color: #475569; margin: 0; font-size: 15px;">
                                    <strong>ห้องเรียน:</strong> ${formatClassName(teacherClass)} | <strong>ครูที่ปรึกษา:</strong> ${teacher.name}
                                </p>
                                <p style="color: #475569; margin: 5px 0 0 0; font-size: 14px;">${title}</p>
                            </div>

                            <table style="width: 100%; border-collapse: collapse; margin-bottom: 20px;">
                                <thead>
                                    <tr style="background: #f1f5f9; border-top: 2px solid #cbd5e0; border-bottom: 2px solid #cbd5e0;">
                                        <th style="padding: 12px; text-align: center; font-size: 14px; width: 10%;">ลำดับ</th>
                                        <th style="padding: 12px; text-align: center; font-size: 14px; width: 15%;">รหัส</th>
                                        <th style="padding: 12px; text-align: left; font-size: 14px; width: 45%;">ชื่อ-นามสกุล</th>
                                        <th style="padding: 12px; text-align: center; font-size: 14px; width: 15%;">คะแนน</th>
                                        <th style="padding: 12px; text-align: center; font-size: 14px; width: 15%;">ผลประเมิน</th>
                                    </tr>
                                </thead>
                                <tbody>${tableRows}</tbody>
                            </table>

                            ${signaturesHtml}

                            <div style="margin-top: 30px; text-align: right; border-top: 1px solid #f1f5f9; padding-top: 10px; display: flex; justify-content: space-between;">
                                <p style="margin: 0; color: #94a3b8; font-size: 11px;">หน้า ${i + 1} / ${totalPages}</p>
                                <p style="margin: 0; color: #94a3b8; font-size: 11px;">พิมพ์เมื่อ: ${new Date().toLocaleString('th-TH')}</p>
                            </div>
                        `;

                        document.body.appendChild(tempDiv);
                        await new Promise(r => setTimeout(r, 500));
                        const canvas = await html2canvas(tempDiv, { scale: 2, useCORS: true, logging: false, backgroundColor: '#ffffff' });
                        document.body.removeChild(tempDiv);

                        const imgData = canvas.toDataURL('image/jpeg', 0.95);
                        let imgHeight = (canvas.height * pdfWidth) / canvas.width;

                        // SAFETY SCALING
                        if (imgHeight > pdfHeight) {
                            imgHeight = pdfHeight;
                        }

                        if (i > 0) pdf.addPage();
                        pdf.addImage(imgData, 'JPEG', 0, 0, pdfWidth, imgHeight);
                    }

                    pdf.save(`${title.replace(/ /g, '_')}.pdf`);
                    showToast('success', 'ส่งออก PDF สำเร็จ');
                } catch (err) {
                    console.error('PDF Export error:', err);
                    showToast('error', 'ไม่สามารถส่งออก PDF ได้');
                }
            } else {
                // IMAGE EXPORT: Render everything on one long canvas as before
                const tempDiv = document.createElement('div');
                tempDiv.style.cssText = `
                    position: fixed; left: -10000px; top: 0; width: 800px;
                    background: #ffffff; padding: 40px;
                    color: #000000; font-family: 'Prompt', 'Sarabun', Arial, sans-serif;
                    z-index: 1000; box-sizing: border-box;
                `;

                let tableRows = data.map((s, idx) => `
                    <tr style="border-bottom: 1px solid #eee;">
                        <td style="padding: 12px; text-align: center; font-size: 14px;">${idx + 1}</td>
                        <td style="padding: 12px; text-align: center; font-size: 14px;">${s.id}</td>
                        <td style="padding: 12px; font-size: 14px;">${s.name}</td>
                        <td style="padding: 12px; text-align: center; font-weight: bold; font-size: 14px; color: ${s.score < 60 ? '#ef4444' : '#10b981'};">${s.score}</td>
                        <td style="padding: 12px; text-align: center; font-size: 14px;">${s.evaluation || (s.score < 60 ? 'ไม่ผ่านเกณฑ์' : 'ผ่านเกณฑ์')}</td>
                    </tr>
                `).join('');

                tempDiv.innerHTML = `
                    <div style="text-align: center; margin-bottom: 25px; border-bottom: 2px solid #3b82f6; padding-bottom: 15px;">
                        <h1 style="color: #1e3a8a; margin: 0 0 5px 0; font-size: 24px; font-weight: 700;">รายงานสรุปคะแนนพฤติกรรม</h1>
                        <h2 style="color: #1e40af; margin: 0 0 10px 0; font-size: 20px; font-weight: 600;">โรงเรียนเทพา</h2>
                        <p style="color: #475569; margin: 0; font-size: 15px;">
                            <strong>ห้องเรียน:</strong> ${formatClassName(teacherClass)} | <strong>ครูที่ปรึกษา:</strong> ${teacher.name}
                        </p>
                        <p style="color: #475569; margin: 5px 0 0 0; font-size: 14px;">${title}</p>
                    </div>

                    <table style="width: 100%; border-collapse: collapse; margin-bottom: 30px;">
                        <thead>
                            <tr style="background: #f1f5f9; border-top: 2px solid #cbd5e0; border-bottom: 2px solid #cbd5e0;">
                                <th style="padding: 12px; text-align: center; font-size: 14px; width: 10%;">ลำดับ</th>
                                <th style="padding: 12px; text-align: center; font-size: 14px; width: 15%;">รหัส</th>
                                <th style="padding: 12px; text-align: left; font-size: 14px; width: 45%;">ชื่อ-นามสกุล</th>
                                <th style="padding: 12px; text-align: center; font-size: 14px; width: 15%;">คะแนน</th>
                                <th style="padding: 12px; text-align: center; font-size: 14px; width: 15%;">ผลประเมิน</th>
                            </tr>
                        </thead>
                        <tbody>${tableRows}</tbody>
                    </table>

                    <div style="margin-top: 50px; display: flex; justify-content: space-around; text-align: center; font-size: 14px;">
                        <div style="width: 250px;">
                            <p style="margin-bottom: 40px;">ลงชื่อ.......................................................</p>
                            <p>(.......................................................)</p>
                            <p style="margin-top: 8px; font-weight: 600;">ผู้รายงาน</p>
                        </div>
                        <div style="width: 250px;">
                            <p style="margin-bottom: 40px;">ลงชื่อ.......................................................</p>
                            <p>(.......................................................)</p>
                            <p style="margin-top: 8px; font-weight: 600;">หัวหน้างานกิจการนักเรียน</p>
                        </div>
                    </div>

                    <div style="margin-top: 30px; text-align: right; border-top: 1px solid #f1f5f9; padding-top: 10px;">
                        <p style="margin: 0; color: #94a3b8; font-size: 11px;">พิมพ์เมื่อ: ${new Date().toLocaleString('th-TH')}</p>
                    </div>
                `;

                document.body.appendChild(tempDiv);
                try {
                    const canvas = await html2canvas(tempDiv, { scale: 2, useCORS: true, logging: false, backgroundColor: '#ffffff' });
                    const link = document.createElement('a');
                    link.download = `${title.replace(/ /g, '_')}.png`;
                    link.href = canvas.toDataURL('image/png');
                    link.click();
                    showToast('success', 'ส่งออกรูปภาพสำเร็จ');
                } catch (err) {
                    console.error('Image Export error:', err);
                    showToast('error', 'ไม่สามารถส่งออกรูปภาพได้');
                } finally {
                    document.body.removeChild(tempDiv);
                }
            }
        }

        window.onload = init;
    </script>

    <!-- Manual Input Modal -->
    <div class="manual-input-modal" id="manualInputModal">
        <div class="manual-input-content">
            <div class="manual-input-icon">
                <i class="fas fa-keyboard"></i>
            </div>
            <h3>กรอกรหัสนักเรียน</h3>
            <p>พิมพ์รหัสนักเรียนที่ต้องการเพิ่ม/ลดคะแนน</p>
            <input type="text" class="manual-input-field" id="manualStudentId" placeholder="12345" maxlength="10"
                autocomplete="off" onkeypress="if(event.key === 'Enter') submitManualInput()">
            <div class="manual-input-buttons">
                <button class="btn-cancel" onclick="closeManualInput()">ยกเลิก</button>
                <button class="btn-confirm" onclick="submitManualInput()">
                    <i class="fas fa-check"></i> ยืนยัน
                </button>
            </div>
        </div>
    </div>

    <!-- QR Scanner Modal -->
    <div class="qr-scanner-modal" id="qrScannerModal">
        <div class="qr-scanner-content">
            <div class="qr-scanner-header">
                <h3><i class="fas fa-qrcode"></i> สแกน QR Code นักเรียน</h3>
                <button class="qr-close-btn" onclick="closeQRScanner()">×</button>
            </div>

            <div id="qr-reader" class="qr-reader-container"></div>
            <div id="qr-reader-hidden" class="qr-reader-hidden"></div>

            <div class="qr-form" id="qrForm">
                <div class="qr-form-group">
                    <label>รหัสนักเรียน</label>
                    <input type="text" id="qrStudentId" readonly>
                </div>
                <div class="qr-form-group">
                    <label>ชื่อนักเรียน</label>
                    <input type="text" id="qrStudentName" readonly>
                </div>

                <!-- Tabs -->
                <div class="modal-tabs">
                    <button class="modal-tab active" onclick="switchModalTab('deduction')">ตัดคะแนน</button>
                    <button class="modal-tab" onclick="switchModalTab('work')">แก้ไข/เพิ่มคะแนน</button>
                </div>

                <!-- Section 1: Deduction (Original) -->
                <div id="section-deduction" class="section-content show">
                    <!-- Checkbox group for deduction reasons -->
                    <div class="deduction-reasons-container" id="qrDeductionReasonsContainer">
                        <label class="deduction-reasons-label">เลือกสาเหตุการหักคะแนน <span
                                class="required-indicator">*</span></label>
                        <div class="deduction-reasons-grid">
                            <div class="deduction-checkbox-item" onclick="toggleQRDeductionCheckbox(this)">
                                <input type="checkbox" id="qrReason1" value="มาสาย">
                                <label for="qrReason1">1. มาสาย</label>
                            </div>
                            <div class="deduction-checkbox-item" onclick="toggleQRDeductionCheckbox(this)">
                                <input type="checkbox" id="qrReason2" value="ไม่สวมหมวกกันน็อค">
                                <label for="qrReason2">2. ไม่สวมหมวกกันน็อค</label>
                            </div>
                            <div class="deduction-checkbox-item" onclick="toggleQRDeductionCheckbox(this)">
                                <input type="checkbox" id="qrReason3" value="หนีเรียน">
                                <label for="qrReason3">3. หนีเรียน</label>
                            </div>
                            <div class="deduction-checkbox-item" onclick="toggleQRDeductionCheckbox(this)">
                                <input type="checkbox" id="qrReason4" value="สูบบุหรี่">
                                <label for="qrReason4">4. สูบบุหรี่</label>
                            </div>
                            <div class="deduction-checkbox-item" onclick="toggleQRDeductionCheckbox(this)">
                                <input type="checkbox" id="qrReason5" value="บุหรี่ไฟฟ้า">
                                <label for="qrReason5">5. บุหรี่ไฟฟ้า</label>
                            </div>
                            <div class="deduction-checkbox-item" onclick="toggleQRDeductionCheckbox(this)">
                                <input type="checkbox" id="qrReason6" value="บุคลิกภาพ/การแต่งกายผิดระเบียบ">
                                <label for="qrReason6">6. บุคลิกภาพ/การแต่งกายผิดระเบียบ</label>
                            </div>
                            <div class="deduction-checkbox-item" onclick="toggleQRDeductionCheckbox(this)">
                                <input type="checkbox" id="qrReason7" value="ทะเลาะวิวาท">
                                <label for="qrReason7">7. ทะเลาะวิวาท</label>
                            </div>
                            <div class="deduction-checkbox-item" onclick="toggleQRDeductionCheckbox(this)">
                                <input type="checkbox" id="qrReason8" value="ใช้สื่อโซเชียลไม่เหมาะสม">
                                <label for="qrReason8">8. ใช้สื่อโซเชียลไม่เหมาะสม</label>
                            </div>
                            <div class="deduction-checkbox-item" onclick="toggleQRDeductionCheckbox(this)">
                                <input type="checkbox" id="qrReason9" value="เล่นการพนัน">
                                <label for="qrReason9">9. เล่นการพนัน</label>
                            </div>
                            <div class="deduction-checkbox-item" onclick="toggleQRDeductionCheckbox(this)">
                                <input type="checkbox" id="qrReason10" value="สิงห้องน้ำ">
                                <label for="qrReason10">10. สิงห้องน้ำ</label>
                            </div>
                            <div class="deduction-checkbox-item" onclick="toggleQRDeductionCheckbox(this)">
                                <input type="checkbox" id="qrReason11" value="บูลลี่">
                                <label for="qrReason11">11. บูลลี่</label>
                            </div>
                            <div class="deduction-checkbox-item" onclick="toggleQRDeductionCheckbox(this)">
                                <input type="checkbox" id="qrReason12" value="ทำลายทรัพย์สินโรงเรียน">
                                <label for="qrReason12">12. ทำลายทรัพย์สินโรงเรียน</label>
                            </div>
                            <div class="deduction-checkbox-item" onclick="toggleQRDeductionCheckbox(this)">
                                <input type="checkbox" id="qrReason13" value="แอบถ่ายรูป">
                                <label for="qrReason13">13. แอบถ่ายรูป</label>
                            </div>
                            <div class="deduction-checkbox-item" onclick="toggleQRDeductionCheckbox(this)">
                                <input type="checkbox" id="qrReasonOther" value="อื่นๆ">
                                <label for="qrReasonOther">อื่นๆ (ระบุ)</label>
                            </div>
                        </div>
                        <div class="other-reason-input" id="qrOtherReasonInput">
                            <input type="text" id="qrOtherReasonText" placeholder="ระบุสาเหตุอื่นๆ..."
                                oninput="updateQRReasonFromCheckboxes()">
                        </div>
                    </div>

                    <div class="qr-form-group">
                        <label>สาเหตุที่เลือก</label>
                        <textarea id="qrReason" rows="3" placeholder="สาเหตุจะแสดงที่นี่เมื่อเลือกจากรายการด้านบน..."
                            readonly></textarea>
                    </div>
                </div>

                <!-- Section 2: Work Submission (New) -->
                <div id="section-work" class="section-content section-hidden">
                    <div class="qr-form-group">
                        <label>รายละเอียดงาน / การแก้ไข</label>
                        <textarea id="workDetail" rows="3"
                            placeholder="ระบุรายละเอียดงานหรือสิ่งที่แก้ไข..."></textarea>
                    </div>

                    <div class="image-upload-grid">
                        <!-- Before Image -->
                        <div class="image-upload-box" onclick="document.getElementById('beforeImageInput').click()">
                            <input type="file" id="beforeImageInput" class="file-input" accept="image/*"
                                onchange="previewImage(this, 'beforePreview', 'beforePlaceholder')">
                            <div id="beforePlaceholder" class="upload-placeholder">
                                <i class="fas fa-camera"></i>
                                <p>ก่อนทำ</p>
                            </div>
                            <img id="beforePreview" class="image-preview" alt="Before Preview">
                        </div>

                        <!-- After Image -->
                        <div class="image-upload-box" onclick="document.getElementById('afterImageInput').click()">
                            <input type="file" id="afterImageInput" class="file-input" accept="image/*"
                                onchange="previewImage(this, 'afterPreview', 'afterPlaceholder')">
                            <div id="afterPlaceholder" class="upload-placeholder">
                                <i class="fas fa-magic"></i>
                                <p>หลังทำ</p>
                            </div>
                            <img id="afterPreview" class="image-preview" alt="After Preview">
                        </div>
                    </div>
                </div>
                <div class="qr-form-buttons">
                    <button class="qr-btn qr-btn-cancel" onclick="cancelQRForm()">ยกเลิก</button>
                    <button class="qr-btn qr-btn-submit" onclick="submitQRForm()">ส่ง</button>
                </div>
            </div>
        </div>
    </div>


    <!-- Score History Modal -->
    <div class="history-modal-overlay" id="historyModal">
        <div class="history-modal">
            <div class="history-modal-header">
                <h3><i class="fas fa-history"></i> ประวัติคะแนนพฤติกรรม</h3>
                <button class="history-close-btn" onclick="closeHistoryModal()">×</button>
            </div>
            <div class="history-student-info">
                <div class="history-student-avatar">
                    <i class="fas fa-user-graduate"></i>
                </div>
                <div class="history-student-details">
                    <h4 id="historyStudentName">-</h4>
                    <span id="historyStudentId">รหัส: -</span>
                </div>
            </div>
            <div class="history-list-container">
                <div class="history-list" id="historyList">
                    <!-- History items will be rendered here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Student Search Modal -->
    <div class="student-search-overlay" id="studentSearchOverlay">
        <div class="student-search-modal">
            <div class="student-search-header">
                <h3><i class="fas fa-users"></i> ค้นหานักเรียนทั้งหมด</h3>
                <button class="student-search-close" onclick="closeStudentSearchModal()">×</button>
            </div>
            <div class="student-search-filters">
                <input type="text" class="student-search-input" id="studentSearchInput"
                    placeholder="🔍 ค้นหาชื่อ หรือ รหัสนักเรียน..." oninput="filterStudentSearch()">
                <select class="student-search-class-filter" id="studentSearchClassFilter"
                    onchange="filterStudentSearch()">
                    <option value="">ทุกห้อง</option>
                </select>
            </div>
            <div class="student-search-results" id="studentSearchResults">
                <!-- Results will be rendered here -->
            </div>
            <div class="student-search-count" id="studentSearchCount">
                กำลังโหลด...
            </div>
        </div>
    </div>
    <!-- Manage Student Modal -->
    <div class="student-search-overlay" id="manageStudentModal">
        <div class="report-modal" style="max-width: 450px;">
            <div class="manage-student-header">
                <h3><i class="fas fa-user-cog"></i> จัดการนักเรียน</h3>
            </div>
            <div class="manage-student-profile">
                <div class="manage-avatar-wrapper">
                    <div class="manage-avatar" id="manageStudentAvatar">
                        <i class="fas fa-user"></i>
                    </div>
                    <div class="manage-avatar-badge" onclick="openUploadProfileModal()">
                        <i class="fas fa-camera"></i>
                    </div>
                </div>
                <div class="manage-student-name" id="manageStudentName">-</div>
                <div class="manage-student-id" id="manageStudentId">รหัส: -</div>
            </div>

            <!-- Student Profile Details Section -->
            <div class="manage-student-details">
                <div class="detail-item">
                    <div class="detail-icon"><i class="fas fa-graduation-cap"></i></div>
                    <div class="detail-info">
                        <div class="detail-label">สถานะการเรียน</div>
                        <div class="detail-value" id="manageStudentAcademic">-</div>
                    </div>
                </div>
                <div class="detail-item">
                    <div class="detail-icon"><i class="fas fa-star"></i></div>
                    <div class="detail-info">
                        <div class="detail-label">สถานะพฤติกรรม</div>
                        <div class="detail-value" id="manageStudentStatus">-</div>
                    </div>
                </div>
                <div class="detail-item">
                    <div class="detail-icon"><i class="fas fa-chart-line"></i></div>
                    <div class="detail-info">
                        <div class="detail-label">คะแนนปัจจุบัน</div>
                        <div class="detail-value" id="manageStudentScore">-</div>
                    </div>
                </div>
            </div>

            <div class="manage-options">
                <button class="manage-option-btn" onclick="openHistoryFromManage()">
                    <div class="manage-option-icon">
                        <i class="fas fa-history"></i>
                    </div>
                    <div class="manage-option-content">
                        <span>ประวัติคะแนน</span>
                        <div class="manage-option-desc">ดูประวัติการเพิ่ม/ลดคะแนนทั้งหมด</div>
                    </div>
                    <i class="fas fa-chevron-right manage-option-arrow"></i>
                </button>
                <button class="manage-option-btn" onclick="closeManageStudentModal()">
                    <div class="manage-option-icon" style="background: linear-gradient(135deg, #64748b, #475569);">
                        <i class="fas fa-times"></i>
                    </div>
                    <div class="manage-option-content">
                        <span>ปิดหน้าต่าง</span>
                        <div class="manage-option-desc">กลับสู่หน้ารายชื่อนักเรียน</div>
                    </div>
                </button>
            </div>
        </div>
    </div>

    <!-- Profile Viewer Modal -->
    <div class="student-search-overlay" id="profileViewerModal" onclick="closeProfileViewer(event)"
        style="z-index: 10200;">
        <div class="report-modal" style="max-width: 400px; padding: 25px;" onclick="event.stopPropagation()">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h3 id="profileViewerName" style="margin: 0; font-size: 1.5rem; color: #1e293b;">-</h3>
                <button onclick="closeProfileViewer()"
                    style="border: none; background: #f1f5f9; width: 36px; height: 36px; border-radius: 50%; cursor: pointer; color: #64748b; font-size: 1.2rem; display: flex; align-items: center; justify-content: center; transition: all 0.2s;">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div id="profileViewerId"
                style="color: #6366f1; background: #eef2ff; padding: 4px 12px; border-radius: 20px; font-size: 0.9rem; margin-bottom: 20px; display: inline-block; font-weight: 600;">
                รหัส: -</div>
            <div id="profileViewerImageContainer" class="profile-viewer-image-container">
                <div class="no-profile-image">
                    <i class="fas fa-user-graduate"></i>
                    <p>ไม่มีรูปโปรไฟล์</p>
                </div>
            </div>
            <div style="margin-top: 20px; text-align: center;">
                <p style="color: #64748b; font-size: 0.85rem;"><i class="fas fa-info-circle"></i> รูปภาพที่จัดเก็บในระบบ
                    edstudent</p>
            </div>
        </div>
    </div>

    <!-- Upload Profile Modal -->
    <div class="student-search-overlay" id="uploadProfileModal" style="z-index: 10100;">
        <div class="report-modal" style="max-width: 450px;">
            <div class="report-header"
                style="background: linear-gradient(135deg, #6366f1, #8b5cf6); padding: 20px 25px;">
                <h3><i class="fas fa-camera"></i> อัปโหลดรูปโปรไฟล์</h3>
            </div>
            <div class="report-body" style="padding: 30px;">
                <div class="upload-preview-container"
                    style="background: #f8fafc; border: 2px dashed #e2e8f0; border-radius: 24px; padding: 40px 20px;">
                    <div class="upload-preview" onclick="document.getElementById('profileImageInput').click()"
                        style="width: 200px; height: 200px; border: 4px solid white; box-shadow: 0 15px 35px rgba(0,0,0,0.1);">
                        <input type="file" id="profileImageInput" class="hidden-input" accept="image/*"
                            onchange="previewProfileImage(this)">
                        <div id="profilePlaceholder">
                            <i class="fas fa-cloud-upload-alt" style="font-size: 4rem; color: #cbd5e1;"></i>
                            <p style="margin-top: 10px; font-weight: 600; color: #94a3b8;">คลิกเพื่อเลือกรูป</p>
                        </div>
                        <img id="profilePreview" class="profile-preview-hidden"
                            style="width: 100%; height: 100%; object-fit: cover; border-radius: 50%;">
                    </div>
                    <p class="profile-instruction" style="margin-top: 20px;">เลือกรูปภาพนักเรียนที่ชัดเจน (JPG/PNG)</p>
                    <p style="font-size: 0.8rem; color: #94a3b8; margin-top: 5px;">
                        ระบบจะทำการตัดรูปส่วนกลางให้อัตโนมัติเป็นวงกลม</p>
                </div>
                <div class="report-actions" style="grid-template-columns: 1fr 1fr; margin-top: 25px;">
                    <button class="report-btn" onclick="closeUploadProfileModal()"
                        style="background: #f1f5f9; color: #475569; padding: 12px; border-radius: 12px; font-weight: 600;">ยกเลิก</button>
                    <button class="report-btn" onclick="saveProfileImage()"
                        style="background: linear-gradient(135deg, #10b981, #059669); color: white; padding: 12px; border-radius: 12px; font-weight: 700;">บันทึกรูปภาพ</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Reporting Modal -->
    <div class="student-search-overlay" id="reportModal">
        <div class="report-modal">
            <div class="report-header">
                <h3><i class="fas fa-file-alt"></i> รายงานสรุปคะแนนพฤติกรรม</h3>
                <button class="qr-close-btn" onclick="closeReportModal()"
                    style="position: absolute; right: 20px; top: 20px; color: white;">×</button>
            </div>
            <div class="report-body">
                <div class="report-form-group">
                    <label>รายเดือน <span class="required-indicator">*</span></label>
                    <select class="report-select" id="reportMonth">
                        <option value="all">ทุกเดือน (ทั้งปี)</option>
                        <option value="0">มกราคม</option>
                        <option value="1">กุมภาพันธ์</option>
                        <option value="2">มีนาคม</option>
                        <option value="3">เมษายน</option>
                        <option value="4">พฤษภาคม</option>
                        <option value="5">มิถุนายน</option>
                        <option value="6">กรกฎาคม</option>
                        <option value="7">สิงหาคม</option>
                        <option value="8">กันยายน</option>
                        <option value="9">ตุลาคม</option>
                        <option value="10">พฤศจิกายน</option>
                        <option value="11">ธันวาคม</option>
                    </select>
                </div>
                <div class="report-form-group">
                    <label>เลือกปีการศึกษา <span class="required-indicator">*</span></label>
                    <select class="report-select" id="reportYear">
                        <!-- Populated by JS -->
                    </select>
                </div>
                <div class="report-form-group">
                    <label>สถานะพฤติกรรม <span class="required-indicator">*</span></label>
                    <select class="report-select" id="reportFilter">
                        <option value="all">ทั้งหมด (ทุกคน)</option>
                        <option value="failed">ไม่ผ่านเกณฑ์ (ปรับแก้คะแนนด่วน)</option>
                        <option value="passed">ผ่านเกณฑ์ (คะแนนปกติ)</option>
                        <option value="excellent">เด็กดีศรีเทพา</option>
                    </select>
                </div>

                <div class="report-actions">
                    <button class="report-btn btn-image" onclick="exportReport('image')">
                        <i class="fas fa-image"></i> ส่งออกเป็นรูปภาพ
                    </button>
                    <button class="report-btn btn-pdf" onclick="exportReport('pdf')">
                        <i class="fas fa-file-pdf"></i> ส่งออกเป็น PDF
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Copyright Footer -->
    <div class="footer-section">
        © 2026 นางสาวสโรชา เมืองมุสิก & ด.ช.เทิดศักดิ์ สุวรรณมาลี
    </div>

</body>

</html>