<!DOCTYPE html>
<html lang="th">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>หน้าหลัก - ระบบคะแนนพฤติกรรม</title>
  <link
    href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=Prompt:wght@300;400;500;600;700&display=swap"
    rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <style>
    :root {
      --bg: #050507;
      --bg-2: #0a0a0f;
      --surface: #0f1014;
      --surface-2: #16171e;
      --surface-3: #1e2028;
      --border: rgba(255, 255, 255, 0.06);
      --border-2: rgba(255, 255, 255, 0.1);
      --grad-1: #6366f1;
      --grad-2: #8b5cf6;
      --grad-3: #a78bfa;
      --grad-4: #c084fc;
      --cyan: #22d3ee;
      --emerald: #34d399;
      --rose: #fb7185;
      --amber: #fbbf24;
      --sky: #38bdf8;
      --primary: #8b5cf6;
      --success: #34d399;
      --warning: #fbbf24;
      --danger: #fb7185;
      --text: #f0f0f5;
      --text-2: #a1a1b5;
      --text-3: #5a5a72;
      --text-main: #f0f0f5;
      --text-muted: #a1a1b5;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0
    }

    body {
      font-family: 'Prompt', 'Inter', sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      -webkit-tap-highlight-color: transparent;
      overflow-x: hidden;
    }

    /* ── Ambient Background ── */
    body::before {
      content: '';
      position: fixed;
      inset: 0;
      z-index: 0;
      pointer-events: none;
      background:
        radial-gradient(ellipse 600px 400px at 15% 20%, rgba(99, 102, 241, 0.07), transparent),
        radial-gradient(ellipse 500px 500px at 85% 60%, rgba(139, 92, 246, 0.05), transparent),
        radial-gradient(ellipse 400px 300px at 50% 90%, rgba(34, 211, 238, 0.04), transparent);
    }

    /* ── Grid pattern ── */
    body::after {
      content: '';
      position: fixed;
      inset: 0;
      z-index: 0;
      pointer-events: none;
      background-image:
        linear-gradient(rgba(255, 255, 255, 0.015) 1px, transparent 1px),
        linear-gradient(90deg, rgba(255, 255, 255, 0.015) 1px, transparent 1px);
      background-size: 60px 60px;
    }

    @keyframes fadeUp {
      from {
        opacity: 0;
        transform: translateY(24px)
      }

      to {
        opacity: 1;
        transform: translateY(0)
      }
    }

    @keyframes fadeIn {
      from {
        opacity: 0
      }

      to {
        opacity: 1
      }
    }

    @keyframes pulse {

      0%,
      100% {
        opacity: 1
      }

      50% {
        opacity: .5
      }
    }

    @keyframes spin {
      to {
        transform: rotate(360deg)
      }
    }

    @keyframes wave {

      0%,
      60%,
      100% {
        transform: rotate(0)
      }

      10% {
        transform: rotate(14deg)
      }

      20% {
        transform: rotate(-8deg)
      }

      30% {
        transform: rotate(14deg)
      }

      40% {
        transform: rotate(-4deg)
      }

      50% {
        transform: rotate(10deg)
      }
    }

    @keyframes zoomIn {
      from {
        opacity: 0;
        transform: scale(.92)
      }

      to {
        opacity: 1;
        transform: scale(1)
      }
    }

    @keyframes gradientMove {
      0% {
        background-position: 0% 50%
      }

      50% {
        background-position: 100% 50%
      }

      100% {
        background-position: 0% 50%
      }
    }

    @keyframes ringPulse {

      0%,
      100% {
        opacity: .6
      }

      50% {
        opacity: 1
      }
    }

    .page {
      position: relative;
      z-index: 1
    }

    .container {
      max-width: 520px;
      margin: 0 auto;
      padding: 0 16px 90px
    }

    /* ── NAVBAR ── */
    .nav {
      position: sticky;
      top: 0;
      z-index: 100;
      background: rgba(5, 5, 7, 0.8);
      border-bottom: 1px solid var(--border);
      padding: 12px 0;
    }

    .nav-inner {
      max-width: 520px;
      margin: 0 auto;
      padding: 0 16px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .nav-brand {
      display: flex;
      align-items: center;
      gap: 8px
    }

    .nav-brand img {
      height: 50px;
      width: auto;
      object-fit: contain
    }

    .brand-tpac-logo {
      height: 75px !important;
      margin-left: 4px;
      mix-blend-mode: screen;
      filter: contrast(1.1) brightness(1.1)
    }

    .nav-right {
      display: flex;
      align-items: center;
      gap: 10px
    }

    .nav-user {
      text-align: right;
      display: none
    }

    @media(min-width:640px) {
      .nav-user {
        display: block
      }
    }

    .nav-user-name {
      font-size: .82rem;
      font-weight: 500;
      color: var(--text)
    }

    .nav-user-id {
      font-size: .68rem;
      color: var(--text-3)
    }

    .btn-icon {
      width: 36px;
      height: 36px;
      border-radius: 10px;
      background: var(--surface);
      border: 1px solid var(--border);
      color: var(--text-3);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: .85rem;
      transition: color .2s, border-color .2s;
    }

    .btn-icon:hover {
      color: var(--rose);
      border-color: rgba(251, 113, 133, .3)
    }

    /* ── HERO SCORE ── */
    .hero {
      text-align: center;
      padding: 48px 20px 40px;
      animation: fadeUp .7s ease;
    }

    .hero-label {
      font-size: .65rem;
      color: var(--text-3);
      text-transform: uppercase;
      letter-spacing: 3px;
      font-weight: 500;
      margin-bottom: 28px;
    }

    .score-ring {
      position: relative;
      width: 180px;
      height: 180px;
      margin: 0 auto 24px;
    }

    .score-ring svg {
      width: 100%;
      height: 100%;
      transform: rotate(-90deg);
    }

    .ring-bg {
      fill: none;
      stroke: var(--surface-2);
      stroke-width: 6
    }

    .ring-progress {
      fill: none;
      stroke: url(#scoreGrad);
      stroke-width: 6;
      stroke-linecap: round;
      stroke-dasharray: 502;
      stroke-dashoffset: 502;
      transition: stroke-dashoffset 1.5s cubic-bezier(.4, 0, .2, 1);
    }

    .score-inner {
      position: absolute;
      inset: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }

    .score-num {
      font-family: 'Inter', sans-serif;
      font-size: 3.8rem;
      font-weight: 800;
      line-height: 1;
      letter-spacing: -3px;
      background: linear-gradient(135deg, #fff 30%, var(--grad-3));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .score-of {
      font-size: .72rem;
      color: var(--text-3);
      margin-top: 4px;
      font-weight: 400
    }

    .hero-status {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 16px;
      border-radius: 20px;
      font-weight: 500;
      font-size: .78rem;
      background: var(--surface);
      border: 1px solid var(--border);
      transition: border-color .2s;
    }

    .hero-status .dot {
      width: 6px;
      height: 6px;
      border-radius: 50%;
      animation: pulse 2s infinite
    }

    .st-normal {
      color: var(--emerald)
    }

    .st-normal .dot {
      background: var(--emerald)
    }

    .st-risk {
      color: var(--amber)
    }

    .st-risk .dot {
      background: var(--amber)
    }

    .st-urgent {
      color: var(--rose)
    }

    .st-urgent .dot {
      background: var(--rose)
    }

    .st-excellent {
      color: var(--amber)
    }

    .st-excellent .dot {
      background: var(--amber)
    }

    /* ── SECTION TITLES ── */
    .sec-title {
      font-size: .68rem;
      color: var(--text-3);
      text-transform: uppercase;
      letter-spacing: 2px;
      font-weight: 500;
      margin-bottom: 12px;
      padding-left: 2px;
    }

    /* ── ACTION CARDS ── */
    .actions {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin-bottom: 24px
    }

    .act-card {
      position: relative;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 22px 16px 18px;
      cursor: pointer;
      transition: transform .15s, border-color .2s;
      overflow: hidden;
      animation: fadeUp .5s ease backwards;
    }

    .act-card:hover {
      transform: translateY(-3px);
      border-color: var(--border-2)
    }

    .act-card:active {
      transform: scale(.98)
    }

    .act-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 2px;
      background: var(--card-accent, var(--grad-2));
      opacity: 0;
      transition: opacity .2s;
    }

    .act-card:hover::before {
      opacity: 1
    }

    .act-icon {
      width: 42px;
      height: 42px;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.1rem;
      margin-bottom: 12px;
    }

    .act-title {
      font-size: .84rem;
      font-weight: 600;
      color: var(--text);
      margin-bottom: 2px
    }

    .act-desc {
      font-size: .66rem;
      color: var(--text-3);
      font-weight: 300;
      line-height: 1.4
    }

    .d1 {
      animation-delay: 0s
    }

    .d2 {
      animation-delay: .06s
    }

    .d3 {
      animation-delay: .12s
    }

    .d4 {
      animation-delay: .18s
    }

    .d5 {
      animation-delay: .24s
    }

    .ic-hist {
      background: rgba(56, 189, 248, .08);
      color: var(--sky);
      --card-accent: var(--sky)
    }

    .ic-rule {
      background: rgba(139, 92, 246, .08);
      color: var(--grad-2);
      --card-accent: var(--grad-2)
    }

    .ic-qr {
      background: rgba(251, 191, 36, .08);
      color: var(--amber);
      --card-accent: var(--amber)
    }

    .ic-prof {
      background: rgba(52, 211, 153, .08);
      color: var(--emerald);
      --card-accent: var(--emerald)
    }

    .ic-bell {
      background: rgba(251, 113, 133, .08);
      color: var(--rose);
      --card-accent: var(--rose)
    }

    .act-card:hover .ic-hist {
      background: rgba(56, 189, 248, .15)
    }

    .act-card:hover .ic-rule {
      background: rgba(139, 92, 246, .15)
    }

    .act-card:hover .ic-qr {
      background: rgba(251, 191, 36, .15)
    }

    .act-card:hover .ic-prof {
      background: rgba(52, 211, 153, .15)
    }

    .act-card:hover .ic-bell {
      background: rgba(251, 113, 133, .15)
    }

    /* ── INFO CARD ── */
    .info-card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 20px;
      margin-bottom: 20px;
      animation: fadeUp .6s ease backwards;
      animation-delay: .3s;
    }

    .info-header {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 16px;
      font-size: .78rem;
      font-weight: 500;
      color: var(--text-2);
    }

    .info-header i {
      color: var(--grad-3);
      font-size: .85rem
    }

    .info-row {
      display: flex;
      align-items: center;
      padding: 10px 0;
      border-bottom: 1px solid var(--border);
    }

    .info-row:last-child {
      border-bottom: none
    }

    .info-row-icon {
      width: 32px;
      height: 32px;
      border-radius: 8px;
      background: rgba(139, 92, 246, .06);
      display: flex;
      align-items: center;
      justify-content: center;
      margin-right: 12px;
      color: var(--grad-3);
      font-size: .78rem;
      flex-shrink: 0;
    }

    .info-label {
      font-size: .62rem;
      color: var(--text-3);
      text-transform: uppercase;
      letter-spacing: .6px
    }

    .info-val {
      font-size: .88rem;
      font-weight: 500;
      color: var(--text)
    }

    /* ── MODALS ── */
    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(2, 2, 4, 0.88);
      z-index: 1000;
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0;
      visibility: hidden;
      transition: opacity .2s, visibility .2s;
    }

    .modal-overlay.active {
      opacity: 1;
      visibility: visible
    }

    .modal {
      background: var(--surface);
      border: 1px solid var(--border-2);
      border-radius: 20px;
      width: 92%;
      max-width: 440px;
      max-height: 82vh;
      overflow-y: auto;
      transform: scale(.94) translateY(10px);
      transition: transform .3s cubic-bezier(.34, 1.56, .64, 1);
    }

    .modal-overlay.active .modal {
      transform: scale(1) translateY(0)
    }

    .modal-head {
      padding: 18px 20px;
      border-bottom: 1px solid var(--border);
      display: flex;
      justify-content: space-between;
      align-items: center;
      position: sticky;
      top: 0;
      background: var(--surface);
      z-index: 10;
      border-radius: 20px 20px 0 0;
    }

    .modal-head h3 {
      font-size: .95rem;
      font-weight: 600;
      color: var(--text)
    }

    .modal-body {
      padding: 20px;
      color: var(--text-2);
      line-height: 1.7;
      font-weight: 300
    }

    .modal-body h3 {
      color: var(--text);
      margin: 14px 0 8px;
      font-size: .95rem;
      font-weight: 500;
      padding-left: 12px;
      border-left: 2px solid var(--grad-2)
    }

    .modal-body ul {
      padding-left: 18px
    }

    .modal-body li {
      margin-bottom: 5px
    }

    /* ── SCROLLBAR ── */
    ::-webkit-scrollbar {
      width: 3px
    }

    ::-webkit-scrollbar-track {
      background: transparent
    }

    ::-webkit-scrollbar-thumb {
      background: rgba(255, 255, 255, .08);
      border-radius: 3px
    }

    /* ── PROFILE ── */
    .profile-header {
      text-align: center;
      margin-bottom: 20px
    }

    .profile-img-container {
      width: 90px;
      height: 90px;
      margin: 0 auto 10px;
      position: relative;
      cursor: pointer
    }

    .profile-img {
      width: 100%;
      height: 100%;
      border-radius: 50%;
      object-fit: cover;
      border: 2px solid var(--grad-2)
    }

    .profile-badge {
      position: absolute;
      bottom: 0;
      right: 0;
      background: var(--grad-2);
      color: #fff;
      width: 24px;
      height: 24px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      border: 2px solid var(--surface);
      font-size: .6rem;
    }

    /* ── TOAST ── */
    .toast-container {
      position: fixed;
      top: 16px;
      right: 16px;
      z-index: 2000;
      display: flex;
      flex-direction: column;
      gap: 8px;
      pointer-events: none;
    }

    .toast {
      background: var(--surface-2);
      border: 1px solid var(--border-2);
      border-left: 3px solid var(--grad-2);
      padding: 12px 16px;
      border-radius: 12px;
      min-width: 240px;
      max-width: 340px;
      display: flex;
      align-items: flex-start;
      gap: 10px;
      transform: translateX(120%);
      transition: transform .3s cubic-bezier(.34, 1.56, .64, 1);
      pointer-events: auto;
    }

    .toast.show {
      transform: translateX(0)
    }

    .toast-icon {
      font-size: .95rem;
      margin-top: 1px
    }

    .toast-content {
      flex: 1
    }

    .toast-title {
      font-weight: 500;
      font-size: .82rem;
      color: var(--text)
    }

    .toast-msg {
      font-size: .74rem;
      color: var(--text-2);
      line-height: 1.4;
      margin-top: 2px
    }

    .toast-success {
      border-left-color: var(--emerald)
    }

    .toast-success .toast-icon {
      color: var(--emerald)
    }

    .toast-error {
      border-left-color: var(--rose)
    }

    .toast-error .toast-icon {
      color: var(--rose)
    }

    .toast-info {
      border-left-color: var(--sky)
    }

    .toast-info .toast-icon {
      color: var(--sky)
    }

    /* ── PROFILE VIEWER ── */
    .pv-overlay {
      position: fixed;
      inset: 0;
      background: rgba(2, 2, 4, 0.96);
      z-index: 3000;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-direction: column;
      opacity: 0;
      pointer-events: none;
      transition: opacity .2s;
    }

    .pv-overlay.active {
      opacity: 1;
      pointer-events: all
    }

    .pv-img {
      max-width: 85%;
      max-height: 65vh;
      border-radius: 16px;
      border: 1px solid var(--border-2);
      transform: scale(.94);
      transition: transform .25s ease
    }

    .pv-overlay.active .pv-img {
      transform: scale(1)
    }

    .pv-close {
      position: absolute;
      top: 20px;
      right: 20px;
      background: var(--surface-2);
      border: 1px solid var(--border);
      color: var(--text-2);
      width: 36px;
      height: 36px;
      border-radius: 50%;
      font-size: .9rem;
      cursor: pointer;
      transition: color .15s;
    }

    .pv-close:hover {
      color: var(--rose)
    }

    /* ── FOOTER ── */
    .site-footer {
      position: fixed;
      bottom: 10px;
      left: 50%;
      transform: translateX(-50%);
      color: var(--text-3);
      font-size: .62rem;
      text-align: center;
      background: var(--surface);
      padding: 4px 14px;
      border-radius: 20px;
      border: 1px solid var(--border);
      white-space: nowrap;
      z-index: 50;
    }

    /* ── RESPONSIVE ── */
    @media(max-width:640px) {
      .hero {
        padding: 36px 16px 32px
      }

      .score-ring {
        width: 150px;
        height: 150px
      }

      .score-num {
        font-size: 3rem
      }

      .actions {
        gap: 8px
      }

      .act-card {
        padding: 18px 12px 14px
      }

      .act-icon {
        width: 36px;
        height: 36px;
        font-size: 1rem;
        margin-bottom: 10px
      }

      .act-title {
        font-size: .8rem
      }

      .container {
        padding: 0 12px 80px
      }

      .toast {
        min-width: unset;
        max-width: 88vw
      }
    }

    @media(max-width:380px) {
      .score-ring {
        width: 130px;
        height: 130px
      }

      .score-num {
        font-size: 2.4rem;
        letter-spacing: -2px
      }

      .nav-brand img {
        height: 40px
      }

      .brand-tpac-logo {
        height: 60px !important
      }

      .act-card {
        padding: 14px 10px 12px
      }
    }
  </style>
</head>

<body>
  <div class="page">

    <!-- Nav -->
    <nav class="nav">
      <div class="nav-inner">
        <div class="nav-brand">
          <img src="logo.png" alt="Logo">
          <img src="LOGOprogram/logoV2.png" alt="TPAC" class="brand-tpac-logo">
        </div>
        <div class="nav-right">
          <div class="nav-user">
            <div class="nav-user-name" id="navUserName">...</div>
            <div class="nav-user-id" id="navUserId">...</div>
          </div>
          <button class="btn-icon" onclick="logout()" title="ออกจากระบบ">
            <i class="fas fa-arrow-right-from-bracket"></i>
          </button>
        </div>
      </div>
    </nav>

    <div class="container">

      <!-- Hero Score -->
      <div class="hero">
        <div class="hero-label">คะแนนพฤติกรรมของคุณ</div>
        <div class="score-ring">
          <svg viewBox="0 0 180 180">
            <defs>
              <linearGradient id="scoreGrad" x1="0%" y1="0%" x2="100%" y2="100%">
                <stop offset="0%" stop-color="#6366f1" />
                <stop offset="50%" stop-color="#8b5cf6" />
                <stop offset="100%" stop-color="#a78bfa" />
              </linearGradient>
            </defs>
            <circle class="ring-bg" cx="90" cy="90" r="80" />
            <circle class="ring-progress" id="scoreRing" cx="90" cy="90" r="80" />
          </svg>
          <div class="score-inner">
            <div class="score-num" id="scoreValue">-</div>
            <div class="score-of">/ 100 คะแนน</div>
          </div>
        </div>
        <div class="hero-status st-normal" id="statusBadge">
          <span class="dot"></span> <span id="statusText">ปกติ</span>
        </div>
      </div>

      <!-- Actions -->
      <div class="sec-title">เมนูหลัก</div>
      <div class="actions">
        <div class="act-card d1" onclick="openModal('history')">
          <div class="act-icon ic-hist"><i class="fas fa-clock-rotate-left"></i></div>
          <div class="act-title">ประวัติ</div>
          <div class="act-desc">การเคลื่อนไหวคะแนน</div>
        </div>
        <div class="act-card d2" onclick="openModal('rules')">
          <div class="act-icon ic-rule"><i class="fas fa-scale-balanced"></i></div>
          <div class="act-title">กฎระเบียบ</div>
          <div class="act-desc">เกณฑ์การตัดคะแนน</div>
        </div>
        <div class="act-card d3" onclick="openModal('qrcode')">
          <div class="act-icon ic-qr"><i class="fas fa-qrcode"></i></div>
          <div class="act-title">QR Code</div>
          <div class="act-desc">สำหรับแสดงให้ครู</div>
        </div>
        <div class="act-card d4" onclick="openModal('profile')">
          <div class="act-icon ic-prof"><i class="fas fa-user-astronaut"></i></div>
          <div class="act-title">โปรไฟล์</div>
          <div class="act-desc">ข้อมูลส่วนตัว</div>
        </div>
        <div class="act-card d5" onclick="openModal('notifications')">
          <div class="act-icon ic-bell"><i class="fas fa-bell"></i></div>
          <div class="act-title">การแจ้งเตือน</div>
          <div class="act-desc">ติดตามสถานะคำร้อง</div>
        </div>
      </div>

      <!-- Info -->
      <div class="sec-title">ข้อมูลนักเรียน</div>
      <div class="info-card">
        <div class="info-row">
          <div class="info-row-icon"><i class="fas fa-user"></i></div>
          <div>
            <div class="info-label">ชื่อ-นามสกุล</div>
            <div class="info-val" id="infoName">-</div>
          </div>
        </div>
        <div class="info-row">
          <div class="info-row-icon"><i class="fas fa-fingerprint"></i></div>
          <div>
            <div class="info-label">รหัสนักเรียน</div>
            <div class="info-val" id="infoId">-</div>
          </div>
        </div>
        <div class="info-row">
          <div class="info-row-icon"><i class="fas fa-heart-pulse"></i></div>
          <div>
            <div class="info-label">สถานะพฤติกรรม</div>
            <div class="info-val" id="infoStatus">-</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Main Modal -->
    <div class="modal-overlay" id="mainModalOverlay" onclick="closeModal()">
      <div class="modal" onclick="event.stopPropagation()">
        <div class="modal-head">
          <h3 id="modalTitle">Title</h3>
          <button class="btn-icon" onclick="closeModal()" style="width:30px;height:30px"><i
              class="fas fa-xmark"></i></button>
        </div>
        <div class="modal-body" id="modalContent"></div>
      </div>
    </div>

    <!-- Profile Viewer -->
    <div class="pv-overlay" id="profileViewer" onclick="closeProfileViewer()">
      <button class="pv-close" onclick="closeProfileViewer()">&times;</button>
      <div id="pvImageContainer"></div>
      <div style="margin-top:16px;text-align:center;color:#fff">
        <h2 id="pvName" style="font-size:1.1rem;margin-bottom:4px"></h2>
        <p id="pvId" style="opacity:.6;font-size:.85rem"></p>
      </div>
    </div>

    <!-- Logout Confirm -->
    <div class="modal-overlay" id="logoutConfirmOverlay" style="z-index:3000">
      <div
        style="max-width:360px;width:90%;text-align:center;padding:40px 30px;background:var(--surface);border:1px solid var(--border-2);border-radius:24px;animation:zoomIn .3s cubic-bezier(.34,1.56,.64,1)">
        <div style="font-size:3rem;margin-bottom:16px;display:inline-block;animation:wave 2s infinite">👋</div>
        <h3 style="font-size:1.3rem;margin-bottom:8px;font-weight:700;color:var(--text)">ออกจากระบบ</h3>
        <p style="color:var(--text-2);margin-bottom:28px;line-height:1.6;font-size:.88rem">
          คุณต้องการออกจากการทำงาน<br>ในเซสชันนี้ใช่หรือไม่?</p>
        <div style="display:flex;gap:12px">
          <button onclick="closeLogoutModal()"
            style="flex:1;padding:13px;border-radius:14px;border:1px solid var(--border-2);background:transparent;color:var(--text);font-weight:600;cursor:pointer;font-family:inherit;font-size:.88rem">ยกเลิก</button>
          <button onclick="confirmLogout()"
            style="flex:1;padding:13px;border-radius:14px;border:none;background:linear-gradient(135deg,var(--rose),#e11d48);color:#fff;font-weight:600;cursor:pointer;font-family:inherit;font-size:.88rem">ยืนยัน</button>
        </div>
      </div>
    </div>

    <!-- Toast -->
    <div class="toast-container" id="toastContainer"></div>

    <!-- Score Submit Modal -->
    <div class="modal-overlay" id="scoreSubmitOverlay" onclick="closeScoreSubmitModal()">
      <div class="modal" style="max-width:480px" onclick="event.stopPropagation()">
        <div class="modal-head"
          style="background:linear-gradient(135deg,var(--emerald),#06b6d4);border-radius:20px 20px 0 0">
          <h3 style="color:#000"><i class="fas fa-plus-circle"></i> ส่งขอเพิ่มคะแนน</h3>
          <button class="btn-icon" onclick="closeScoreSubmitModal()"
            style="color:#000;border-color:rgba(0,0,0,.15);width:30px;height:30px"><i class="fas fa-xmark"></i></button>
        </div>
        <div class="modal-body" style="padding:20px">
          <div
            style="background:rgba(139,92,246,.06);padding:14px;border-radius:12px;margin-bottom:18px;border:1px solid rgba(139,92,246,.1)">
            <div style="font-weight:600;color:var(--grad-3)" id="submitStudentName">-</div>
            <div style="font-size:.82rem;color:var(--text-3)" id="submitStudentId">รหัส: -</div>
          </div>
          <div style="margin-bottom:18px">
            <label style="display:block;color:var(--text-2);font-size:.82rem;margin-bottom:6px">รายละเอียดงาน /
              การแก้ไข</label>
            <textarea id="submitDetail" placeholder="ระบุรายละเอียดงานหรือสิ่งที่ได้แก้ไข..."
              style="width:100%;height:90px;padding:12px;border-radius:12px;border:1px solid var(--border-2);background:var(--surface-2);color:var(--text);font-size:.9rem;resize:none;font-family:inherit"></textarea>
          </div>
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:18px">
            <div style="text-align:center">
              <input type="file" id="beforeImageInput" accept="image/*" style="display:none"
                onchange="previewImage(this,'beforePreview')">
              <div onclick="document.getElementById('beforeImageInput').click()"
                style="border:2px dashed var(--border-2);border-radius:12px;padding:24px 12px;cursor:pointer;min-height:100px;display:flex;flex-direction:column;align-items:center;justify-content:center"
                id="beforeBox">
                <i class="fas fa-camera" style="font-size:1.5rem;color:var(--text-3);margin-bottom:8px"></i>
                <div style="color:var(--text-3);font-size:.8rem">ก่อนทำ</div>
                <img id="beforePreview" src=""
                  style="display:none;max-width:100%;max-height:70px;margin-top:8px;border-radius:6px">
              </div>
            </div>
            <div style="text-align:center">
              <input type="file" id="afterImageInput" accept="image/*" style="display:none"
                onchange="previewImage(this,'afterPreview')">
              <div onclick="document.getElementById('afterImageInput').click()"
                style="border:2px dashed var(--border-2);border-radius:12px;padding:24px 12px;cursor:pointer;min-height:100px;display:flex;flex-direction:column;align-items:center;justify-content:center"
                id="afterBox">
                <i class="fas fa-edit" style="font-size:1.5rem;color:var(--text-3);margin-bottom:8px"></i>
                <div style="color:var(--text-3);font-size:.8rem">หลังทำ</div>
                <img id="afterPreview" src=""
                  style="display:none;max-width:100%;max-height:70px;margin-top:8px;border-radius:6px">
              </div>
            </div>
          </div>
          <div style="display:flex;gap:10px">
            <button onclick="closeScoreSubmitModal()"
              style="flex:1;padding:13px;border-radius:12px;border:1px solid var(--border-2);background:transparent;color:var(--text);font-weight:600;cursor:pointer;font-family:inherit">ยกเลิก</button>
            <button onclick="submitScoreRequest()"
              style="flex:1;padding:13px;border-radius:12px;border:none;background:linear-gradient(135deg,var(--emerald),#06b6d4);color:#000;font-weight:700;cursor:pointer;font-family:inherit;display:flex;align-items:center;justify-content:center;gap:6px"><i
                class="fas fa-paper-plane"></i> บันทึกผลงาน</button>
          </div>
        </div>
      </div>
    </div>

  </div>

  <script>
    const CONFIG = { checkInterval: 3000 };
    let currentUser = null, pollInterval = null;

    document.addEventListener('DOMContentLoaded', () => initSession());

    function initSession() {
      const s = sessionStorage.getItem('currentUser');
      if (!s) { window.location.href = 'index.html'; return }
      currentUser = JSON.parse(s);
      updateUI(currentUser);
      startPolling();
      setTimeout(() => showToast('success', 'ยินดีต้อนรับ', `สวัสดีคุณ ${currentUser.name.split(' ')[0]}`), 500);
    }

    function startPolling() {
      if (pollInterval) clearInterval(pollInterval);
      pollInterval = setInterval(async () => {
        try {
          const r = await fetch(`user2.1.json?v=${Date.now()}`);
          if (!r.ok) return;
          const students = await r.json();
          const d = students.find(s => s.id === currentUser.id);
          if (d) checkForUpdates(d);
        } catch (e) { console.error("Poll:", e) }
      }, CONFIG.checkInterval);
    }

    function checkForUpdates(d) {
      let changed = false;
      if (d.score !== currentUser.score) {
        const diff = d.score - currentUser.score;
        showToast(diff > 0 ? 'success' : 'error', 'คะแนนเปลี่ยนแปลง', `คะแนนของคุณ ${diff > 0 ? '+' : ''}${diff} (ใหม่: ${d.score})`);
        currentUser.score = d.score; changed = true;
      }
      const ns = d.statuspoint || 'normal', cs = currentUser.statuspoint || 'normal';
      if (ns !== cs) {
        showToast('info', 'สถานะเปลี่ยน', `สถานะพฤติกรรมเปลี่ยนเป็น "${getLocalizedStatus(ns)}"`);
        currentUser.statuspoint = ns; changed = true;
      }
      currentUser.status = d.status;
      if (changed) { sessionStorage.setItem('currentUser', JSON.stringify(currentUser)); updateUI(currentUser) }
    }

    function updateUI(u) {
      document.getElementById('navUserName').textContent = u.name;
      document.getElementById('navUserId').textContent = `ID: ${u.id}`;
      document.getElementById('infoName').textContent = u.name;
      document.getElementById('infoId').textContent = u.id;
      // Score ring
      const score = u.score || 0;
      document.getElementById('scoreValue').textContent = score;
      const ring = document.getElementById('scoreRing');
      const circumference = 2 * Math.PI * 80; // ~502
      const offset = circumference - (score / 100) * circumference;
      setTimeout(() => { ring.style.strokeDashoffset = offset }, 100);
      // Status
      const sk = u.statuspoint || 'normal';
      const sc = getStatusConfig(sk);
      const badge = document.getElementById('statusBadge');
      badge.className = 'hero-status st-' + sk.replace('excellent', 'excellent');
      const stMap = { 'normal': 'st-normal', 'risk': 'st-risk', 'urgent': 'st-urgent', 'excellent': 'st-excellent' };
      badge.className = 'hero-status ' + (stMap[sk] || 'st-normal');
      document.getElementById('statusText').textContent = sc.text;
      document.getElementById('infoStatus').textContent = sc.text;
    }

    function getStatusConfig(s) {
      const m = {
        'normal': { text: 'ปกติ', class: 'st-normal', icon: 'fas fa-check-circle' },
        'risk': { text: 'เริ่มมีความเสี่ยง', class: 'st-risk', icon: 'fas fa-exclamation-triangle' },
        'urgent': { text: 'ปรับปรุงด่วน', class: 'st-urgent', icon: 'fas fa-radiation' },
        'excellent': { text: 'เด็กดีศรีเทพา', class: 'st-excellent', icon: 'fas fa-star' }
      };
      return m[s] || m.normal;
    }
    function getLocalizedStatus(s) { return getStatusConfig(s).text }

    // --- Modal ---
    async function openModal(type) {
      const modal = document.getElementById('mainModalOverlay');
      const title = document.getElementById('modalTitle');
      const body = document.getElementById('modalContent');
      body.innerHTML = '<div style="text-align:center;padding:30px;color:var(--text-3)"><i class="fas fa-circle-notch fa-spin"></i> กำลังโหลด...</div>';
      let c = { title: '', body: '' };
      switch (type) {
        case 'history': c = await getHistoryContent(); break;
        case 'rules': c = getRulesContent(); break;
        case 'qrcode': c = getQRContent(); break;
        case 'profile': c = getProfileContent(); break;
        case 'notifications': c = getNotificationsContent(); setTimeout(loadStudentNotifications, 100); break;
      }
      title.innerHTML = c.title; body.innerHTML = c.body;
      modal.classList.add('active');
      if (type === 'qrcode') {
        setTimeout(() => {
          const qr = document.getElementById('qrCanvas');
          if (qr) new QRCode(qr, { text: currentUser.id, width: 180, height: 180, colorDark: "#1e1b4b", colorLight: "#fff", correctLevel: QRCode.CorrectLevel.H });
        }, 100);
      }
    }
    function closeModal() { document.getElementById('mainModalOverlay').classList.remove('active') }

    async function getHistoryContent() {
      try {
        const r = await fetch('log.json'); if (!r.ok) throw 0;
        const logs = await r.json();
        const lim = new Date(); lim.setMonth(lim.getMonth() - 3);
        const ul = logs.filter(l => l.student_id === currentUser.id && new Date(l.timestamp) > lim).sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
        if (!ul.length) return { title: '<i class="fas fa-clock-rotate-left"></i> ประวัติคะแนน', body: '<div style="text-align:center;padding:30px;color:var(--text-3)">ยังไม่มีประวัติเร็วๆ นี้</div>' };
        let h = '<div style="display:flex;flex-direction:column;gap:2px">';
        ul.forEach(l => {
          const d = new Date(l.timestamp).toLocaleDateString('th-TH', { day: 'numeric', month: 'short', year: '2-digit', hour: '2-digit', minute: '2-digit' });
          const pos = l.change > 0;
          h += `<div style="display:flex;justify-content:space-between;align-items:center;padding:12px 0;border-bottom:1px solid var(--border)">
        <div><div style="font-weight:500;font-size:.88rem">${l.reason}</div><div style="font-size:.72rem;color:var(--text-3)"><i class="far fa-clock"></i> ${d}</div></div>
        <div style="font-weight:700;font-size:1.05rem;color:${pos ? 'var(--emerald)' : 'var(--rose)'}">${pos ? '+' : ''}${l.change}</div></div>`;
        });
        h += '</div>';
        return { title: '<i class="fas fa-clock-rotate-left"></i> ประวัติคะแนน', body: h };
      } catch (e) { return { title: 'ข้อผิดพลาด', body: 'ไม่สามารถโหลดข้อมูลประวัติได้' } }
    }

    function getRulesContent() {
      return {
        title: '<i class="fas fa-scale-balanced"></i> กฎระเบียบ', body: `
    <h3>🚫 การหักคะแนน</h3><ul>
    <li><strong style="color:var(--rose)">-10</strong> : มาสาย / แต่งกายผิดระเบียบ</li>
    <li><strong style="color:var(--rose)">-10</strong> : ไม่สวมหมวกนิรภัย</li>
    <li><strong style="color:var(--rose)">-20</strong> : ทะเลาะวิวาท / ก่อเรื่อง</li>
    <li><strong style="color:var(--rose)">-30</strong> : สูบบุหรี่ / สิ่งเสพติด / พกอาวุธ</li>
    <li><strong style="color:var(--rose)">-60</strong> : ดื่มสุราในค่าย</li></ul>
    <div style="margin-top:18px;padding:14px;background:rgba(251,191,36,.06);border-left:3px solid var(--amber);border-radius:10px;font-size:.85rem">
      <i class="fas fa-lightbulb" style="color:var(--amber)"></i> พฤติกรรมดีมีโอกาสได้รับคะแนนเพิ่มตามดุลยพินิจของครู
    </div>
    <div style="margin-top:24px;text-align:center">
      <button onclick="openScoreSubmitModal()" style="background:linear-gradient(135deg,var(--emerald),#06b6d4);border:none;padding:14px 28px;border-radius:14px;color:#000;font-weight:700;font-size:.92rem;cursor:pointer;display:inline-flex;align-items:center;gap:8px;font-family:inherit">
        <i class="fas fa-plus-circle"></i> ส่งขอเพิ่มคะแนน
      </button>
      <p style="color:var(--text-3);font-size:.72rem;margin-top:8px">ส่งหลักฐานการทำความดี/ช่วยเหลือโรงเรียน</p>
    </div>`};
    }

    function getNotificationsContent() {
      return { title: '<i class="fas fa-bell"></i> การแจ้งเตือน', body: `<div id="notificationList" style="display:flex;flex-direction:column;gap:12px"><div style="text-align:center;padding:20px;color:var(--text-3)"><i class="fas fa-spinner fa-spin"></i> กำลังโหลด...</div></div>` };
    }

    async function loadStudentNotifications() {
      const list = document.getElementById('notificationList'); if (!list) return;
      try {
        const r = await fetch('/toadmin.json'); const data = await r.json();
        const my = data.filter(i => String(i.student_id) === String(currentUser.id)).sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
        if (!my.length) { list.innerHTML = '<div style="text-align:center;padding:36px 20px;color:var(--text-3)"><i class="fas fa-bell-slash" style="font-size:2.5rem;margin-bottom:12px;opacity:.4"></i><br>ไม่มีการแจ้งเตือน</div>'; return }
        list.innerHTML = my.map(i => {
          const d = new Date(i.timestamp).toLocaleString('th-TH');
          let sc = '#f7b733', si = 'fa-clock', st = 'รอการตรวจสอบ', bg = 'rgba(247,183,51,.06)', bc = 'rgba(247,183,51,.2)';
          if (i.status === 'completed') { sc = '#34d399'; si = 'fa-check-circle'; st = 'อนุมัติแล้ว'; bg = 'rgba(52,211,153,.06)'; bc = 'rgba(52,211,153,.2)' }
          else if (i.status === 'rejected') { sc = '#fb7185'; si = 'fa-times-circle'; st = 'ถูกปฏิเสธ'; bg = 'rgba(251,113,133,.06)'; bc = 'rgba(251,113,133,.2)' }
          const reason = i.admin_reason || i.reason || i.detail || '-';
          return `<div style="background:${bg};border:1px solid ${bc};border-radius:14px;padding:14px">
        <div style="display:flex;justify-content:space-between;align-items:start;margin-bottom:8px">
          <div style="font-weight:600;color:${sc};display:flex;align-items:center;gap:5px;font-size:.85rem"><i class="fas ${si}"></i> ${st}</div>
          <div style="font-size:.7rem;color:var(--text-3)">${d}</div></div>
        <div style="color:var(--text);margin-bottom:6px;font-size:.88rem">${i.detail || i.reason || 'ส่งคำร้อง'}</div>
        ${i.status === 'rejected' ? `<div style="font-size:.82rem;color:var(--rose);background:rgba(0,0,0,.15);padding:8px;border-radius:8px"><i class="fas fa-comment-alt"></i> เหตุผล: ${reason}</div>` : ''}
        ${i.status === 'completed' && i.admin_reason ? `<div style="font-size:.82rem;color:var(--emerald);background:rgba(0,0,0,.15);padding:8px;border-radius:8px"><i class="fas fa-comment-check"></i> ${i.admin_reason}</div>` : ''}</div>`;
        }).join('');
      } catch (e) { console.error(e); list.innerHTML = '<div style="text-align:center;color:var(--rose)">เกิดข้อผิดพลาดในการโหลดข้อมูล</div>' }
    }

    function getQRContent() {
      return {
        title: '<i class="fas fa-qrcode"></i> QR Student ID', body: `<div style="text-align:center;padding:10px">
    <div style="display:inline-block;padding:20px;border-radius:16px;background:var(--surface-2);border:1px solid var(--border-2)">
      <div id="qrCanvas" style="background:#fff;padding:10px;border-radius:10px"></div>
      <div style="margin-top:12px"><div style="font-size:.68rem;color:var(--text-3);text-transform:uppercase;letter-spacing:1px">Student ID</div>
        <div style="font-size:1.4rem;font-weight:700;color:var(--grad-3);margin-top:2px">${currentUser.id}</div></div></div>
    <p style="color:var(--text-3);font-size:.8rem;margin-top:16px"><i class="fas fa-check-circle" style="color:var(--emerald)"></i> พร้อมสำหรับการสแกน</p></div>`};
    }

    function getProfileContent() {
      const ts = Date.now(), img = `edstudent/${currentUser.id}.jpg?v=${ts}`;
      return {
        title: '<i class="fas fa-user-circle"></i> ข้อมูลส่วนตัว', body: `<div class="profile-header">
    <div class="profile-img-container" onclick="openProfileViewer('${img}')">
      <img src="${img}" class="profile-img" onerror="this.src='https://ui-avatars.com/api/?name=${currentUser.name}&background=random&color=fff'">
      <div class="profile-badge"><i class="fas fa-search-plus"></i></div></div>
    <h3 style="border:none;margin:0;font-size:1.05rem">${currentUser.name}</h3>
    <p style="color:var(--text-3);font-size:.82rem">${currentUser.id}</p></div>
    <div style="background:var(--surface-2);border-radius:14px;padding:18px;border:1px solid var(--border)">
      <div style="margin-bottom:14px"><div style="color:var(--text-3);font-size:.7rem;text-transform:uppercase;letter-spacing:.5px;margin-bottom:2px">สถานะการเรียน</div><div style="font-weight:500;font-size:.92rem">${getAcademicStatus(currentUser.status)}</div></div>
      <div style="margin-bottom:14px"><div style="color:var(--text-3);font-size:.7rem;text-transform:uppercase;letter-spacing:.5px;margin-bottom:2px">ระดับพฤติกรรม</div><div style="font-weight:500;font-size:.92rem">${getLocalizedStatus(currentUser.statuspoint || 'normal')}</div></div>
      <div><div style="color:var(--text-3);font-size:.7rem;text-transform:uppercase;letter-spacing:.5px;margin-bottom:2px">คะแนนสะสม</div><div style="font-weight:500;font-size:.92rem">${currentUser.score} คะแนน</div></div></div>`
      };
    }

    function getAcademicStatus(s) {
      const m = { 'normal': 'กำลังศึกษาอยู่', 'Absent': 'ขาดเรียนบ่อย', 'moved': 'ย้ายสถานศึกษา', 'notnormal': 'พักการเรียน' };
      return m[s] || 'กำลังศึกษาอยู่';
    }

    function openProfileViewer(src) {
      if (!src) return;
      const pv = document.getElementById('profileViewer');
      document.getElementById('pvName').textContent = currentUser.name;
      document.getElementById('pvId').textContent = currentUser.id;
      document.getElementById('pvImageContainer').innerHTML = `<img src="${src}" class="pv-img" onerror="this.src='https://ui-avatars.com/api/?name=${currentUser.name}&size=512'">`;
      pv.classList.add('active');
    }
    function closeProfileViewer() { document.getElementById('profileViewer').classList.remove('active') }

    function showToast(type, title, message) {
      const c = document.getElementById('toastContainer'), t = document.createElement('div');
      const icons = { success: 'fas fa-check-circle', error: 'fas fa-times-circle', info: 'fas fa-info-circle', warning: 'fas fa-exclamation-triangle' };
      t.className = `toast toast-${type}`;
      t.innerHTML = `<div class="toast-icon"><i class="${icons[type] || icons.info}"></i></div><div class="toast-content"><div class="toast-title">${title}</div><div class="toast-msg">${message}</div></div>`;
      c.appendChild(t);
      requestAnimationFrame(() => t.classList.add('show'));
      setTimeout(() => { t.classList.remove('show'); t.addEventListener('transitionend', () => t.remove()) }, 4000);
    }

    function logout() { document.getElementById('logoutConfirmOverlay').classList.add('active') }
    function closeLogoutModal() { document.getElementById('logoutConfirmOverlay').classList.remove('active') }
    function confirmLogout() {
      closeLogoutModal(); clearInterval(pollInterval); sessionStorage.removeItem('currentUser');
      document.body.style.opacity = '0'; document.body.style.transform = 'scale(.97)'; document.body.style.transition = 'all .4s ease';
      setTimeout(() => window.location.href = 'index.html', 400);
    }

    function openScoreSubmitModal() {
      closeModal();
      document.getElementById('submitStudentName').textContent = currentUser.name;
      document.getElementById('submitStudentId').textContent = 'รหัส: ' + currentUser.id;
      document.getElementById('submitDetail').value = '';
      document.getElementById('beforeImageInput').value = '';
      document.getElementById('afterImageInput').value = '';
      document.getElementById('beforePreview').style.display = 'none';
      document.getElementById('afterPreview').style.display = 'none';
      document.getElementById('scoreSubmitOverlay').classList.add('active');
    }
    function closeScoreSubmitModal() { document.getElementById('scoreSubmitOverlay').classList.remove('active') }
    function previewImage(input, pid) {
      const f = input.files[0]; if (f) { const r = new FileReader(); r.onload = e => { const p = document.getElementById(pid); p.src = e.target.result; p.style.display = 'block' }; r.readAsDataURL(f) }
    }
    async function getBase64FromInput(id) {
      const i = document.getElementById(id); if (!i.files || !i.files[0]) return '';
      return new Promise(r => { const rd = new FileReader(); rd.onload = () => r(rd.result); rd.readAsDataURL(i.files[0]) });
    }
    async function submitScoreRequest() {
      const detail = document.getElementById('submitDetail').value.trim();
      const bi = document.getElementById('beforeImageInput'), ai = document.getElementById('afterImageInput');
      if (!detail) { showToast('error', 'กรุณากรอกข้อมูล', 'ระบุรายละเอียดงาน/การแก้ไข'); return }
      if (!bi.files || !bi.files.length) { showToast('error', 'กรุณาแนบรูป', 'กรุณาอัพโหลดรูป "ก่อนทำ"'); return }
      if (!ai.files || !ai.files.length) { showToast('error', 'กรุณาแนบรูป', 'กรุณาอัพโหลดรูป "หลังทำ"'); return }
      showToast('info', 'กำลังส่ง...', 'กรุณารอสักครู่');
      try {
        const b64b = await getBase64FromInput('beforeImageInput'), b64a = await getBase64FromInput('afterImageInput');
        const data = { student_id: currentUser.id, student_name: currentUser.name, detail, image_before: b64b, image_after: b64a, teacher: 'นักเรียนส่งเอง', timestamp: new Date().toISOString(), status: 'pending', type: 'work', save_folder: 'profly' };
        const res = await fetch('/api/save-work', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(data) });
        const result = await res.json();
        if (result.status === 'success') { showToast('success', 'ส่งเสร็จสิ้น', 'รอครูตรวจสอบและอนุมัติ'); closeScoreSubmitModal() }
        else throw new Error(result.message || 'Failed');
      } catch (e) { console.error('Submit:', e); showToast('error', 'เกิดข้อผิดพลาด', e.message) }
    }
  </script>

  <div class="site-footer">© 2026 นางสาวสโรชา เมืองมุสิก & ด.ช.เทิดศักดิ์ สุวรรณมาลี</div>
</body>

</html>